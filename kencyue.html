<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Ken的首頁 (Firebase版)</title>
  <link rel="shortcut icon" href="images/tool-box.png" type="image/x-icon">
  <style>
    /* --- 基礎樣式 --- */
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:linear-gradient(135deg,#a2c5ff,#e1bee7);min-height:100vh;display:flex;flex-direction:column;}
    .toolbar{height:36px;background:rgba(0,0,0,0.7);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 12px;font-size:13px;}
    .traffic-lights{display:flex;gap:6px;}
    .circle{width:12px;height:12px;border-radius:50%;}
    .red{background:#ff5f56;}.yellow{background:#ffbd2e;}.green{background:#27c93f;}
    
    /* 登入按鈕樣式 */
    #authContainer { display: flex; align-items: center; gap: 10px; }
    #userDisplay { font-weight: bold; color: #add8e6; }
    .btn-auth { background: #4a90e2; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn-auth:hover { background: #357abd; }

    /* --- 頁籤容器 (Tab Container Wrapper) --- */
    .tab-container-wrapper {
        margin: 12px 12px 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.12); 
        background: rgba(255, 255, 255, 0.8); 
        border-radius: 12px 12px 0 0;
        user-select: none;
    }
    .tabs{
        display:flex;
        flex-wrap:wrap;
        background:transparent;
        margin:0;
        overflow:hidden;
        gap:0;
        padding: 0 10px;
        position: relative;
        z-index: 10;
    }
    
    /* --- 頁籤單體樣式 --- */
    .tab{
        flex:0 0 auto; 
        padding:10px 18px;
        text-align:center;
        font-size:14px;
        font-weight:600;
        cursor:pointer;
        background:#cccccc; 
        color: #333;
        border-radius: 8px 8px 0 0;
        transition:all .3s;
        margin-right: 4px;
        border: 1px solid #c0c0c0; 
        border-bottom: none; 
        transform: translateY(1px); 
    }
    .tab:hover { background: #b8b8b8; }
    .tab.active{
        background:#ffffff; 
        color:#4a90e2;
        border-color: #ffffff; 
        transform: translateY(0); 
        box-shadow: 0 -2px 5px rgba(0,0,0,0.05); 
        position: relative;
        z-index: 11; 
        margin-bottom: -1px; 
    }

    /* --- 內容區塊容器 --- */
    #groupsContainer {
        position: relative;
        overflow: hidden;
        min-height: 200px;
        background: #ffffff; 
        margin: -1px 12px 12px; 
        border-radius: 0 0 12px 12px; 
        box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        padding: 10px 0 0 0; 
    }
    
    .group-block{margin:0;}
    .group-content-wrapper {
        position: absolute;
        top: 0; left: 0; width: 100%;
        opacity: 0; pointer-events: none;
        transform: translateX(100%);
        transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        padding-top: 10px;
    }
    .group-content-wrapper.active {
        position: static; 
        opacity: 1; pointer-events: auto;
        transform: translateX(0);
    }

    /* --- 書籤網格樣式 --- */
    .bookmark-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:6px;justify-content:center;padding:0 12px 12px;margin-top:0;}
    .bookmark-item{text-decoration:none;color:#333;font-size:12px;display:flex;flex-direction:column;align-items:center;width:70px;padding:6px;border-radius:10px;background:rgba(230,230,230,0.85);
        transition:transform .2s;gap:4px;}
    .bookmark-item:hover{transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,0.2);}
    .bookmark-item img{width:44px;height:44px;border-radius:8px;object-fit:contain;}
    .bookmark-item span{text-align:center;max-width:80px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}

    /* --- 編輯浮窗 (Modal) --- */
    .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:999;}
    .modal{
        display:none;
        position:fixed;
        top:50%; left:50%;
        transform:translate(-50%,-50%);
        background:#fff;
        border-radius:12px;
        z-index:1000;
        width:95%; max-width:900px;
        max-height:88vh;
        overflow:hidden;
        box-shadow:0 10px 30px rgba(0,0,0,0.3);
        flex-direction:column;
    }
    
    .modal-header{padding:16px 20px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;}
    .modal-body{flex:1;overflow-y:auto;}
    .modal-footer{padding:16px 20px;border-top:1px solid #eee;text-align:right;background:#fafafa;}

    /* 編輯器 Tabs 區域 */
    .editor-tabs {
        display:flex;
        background:#f1f3f5;
        border-bottom:1px solid #ddd;
        position:sticky;
        top:0;
        z-index:10;
        overflow-x: auto; /* 允許過多 Tab 時橫向捲動 */
        padding-bottom: 2px;
        /* 隱藏捲軸 */
        scrollbar-width: none; 
        -ms-overflow-style: none;
    }
    .editor-tabs::-webkit-scrollbar { display: none; }

    /* 修改 CSS 中 .editor-tab 的部分 - 針對手機拖曳優化 */
    .editor-tab {
        flex: 0 0 auto;
        padding: 12px 20px;
        font-weight: 600;
        cursor: pointer;
        background: #e2e6ea;
        transition: background .2s, transform .1s;
        border-right: 1px solid #dcdcdc;
        user-select: none; /* 禁止選取文字，避免拖曳變選取 */
        -webkit-user-select: none;
        
        /* 關鍵設定：允許垂直捲動(瀏覽內容)，但由 JS 控制水平拖曳 */
        touch-action: pan-y; 
    }
    
    .editor-tab.active {
        background: #fff;
        border-bottom: 2px solid #4a90e2;
        color: #4a90e2;
    }

    /* Sortable 拖曳時的視覺效果 */
    .sortable-ghost { 
        opacity: 0.4; 
        background: #cce5ff; 
    }
    .sortable-chosen {
        background: #dbeaff;
        transform: scale(1.05); /* 抓取時稍微放大 */
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 99;
    }

    .editor-panel{display:none;padding:20px;}
    .editor-panel.active{display:block;}

    /* 編輯器卡片列表樣式 */
    .card-list { margin-top: 15px; user-select: none; }
    .bookmark-card { background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
    
    .card-header { 
        padding: 12px 15px; 
        background: #f1f1f1; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        font-weight: 600; 
        touch-action: none; /* 卡片標題區塊完全交給 JS 處理拖曳 */
    }
    
    .drag-handle { font-size: 16px; color: #888; margin-right: 10px; cursor: grab; padding: 0 5px;}
    .card-title { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px; cursor: pointer; }
    .toggle-icon { font-size: 18px; transition: transform 0.3s; font-family: Arial, sans-serif; cursor: pointer; padding-left: 10px; }
    .bookmark-card.active .toggle-icon { transform: rotate(180deg); }
    .card-content { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out; }
    .bookmark-card.active .card-content { max-height: 500px; padding: 15px; border-top: 1px solid #eee; }
    .card-field { margin-bottom: 10px; }
    .card-field label { display: block; font-size: 13px; color: #555; margin-bottom: 3px; font-weight: 600; }
    .card-field input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 13px; }
    .card-actions { padding-top: 10px; text-align: right; }
    .btn-primary { background: #4a90e2; color: #fff; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
    .btn-danger { background: #ff5f56; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }

    @media (max-width:600px){
      .toolbar{ font-size: 11px; }
      .bookmark-item{width:70px;padding:4px;}
      .bookmark-item img{width:36px;height:36px;}
      .modal { width: 100%; max-width: 100%; height: 100%; max-height: 100%; top: 0; left: 0; transform: none; border-radius: 0; }
      .modal-footer { display: flex; flex-wrap: wrap; justify-content: flex-end; }
      .modal-footer button { flex: 1 1 auto; margin: 4px 2px; }
    }
  </style>
</head>
<body>

  <div class="toolbar" id="toolbar">
    <div style="display:flex; align-items:center; gap:10px;">
        <div class="traffic-lights" onclick="window.openEditor()">
            <div class="circle red"></div><div class="circle yellow"></div><div class="circle green"></div>
        </div>
        <div id="pageTitle" onclick="window.openEditor()" style="cursor:pointer;">Ken的首頁</div>
        <div id="loadingState" style="display:none; color: #ffeb3b; font-size:12px;">同步中...</div>
    </div>
    
    <div id="authContainer">
        <span id="userDisplay">未登入 (唯讀模式)</span>
        <button id="loginBtn" class="btn-auth">Google 登入</button>
        <button id="logoutBtn" class="btn-auth" style="display:none;">登出</button>
        <div id="time"></div>
    </div>
  </div>

  <div class="tab-container-wrapper">
    <div id="mainTabs" class="tabs"></div>
  </div>
  
  <div id="groupsContainer"></div>

  <div class="overlay" id="overlay"></div>
  <div class="modal" id="modal">
    <div class="modal-header">
      <h3 style="margin:0;">編輯書籤</h3>
      <button id="closeBtn" style="background:none;border:none;font-size:24px;cursor:pointer;">×</button>
    </div>
    <div style="padding:0 20px 10px;">
      <label>頁面標題: <input id="titleInput" style="width:70%;padding:6px;font-size:14px;"></label>
    </div>
    <div class="modal-body">
      <div style="padding: 0 10px; font-size: 12px; color: #888; background: #f1f3f5;">
          提示：(手機版) 長按組別名稱可拖曳排序
      </div>
      <div class="editor-tabs" id="editorTabs"></div>
      <div id="editorPanels"></div>
    </div>
    <div class="modal-footer">
      <button onclick="window.addGroup()" class="btn-primary">新增組別</button>
      <button onclick="window.saveAll()" class="btn-primary">儲存全部</button>
      <button onclick="window.backupData()">匯出備份(JSON)</button>
      <button onclick="window.triggerRestore()">匯入還原</button>
      <input type="file" id="restoreFile" style="display:none"/>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } 
    from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } 
    from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  // --- Firebase 設定 ---
  const firebaseConfig = {
    apiKey: "AIzaSyAXlnUOnQZX1f1EZMJHlw-kTq_HZaCtnUE",
    authDomain: "bookmarks-bf775.firebaseapp.com",
    projectId: "bookmarks-bf775",
    storageBucket: "bookmarks-bf775.firebasestorage.app",
    messagingSenderId: "1028721219460",
    appId: "1:1028721219460:web:7f9ff7ef284d398b1cefd1",
    measurementId: "G-L3ZX218VPD"
  };

  // 初始化 Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // --- 全域變數管理 (移到 Module 內) ---
  let data = { title: "Ken的首頁 (未登入)", groups: [] };
  let currentUser = null;
  let currentMainTab = null;
  let currentEditorTab = 0;
  const columnHeaders = ["URL", "敘述", "Icon URL", "序號"];

  // 預設資料 (未登入時顯示)
  const defaultData = {
    title: "歡迎使用",
    groups: [
      {
        group: "範例組別",
        items: [
           { url: "https://www.google.com", text: "Google", img: "", order: 1 }
        ]
      }
    ]
  };

  // --- Auth 邏輯 ---
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const userDisplay = document.getElementById("userDisplay");
  const loadingState = document.getElementById("loadingState");

  loginBtn.onclick = () => {
    signInWithPopup(auth, provider).catch(error => {
      console.error("Login Failed", error);
      alert("登入失敗: " + error.message);
    });
  };

  logoutBtn.onclick = () => {
    signOut(auth).then(() => {
        alert("已登出");
        location.reload(); // 簡單重整清除狀態
    });
  };

  // 監聽登入狀態改變
  onAuthStateChanged(auth, async (user) => {
    if (user) {
        // 已登入
        currentUser = user;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        userDisplay.textContent = `Hi, ${user.displayName}`;
        userDisplay.style.color = "#a2c5ff";
        
        // 讀取 Firestore 資料
        await loadDataFromFirestore(user.uid);
    } else {
        // 未登入
        currentUser = null;
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        userDisplay.textContent = "未登入 (唯讀)";
        userDisplay.style.color = "#ccc";
        
        // 載入預設資料
        data = JSON.parse(JSON.stringify(defaultData));
        renderMain();
    }
  });

  // --- Firestore 資料操作 ---
  async function loadDataFromFirestore(uid) {
      showLoading(true);
      try {
          const docRef = doc(db, "users", uid);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
              const cloudData = docSnap.data().bookmarksData;
              // 簡單驗證資料結構
              if (cloudData && Array.isArray(cloudData.groups)) {
                  data = cloudData;
                  console.log("已從 Firestore 載入資料");
              }
          } else {
              console.log("尚無雲端資料，使用預設值");
              // 可以在這裡決定是否要寫入一份預設資料上去
              data = { title: `${currentUser.displayName}的首頁`, groups: [] };
          }
      } catch (e) {
          console.error("讀取失敗", e);
          alert("讀取雲端資料失敗");
      }
      showLoading(false);
      renderMain();
  }

  async function saveDataToFirestore() {
      if (!currentUser) {
          alert("請先登入才能儲存資料！");
          return;
      }
      showLoading(true);
      try {
          await setDoc(doc(db, "users", currentUser.uid), {
              bookmarksData: data,
              updatedAt: new Date()
          });
          alert("儲存成功！");
      } catch (e) {
          console.error("儲存失敗", e);
          alert("儲存失敗: " + e.message);
      }
      showLoading(false);
  }

  function showLoading(isLoading) {
      loadingState.style.display = isLoading ? "block" : "none";
  }

  // --- 暴露函式給 Window (讓 HTML onclick 也能呼叫) ---
  
  // 1. 編輯器相關
  window.openEditor = function() {
      // 填入標題
      document.getElementById("titleInput").value = data.title || "";
      
      const tabs = document.getElementById("editorTabs");
      const panels = document.getElementById("editorPanels");
      tabs.innerHTML = "";
      panels.innerHTML = "";
      
      if (data.groups.length > 0 && currentEditorTab >= data.groups.length) {
          currentEditorTab = data.groups.length - 1;
      }
      if (data.groups.length === 0) currentEditorTab = 0;

      data.groups.forEach((g, i) => {
          // 建立 Tab
          const tab = document.createElement("div");
          tab.className = "editor-tab";
          tab.dataset.index = i;
          if (i === currentEditorTab) tab.classList.add("active");
          tab.textContent = g.group;
          
          // 點擊事件 (區分拖曳與點擊)
          tab.onclick = () => {
              document.querySelectorAll(".editor-tab").forEach(t => t.classList.remove("active"));
              document.querySelectorAll(".editor-panel").forEach(p => p.classList.remove("active"));
              tab.classList.add("active");
              document.querySelector(`.editor-panel[data-index="${i}"]`).classList.add("active");
              currentEditorTab = i;
          };
          tabs.appendChild(tab);

          // 建立 Panel
          const panel = document.createElement("div");
          panel.className = "editor-panel";
          panel.dataset.index = i;
          if (i === currentEditorTab) panel.classList.add("active");

          panel.innerHTML = `
              <h4 contenteditable="true" style="margin:0 0 15px;padding:8px;background:#f8f9fa;border-radius:6px;">${g.group}</h4>
              <div class="card-list"></div>
              <button onclick="window.addRow(${i})" class="btn-primary" style="margin-top: 10px;">新增一列</button>
              <button onclick="window.deleteGroup(${i})" class="btn-danger" style="margin-top: 10px;">刪除整個組別</button>
          `;
          
          // 雙向綁定組別名稱
          const groupNameH4 = panel.querySelector("h4");
          groupNameH4.addEventListener('input', (e) => {
              const newName = e.target.innerText.trim();
              const tabElement = document.querySelector(`.editor-tab[data-index="${i}"]`);
              if (tabElement) tabElement.textContent = newName || '未命名組別';
          });

          // 產生卡片
          const cardList = panel.querySelector(".card-list");
          if(Array.isArray(g.items)) {
              let cardsHtml = '';
              g.items.forEach(item => {
                  cardsHtml += createBookmarkCardHtml(item.url, item.text, item.img, item.order);
              });
              cardList.innerHTML = cardsHtml;
              
              // 綁定卡片標題輸入
              cardList.querySelectorAll('.bookmark-card').forEach(card => {
                  const titleInput = card.querySelector('input[data-field="1"]');
                  if (titleInput) {
                      titleInput.addEventListener('input', (e) => {
                          card.querySelector('.card-title').textContent = e.target.value.trim() || '未命名書籤';
                      });
                  }
              });

              // 初始化 Sortable (卡片垂直拖曳)
              if (Sortable) {
                  new Sortable(cardList, {
                      animation: 150,
                      handle: '.drag-handle',
                      ghostClass: 'sortable-ghost',
                      // 手機優化：卡片用 handle 拖曳，所以反應要快
                      delay: 0, 
                      touchStartThreshold: 3 // 防止手抖誤觸
                  });
              }
          }
          panels.appendChild(panel);
      });

    // 初始化 Sortable (組別 Tab 水平拖曳)
    if (Sortable && data.groups.length > 0) {
        const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

        new Sortable(tabs, {
            animation: 200,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen', // 被選中時的樣式
            direction: 'horizontal', 
            
            // 關鍵：延遲設定，防止滑動 Tabs 時誤觸拖曳
            delay: isTouch ? 200 : 0, 
            delayOnTouchOnly: true, // 只在觸控設備啟用延遲
            
            // 容錯：手指按住時可以微幅抖動 (10px) 而不取消拖曳
            touchStartThreshold: 10, 

            // 震動回饋 (如果瀏覽器支援)
            onChoose: function() {
                if (navigator.vibrate) navigator.vibrate(50);
            }
        });
    }

      document.getElementById("modal").style.display = "flex";
      document.getElementById("overlay").style.display = "block";
  };

  // 2. 輔助函式 (產生 HTML)
  function createBookmarkCardHtml(url = '', text = '', img = '', order = '') {
    const uniqueId = Date.now() + Math.random().toString(36).substring(2, 9);
    let content = '';
    const initialValues = [url, text, img, order];
    const inputTypes = ['', '', '', 'number'];

    columnHeaders.forEach((label, index) => {
        content += `
            <div class="card-field">
                <label for="input-${uniqueId}-${index}">${label}</label>
                <input id="input-${uniqueId}-${index}" data-field="${index}" value="${initialValues[index] || ''}" type="${inputTypes[index] || 'text'}">
            </div>
        `;
    });

    return `
        <div class="bookmark-card">
            <div class="card-header">
                <div style="display:flex;align-items:center;flex-grow:1;">
                    <div class="drag-handle">☰</div>
                    <div class="card-title" onclick="window.toggleCard(this.parentNode.parentNode)">${text || '未命名書籤'}</div>
                </div>
                <div class="toggle-icon" onclick="window.toggleCard(this.parentNode.parentNode)">▼</div>
            </div>
            <div class="card-content">
                ${content}
                <div class="card-actions">
                    <button onclick="window.removeCard(this)" class="btn-danger">刪除</button>
                </div>
            </div>
        </div>
    `;
  }

  // 3. UI 操作函式
  window.toggleCard = function(headerOrCard) {
      // 兼容傳入 icon 或 card 本身
      let card = headerOrCard.classList.contains('bookmark-card') ? headerOrCard : headerOrCard.closest('.bookmark-card');
      if(card) card.classList.toggle('active');
  };

  window.removeCard = function(btn) {
      if(confirm("確定刪除?")) btn.closest('.bookmark-card').remove();
  };

  window.addRow = function(panelIndex) {
      const panel = document.querySelectorAll(".editor-panel")[panelIndex];
      const cardList = panel.querySelector(".card-list");
      const newCardHtml = createBookmarkCardHtml();
      cardList.insertAdjacentHTML('beforeend', newCardHtml);
      const addedCard = cardList.lastElementChild;
      addedCard.classList.add('active');
      
      const titleInput = addedCard.querySelector('input[data-field="1"]');
      if (titleInput) {
          titleInput.addEventListener('input', (e) => {
              addedCard.querySelector('.card-title').textContent = e.target.value.trim() || '未命名書籤';
          });
      }
      
      // 新增後滾動到底部
      addedCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
  };

  window.addGroup = function() {
      const name = prompt("新組別名稱", "新組別");
      if (name) {
          data.groups.push({group: name, items: []});
          currentEditorTab = data.groups.length - 1;
          window.openEditor();    
      }
  };

  window.deleteGroup = function(i) {
      if (confirm("確定刪除整個組別？")) {
          data.groups.splice(i, 1);
          if (data.groups.length > 0) {
              if (currentEditorTab >= data.groups.length) currentEditorTab = data.groups.length - 1;
          } else {
              currentEditorTab = 0; 
          }
          window.openEditor();      
      }
  };

  // 4. 儲存與備份邏輯
  window.saveAll = async function() {
      // 邏輯同原版，收集 DOM 資料更新 data
      const newGroups = [];
      const orderedGroupNames = [];
      document.querySelectorAll("#editorTabs .editor-tab").forEach(tab => {
          orderedGroupNames.push(tab.textContent.trim());
      });

      const processedGroupsMap = new Map();
      document.querySelectorAll(".editor-panel").forEach(panel => {
          const name = panel.querySelector("h4").innerText.trim(); 
          if (!name) return;
          
          const items = [];
          panel.querySelectorAll(".bookmark-card").forEach((card, index) => {
              const urlInput = card.querySelector('input[data-field="0"]');
              const textInput = card.querySelector('input[data-field="1"]');
              const imgInput = card.querySelector('input[data-field="2"]');

              let url = urlInput ? urlInput.value.trim() : '';
              if (url) {
                  let text = textInput ? (textInput.value.trim() || "未命名") : "未命名";
                  let img = imgInput ? imgInput.value.trim() : '';
                  let order = index + 1;
                  
                  if (!url.includes(':') && !url.startsWith('#')) url = 'http://' + url;
                  
                  // Auto favicon logic
                  if (!img && (url.startsWith('http'))) {
                      try { img = new URL(url).origin + "/favicon.ico"; } catch(e){}
                  }

                  items.push({url, text, img, order});
              }
          });
          if (items.length > 0) processedGroupsMap.set(name, {group: name, items});
      });

      orderedGroupNames.forEach(name => {
          const group = processedGroupsMap.get(name);
          if (group) newGroups.push(group);
      });

      data.title = document.getElementById("titleInput").value.trim() || "Ken的首頁";
      data.groups = newGroups;

      // 關閉視窗
      document.getElementById("modal").style.display = "none";
      document.getElementById("overlay").style.display = "none";
      
      // 更新畫面
      renderMain();

      // ★ 關鍵：寫入 Firebase ★
      if (currentUser) {
          await saveDataToFirestore();
      } else {
          alert("您目前未登入，變更僅暫存於記憶體中，重新整理後會消失。請登入以儲存。");
      }
  };

  window.backupData = function() {
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "bookmarks_backup.json";
      a.click();
  };

  window.triggerRestore = function() {
      document.getElementById("restoreFile").click();
  };

  // 綁定 file input change 事件 (因為是 type=module, 不能直接用 onclick HTML attribute 綁定 onchange)
  document.getElementById("restoreFile").onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (ev) => {
          try {
              const obj = JSON.parse(ev.target.result);
              if (obj && Array.isArray(obj.groups)) {
                  data = obj;
                  renderMain();
                  alert("匯入成功！");
                  
                  // ★ 如果已登入，匯入後直接詢問是否同步上雲端
                  if (currentUser) {
                      if(confirm("檢測到您已登入，是否將匯入的資料同步儲存到雲端？")) {
                          await saveDataToFirestore();
                      }
                  }
              } else {
                  throw new Error("格式錯誤");
              }
          } catch(err) { 
              alert("還原失敗，格式錯誤"); 
          }
      };
      reader.readAsText(file);
      e.target.value = null; 
  };

  document.getElementById("closeBtn").onclick = () => {
    document.getElementById("modal").style.display = "none";
    document.getElementById("overlay").style.display = "none";
  };

  // --- 渲染主畫面邏輯 ---
  function renderMain() {
    document.getElementById("pageTitle").textContent = data.title || "Ken的首頁";
    const tabsContainer = document.getElementById("mainTabs");
    tabsContainer.innerHTML = "";
    const contentContainer = document.getElementById("groupsContainer");
    contentContainer.innerHTML = "";

    if (!data.groups || data.groups.length === 0) {
        tabsContainer.innerHTML = "<div style='padding:15px;color:#666;'>無資料</div>";
        return;
    }
    
    // 決定顯示哪個 Tab
    const groupNames = data.groups.map(g => g.group);
    if (!currentMainTab || !groupNames.includes(currentMainTab)) {
        currentMainTab = data.groups[0].group;
    }

    data.groups.forEach((g) => {
        const tab = document.createElement("div");
        tab.className = "tab";
        tab.textContent = g.group;
        if (g.group === currentMainTab) tab.classList.add("active");
        
        tab.onclick = () => {
            document.querySelectorAll("#mainTabs .tab").forEach(t => t.classList.remove("active"));
            tab.classList.add("active");
            currentMainTab = g.group;
            window.showGroup(g.group); 
        };
        tabsContainer.appendChild(tab);

        const groupWrapper = document.createElement("div");
        groupWrapper.className = "group-content-wrapper";
        groupWrapper.dataset.groupName = g.group; 

        if (!g.items || g.items.length === 0) {
            groupWrapper.innerHTML = "<div style='text-align:center;padding:60px;color:#888;'>此組別暫無書籤</div>";
        } else {
            const block = document.createElement("div");
            block.className = "group-block";
            block.innerHTML = `<div class="bookmark-grid"></div>`;
            const grid = block.querySelector(".bookmark-grid");

            g.items.forEach(item => {
                const a = document.createElement("a");
                a.className = "bookmark-item";
                a.href = item.url;
                a.target = "_blank"; // 預設開新分頁
                
                let icon = item.img || 'images/tool-box.png';
                a.innerHTML = `<img src="${icon}" onerror="this.src='images/tool-box.png'"><span>${item.text}</span>`;
                grid.appendChild(a);
            });
            groupWrapper.appendChild(block);
        }
        contentContainer.appendChild(groupWrapper);
    });

    window.showGroup(currentMainTab);
  }

  window.showGroup = function(groupName) {
      document.querySelectorAll("#groupsContainer .group-content-wrapper").forEach(wrapper => {
          if (wrapper.dataset.groupName === groupName) {
              wrapper.classList.add("active");
          } else {
              wrapper.classList.remove("active");
          }
      });
  };

  // 時間
  function updateTime() {
    const now = new Date();
    document.getElementById("time").textContent = 
        `${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;
  }
  setInterval(updateTime, 1000);
  updateTime();

</script>
</body>
</html>
