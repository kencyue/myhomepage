<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æœå‹™æŠ€è¡“ä¸­å¿ƒè¡Œäº‹æ›†</title>
  <link rel="manifest" href="manifest.json">
  <link href="style.css" rel="stylesheet">
  <link rel="icon" href="images/favicon.png?ver=3">
<script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.6/lunar.min.js"></script>
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient(
  "https://iygmwaxbfpyaqzttxfck.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5Z213YXhiZnB5YXF6dHR4ZmNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1NTEwNDAsImV4cCI6MjA3NDEyNzA0MH0.NJcG_rlwypKgadeBAfLvihzqLVDM92DmwZbl36EvJfE"
);

const today = new Date();
let deptEvents = {}, holidayList = [];
let currentDept = "ALL", currentDate = null;
let userSession = null;
let userDept = "NONE"; // ğŸ”¹ æ–°å¢ï¼šä½¿ç”¨è€…éƒ¨é–€æ¬Šé™
let isPrivateVisible = localStorage.getItem("showPrivate") === "true"; // ğŸ”¹ KEN å°ˆç”¨ç§äººäº‹ä»¶é–‹é—œ
let canEdit = false;   // ğŸ”¹ æ˜¯å¦èƒ½ç·¨è¼¯
let multiSelectMode = false;
let selectedDates = new Set();


// âœ… æª¢æŸ¥ç™½åå–®ä¸¦å–å‡º dept æ¬„ä½
async function checkWhitelist(email) {
  const { data } = await supabase
    .from("allowed_users")
    .select("email, dept")
    .eq("email", email)
    .maybeSingle();

  if (data) {
    userDept = data.dept || "NONE";
    return true;
  }

  // ğŸ”¹ è‹¥ä¸å­˜åœ¨ï¼Œå‰‡è‡ªå‹•æ–°å¢ç‚ºå”¯è®€å¸³è™Ÿ
  const { error } = await supabase
    .from("allowed_users")
    .insert([{ email, dept: "NONE" }]);

  if (error) {
    console.warn("æ–°å¢é è¨­ä½¿ç”¨è€…å¤±æ•—ï¼š", error.message);
  } else {
    console.log("å·²è‡ªå‹•æ–°å¢ä½¿ç”¨è€…ï¼š", email);
  }

  userDept = "NONE";
  return false;
}


function pad2(n){return String(n).padStart(2,"0");}
function ymdToCompact(d){return d.replaceAll("-","");}
function ymdRange(year,month){
  const start=`${year}-${pad2(month)}-01`;
  const endDate=new Date(year,month,1);
  const end=`${endDate.getFullYear()}-${pad2(endDate.getMonth()+1)}-01`;
  return{start,end};
}

async function fetchMonthData(year,month){
  const {start,end}=ymdRange(year,month);
  const hq=await supabase.from("holidays")
    .select("date,description,is_holiday")
    .gte("date",start).lt("date",end).order("date");
  holidayList=(hq.data||[]).map(r=>({
    date:ymdToCompact(r.date),
    description:r.description,
    isHoliday:r.is_holiday
  }));

  const eq=await supabase.from("events")
    .select("id,date,dept,description")
    .gte("date",start).lt("date",end).order("date");
  const events=(eq.data||[]).map(r=>({
    id:r.id,date:ymdToCompact(r.date),dept:r.dept,description:r.description
  }));

deptEvents = { ALL: [], SG2: [], SG3: [], SG4: [], SG5: [], KEN: [] };
  for(const ev of events) if(deptEvents[ev.dept]) deptEvents[ev.dept].push(ev);
}

function getHoliday(dateStr){return holidayList.find(h=>h.date===dateStr);}

// âœ… æ ¹æ“š userDept æ±ºå®šæ˜¯å¦å¯æ“ä½œè©²äº‹ä»¶
function canOperateDept(dept){
  if (["ALL", "KEN"].includes(userDept)) return true; // ğŸ”¹ ç®¡ç†å“¡èˆ‡ä¸»ç®¡å¯æ“ä½œå…¨éƒ¨
  if (userDept === "NONE") return false;
  return userDept === dept;
}


function openModal(dateStr,events){
  currentDate=dateStr;
  document.getElementById("modal-date").textContent=dateStr;
  const list=document.getElementById("modal-list");
  list.innerHTML="";
  const holiday = getHoliday(dateStr.replaceAll("-",""));
if (holiday) {
  const div = document.createElement("div");
  div.className = "event-item";

  const span = document.createElement("span");
  span.className = "lunar holiday";
  span.textContent = `[å‡æ—¥] ${holiday.description}`;

// âœ… ALL èˆ‡ KEN å¯ inline ä¿®æ”¹
if (["ALL", "KEN"].includes(userDept)) {
    span.style.cursor = "pointer";
    span.onclick = () => {
      const input = document.createElement("input");
      input.type = "text";
      input.value = holiday.description;
      input.style.width = "80%";
      span.replaceWith(input);
      input.focus();

      // å„²å­˜æ›´æ–°
      const save = async () => {
        const newDesc = input.value.trim();
        if (!newDesc || newDesc === holiday.description) {
          input.replaceWith(span);
          return;
        }
        const { error } = await supabase
          .from("holidays")
          .update({ description: newDesc })
          .eq("date", dateStr);
        if (error) {
          alert("ä¿®æ”¹å‡æ—¥å¤±æ•—ï¼š" + error.message);
        } else {
          holiday.description = newDesc;
          span.textContent = `[å‡æ—¥] ${newDesc}`;
        }
        input.replaceWith(span);
      };

      input.addEventListener("blur", save);
      input.addEventListener("keydown", e => {
        if (e.key === "Enter") save();
        if (e.key === "Escape") input.replaceWith(span);
      });
    };

    const btn = document.createElement("button");
    btn.textContent = "åˆªé™¤";
    btn.onclick = () => deleteHoliday(dateStr);
    div.appendChild(span);
    div.appendChild(btn);
  } else {
    div.appendChild(span);
  }

  list.appendChild(div);
}


  if(events.length===0){
    const div=document.createElement("div");
    div.className="event-item";
    div.innerHTML="<span>(ç„¡äº‹ä»¶)</span>";
    list.appendChild(div);
  } else {
    events.forEach(ev=>{
      const div=document.createElement("div");
      div.className="event-item";
const span = document.createElement("span");
span.className = `dept-${ev.dept}`;
span.textContent = `[${ev.dept}] ${ev.description}`;

// âœ… é»æ“Šé€²å…¥ç·¨è¼¯æ¨¡å¼
if (canOperateDept(ev.dept)) {
  span.style.cursor = "pointer";
  span.onclick = () => {
    const input = document.createElement("input");
    input.type = "text";
    input.value = ev.description;
    input.style.width = "80%";
    span.replaceWith(input);
    input.focus();

    // å¤±ç„¦æˆ–æŒ‰ Enter å³æ›´æ–°
    const save = async () => {
      const newDesc = input.value.trim();
      if (!newDesc || newDesc === ev.description) {
        input.replaceWith(span);
        return;
      }
      const { error } = await supabase
        .from("events")
        .update({ description: newDesc })
        .eq("id", ev.id);
      if (error) {
        alert("ä¿®æ”¹å¤±æ•—ï¼š" + error.message);
      } else {
        ev.description = newDesc;
        span.textContent = `[${ev.dept}] ${newDesc}`;
      }
      input.replaceWith(span);
    };

    input.addEventListener("blur", save);
    input.addEventListener("keydown", e => {
      if (e.key === "Enter") save();
      if (e.key === "Escape") input.replaceWith(span);
    });
  };
}

div.appendChild(span);

if (canOperateDept(ev.dept)) {
  const btn = document.createElement("button");
  btn.textContent = "åˆªé™¤";
  btn.onclick = () => deleteEvent(ev.id);
  div.appendChild(btn);
}
      list.appendChild(div);
    });
  }
// æ²’ç™»å…¥æˆ– NONE éƒ½ä¸é¡¯ç¤ºæ–°å¢å€å¡Š
const addSection = document.querySelector("#modal .add-section");
if (!userSession || userDept === "NONE") {
  addSection.style.display = "none";
} else {
  addSection.style.display = "block";
}

  document.getElementById("modal").style.display="flex";
}
function closeModal(e){if(!e||e.target.id==="modal")document.getElementById("modal").style.display="none";}
window.closeModal=closeModal;

function toggleSelect(ymd, el) {
  const shareBtn = document.getElementById("multiShareBtn");

  if (selectedDates.has(ymd)) {
    selectedDates.delete(ymd);
    el.classList.remove("selected-day");
  } else {
    selectedDates.add(ymd);
    el.classList.add("selected-day");
  }
  
   // âœ… æ§åˆ¶åˆ†äº« + å–æ¶ˆé¸å–å€å¡Šé¡¯ç¤º
  const controls = document.getElementById("multiSelectControls");
  controls.style.display = selectedDates.size > 0 ? "block" : "none";

  if (selectedDates.size > 0) {
    shareBtn.style.display = "inline-block";
    shareBtn.textContent = `åˆ†äº« (${selectedDates.size} æ—¥)`;
  } else {
    shareBtn.style.display = "none";
    shareBtn.textContent = "åˆ†äº«";
    multiSelectMode = false;
  }
}


async function updateCalendar() {
  document.getElementById("loading").style.display = "block";

  const year = parseInt(document.querySelector("#yearDropdown .dropdown-toggle").dataset.value);
  const month = parseInt(document.querySelector("#monthDropdown .dropdown-toggle").dataset.value);
  if (isNaN(year) || isNaN(month)) {
    document.getElementById("loading").style.display = "none";
    return;
  }

  document.getElementById("month-title").textContent = `${year}å¹´ ${month}æœˆ`;
  await fetchMonthData(year, month);

  const calendar = document.getElementById("calendar");
  calendar.innerHTML = "";

  // === ğŸ”¹ ä½¿ç”¨è€…å¯è‡ªè¨‚ã€Œä¸€é€±ç¬¬ä¸€å¤©ã€ ===
  // 0=æ˜ŸæœŸæ—¥, 1=æ˜ŸæœŸä¸€, ..., 6=æ˜ŸæœŸå…­
  let weekStart = parseInt(localStorage.getItem("weekStart") || "1"); // é è¨­æ˜ŸæœŸä¸€

  const weekdays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
  const orderedWeekdays = weekdays.slice(weekStart).concat(weekdays.slice(0, weekStart));

  orderedWeekdays.forEach((d, i) => {
    const el = document.createElement("div");
    el.className = "weekday-header";
    const realIndex = (i + weekStart) % 7;
    if (realIndex === 0 || realIndex === 6) el.classList.add("weekend"); // å…­æ—¥ç´…å­—
    el.textContent = d;

    // ğŸ”¹ é»æ“Šè¨­å®šç‚ºæ¯é€±ç¬¬ä¸€å¤©
    el.style.cursor = "pointer";
    el.title = "é»æˆ‘è¨­å®šç‚ºæ¯é€±ç¬¬ä¸€å¤©";
    el.onclick = () => {
      localStorage.setItem("weekStart", realIndex);
      updateCalendar(); // é‡æ–°è¼‰å…¥
    };

    calendar.appendChild(el);
  });

  // === ğŸ”¹ è¨ˆç®—ç•¶æœˆå¤©æ•¸èˆ‡é–‹å§‹ä½ç½® ===
  const firstDay = new Date(year, month - 1, 1);
  const lastDay = new Date(year, month, 0);
  const startWeek = (firstDay.getDay() - weekStart + 7) % 7;
  const daysInMonth = lastDay.getDate();

  // === ğŸ”¹ è£œå‰é¢ç©ºç™½æ ¼ ===
  for (let i = 0; i < startWeek; i++) {
    const empty = document.createElement("div");
    calendar.appendChild(empty);
  }

  // === ğŸ”¹ å¯¦éš›ç”Ÿæˆæ—¥æœŸæ ¼ ===
  for (let d = 1; d <= daysInMonth; d++) {
    const dateObj = new Date(year, month - 1, d);
    const ymd = `${year}${pad2(month)}${pad2(d)}`;
    const holiday = getHoliday(ymd);

    let events = [];
    if (currentDept === "ALL") {
      events = [
        ...deptEvents.ALL,
        ...deptEvents.SG2,
        ...deptEvents.SG3,
        ...deptEvents.SG4,
        ...deptEvents.SG5,
        ...(userDept === "KEN" && isPrivateVisible ? deptEvents.KEN || [] : [])
      ].filter(ev => ev.date === ymd);
    } else if (currentDept === "PRIVATE" && userDept === "KEN") {
      events = (deptEvents.KEN || []).filter(ev => ev.date === ymd);
    } else {
      events = (deptEvents[currentDept] || []).filter(ev => ev.date === ymd);
    }

    const lunar = Lunar.fromDate(dateObj);
    const el = document.createElement("div");
    el.className = "day";
    el.dataset.date = ymd;

    if (today.getFullYear() === year && today.getMonth() + 1 === month && today.getDate() === d)
      el.classList.add("today");
    if (holiday?.isHoliday) el.classList.add("holiday");
    const dayOfWeek = dateObj.getDay();
    const adjWeekIndex = (dayOfWeek - weekStart + 7) % 7;
    if (adjWeekIndex === 5 || adjWeekIndex === 6) el.classList.add("weekend");

    el.innerHTML = `<strong>${d}</strong>`;
    el.innerHTML += `<div class="lunar ${holiday?.isHoliday ? "holiday" : ""}">${holiday?.description || lunar.getDayInChinese()}</div>`;

if (events.length > 0) {
  const dots = document.createElement("div");
  dots.className = "event-dots";
  const shownDepts = new Set();
  events.forEach(ev => {
    if (!shownDepts.has(ev.dept)) {
      shownDepts.add(ev.dept);
      const dot = document.createElement("div");
      dot.className = "dot " + ev.dept;
      dots.appendChild(dot);
    }
  });
  el.appendChild(dots);
}

// === é»æ“Šèˆ‡é•·æŒ‰äº‹ä»¶ ===
let pressTimer;

el.addEventListener("touchstart", () => {
  pressTimer = setTimeout(() => {
    multiSelectMode = true;
    toggleSelect(ymd, el);
  }, 450); // é•·æŒ‰è§¸ç™¼å¤šé¸
});

el.addEventListener("touchend", () => {
  clearTimeout(pressTimer);
});


el.addEventListener("click", () => {
  if (multiSelectMode) {
    toggleSelect(ymd, el);
  } else {
    openModal(`${year}-${pad2(month)}-${pad2(d)}`, events);
  }
});


    // ğŸ”¹ æ»‘é¼ ç§»ä¸Šæç¤ºï¼ˆæ¡Œæ©Ÿï¼‰
    if (!/Mobi|Android/i.test(navigator.userAgent)) {
      el.onmouseenter = (e) => {
        const tips = [];
        if (holiday?.description) tips.push(`ã€å‡æ—¥ã€‘${holiday.description}`);
        events.forEach(ev => {
          tips.push(`[${ev.dept}] ${ev.description}`);
        });
        if (tips.length === 0) return;
        let tooltip = document.createElement("div");
        tooltip.className = "hover-tooltip";
        tooltip.innerHTML = tips.join("<br>");
        document.body.appendChild(tooltip);
        const rect = e.target.getBoundingClientRect();
        tooltip.style.left = rect.left + window.scrollX + rect.width / 2 + "px";
        tooltip.style.top = rect.top + window.scrollY - 10 + "px";
        tooltip.style.transform = "translateX(-50%)";
        tooltip.style.opacity = "1";
        el._tooltip = tooltip;
      };
      el.onmouseleave = () => {
        if (el._tooltip) {
          el._tooltip.remove();
          el._tooltip = null;
        }
      };
    }

    calendar.appendChild(el);
  }

  document.getElementById("loading").style.display = "none";
}


async function addEvent() {
  const desc = document.getElementById("new-desc").value.trim();
  const dept = document.getElementById("new-dept").value;

  if (!desc) {
    alert("è«‹è¼¸å…¥æè¿°");
    return;
  }
  if (userDept === "NONE") {
    alert("ä½ æ²’æœ‰æ–°å¢æ¬Šé™");
    return;
  }
  if (!dept) {
    alert("è«‹é¸æ“‡éƒ¨é–€");
    return;
  }

// âœ… ç‰¹æ®Šï¼šALL æˆ– KEN å¸³è™Ÿ + ALL éƒ¨é–€ + hé–‹é ­hçµå°¾ â†’ æ–°å¢å‡æ—¥
if (["ALL", "KEN"].includes(userDept) && dept === "ALL" && /^h.*h$/i.test(desc)) {

    const holidayName = desc.slice(1, -1).trim(); // å»æ‰å‰å¾Œ h
    if (!holidayName) {
      alert("è«‹è¼¸å…¥å‡æ—¥åç¨±ï¼Œä¾‹å¦‚ï¼šhåœ‹æ…¶æ—¥h");
      return;
    }
    const { error } = await supabase.from("holidays").insert([
      { date: currentDate, description: holidayName, is_holiday: true }
    ]);
    if (error) {
      alert("æ–°å¢å‡æ—¥å¤±æ•—ï¼š" + error.message);
    } else {
      alert(`å·²æ–°å¢å‡æ—¥ï¼š${holidayName}`);
      document.getElementById("new-desc").value = "";
      await updateCalendar();
    }
    return;
  }

// âœ… ä¸€èˆ¬äº‹ä»¶æ–°å¢é‚è¼¯
if (
  userDept !== "ALL" &&   // éç®¡ç†å“¡
  userDept !== "KEN" &&   // éä¸»ç®¡
  userDept !== dept       // ä¸”ä¸æ˜¯è‡ªå·±çš„éƒ¨é–€
) {
  alert("ä½ åªèƒ½æ“ä½œè‡ªå·±éƒ¨é–€äº‹ä»¶");
  return;
}


  const { error } = await supabase.from("events").insert([
    { date: currentDate, dept, description: desc }
  ]);
  if (error) {
    alert("æ–°å¢å¤±æ•—ï¼š" + error.message);
    return;
  }
  document.getElementById("new-desc").value = "";
  await updateCalendar();
}


window.deleteEvent=async function(id){
  if(userDept==="NONE"){alert("ä½ æ²’æœ‰åˆªé™¤æ¬Šé™");return;}
  const { data }=await supabase.from("events").select("dept").eq("id",id).maybeSingle();
  if(!data){alert("äº‹ä»¶ä¸å­˜åœ¨");return;}
  if(!["ALL","KEN"].includes(userDept) && userDept!==data.dept){
  alert("ä½ ç„¡æ³•åˆªé™¤æ­¤éƒ¨é–€äº‹ä»¶");
  return;
}
  const { error }=await supabase.from("events").delete().eq("id",id);
  if(error){alert("åˆªé™¤å¤±æ•—:"+error.message);return;}
  await updateCalendar();
}

window.deleteHoliday = async function(dateStr) {
if (!["ALL","KEN"].includes(userDept)) {
  alert("åªæœ‰å…¨æ¬Šé™å¯åˆªé™¤å‡æ—¥");
  return;
}
  if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${dateStr} çš„å‡æ—¥å—ï¼Ÿ`)) return;
  const { error } = await supabase.from("holidays").delete().eq("date", dateStr);
  if (error) {
    alert("åˆªé™¤å¤±æ•—ï¼š" + error.message);
  } else {
    alert("å·²åˆªé™¤å‡æ—¥");
    await updateCalendar();
  }
};


async function login(){
  await supabase.auth.signInWithOAuth({
    provider:"google",
    options:{redirectTo:"https://kencyue.neocities.org/calendar/index.html"}
  });
}
async function logout() {
  try {
    await supabase.auth.signOut({ scope: 'local' });
  } catch (e) {
    console.warn("signOut error:", e);
  }

  // ğŸ”¹ åƒ…æ¸…é™¤ç™»å…¥ç›¸é—œè³‡æ–™ï¼Œä¸å‹•ç§äººè¨­å®š
  localStorage.removeItem("supabase.auth.token");
  localStorage.removeItem("supabase.auth.refresh_token");
  sessionStorage.clear(); // ä¿éšªç”¨ï¼Œä½†ä¸æœƒå½±éŸ¿ showPrivate

  // ğŸ”¹ é‡è¨­å…¨åŸŸè®Šæ•¸ï¼ˆç¢ºä¿ç•«é¢ä¹¾æ·¨ï¼‰
  userSession = null;
  userDept = "NONE";
  canEdit = false;

  // ğŸ”¹ UI æ¸…ç©ºï¼Œéš±è—ç§äººå€åŸŸ
  const privateToggle = document.getElementById("privateToggle");
  if (privateToggle) privateToggle.style.display = "none";
  const calendar = document.getElementById("calendar");
  if (calendar) calendar.innerHTML = "";

  // ğŸ”¹ é‡è¼‰ç•«é¢ï¼ˆä¸ä½¿ç”¨å¿«å–ï¼‰
  window.location.href = window.location.origin + window.location.pathname;
}



// âœ… çµ±ä¸€ Session è™•ç†
async function handleSession(session) {
  userSession = session;
  canEdit = false;
  userDept = "NONE";
  if (session?.user?.email) {
    canEdit = await checkWhitelist(session.user.email);
  }
  const label = (userDept==="ALL")
    ? "ï¼ˆç®¡ç†å“¡ï¼‰"
    : (userDept==="NONE" ? "ï¼ˆå”¯è®€ï¼‰" : `ï¼ˆ${userDept}ï¼‰`);
  document.getElementById("loginBtn").style.display=session?"none":"inline-block";
  document.getElementById("logoutBtn").style.display=session?"inline-block":"none";
  document.getElementById("user-info").textContent=session
    ? `${session.user.email}${label}`
    : "";
    updateAddDeptOptions();
}

function updateAddDeptOptions() {
  const sel = document.getElementById("new-dept");
  if (!sel) return;
  sel.innerHTML = ""; // æ¸…ç©ºèˆŠé¸é …

  let opts = [];
if (userDept === "ALL") {
  opts = ["ALL", "SG2", "SG3", "SG4", "SG5"];
  sel.style.display = "inline-block";
  sel.disabled = false;
}
else if (userDept === "KEN") {
  // ğŸ”¹ KENï¼šå¯æ“ä½œæ‰€æœ‰éƒ¨é–€ + è‡ªå·±
  opts = ["ALL", "SG2", "SG3", "SG4", "SG5", "KEN"];
  sel.style.display = "inline-block";
  sel.disabled = false;
}

  else if (["SG2", "SG3", "SG4", "SG5"].includes(userDept)) {
    // ğŸ”¹ ä¸€èˆ¬éƒ¨é–€ï¼šå›ºå®šè‡ªå·±éƒ¨é–€ã€ä¸é¡¯ç¤ºé¸å–®
    opts = [userDept];
    sel.style.display = "none";    // â¬…ï¸ éš±è—é¸å–®
    sel.disabled = true;           // â¬…ï¸ é˜²æ­¢æ“ä½œ
  } 
  else {
    // ğŸ”¹ ç„¡æ¬Šé™ï¼šæ•´å€‹æ–°å¢å€å¡Šä¸é¡¯ç¤º
    const addSection = document.querySelector("#modal .add-section");
    if (addSection) addSection.style.display = "none";
    return;
  }

  opts.forEach(d => {
    const o = document.createElement("option");
    o.value = d;
    o.textContent = d;
    sel.appendChild(o);
  });
}



async function restoreSession() {
  const { data: { session } } = await supabase.auth.getSession();
  await handleSession(session);
}

supabase.auth.onAuthStateChange((_event, session) => {
  handleSession(session);
});

async function init() {
  await restoreSession();
  // ğŸ”¹ è‹¥ç™»å…¥è€…æ˜¯ KENï¼Œé¡¯ç¤ºéƒ¨é–€ä¸‹æ‹‰é¸å–®çš„ã€Œç§äººã€é …ç›®
const deptMenu = document.querySelector("#deptDropdown .dropdown-menu");
const oldPrivate = deptMenu.querySelector('[data-value="PRIVATE"]');
if (oldPrivate) oldPrivate.remove();

if (userDept === "KEN") {
  const div = document.createElement("div");
  div.className = "dept-KEN";
  div.dataset.value = "PRIVATE";
  div.textContent = "KEN ç§äººæ—¥ç¨‹";
  deptMenu.appendChild(div);

  div.onclick = () => {
    currentDept = "PRIVATE";
    localStorage.setItem("selectedDept", currentDept);
    const toggle = document.querySelector("#deptDropdown .dropdown-toggle");
    toggle.textContent = div.textContent;
    toggle.className = "dropdown-toggle dept-KEN";
    deptMenu.style.display = "none";
    updateCalendar();
  };
}

const privateToggle = document.getElementById("privateToggle");
const privateCheckbox = document.getElementById("privateCheckbox");

// ğŸ”¹ KEN å°ˆç”¨ï¼šé¡¯ç¤ºç§äººåˆ‡æ›é–‹é—œ
if (userDept === "KEN") {
  privateToggle.style.display = "inline-flex";
  privateCheckbox.checked = isPrivateVisible;
  privateCheckbox.onchange = () => {
    isPrivateVisible = privateCheckbox.checked;
    localStorage.setItem("showPrivate", isPrivateVisible);
    updateCalendar();
  };
} else {
  privateToggle.style.display = "none";
  privateCheckbox.checked = false;
}


  document.getElementById("todayBtn").onclick = () => {
    const yearToggle = document.querySelector("#yearDropdown .dropdown-toggle");
    const monthToggle = document.querySelector("#monthDropdown .dropdown-toggle");
    const y = today.getFullYear();
    const m = today.getMonth() + 1;
    yearToggle.textContent = y + " å¹´"; 
    yearToggle.dataset.value = y;
    monthToggle.textContent = m + " æœˆ"; 
    monthToggle.dataset.value = m;
    updateCalendar();
  };

  const savedDept = localStorage.getItem("selectedDept");
  if(savedDept){
    currentDept = savedDept;
    const dd = document.getElementById("deptDropdown");
    const toggle = dd.querySelector(".dropdown-toggle");
    const menuItem = dd.querySelector(`.dropdown-menu div[data-value="${savedDept}"]`);
    if(menuItem){
      toggle.textContent = menuItem.textContent;
      toggle.className = "dropdown-toggle " + menuItem.className;
    }
  }

  const yearDd = document.getElementById("yearDropdown");
  const yearToggle = yearDd.querySelector(".dropdown-toggle");
  const yearMenu = yearDd.querySelector(".dropdown-menu");
  const monthDd = document.getElementById("monthDropdown");
  const monthToggle = monthDd.querySelector(".dropdown-toggle");
  const monthMenu = monthDd.querySelector(".dropdown-menu");
  const currentYear = today.getFullYear();
  const currentMonth = today.getMonth() + 1;

  for (let y = currentYear - 5; y <= currentYear + 5; y++) {
    const div = document.createElement("div");
    div.textContent = y + " å¹´";
    div.dataset.value = y;
    div.onclick = () => {
      yearToggle.textContent = div.textContent;
      yearToggle.dataset.value = y;
      updateCalendar();
      yearMenu.style.display = "none";
    };
    yearMenu.appendChild(div);
  }
  yearToggle.textContent = currentYear + " å¹´";
  yearToggle.dataset.value = currentYear;

  monthMenu.querySelectorAll("div").forEach(div => {
    div.onclick = () => {
      monthToggle.textContent = div.textContent;
      monthToggle.dataset.value = div.dataset.value;
      updateCalendar();
      monthMenu.style.display = "none";
    };
  });
  monthToggle.textContent = currentMonth + " æœˆ";
  monthToggle.dataset.value = currentMonth;

  [yearDd, monthDd].forEach(dd => {
    const toggle = dd.querySelector(".dropdown-toggle");
    const menu = dd.querySelector(".dropdown-menu");
    toggle.onclick = () => {
      menu.style.display = menu.style.display === "block" ? "none" : "block";
    };
    document.addEventListener("click", e => {
      if (!dd.contains(e.target)) menu.style.display = "none";
    });
  });

  async function switchMonth(direction) {
    const cal = document.getElementById("calendar");
    cal.style.opacity = 0;
    let y = parseInt(yearToggle.dataset.value);
    let m = parseInt(monthToggle.dataset.value);
    if (direction === "next") {
      if (m < 12) m++; else { m = 1; y++; }
    } else {
      if (m > 1) m--; else { m = 12; y--; }
    }
    yearToggle.textContent = y + " å¹´"; yearToggle.dataset.value = y;
    monthToggle.textContent = m + " æœˆ"; monthToggle.dataset.value = m;
    await updateCalendar();
    cal.style.opacity = 1;
    cal.classList.add(direction === "next" ? "fade-in-left" : "fade-in-right");
    setTimeout(() => cal.classList.remove("fade-in-left", "fade-in-right"), 300);
  }

  document.getElementById("prevMonth").onclick = () => switchMonth("prev");
  document.getElementById("nextMonth").onclick = () => switchMonth("next");
  await updateCalendar();
  
}

init();
window.addEvent=addEvent; 
window.login=login; 
window.logout=logout;

const dd = document.getElementById("deptDropdown");
const toggle = dd.querySelector(".dropdown-toggle");
const menu = dd.querySelector(".dropdown-menu");

toggle.onclick = () => {
  menu.style.display = menu.style.display === "block" ? "none" : "block";
};
menu.querySelectorAll("div").forEach(it => {
  it.onclick = () => {
    currentDept = it.dataset.value;
    localStorage.setItem("selectedDept", currentDept);
    toggle.textContent = it.textContent;
    toggle.className = "dropdown-toggle " + it.className;
    menu.style.display = "none";
    updateCalendar();
  };
});
document.addEventListener("click", e => {
  if (!dd.contains(e.target)) menu.style.display = "none";
});

document.getElementById("shareBtn").onclick = async () => {
  if (!currentDate) return;
  const list = Array.from(document.querySelectorAll("#modal-list span"))
    .map(el => el.textContent)
    .join("\n");
  const text = `${currentDate}\n${list || "(ç„¡äº‹ä»¶)"}`;
  if (navigator.share) {
    try { await navigator.share({ title: "è¡Œäº‹æ›†äº‹ä»¶", text }); }
    catch (err) { console.log("åˆ†äº«å–æ¶ˆæˆ–å¤±æ•—:", err); }
  } else {
    navigator.clipboard.writeText(text);
    alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿:\n" + text);
  }
};

// === æ‰‹æ©Ÿæ»‘å‹•åˆ‡æ›æœˆä»½ ===
let touchStartX = 0, touchEndX = 0;
function handleSwipe() {
  const diff = touchEndX - touchStartX;
  if (Math.abs(diff) > 50) {
    const cal = document.getElementById("calendar");
    if (diff > 0) {
      cal.classList.add("slide-right");
      setTimeout(() => {
        document.getElementById("prevMonth").click();
        cal.classList.remove("slide-right");
      }, 300);
    } else {
      cal.classList.add("slide-left");
      setTimeout(() => {
        document.getElementById("nextMonth").click();
        cal.classList.remove("slide-left");
      }, 300);
    }
  }
}
const cal = document.getElementById("calendar");
cal.addEventListener("touchstart", e => { touchStartX = e.changedTouches[0].screenX; });
cal.addEventListener("touchend", e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); });

document.getElementById("multiShareBtn").onclick = async () => {
  if (selectedDates.size === 0) return;

  const dates = Array.from(selectedDates).sort();
  let text = "";

  for (const d of dates) {
    const y = parseInt(d.slice(0,4));
    const m = parseInt(d.slice(4,6));
    const dd = d.slice(6,8);

    // âœ… æ¯å¤©è¼¸å‡ºå‰ï¼Œå…ˆæŠ“è©²æ—¥æœŸæ‰€å±¬æœˆä»½
    await fetchMonthData(y, m);

    const holiday = holidayList.find(h => h.date === d);

    let events = [];
    if (currentDept === "ALL") {
      events = [
        ...deptEvents.ALL,
        ...deptEvents.SG2,
        ...deptEvents.SG3,
        ...deptEvents.SG4,
        ...deptEvents.SG5,
        ...(userDept === "KEN" && isPrivateVisible ? deptEvents.KEN : [])
      ].filter(ev => ev.date === d);
    }
    else if (currentDept === "PRIVATE" && userDept === "KEN") {
      events = (deptEvents.KEN || []).filter(ev => ev.date === d);
    }
    else {
      events = (deptEvents[currentDept] || []).filter(ev => ev.date === d);
    }

    text += `${y}-${m}-${dd}\n`;

    if (holiday) text += `ã€å‡æ—¥ã€‘${holiday.description}\n`;
    if (events.length > 0) events.forEach(ev => text += `[${ev.dept}] ${ev.description}\n`);
    if (!holiday && events.length === 0) text += `(ç„¡äº‹ä»¶)\n`;

    text += "\n";
  }

  if (navigator.share) {
    try { await navigator.share({ title: "è¡Œäº‹æ›†", text }); } catch {}
  } else {
    await navigator.clipboard.writeText(text);
    alert("å·²è¤‡è£½ï¼š\n" + text);
  }
};

document.getElementById("clearSelectBtn").onclick = () => {
  selectedDates.forEach(d => {
    const cell = document.querySelector(`[data-date="${d}"]`);
    if (cell) cell.classList.remove("selected-day");
  });
  selectedDates.clear();
  multiSelectMode = false;
  document.getElementById("multiSelectControls").style.display = "none";
};

//è¼¸å‡ºics
document.getElementById("exportRangeBtn").onclick = () => {
  document.getElementById("exportRangeModal").style.display = "flex";
};

document.getElementById("confirmExportRange").onclick = async () => {
  const start = document.getElementById("exportStart").value;
  const end = document.getElementById("exportEnd").value;

  if (!start || !end) {
    alert("è«‹é¸æ“‡é–‹å§‹èˆ‡çµæŸæ—¥æœŸ");
    return;
  }

  let s = new Date(start);
  let e = new Date(end);
  if (s > e) [s, e] = [e, s]; // äº¤æ›ï¼ˆé¿å…ä½¿ç”¨è€…é¸åï¼‰

  let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//kencyue calendar//TW\n";

  while (s <= e) {
    const y = s.getFullYear();
    const m = (s.getMonth() + 1).toString().padStart(2, "0");
    const d = s.getDate().toString().padStart(2, "0");
    const ymd = `${y}${m}${d}`;

    await fetchMonthData(y, s.getMonth() + 1); // âœ… æŠ“å°æœˆä»½

    const holiday = holidayList.find(h => h.date === ymd);

    let events = [];
    if (currentDept === "ALL") {
      events = [
        ...deptEvents.ALL,
        ...deptEvents.SG2,
        ...deptEvents.SG3,
        ...deptEvents.SG4,
        ...deptEvents.SG5,
        ...(userDept === "KEN" && isPrivateVisible ? deptEvents.KEN : [])
      ].filter(ev => ev.date === ymd);
    } 
    else if (currentDept === "PRIVATE" && userDept === "KEN") {
      events = (deptEvents.KEN || []).filter(ev => ev.date === ymd);
    } 
    else {
      events = (deptEvents[currentDept] || []).filter(ev => ev.date === ymd);
    }

    if (holiday) {
      ics += `BEGIN:VEVENT\nDTSTART;VALUE=DATE:${ymd}\nDTEND;VALUE=DATE:${ymd}\nSUMMARY:ã€å‡æ—¥ã€‘${holiday.description}\nEND:VEVENT\n`;
    }

    events.forEach(ev => {
      ics += `BEGIN:VEVENT\nDTSTART;VALUE=DATE:${ymd}\nDTEND;VALUE=DATE:${ymd}\nSUMMARY:[${ev.dept}] ${ev.description}\nEND:VEVENT\n`;
    });

    s.setDate(s.getDate() + 1);
  }

  ics += "END:VCALENDAR";

  const blob = new Blob([ics], { type: "text/calendar" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "calendar_export.ics";
  a.click();

  document.getElementById("exportRangeModal").style.display = "none";
};



</script>


</head>
<body>
  <h2>æœå‹™æŠ€è¡“ä¸­å¿ƒè¡Œäº‹æ›†</h2>

  <!-- ç¬¬ä¸€åˆ—ï¼šéƒ¨é–€ + ç™»å…¥æ§åˆ¶ -->
  <div class="controls">
  <label id="privateToggle" style="display:none; align-items:center; gap:4px; font-size:0.9rem;">
  <input type="checkbox" id="privateCheckbox" />
</label>

    <button id="todayBtn">ä»Šæ—¥</button>

<div class="dropdown" id="deptDropdown">
    <div class="dropdown-toggle dept-ALL">æ‰€æœ‰éƒ¨é–€</div>
    <div class="dropdown-menu">
      <div class="dept-ALL" data-value="ALL">æ‰€æœ‰éƒ¨é–€</div>
      <div class="dept-SG2" data-value="SG2">SG2 ç©ºèª¿ç©ºè³ª</div>
      <div class="dept-SG3" data-value="SG3">SG3 é›»åŒ–å•†å“</div>
      <div class="dept-SG4" data-value="SG4">SG4 è¦–è½å•†å“</div>
      <div class="dept-SG5" data-value="SG5">SG5 æ•™è‚²è¨“ç·´</div>
    </div>
  </div>
    <button id="loginBtn" onclick="login()">ç™»å…¥</button>
    <button id="logoutBtn" onclick="logout()" style="display:none;">ç™»å‡º</button>
    <button id="exportRangeBtn">åŒ¯å‡º.ics</button>
    <div id="user-info"></div>
  </div>

<!-- ç¬¬äºŒåˆ—ï¼šå¹´ä»½æœˆä»½é¸æ“‡ -->
<div class="controls">
  <button id="prevMonth">ã€ˆ</button>

  <div class="dropdown" id="yearDropdown">
    <div class="dropdown-toggle">å¹´ä»½</div>
    <div class="dropdown-menu"></div>
  </div>

  <div class="dropdown" id="monthDropdown">
    <div class="dropdown-toggle">æœˆä»½</div>
    <div class="dropdown-menu">
      <div data-value="1">1 æœˆ</div>
      <div data-value="2">2 æœˆ</div>
      <div data-value="3">3 æœˆ</div>
      <div data-value="4">4 æœˆ</div>
      <div data-value="5">5 æœˆ</div>
      <div data-value="6">6 æœˆ</div>
      <div data-value="7">7 æœˆ</div>
      <div data-value="8">8 æœˆ</div>
      <div data-value="9">9 æœˆ</div>
      <div data-value="10">10 æœˆ</div>
      <div data-value="11">11 æœˆ</div>
      <div data-value="12">12 æœˆ</div>
    </div>
  </div>

  <button id="nextMonth">ã€‰</button>
</div>

  <div id="month-title"></div>
  <div id="loading">è¼‰å…¥ä¸­...</div>
  <div id="calendar"></div>

  <!-- å½ˆçª— -->
  <div id="modal" onclick="closeModal(event)">
    <div class="content">
      <div style="display:flex; align-items:center; gap:8px;">
  <h3 id="modal-date" style="margin:0;"></h3>
<button id="shareBtn" class="icon-btn" aria-label="Share">
  <svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" fill="#000000">
    <path fill="#555" d="M15.8153846,0 C17.5757653,0 19,1.449773 19,3.2346723 C19,5.01957161 17.5757653,6.46934461 15.8153846,6.46934461 C14.8689948,6.46934461 14.0197576,6.05033214 13.4367386,5.38549912 L7.15261285,8.82514052 C7.29248826,9.18940809 7.36923077,9.58567518 7.36923077,10 C7.36923077,10.5415447 7.23812473,11.0522398 7.00630231,11.5009538 L13.0141056,15.2255191 C13.5528137,14.2165053 14.6045882,13.5306554 15.8153846,13.5306554 C17.5757653,13.5306554 19,14.9804284 19,16.7653277 C19,18.550227 17.5757653,20 15.8153846,20 C14.0550039,20 12.6307692,18.550227 12.6307692,16.7653277 L12.634,16.627 L6.10445872,12.5810774 C5.57086177,12.9912437 4.9059594,13.2346723 4.18461538,13.2346723 C2.42423469,13.2346723 1,11.7848993 1,10 C1,8.21510069 2.42423469,6.7653277 4.18461538,6.7653277 C5.03696272,6.7653277 5.81050611,7.10520333 6.38173776,7.65843224 L12.7644192,4.16474612 C12.677473,3.8701237 12.6307692,3.55789277 12.6307692,3.2346723 C12.6307692,1.449773 14.0550039,0 15.8153846,0 Z M15.8153846,14.9260042 C14.8228382,14.9260042 14.0153846,15.7479365 14.0153846,16.7653277 C14.0153846,17.7827189 14.8228382,18.6046512 15.8153846,18.6046512 C16.807931,18.6046512 17.6153846,17.7827189 17.6153846,16.7653277 C17.6153846,15.7479365 16.807931,14.9260042 15.8153846,14.9260042 Z M4.18461538,8.16067653 C3.19206902,8.16067653 2.38461538,8.98260882 2.38461538,10 C2.38461538,11.0173912 3.19206902,11.8393235 4.18461538,11.8393235 C5.17716175,11.8393235 5.98461538,11.0173912 5.98461538,10 C5.98461538,8.98260882 5.17716175,8.16067653 4.18461538,8.16067653 Z M15.8153846,1.39534884 C14.8228382,1.39534884 14.0153846,2.21728112 14.0153846,3.2346723 C14.0153846,4.25206348 14.8228382,5.07399577 15.8153846,5.07399577 C16.807931,5.07399577 17.6153846,4.25206348 17.6153846,3.2346723 C17.6153846,2.21728112 16.807931,1.39534884 15.8153846,1.39534884 Z"></path>
  </svg>
</button>


</div>
      <div id="modal-list"></div>
      <div class="add-section">
        <select id="new-dept">
          <option value="ALL">ALL</option>
          <option value="SG2">SG2</option>
          <option value="SG3">SG3</option>
          <option value="SG4">SG4</option>
          <option value="SG5">SG5</option>
        </select>
        <textarea id="new-desc" placeholder="äº‹ä»¶æè¿°" rows="3"></textarea>
        <div class="btn-row">
          <button class="btn-primary" onclick="addEvent()">æ–°å¢äº‹ä»¶</button>
          <button class="btn-secondary" onclick="closeModal()">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>
  
<div id="exportRangeModal" style="display:none;position:fixed;inset:0;background:#0008;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:20px;border-radius:8px;width:260px;text-align:center;">
    <div>é–‹å§‹æ—¥æœŸï¼š</div>
    <input type="date" id="exportStart" style="width:100%;margin-bottom:10px;">
    <div>çµæŸæ—¥æœŸï¼š</div>
    <input type="date" id="exportEnd" style="width:100%;margin-bottom:15px;">
    <button id="confirmExportRange">åŒ¯å‡º</button>
    <button onclick="document.getElementById('exportRangeModal').style.display='none'">å–æ¶ˆ</button>
  </div>
</div>
  
  <div id="multiSelectControls" style="text-align:center;margin-top:12px;display:none;">
  <button id="multiShareBtn">åˆ†äº«</button>
  <button id="clearSelectBtn">å–æ¶ˆé¸å–</button>
</div>
</body>
</html>

