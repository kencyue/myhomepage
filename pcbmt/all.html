<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CSV ææ–™ä»£è™Ÿåˆ†é¡å·¥å…· (å¤šæª”åˆä½µâ€§ä¸ç¯©ä¿å…§å¤–)</title>
<!-- è§£æ CSV / ç”¢ç”Ÿ XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root { --border: 1px solid #ccc; }
  body { font-family: Arial,Helvetica,sans-serif; padding:20px; line-height:1.6; min-height:100vh; display:flex; flex-direction:column; }
  body.dragover { background:#e0f7fa; }
  #hint  { text-align:center; margin-bottom:12px; color:#666; }
  #stats { background:#ffeb3b; padding:8px 12px; font-weight:bold; margin-bottom:12px; display:none; }
  #stats .red{color:red}
  .tabs { display:flex; gap:6px; margin-bottom:8px; }
  .tab-btn{ padding:6px 10px; border:var(--border); border-bottom:none; background:#f0f0f0; cursor:pointer; }
  .tab-btn.active{ background:#fff; font-weight:bold; }
  .tab-content{ border:var(--border); max-height:60vh; overflow:auto; display:none; }
  .tab-content.active{ display:block; }
  table{ border-collapse:collapse; width:100%; font-size:.85rem }
  th,td{ border:1px solid #ddd; padding:4px 8px; text-align:left; white-space:nowrap }
  thead{ position:sticky; top:0; background:#fff; cursor:pointer }
  #searchBar{ margin-bottom:10px; display:none; }
  #searchBar input{ padding:6px 10px; width:100%; max-width:420px; }
</style>
</head>
<body>
<!-- å·¥å…·åˆ‡æ› -->
<div style="display:flex; align-items:center; gap:10px; margin-bottom:20px;">
  <select id="toolSelect" style="font-size:1.3em; padding:4px 10px; border:1px solid #999; border-radius:6px; background:#fff; font-weight:bold;">
    <option value="all" selected>ä¸åˆ†ä¿å…§å¤–ï¼ˆå¯åˆä½µå¤šå€‹æª”æ¡ˆï¼‰</option>
    <option value="index">ä¿å…§ï¼ˆå¯åˆä½µå¤šå€‹æª”æ¡ˆï¼‰</option>
  </select>
</div>
<script>
  document.getElementById('toolSelect').addEventListener('change',e=>{
    if(e.target.value==='index') location.href='index.html';
  });
</script>

<p id="hint">æ‹–æ”¾ä¸€å€‹æˆ–å¤šå€‹ CSV è‡³é é¢ï¼Œæˆ–ä½¿ç”¨ <kbd>Ctrl+O</kbd> é¸æª”</p>
<input type="file" id="fileInput" accept=".csv" multiple style="display:none" />
<div id="stats"></div>
<div id="preview"></div>

<script>
(()=>{
  /* ---------- DOM ---------- */
  const fileInput   = document.getElementById('fileInput');
  const statsDiv    = document.getElementById('stats');
  const previewDiv  = document.getElementById('preview');
  const hint        = document.getElementById('hint');

  /* æœå°‹åˆ— */
  const searchBar   = document.createElement('div');
  searchBar.id      = 'searchBar';
  searchBar.innerHTML = `<input type="text" id="searchInput" placeholder="é—œéµå­—æˆ– æ¬„ä½:å€¼, æ¬„ä½2:å€¼2" />`;
  const searchInput = searchBar.querySelector('input');

  /* ---------- å…¨åŸŸç‹€æ…‹ ---------- */
  let headers = [];
  let groups  = {};            // { ç¸½è¡¨, PCB, é¦¬é”, æ··ä»¶ }
  let tables  = {};            // name -> <table>
  let currentTable=null;

  /* ---------- åŸºæœ¬æ‹–æ‹‰ / é–‹æª” ---------- */
  ['dragover','drop'].forEach(evt=>document.addEventListener(evt,e=>e.preventDefault()));
  document.addEventListener('dragenter',()=>document.body.classList.add('dragover'));
  document.addEventListener('dragleave',e=>{ if(e.target===document) document.body.classList.remove('dragover'); });
  document.addEventListener('drop',e=>{ document.body.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
  document.addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='o'){e.preventDefault();fileInput.click();} });
  fileInput.addEventListener('change',e=>handleFiles(e.target.files));

  /* ---------- è®€æª” & åˆä½µ ---------- */
  function handleFiles(fileList){
    if(!fileList.length) return;
    const files = Array.from(fileList);
    let hdr=null, body=[], done=0;

    files.forEach(file=>{
      Papa.parse(file,{encoding:'utf-8', skipEmptyLines:true, complete:res=>{
        const rows=res.data;
        if(!rows.length){done++; ck(); return;}
        if(!hdr){hdr=rows[0];}
        else if(hdr.length!==rows[0].length){alert(`æª”æ¡ˆ ${file.name} æ¬„ä½æ•¸ä¸ç¬¦ï¼Œå·²è·³é`); done++; ck(); return;}
        body.push(...rows.slice(1)); done++; ck();
      }});
    });
    function ck(){ if(done===files.length) processRows([hdr,...body]); }
  }

  /* ---------- è³‡æ–™è™•ç† ---------- */
  function processRows(allRows){
    hint.style.display='none';
    headers = allRows[0];

    const matIdx  = headers.findIndex(h=>h.includes('ææ–™ä»£è™Ÿ'));
    const idIdx   = headers.findIndex(h=>h.includes('ç®¡ç†è™Ÿç¢¼'));
    const nameIdx = headers.findIndex(h=>h.includes('ææ–™åç¨±'));
    if([matIdx,idIdx,nameIdx].includes(-1)){
      alert('ç¼ºå°‘å¿…è¦æ¬„ä½ï¼šææ–™ä»£è™Ÿ / ææ–™åç¨± / ç®¡ç†è™Ÿç¢¼');
      return;
    }

    const totalRows = [];
    const classified=[];
    const idFlag=new Map();
    const idSet=new Set();

    for(let i=1;i<allRows.length;i++){
      const cells=allRows[i];
      if(!cells.length||cells.every(c=>c==='')) continue;
      totalRows.push(cells);
      idSet.add(cells[idIdx]);

      const id=cells[idIdx];
      const mat=cells[matIdx];
      const name=cells[nameIdx]||'';
      const isMotor=/40301-/.test(mat)&&(name.includes('é€é¢¨')||name.includes('å´é¦¬é”'));
      const isPCB=/4045[06]-/.test(mat)&&name.includes('ä¸»æ§');

      classified.push({id,cells,flag:{isMotor,isPCB}});
      if(!idFlag.has(id)) idFlag.set(id,{pcb:false,motor:false});
      const f=idFlag.get(id); if(isMotor)f.motor=true; if(isPCB)f.pcb=true;
    }

    groups={ç¸½è¡¨:totalRows,PCB:[],é¦¬é”:[],æ··ä»¶:[]};
    const uniq={PCB:new Set(),é¦¬é”:new Set(),æ··ä»¶:new Set()};

    idFlag.forEach((v,id)=>{
      const rows=classified.filter(r=>r.id===id);
      if(v.pcb&&v.motor){uniq.æ··ä»¶.add(id); groups.æ··ä»¶.push(...rows.map(r=>r.cells));}
      else if(v.pcb){uniq.PCB.add(id); groups.PCB.push(rows.find(r=>r.flag.isPCB).cells);} 
      else if(v.motor){uniq.é¦¬é”.add(id); groups.é¦¬é”.push(rows.find(r=>r.flag.isMotor).cells);} 
    });

    renderStats(totalRows.length,idSet.size,uniq,groups);
    buildTabs();
  }

  /* ---------- çµ±è¨ˆå€ ---------- */
  function renderStats(allCnt,uniqCnt,uniqG,groups){
    statsDiv.style.display='block';
    statsDiv.innerHTML = `
      ç¸½åˆ—æ•¸ï¼š<span class='red'>${allCnt}</span>ï½œ
      ä¸é‡è¦†ç®¡ç†è™Ÿç¢¼ï¼š<span class='red'>${uniqCnt}</span>ï½œ
      PCB ä»¶æ•¸ï¼š<span class='red'>${uniqG.PCB.size}</span>ï¼ˆåˆ—æ•¸ï¼š<span class='red'>${groups.PCB.length}</span>ï¼‰ï½œ
      é¦¬é” ä»¶æ•¸ï¼š<span class='red'>${uniqG.é¦¬é”.size}</span>ï¼ˆåˆ—æ•¸ï¼š<span class='red'>${groups.é¦¬é”.length}</span>ï¼‰ï½œ
      PCB+é¦¬é” ä»¶æ•¸ï¼š<span class='red'>${uniqG.æ··ä»¶.size}</span>ï¼ˆåˆ—æ•¸ï¼š<span class='red'>${groups.æ··ä»¶.length}</span>ï¼‰ï½œ
      ç›®å‰é¡¯ç¤ºåˆ—æ•¸ï¼š<span id='currentCount' class='red'>0</span>
      <button id='dlXlsx'>ğŸ“ åŒ¯å‡º XLSX(å…¨éƒ¨)</button>
      <button id='dlFilteredXlsx'>ğŸ“ åŒ¯å‡ºç¯©é¸å¾Œ XLSX</button>
      <button id='dlCsv'>â¬‡ï¸ åŒ¯å‡ºç¸½è¡¨ CSV</button>`;

    document.getElementById('dlXlsx').onclick=()=>{
      const wb=XLSX.utils.book_new();
      Object.entries(groups).forEach(([n,r])=>{
        XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([headers,...r]),n);
      });
      XLSX.writeFile(wb,'åˆ†é¡çµæœ.xlsx');
    };

    document.getElementById('dlCsv').onclick=()=>{
      const rows=[headers,...groups['ç¸½è¡¨']];
      const csv='\uFEFF'+rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\r\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='ç¸½è¡¨.csv';a.click();
    };

    document.getElementById('dlFilteredXlsx').onclick=exportFiltered;
  }

  /* ---------- å»ºç«‹åˆ†é  ---------- */
  function buildTabs(){
    previewDiv.innerHTML='';
    tables={};

    previewDiv.appendChild(searchBar);
    const tabs=document.createElement('div');tabs.className='tabs';
    const panels=document.createElement('div');
    previewDiv.appendChild(tabs);previewDiv.appendChild(panels);

    const order=['ç¸½è¡¨','PCB','é¦¬é”','æ··ä»¶'];
    order.forEach((name,idx)=>{
      const btn=document.createElement('button');btn.className='tab-btn';btn.textContent=name;
      const panel=document.createElement('div');panel.className='tab-content';
      const tbl=createTable(groups[name]);
      panel.appendChild(tbl); tables[name]=tbl;

      btn.onclick=()=>{
        [...tabs.children].forEach(b=>b.classList.remove('active'));
        [...panels.children].forEach(p=>p.classList.remove('active'));
        btn.classList.add('active'); panel.classList.add('active');
        currentTable=tbl; applyFilter(searchInput.value);
      };
      tabs.appendChild(btn);panels.appendChild(panel);
      if(idx===0) btn.onclick();
    });

    /* é»è¡¨é ­å¿«é€Ÿè¼¸å…¥æ¬„ä½å: */
    Object.values(tables).forEach(tbl=>{
      tbl.querySelectorAll('thead th').forEach((th,idx)=>{
        th.addEventListener('click',()=>{
          const h=headers[idx];
          if(!new RegExp(`\\b${h}\\s*:`,`i`).test(searchInput.value)){
            searchInput.value+=(searchInput.value.trim()?', ':'')+`${h}:`;
            searchInput.focus();
          }
        });
      });
    });

    searchBar.style.display='block';
    searchInput.value='';
    searchInput.addEventListener('input',()=>applyFilter(searchInput.value));
  }

  /* ---------- Helpers ---------- */
  function createTable(rows){
    const tbl=document.createElement('table');
    tbl.innerHTML=`<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
    const tb=document.createElement('tbody');
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      r.forEach(c=>{const td=document.createElement('td');td.textContent=c;tr.appendChild(td);});
      tb.appendChild(tr);
    });
    tbl.appendChild(tb); return tbl;
  }

  function applyFilter(raw){
    const txt=raw.trim().toLowerCase();
    const parts=txt?txt.split(',').map(s=>s.trim()).filter(Boolean):[];
    const field=[], glob=[];
    parts.forEach(p=>{
      const seg=p.split(':');
      if(seg.length>=2){const key=seg[0].trim(); const val=seg.slice(1).join(':').trim(); const idx=headers.findIndex(h=>h.includes(key)); if(idx!==-1&&val) field.push({idx,val});}
      else if(p) glob.push(p);
    });

    Object.values(tables).forEach(tbl=>{
      [...tbl.querySelectorAll('tbody tr')].forEach(tr=>{
        const cells=[...tr.cells];
        let ok=field.every(c=>cells[c.idx].textContent.toLowerCase().includes(c.val));
        if(ok&&glob.length){const rowText=cells.map(td=>td.textContent).join(' ').toLowerCase(); ok=glob.every(t=>rowText.includes(t));}
        tr.style.display=ok?'':'none';
      });
    });
    updateCount();
  }

  function updateCount(){
    const span=document.getElementById('currentCount');
    if(!span||!currentTable) return;
    span.textContent=[...currentTable.querySelectorAll('tbody tr')].filter(tr=>tr.style.display!=='none').length;
  }

  function exportFiltered(){
    if(!Object.keys(tables).length){alert('å°šæœªåŒ¯å…¥è³‡æ–™');return;}
    const wb=XLSX.utils.book_new();
    Object.entries(tables).forEach(([n,tbl])=>{
      const rows=[...tbl.querySelectorAll('tbody tr')].filter(tr=>tr.style.display!=='none').map(tr=>[...tr.cells].map(td=>td.textContent));
      XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([headers,...rows]),n);
    });
    XLSX.writeFile(wb,'ç¯©é¸çµæœ.xlsx');
  }
})();
</script>
</body>
</html>