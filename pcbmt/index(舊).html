<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CSV ææ–™ä»£è™Ÿåˆ†é¡å·¥å…· (å¤šæª”åˆä½µ)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root { --border: 1px solid #ccc; }
  body { font-family: Arial,Helvetica,sans-serif; padding: 20px; line-height: 1.6; min-height: 100vh; display: flex; flex-direction: column; }
  body.dragover { background: #e0f7fa; }
  #hint { text-align: center; margin-bottom: 12px; color: #666; }
  #stats { background: #ffeb3b; padding: 8px 12px; font-weight: bold; margin-bottom: 12px; display: none; }
  .tabs { display: flex; gap: 6px; margin-bottom: 8px; }
  .tab-btn { padding: 6px 10px; border: var(--border); border-bottom: none; background: #f0f0f0; cursor: pointer; }
  .tab-btn.active { background: #fff; font-weight: bold; }
  .tab-content { border: var(--border); max-height: 60vh; overflow: auto; display: none; }
  .tab-content.active { display: block; }
  table { border-collapse: collapse; width: 100%; }
  th,td { border: 1px solid #ddd; padding: 4px 8px; font-size: 0.85rem; text-align: left; }
  thead { position: sticky; top: 0; background: #fff; }
  #searchBar { margin-bottom: 10px; display: none; }
  #searchBar input { padding: 6px 10px; width: 100%; max-width: 300px; }
</style>
</head>
<body>
<h2>CSV ææ–™ä»£è™Ÿåˆ†é¡å·¥å…·ï¼ˆå¯åˆä½µå¤šå€‹æª”æ¡ˆï¼‰</h2>
<p id="hint">æ‹–æ”¾ä¸€å€‹æˆ–å¤šå€‹ CSV è‡³é é¢ï¼Œæˆ–ä½¿ç”¨ <kbd>Ctrl+O</kbd> é¸æª”</p>
<input type="file" id="fileInput" accept=".csv" multiple style="display:none" />
<div id="stats"></div>
<div id="searchBar"><input type="text" id="searchInput" placeholder="æœå°‹ / ç¯©é¸ (å³æ™‚)" /></div>
<div id="preview"></div>

<script>
(()=>{
  const fileInput=document.getElementById('fileInput');
  const statsDiv=document.getElementById('stats');
  const previewDiv=document.getElementById('preview');
  const hint=document.getElementById('hint');
  const searchBar=document.getElementById('searchBar');
  const searchInput=document.getElementById('searchInput');
  let currentTable=null;
  let currentHeaders=null;
  let currentGroups=null;

  ['dragover','drop'].forEach(evt=>document.addEventListener(evt,e=>e.preventDefault()));
  document.addEventListener('dragenter',()=>document.body.classList.add('dragover'));
  document.addEventListener('dragleave',e=>{ if(e.target===document) document.body.classList.remove('dragover'); });
  document.addEventListener('drop',e=>{ document.body.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
  document.addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='o'){e.preventDefault();fileInput.click();} });
  fileInput.addEventListener('change',e=>handleFiles(e.target.files));

  function handleFiles(fileList){
    if(!fileList.length) return;
    const files=Array.from(fileList);
    let headers=null; let combined=[]; let processed=0;

    files.forEach(file=>{
      Papa.parse(file,{encoding:'utf-8',skipEmptyLines:true,complete:res=>{const rows=res.data;if(!rows.length){processed++;check();return;} if(!headers){headers=rows[0];} else if(headers.length!==rows[0].length){alert(`æª”æ¡ˆ ${file.name} æ¬„ä½æ•¸ä¸ç¬¦ï¼Œå·²è·³é`);processed++;check();return;} combined.push(...rows.slice(1));processed++;check();}});
    });
    function check(){ if(processed===files.length) processRows([headers,...combined]); }
  }

  function processRows(allRows){
    hint.style.display='none';
    const headers=allRows[0];
    currentHeaders=headers;
    const mIdx=headers.findIndex(h=>h.includes('ææ–™ä»£è™Ÿ'));
    const idIdx=headers.findIndex(h=>h.includes('ç®¡ç†è™Ÿç¢¼'));
    if(mIdx===-1||idIdx===-1){alert('æ‰¾ä¸åˆ° ææ–™ä»£è™Ÿ æˆ– ç®¡ç†è™Ÿç¢¼ æ¬„');return;}

    const raw=[]; const flag=new Map();
    for(let i=1;i<allRows.length;i++){
      const cells=allRows[i]; if(!cells.length||cells.every(c=>c==='')) continue;
      const id=cells[idIdx]; const mat=cells[mIdx]; raw.push({id,cells,mat});
      const isPCB=/4045[05]-/.test(mat); const isMotor=/40301-/.test(mat);
      if(!flag.has(id)) flag.set(id,{pcb:false,motor:false}); const f=flag.get(id);
      if(isPCB) f.pcb=true; if(isMotor) f.motor=true;
    }

    const groups={ç¸½è¡¨:raw.map(r=>r.cells),PCB:[],é¦¬é”:[],æ··ä»¶:[]};
    currentGroups=groups;
    const uniq={PCB:new Set(),é¦¬é”:new Set(),æ··ä»¶:new Set()};
    flag.forEach((v,id)=>{const rows=raw.filter(r=>r.id===id).map(r=>r.cells); if(v.pcb&&v.motor){uniq.æ··ä»¶.add(id);groups.æ··ä»¶.push(...rows);} else if(v.pcb){uniq.PCB.add(id);groups.PCB.push(...rows);} else if(v.motor){uniq.é¦¬é”.add(id);groups.é¦¬é”.push(...rows);} });

    statsDiv.style.display='block';
    statsDiv.innerHTML=`åˆä½µåˆ—æ•¸ï¼š${raw.length}ï½œPCB ä»¶æ•¸ï¼š<font color='red'>${uniq.PCB.size}</font>ï¼ˆåˆ—æ•¸ï¼š${groups.PCB.length}ï¼‰ï½œé¦¬é” ä»¶æ•¸ï¼šï¼š<font color='red'>${uniq.é¦¬é”.size}</font>ï¼ˆåˆ—æ•¸ï¼š${groups.é¦¬é”.length}ï¼‰ï½œPCB+é¦¬é” ä»¶æ•¸ï¼š<font color='red'>${uniq.æ··ä»¶.size}</font>ï¼ˆåˆ—æ•¸ï¼š${groups.æ··ä»¶.length}ï¼‰ <button id="downloadBtn">ğŸ“ åŒ¯å‡º xlsx</button> <button id="csvBtn">â¬‡ï¸ åŒ¯å‡ºç¸½è¡¨ CSV</button>`;

    document.getElementById('downloadBtn').onclick=()=>{
      const wb=XLSX.utils.book_new();
      Object.entries(groups).forEach(([name,arr])=>{ XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([headers,...arr]),name); });
      XLSX.writeFile(wb,'åˆ†é¡çµæœ.xlsx');
    };

    document.getElementById('csvBtn').onclick=()=>{
      if(!currentGroups||!currentHeaders) return;
      const rows=[currentHeaders,...currentGroups['ç¸½è¡¨']];
      const csvContent='\uFEFF'+rows.map(r=>r.map(v=>'"'+v.replace(/"/g,'""')+'"').join(',')).join('\r\n');
      const blob=new Blob([csvContent],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='ç¸½è¡¨.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };

    buildTabs(headers,groups);
  }

  function buildTabs(headers,groups){
    previewDiv.innerHTML=''; searchBar.style.display='block';
    const tabs=document.createElement('div');tabs.className='tabs'; const panels=document.createElement('div');
    previewDiv.appendChild(searchBar); previewDiv.appendChild(tabs); previewDiv.appendChild(panels);

    searchInput.value=''; searchInput.oninput=()=>filterRows(searchInput.value.toLowerCase());

    const createTable=rows=>{const tbl=document.createElement('table');tbl.innerHTML=`<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`; const tb=document.createElement('tbody'); rows.forEach(r=>{const tr=document.createElement('tr'); r.forEach(c=>{const td=document.createElement('td');td.textContent=c;tr.appendChild(td);}); tb.appendChild(tr);}); tbl.appendChild(tb); return tbl;};

    const order=['ç¸½è¡¨','PCB','é¦¬é”','æ··ä»¶'];
    order.forEach((name,idx)=>{
      const rows=groups[name];
      const btn=document.createElement('button');btn.className='tab-btn';btn.textContent=name;
      const panel=document.createElement('div');panel.className='tab-content';panel.appendChild(createTable(rows));
      tabs.appendChild(btn);panels.appendChild(panel);
      btn.onclick=()=>{[...tabs.children].forEach(b=>b.classList.remove('active'));[...panels.children].forEach(p=>p.classList.remove('active')); btn.classList.add('active'); panel.classList.add('active'); currentTable=panel.querySelector('table'); filterRows(searchInput.value.toLowerCase());};
      if(idx===0) btn.onclick();
    });

    function filterRows(keyword){ if(!currentTable) return; [...currentTable.querySelectorAll('tbody tr')].forEach(tr=>{tr.style.display=keyword===''||[...tr.cells].some(td=>td.textContent.toLowerCase().includes(keyword))?'':'none';}); }
  }
})();
</script>
</body>
</html>