<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Firestore æ­·å²ç´€éŒ„åŒ¯å…¥å·¥å…·</title>
  <!-- å¼•å…¥ Vue 3 -->
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
  
  <style>
    /* å…¨å±€æ¨£å¼å’Œè®Šé‡ */
    :root {
      font-size: clamp(14px, 3.5vw, 20px);
      --primary: #4a90e2;
      --success: #50e3c2;
      --warning: #f8e71c;
      --danger: #d0021b;
      --background: #f4f6f9;
      --text: #333;
      --border: #e0e0e0;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --radius: 0.75rem;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--background);
      color: var(--text);
      line-height: 1.5;
    }

    #app {
      max-width: 500px;
      margin: 4rem auto; /* å±…ä¸­ä¸¦å¢åŠ ä¸Šä¸‹é‚Šè· */
      padding: 1.5rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      background: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    h1 {
      margin: 0 0 0.5rem;
      text-align: center;
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--primary);
    }
    
    .subtitle {
        text-align: center;
        color: #666;
        font-size: 0.95rem;
        margin-bottom: 1rem;
    }
    
    /* åŒ¯å…¥å€å¡Šæ¨£å¼ */
    .import-container {
        border: 1px dashed var(--primary);
        padding: 1.5rem;
        border-radius: var(--radius);
        background: #fcfdff;
    }
    .import-container input[type="file"] {
        padding: 0.75rem 0;
        width: 100%;
        display: block;
        font-size: 1rem;
    }
    .import-btn {
        padding: 0.8rem;
        background: var(--warning);
        color: var(--text);
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s, transform 0.1s;
        margin-top: 1rem;
        width: 100%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .import-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* ç‹€æ…‹è¨Šæ¯ */
    .status-message {
      padding: 0.75rem;
      border-radius: 0.5rem;
      text-align: center;
      font-size: 0.9rem;
      margin-top: 1rem;
      font-weight: 500;
    }
    
    .status-message.loading-message {
        background-color: #e0f7fa;
        color: #007bff;
    }

    .status-message.success {
        background-color: #e6ffed;
        color: var(--success);
    }
    .status-message.error {
        background-color: #ffebee;
        color: var(--danger);
    }

    /* RWD èª¿æ•´ */
    @media (max-width: 550px) {
      #app {
        margin: 1rem auto;
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
<div id="app">
  <h1>Firestore æ­·å²ç´€éŒ„åŒ¯å…¥å·¥å…·</h1>
  <p class="subtitle">å°‡ Supabase åŒ¯å‡ºçš„ CSV æ•¸æ“šæ‰¹é‡å¯«å…¥åˆ° Firestore é›†åˆä¸­ã€‚</p>

  <div class="import-container">
      <h2 style="font-size:1.2rem;margin-top:0;">CSV æª”æ¡ˆä¸Šå‚³</h2>
      <p style="font-size:0.85rem;color:#666;margin:0 0 1rem;">
          **ç›®æ¨™é›†åˆ:** `classroom_safety_checks`<br>
          **é æœŸæ¬„ä½:** `employeeId`, `acSwitch`, `lighting`, `doorLock`, `time` (æˆ– Supabase åŒ¯å‡ºçš„å°æ‡‰æ¬„ä½åå¦‚ `employee_id`, `created_at` ç­‰)
      </p>
      <input type="file" ref="csvFile" accept=".csv" @change="handleFileUpload" />
      <button class="import-btn" @click="importCsv" :disabled="!selectedFile || importLoading">
          {{ importLoading ? 'ğŸš€ æ­£åœ¨æ‰¹é‡åŒ¯å…¥ä¸­...' : 'é–‹å§‹åŒ¯å…¥è³‡æ–™' }}
      </button>
      
      <p v-if="importStatus.message" :class="['status-message', importStatus.type]">
          {{ importStatus.message }}
      </p>
  </div>
</div>

<script type="module">
  // å°å…¥ Firebase å¿…è¦çš„æ¨¡çµ„
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, collection, Timestamp, writeBatch, doc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // æ‚¨çš„ Firebase é…ç½® (ç”±ç”¨æˆ¶æä¾›)
  const firebaseConfig = {
    apiKey: "AIzaSyB3zbbQPryMDD3WWEwSDy33XDz2ohmUd-k",
    authDomain: "fir-51fa5.firebaseapp.com",
    projectId: "fir-51fa5",
    storageBucket: "fir-51fa5.firebasestorage.app",
    messagingSenderId: "87934569004",
    appId: "1:87934569004:web:275f884f89737b786c1f89",
    measurementId: "G-8G5P02LHPN"
  };

  // åˆå§‹åŒ– Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const COLLECTION_NAME = 'classroom_safety_checks'; // åŒ¯å…¥çš„ç›®æ¨™é›†åˆåç¨±
  const BATCH_SIZE = 499; // Firestore æ‰¹é‡å¯«å…¥çš„é™åˆ¶

  // Vue æ‡‰ç”¨ç¨‹å¼é‚è¼¯
  Vue.createApp({
    data() {
      return {
        selectedFile: null,
        importLoading: false,
        // ç‹€æ…‹è¨Šæ¯ï¼šmessage (å…§å®¹), type (CSSé¡åˆ¥: success, error, loading-message)
        importStatus: { message: 'è«‹é¸æ“‡ CSV æª”æ¡ˆä¸¦é–‹å§‹åŒ¯å…¥ã€‚', type: 'loading-message' },
      };
    },
    methods: {
      handleFileUpload(event) {
          this.selectedFile = event.target.files[0];
          this.importStatus = { message: `å·²é¸æ“‡æª”æ¡ˆ: ${this.selectedFile.name}`, type: 'loading-message' };
      },

      // è®€å–æª”æ¡ˆå…§å®¹çš„ Promise åŒ…è£
      readFile(file) {
          return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = e => resolve(e.target.result);
              reader.onerror = e => reject(e);
              reader.readAsText(file);
          });
      },

      // ç°¡å–®çš„ CSV è§£æå™¨
      parseCsv(csvString) {
          const lines = csvString.trim().split('\n');
          if (lines.length < 2) throw new Error('CSV æª”æ¡ˆå…§å®¹ä¸è¶³ã€‚');

          const header = lines[0].toLowerCase().split(',').map(h => h.trim().replace(/"/g, ''));
          const data = [];
          
          for (let i = 1; i < lines.length; i++) {
              const values = lines[i].split(',');
              if (values.length !== header.length) {
                console.warn(`è·³éä¸ä¸€è‡´çš„è¡Œ ${i}: ${lines[i]}`);
                continue;
              }
              let obj = {};
              for (let j = 0; j < header.length; j++) {
                  obj[header[j]] = values[j].trim().replace(/"/g, '');
              }
              data.push(obj);
          }
          return data;
      },

      async importCsv() {
          if (!this.selectedFile) return; // å†æ¬¡æª¢æŸ¥
          
          this.importLoading = true;
          this.importStatus = { message: 'è®€å–ä¸¦åŒ¯å…¥ä¸­ï¼Œè«‹å‹¿é—œé–‰ç¶²é ...', type: 'loading-message' };

          try {
              const fileContent = await this.readFile(this.selectedFile);
              const records = this.parseCsv(fileContent);

              if (records.length === 0) {
                  throw new Error('CSV æª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆæ•¸æ“šã€‚');
              }
              
              const collectionRef = collection(db, COLLECTION_NAME);
              let successfulWrites = 0;
              
              // æ‰¹é‡å¯«å…¥é‚è¼¯
              for (let i = 0; i < records.length; i += BATCH_SIZE) {
                  const batch = writeBatch(db);
                  const chunk = records.slice(i, i + BATCH_SIZE);
                  
                  chunk.forEach(record => {
                      // æ ¸å¿ƒè³‡æ–™è½‰æ›é‚è¼¯
                      const firestoreRecord = {
                          // å®¹è¨±å¤šç¨®æ¬„ä½åç¨±ï¼šemployeeid æˆ– employee_id
                          employeeId: String(record.employeeid || record.employee_id || ''),
                          acSwitch: (record.acswitch || record.ac_switch) === 'true' || (record.acswitch || record.ac_switch) === 'Y' ? 'Y' : 'N',
                          lighting: (record.lighting || record.lighting) === 'true' || (record.lighting || record.lighting) === 'Y' ? 'Y' : 'N',
                          doorLock: (record.doorlock || record.door_lock) === 'true' || (record.doorlock || record.door_lock) === 'Y' ? 'Y' : 'N',
                          // è½‰æ›æ™‚é–“å­—ä¸²ç‚º Firestore Timestamp
                          time: Timestamp.fromDate(new Date(record.time || record.created_at || new Date().toISOString())),
                      };
                      
                      const docRef = doc(collectionRef); 
                      batch.set(docRef, firestoreRecord);
                      successfulWrites++;
                  });
                  
                  await batch.commit();
                  this.importStatus.message = `æ­£åœ¨åŒ¯å…¥... å·²å®Œæˆ ${successfulWrites} ç­†ç´€éŒ„ã€‚`;
              }
              
              this.importStatus = { 
                  message: `âœ… æ­å–œï¼æˆåŠŸåŒ¯å…¥ ${successfulWrites} ç­†ç´€éŒ„åˆ° Firestoreï¼`, 
                  type: 'success' 
              };
              
          } catch (error) {
              console.error('åŒ¯å…¥å¤±æ•—:', error);
              let msg = error.message;
              if (msg.includes('Firebase: Error')) {
                  msg = 'è«‹æª¢æŸ¥æ‚¨çš„ Firestore å®‰å…¨è¦å‰‡æ˜¯å¦å·²è¨­ç½®ç‚ºå…¬é–‹å¯«å…¥ (allow write: if true)ã€‚';
              }
              this.importStatus = { 
                  message: `ğŸš¨ åŒ¯å…¥å¤±æ•—: ${msg}`, 
                  type: 'error' 
              };
          } finally {
              this.importLoading = false;
              // é‡è¨­æª”æ¡ˆé¸æ“‡å™¨
              if(this.$refs.csvFile) this.$refs.csvFile.value = null;
              this.selectedFile = null;
          }
      },
    }
  }).mount('#app');
</script>
</body>
</html>