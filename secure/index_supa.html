<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç©ºèª¿æ•™å®¤ï¼å­¸å“¡ä¼‘æ¯å®¤å®‰å…¨æª¢æŸ¥è¡¨</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    :root {
      font-size: clamp(14px, 3.5vw, 22px);
      --primary: #007bff;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #d9534f;
      --background: #f5f7fa;
      --text: #333;
      --border: #ddd;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--background);
      color: var(--text);
      line-height: 1.5;
    }

    #app {
      max-width: 100%;
      padding: 1.25rem;
      box-sizing: border-box;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    h1 {
      margin: 0 0 1rem;
      text-align: center;
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--black);
    }

    .input-remember-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: nowrap;
    }

    input[type="text"] {
      flex: 1;
      padding: 0.6rem 0.8rem;
      font-size: 1rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      background: #fff;
      box-shadow: var(--shadow);
      transition: border-color 0.3s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--primary);
    }

    .remember-btn {
      padding: 0.6rem 1rem;
      background: var(--warning);
      color: var(--text);
      border: none;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.3s, transform 0.1s;
    }

    .remember-btn.active {
      background: var(--success);
      color: #fff;
    }

    .remember-btn:active {
      transform: scale(0.98);
    }

    .check-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .check-button {
      padding: 0.6rem;
      text-align: center;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 0.9rem;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: var(--shadow);
      transition: background 0.3s, border-color 0.3s, transform 0.1s;
    }

    .check-button.active {
      background: var(--success);
      color: #fff;
      border-color: var(--success);
    }

    .check-button:active {
      transform: scale(0.98);
    }

    .action-btn {
      width: 100%;
      padding: 0.75rem;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 0.5rem;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: opacity 0.3s, transform 0.1s;
      margin-top: 1rem;
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .action-btn:active:not(:disabled) {
      transform: scale(0.98);
    }

    .record-table {
      width: 100%;
      overflow-x: auto;
      margin-top: 1rem;
      background: #fff;
      border-radius: 0.5rem;
      box-shadow: var(--shadow);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th, td {
      padding: 0.5rem;
      text-align: center;
      border: 1px solid var(--border);
      white-space: nowrap;
    }

    th {
      background: var(--primary);
      color: #fff;
      font-weight: 500;
    }

    tr:nth-child(even) {
      background: #f9f9f9;
    }

    .pager-btn {
      font-size: 0.85rem;
      margin: 0 0.3rem;
      padding: 0.4rem 0.8rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      cursor: pointer;
      background: #fff;
      transition: background 0.3s, transform 0.1s;
    }

    .pager-btn.active, .pager-btn:hover {
      background: var(--primary);
      color: #fff;
    }

    .pager-btn:active {
      transform: scale(0.98);
    }

    .loading-message, .error-message {
      text-align: center;
      font-size: 0.9rem;
      margin: 0.5rem 0;
    }

    .loading-message {
      color: #555;
    }

    .error-message {
      color: var(--danger);
    }

    @media (max-width: 414px) {
      #app {
        padding: 0.75rem;
      }

      h1 {
        font-size: 1.4rem;
      }

      .check-button {
        font-size: 0.85rem;
        padding: 0.5rem;
      }

      table {
        font-size: 0.8rem;
      }

      th, td {
        padding: 0.4rem;
      }
    }
  </style>
</head>
<body>
<div id="app">
  <h1>ç©ºèª¿æ•™å®¤ï¼å­¸å“¡ä¼‘æ¯å®¤å®‰å…¨æª¢æŸ¥è¡¨</h1>

  <p v-if="withinRange === null" class="loading-message">
    æª¢æŸ¥ä¸­â€¦ <button @click="checkGeolocation" class="pager-btn">é‡è©¦</button>
  </p>
  <p v-if="withinRange === false" class="error-message">
    æ‚¨ä¸åœ¨æ•™å®¤ï¼Œåƒ…èƒ½è§€çœ‹æª¢æŸ¥ç´€éŒ„ã€‚ <button @click="checkGeolocation" class="pager-btn">é‡è©¦</button>
  </p>

  <template v-if="withinRange">
    <div class="input-remember-row">
      <input type="text" v-model="employeeId" placeholder="è«‹è¼¸å…¥ 6 ä½æ•¸å“¡å·¥ä»£è™Ÿ" maxlength="6" @input="onEmployeeIdInput" />
      <button class="remember-btn" :class="{active:rememberMe}" @click="toggleRemember">{{ rememberMe ? 'âœ… å·²è¨˜ä½' : 'è¨˜ä½æˆ‘' }}</button>
    </div>

    <div class="check-buttons">
      <div class="check-button" :class="{active:checklist.acSwitch}" @click="toggleCheck('acSwitch')">â„ï¸ å†·æ°£é–‹é—œ {{ checklist.acSwitch?'âœ…':'' }}</div>
      <div class="check-button" :class="{active:checklist.lighting}" @click="toggleCheck('lighting')">ğŸ’¡ ç…§æ˜ç‡ˆå…· {{ checklist.lighting?'âœ…':'' }}</div>
      <div class="check-button" :class="{active:checklist.doorLock}" @click="toggleCheck('doorLock')">ğŸ” æ•™å®¤é–€é– {{ checklist.doorLock?'âœ…':'' }}</div>
    </div>

    <button class="action-btn" @click="punch" :disabled="!allChecked" :style="{opacity:allChecked?1:0.5,cursor:allChecked?'pointer':'not-allowed'}">å®Œæˆç¢ºèª</button>
    <p v-if="!allChecked" class="error-message">è«‹å®Œæˆæ‰€æœ‰æª¢æŸ¥é …ç›®å¾Œå†é€å‡º</p>
  </template>

  <div class="record-table">
    <div v-if="loading" class="loading-message">è³‡æ–™è®€å–ä¸­â€¦</div>
    <table v-else>
      <thead>
        <tr><th>å“¡å·¥ä»£è™Ÿ</th><th>å†·æ°£é–‹é—œ</th><th>ç…§æ˜ç‡ˆå…·</th><th>æ•™å®¤é–€é–</th><th>é€€å®¤æª¢æŸ¥æ™‚é–“</th></tr>
      </thead>
      <tbody>
        <tr v-for="r in paginatedRecords" :key="r.id">
          <td>{{ formatEmployeeId(r.employeeId) }}</td>
          <td>{{ r.acSwitch==='Y'?'âœ…':'âŒ' }}</td>
          <td>{{ r.lighting==='Y'?'âœ…':'âŒ' }}</td>
          <td>{{ r.doorLock==='Y'?'âœ…':'âŒ' }}</td>
          <td>{{ formatDate(r.time) }}</td>
        </tr>
      </tbody>
    </table>
    <div v-if="!loading" style="text-align:center;margin-top:0.75rem;">
      <button v-for="p in totalPages" :key="p" @click="goToPage(p)" class="pager-btn" :class="{active:p===currentPage}">{{ p }}</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://txlfxivvjfploafbnnqr.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4bGZ4aXZ2amZwbG9hZmJubnFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3ODYxMDMsImV4cCI6MjA2NTM2MjEwM30.2L4SogcQndcCAIUzoX76YoLt7YQ-FvC4mvKmY-i-tws';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

Vue.createApp({
  data() {
    return {
      employeeId: '',
      rememberMe: false,
      checklist: { acSwitch: false, lighting: false, doorLock: false },
      records: [],
      currentPage: 1,
      pageSize: 10,
      loading: true,
      withinRange: null
    };
  },
  computed: {
    allChecked() { return Object.values(this.checklist).every(Boolean); },
    paginatedRecords() { 
      const s = (this.currentPage - 1) * this.pageSize; 
      return this.records.slice(s, s + this.pageSize); 
    },
    totalPages() { return Math.max(1, Math.ceil(this.records.length / this.pageSize)); }
  },
  async mounted() {
    const saved = localStorage.getItem('employeeId');
    if (saved) {
      this.employeeId = saved;
      this.rememberMe = true;
    }
    // ä¸¦è¡ŒåŸ·è¡Œåœ°ç†ä½ç½®æª¢æŸ¥å’Œè¼‰å…¥è¨˜éŒ„
    Promise.all([this.checkGeolocation(), this.loadRecords()]).catch(error => {
      console.error('Initialization error:', error);
    });
  },
  methods: {
    async checkGeolocation() {
      const CENTER = { lat: 25.0086665, lng: 121.4785635 }, R = 50;
      const hav = (a, b) => {
        const rad = d => d * Math.PI / 180, R0 = 6371000;
        const dLat = rad(b.lat - a.lat), dLng = rad(b.lng - a.lng);
        const h = Math.sin(dLat / 2) ** 2 + Math.cos(rad(a.lat)) * Math.cos(rad(b.lat)) * Math.sin(dLng / 2) ** 2;
        return 2 * R0 * Math.asin(Math.sqrt(h));
      };
      if (navigator.geolocation) {
        this.withinRange = null;
        try {
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 8000, enableHighAccuracy: true });
          });
          this.withinRange = hav({ lat: position.coords.latitude, lng: position.coords.longitude }, CENTER) <= R;
        } catch (error) {
          console.error('Geolocation error:', error);
          this.withinRange = false;
        }
      } else {
        this.withinRange = false;
      }
    },
    onEmployeeIdInput() { 
      this.employeeId = this.employeeId.replace(/\D/g, '').slice(0, 6); 
    },
    toggleCheck(k) { 
      this.checklist[k] = !this.checklist[k]; 
    },
    toggleRemember() {
      this.rememberMe = !this.rememberMe;
      this.rememberMe ? localStorage.setItem('employeeId', this.employeeId) : localStorage.removeItem('employeeId');
    },
    async punch() {
      if (this.employeeId.length !== 6) { 
        alert('å“¡å·¥ä»£è™Ÿå¿…é ˆ 6 ä½æ•¸'); 
        return; 
      }
      const payload = {
        employeeId: this.employeeId,
        acSwitch: this.checklist.acSwitch ? 'Y' : 'N',
        lighting: this.checklist.lighting ? 'Y' : 'N',
        doorLock: this.checklist.doorLock ? 'Y' : 'N'
      };
      const { error } = await db.from('cocheck').insert([payload]);
      if (error) { 
        console.error(error); 
        alert('å¯«å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'); 
      } else { 
        alert('é€€å®¤æª¢æŸ¥å·²å®Œæˆï¼'); 
        this.resetForm(); 
        await this.loadRecords(); 
      }
    },
    resetForm() {
      this.checklist = { acSwitch: false, lighting: false, doorLock: false };
      if (!this.rememberMe) { 
        this.employeeId = ''; 
      }
    },
    async loadRecords() {
      this.loading = true;
      try {
        const { data, error } = await db.from('cocheck').select('*').order('time', { ascending: false });
        if (error) throw error;
        this.records = data || [];
      } catch (error) {
        console.error('Load records error:', error);
        this.records = [];
      } finally {
        this.loading = false;
        this.currentPage = 1;
      }
    },
    goToPage(p) { 
      this.currentPage = p; 
    },
    formatDate(str) {
      const d = new Date(str), pad = n => String(n).padStart(2, '0');
      return `${d.getFullYear()}/${pad(d.getMonth() + 1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    },
    formatEmployeeId(id) { 
      return String(id).padStart(6, '0'); 
    }
  }
}).mount('#app');
</script>
</body>
</html>