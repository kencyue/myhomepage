<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç©ºèª¿æ•™å®¤ï¼å­¸å“¡ä¼‘æ¯å®¤å®‰å…¨æª¢æŸ¥è¡¨ (Firestore)</title>
  <!-- å¼•å…¥ Vue 3 -->
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
  
  <style>
    /* å…¨å±€æ¨£å¼å’Œè®Šé‡ */
    :root {
      font-size: clamp(14px, 3.5vw, 20px);
      --primary: #4a90e2; /* è—è‰²ï¼Œæ›´ç¾ä»£ */
      --success: #50e3c2; /* é’ç¶ è‰² */
      --warning: #f8e71c; /* é»ƒè‰² */
      --danger: #d0021b; /* ç´…è‰² */
      --background: #f4f6f9;
      --text: #333;
      --border: #e0e0e0;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --radius: 0.75rem;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--background);
      color: var(--text);
      line-height: 1.5;
      /* ç¢ºä¿ body é«˜åº¦ç­‰æ–¼è¦–çª—é«˜åº¦ï¼Œé¿å…ä¸å¿…è¦çš„æ²è»¸ */
      height: 100vh;
      overflow-y: auto; 
    }

    #app {
      max-width: 600px;
      margin: 0 auto; 
      padding: 0.75rem; /* ä¿®æ­£: æ¸›å°‘å‚ç›´ padding */
      box-sizing: border-box;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 0.75rem; /* ä¿®æ­£: æ¸›å°‘æ•´é«”é–“è· (å¾ 1.25rem é™è‡³ 0.75rem) */
    }

    h1 {
      margin: 0 0 0.5rem; /* ä¿®æ­£: æ¸›å°‘æ¨™é¡Œä¸‹é‚Šè· */
      text-align: center;
      font-size: 1.8rem;
      font-weight: 700;
      color: #333;
    }

    /* è¼¸å…¥å’Œè¨˜ä½æˆ‘æŒ‰éˆ•æ’ç‰ˆ */
    .input-remember-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow: hidden;
      background: #fff;
      padding: 0.5rem; 
    }

    input[type="text"] {
      flex: 1;
      padding: 0.6rem 0.8rem;
      font-size: 1rem;
      border: none;
      border-radius: 0;
      background: transparent;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus {
      outline: none;
    }

    .remember-btn {
      padding: 0.6rem 1rem;
      background: #f0f0f0;
      color: var(--text);
      border: none;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.3s, transform 0.1s;
      flex-shrink: 0;
    }

    .remember-btn.active {
      background: var(--primary);
      color: #fff;
    }

    /* æª¢æŸ¥æŒ‰éˆ•ç¶²æ ¼ */
    .check-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 0.75rem;
      margin-top: 0; /* ä¿®æ­£: ç§»é™¤ä¸Šé‚Šè·ï¼Œä¾é  #app gap */
    }

    .check-button {
      padding: 1rem 0.6rem; 
      text-align: center;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      transition: background 0.3s, border-color 0.3s, transform 0.1s;
    }

    .check-button.active {
      background: var(--success);
      color: #333;
      border-color: var(--success);
      box-shadow: 0 4px 6px rgba(0, 227, 194, 0.2);
    }

    .check-button:active {
      transform: scale(0.98);
    }

    /* å®ŒæˆæŒ‰éˆ• */
    .action-btn {
      width: 100%;
      padding: 1rem;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: background 0.3s, transform 0.1s, opacity 0.3s;
      margin-top: 0.5rem; /* ä¿®æ­£: æ¸›å°‘ä¸Šé‚Šè· (å¾ 1rem é™è‡³ 0.5rem) */
    }

    .action-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
    }

    .action-btn:active:not(:disabled) {
      transform: scale(0.98);
      background: #3983d3;
    }

    /* éŒ¯èª¤å’Œæç¤ºä¿¡æ¯ */
    .loading-message, .error-message {
      padding: 0.5rem;
      border-radius: 0.5rem;
      text-align: center;
      font-size: 0.9rem;
      margin: 0.25rem 0; /* ä¿®æ­£: æ¸›å°‘ä¸Šä¸‹é‚Šè· */
    }
    
    .loading-message {
        color: #555;
        background-color: #e0f7fa;
    }

    .error-message {
      color: var(--danger);
      background-color: #ffebee;
      font-weight: 500;
    }

    /* ç´€éŒ„è¡¨æ ¼ */
    .record-table {
      width: 100%;
      overflow-x: auto; 
      margin-top: 0.75rem; /* ä¿®æ­£: æ¸›å°‘ä¸Šé‚Šè· (å¾ 1.5rem é™è‡³ 0.75rem) */
      background: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 0.1px; 
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      table-layout: fixed; 
    }

    th, td {
      padding: 0.6rem 0.2rem; 
      text-align: center;
      border: 1px solid var(--border);
      white-space: nowrap;
    }
    
    /* èª¿æ•´æ¬„ä½å¯¬åº¦ä»¥é©æ‡‰å°è¢å¹• */
    table thead th:nth-child(1), table tbody td:nth-child(1) { width: 15%; } 
    table thead th:nth-child(2), table tbody td:nth-child(2) { width: 10%; } 
    table thead th:nth-child(3), table tbody td:nth-child(3) { width: 10%; } 
    table thead th:nth-child(4), table tbody td:nth-child(4) { width: 10%; } 
    table thead th:nth-child(5), table tbody td:nth-child(5) { width: 55%; } 

    th {
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      border-color: var(--primary);
    }

    tr:nth-child(even) {
      background: #f9f9f9;
    }

    /* åˆ†é æŒ‰éˆ• */
    .pagination {
        display: flex;
        justify-content: center;
        padding: 0.75rem 0; /* ä¿®æ­£: æ¸›å°‘ä¸Šä¸‹ padding */
        gap: 0.5rem;
    }
    .pager-btn {
      font-size: 0.85rem;
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      cursor: pointer;
      background: #fff;
      transition: background 0.3s, transform 0.1s;
    }

    .pager-btn.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .pager-btn:hover:not(.active) {
        background: #f0f0f0;
    }
    .pager-btn:active {
      transform: scale(0.95);
    }

    /* RWD èª¿æ•´ */
    @media (max-width: 414px) {
      #app {
        padding: 0.5rem; /* ä¿®æ­£: é€²ä¸€æ­¥æ¸›å°‘æ‰‹æ©Ÿä¸Šçš„ padding */
      }

      h1 {
        font-size: 1.5rem;
      }

      .check-button {
        font-size: 0.85rem;
        padding: 0.75rem 0.5rem;
      }
      
      table {
          font-size: 0.75rem;
      }
    }
  </style>
</head>
<body>
<div id="app">
  <h1>ç©ºèª¿æ•™å®¤ï¼å­¸å“¡ä¼‘æ¯å®¤å®‰å…¨æª¢æŸ¥è¡¨</h1>

  <!-- åœ°ç†ä½ç½®æª¢æŸ¥ç‹€æ…‹ -->
  <p v-if="withinRange === null" class="loading-message">
    ğŸŒ æª¢æŸ¥æ‚¨çš„åœ°ç†ä½ç½®ä¸­â€¦ <button @click="checkGeolocation" class="pager-btn">é‡è©¦</button>
  </p>
  <p v-if="withinRange === false" class="error-message">
    ğŸš¨ æ‚¨ä¸åœ¨æŒ‡å®šæ•™å®¤ç¯„åœå…§ (50m)ï¼Œåƒ…èƒ½è§€çœ‹æª¢æŸ¥ç´€éŒ„ã€‚ <button @click="checkGeolocation" class="pager-btn">é‡è©¦</button>
  </p>

  <!-- æª¢æŸ¥è¡¨å–® (åƒ…åœ¨ç¯„åœå…§é¡¯ç¤º) -->
  <template v-if="withinRange">
    <div class="input-remember-row">
      <input type="text" v-model="employeeId" placeholder="è«‹è¼¸å…¥ 6 ä½æ•¸å“¡å·¥ä»£è™Ÿ" maxlength="6" @input="onEmployeeIdInput" />
      <button class="remember-btn" :class="{active:rememberMe}" @click="toggleRemember">{{ rememberMe ? 'âœ… å·²è¨˜ä½' : 'è¨˜ä½æˆ‘' }}</button>
    </div>

    <div class="check-buttons">
      <div class="check-button" :class="{active:checklist.acSwitch}" @click="toggleCheck('acSwitch')">â„ï¸ å†·æ°£é–‹é—œ {{ checklist.acSwitch?'âœ…':'' }}</div>
      <div class="check-button" :class="{active:checklist.lighting}" @click="toggleCheck('lighting')">ğŸ’¡ ç…§æ˜ç‡ˆå…· {{ checklist.lighting?'âœ…':'' }}</div>
      <div class="check-button" :class="{active:checklist.doorLock}" @click="toggleCheck('doorLock')">ğŸ” æ•™å®¤é–€é– {{ checklist.doorLock?'âœ…':'' }}</div>
    </div>

    <button class="action-btn" @click="punch" :disabled="!allChecked || employeeId.length !== 6">å®Œæˆé€€å®¤æª¢æŸ¥</button>
    <p v-if="!allChecked || employeeId.length !== 6" class="error-message">
        {{ employeeId.length !== 6 ? 'å“¡å·¥ä»£è™Ÿå¿…é ˆç‚º 6 ä½æ•¸' : 'è«‹å®Œæˆæ‰€æœ‰æª¢æŸ¥é …ç›®å¾Œå†é€å‡º' }}
    </p>
  </template>

  <!-- ç´€éŒ„è¡¨æ ¼ -->
  <div class="record-table">
    <div v-if="loading" class="loading-message">ğŸš€ è³‡æ–™è®€å–ä¸­â€¦</div>
    <table v-else>
      <thead>
        <tr><th>å“¡å·¥ä»£è™Ÿ</th><th>å†·æ°£<br>é–‹é—œ</th><th>ç…§æ˜<br>ç‡ˆå…·</th><th>æ•™å®¤<br>é–€é–</th><th>é€€å®¤æª¢æŸ¥æ™‚é–“</th></tr>
      </thead>
      <tbody>
        <tr v-for="r in paginatedRecords" :key="r.id">
          <td>{{ formatEmployeeId(r.employeeId) }}</td>
          <td>{{ r.acSwitch==='Y'?'âœ…':'âŒ' }}</td>
          <td>{{ r.lighting==='Y'?'âœ…':'âŒ' }}</td>
          <td>{{ r.doorLock==='Y'?'âœ…':'âŒ' }}</td>
          <td>{{ formatDate(r.time) }}</td>
        </tr>
      </tbody>
    </table>
    
    <!-- åˆ†é æ§åˆ¶ -->
    <div v-if="!loading && totalPages > 1" class="pagination">
        <button v-for="p in totalPages" :key="p" @click="goToPage(p)" class="pager-btn" :class="{active:p===currentPage}">{{ p }}</button>
    </div>
    <div v-if="!loading && records.length === 0" class="loading-message">
        ç›®å‰æ²’æœ‰æª¢æŸ¥ç´€éŒ„ã€‚
    </div>
  </div>
</div>

<script type="module">
  // å°å…¥ Firebase å¿…è¦çš„æ¨¡çµ„
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // æ‚¨çš„ Firebase é…ç½® (ç”±ç”¨æˆ¶æä¾›)
  const firebaseConfig = {
    apiKey: "AIzaSyB3zbbQPryMDD3WWEwSDy33XDz2ohmUd-k",
    authDomain: "fir-51fa5.firebaseapp.com",
    projectId: "fir-51fa5",
    storageBucket: "fir-51fa5.firebasestorage.app",
    messagingSenderId: "87934569004",
    appId: "1:87934569004:web:275f884f89737b786c1f89",
    measurementId: "G-8G5P02LHPN"
  };

  // åˆå§‹åŒ– Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const COLLECTION_NAME = 'classroom_safety_checks'; // Firestore é›†åˆåç¨±

  // Vue æ‡‰ç”¨ç¨‹å¼é‚è¼¯
  Vue.createApp({
    data() {
      return {
        employeeId: '',
        rememberMe: false,
        checklist: { acSwitch: false, lighting: false, doorLock: false },
        records: [],
        currentPage: 1,
        pageSize: 10,
        loading: true,
        withinRange: null,
        unsubscribe: null, 
      };
    },
    computed: {
      allChecked() { return Object.values(this.checklist).every(Boolean); },
      paginatedRecords() { 
        const s = (this.currentPage - 1) * this.pageSize; 
        return this.records.slice(s, s + this.pageSize); 
      },
      totalPages() { 
        return Math.max(1, Math.ceil(this.records.length / this.pageSize)); 
      }
    },
    async mounted() {
      // è¼‰å…¥ localStorage
      const saved = localStorage.getItem('employeeId');
      if (saved) {
        this.employeeId = saved;
        this.rememberMe = true;
      }
      
      try {
        await this.checkGeolocation();
        this.loadRecords(); // è¨­ç½® onSnapshot ç›£è½
      } catch (error) {
        console.error('Initialization error:', error);
      }
    },
    methods: {
      // --- æ ¸å¿ƒåŠŸèƒ½ (æª¢æŸ¥, æäº¤, RFS) ---
      checkGeolocation() {
        return new Promise((resolve) => {
          const CENTER = { lat: 25.0086665, lng: 121.4785635 }; 
          const R = 50; 
          const hav = (a, b) => {
            const rad = d => d * Math.PI / 180, R0 = 6371000;
            const dLat = rad(b.lat - a.lat), dLng = rad(b.lng - a.lng);
            const h = Math.sin(dLat / 2) ** 2 + Math.cos(rad(a.lat)) * Math.cos(rad(b.lat)) * Math.sin(dLng / 2) ** 2;
            return 2 * R0 * Math.asin(Math.sqrt(h));
          };
          if (navigator.geolocation) {
            this.withinRange = null; 
            navigator.geolocation.getCurrentPosition(
              (position) => {
                const distance = hav({ lat: position.coords.latitude, lng: position.coords.longitude }, CENTER);
                this.withinRange = distance <= R;
                resolve(this.withinRange);
              }, 
              (error) => {
                console.error('Geolocation error:', error);
                this.withinRange = false;
                resolve(false);
              }, 
              { timeout: 8000, enableHighAccuracy: true }
            );
          } else {
            this.withinRange = false;
            resolve(false);
          }
        });
      },
      onEmployeeIdInput() { 
        this.employeeId = this.employeeId.replace(/\D/g, '').slice(0, 6); 
        if (this.rememberMe) {
            localStorage.setItem('employeeId', this.employeeId);
        }
      },
      toggleCheck(k) { 
        this.checklist[k] = !this.checklist[k]; 
      },
      toggleRemember() {
        this.rememberMe = !this.rememberMe;
        if (this.rememberMe && this.employeeId.length === 6) {
          localStorage.setItem('employeeId', this.employeeId);
        } else {
          localStorage.removeItem('employeeId');
        }
      },
      async punch() {
        if (this.employeeId.length !== 6 || !this.allChecked) { 
          console.error('å“¡å·¥ä»£è™Ÿæˆ–æª¢æŸ¥é …ç›®æœªå®Œæˆã€‚');
          return; 
        }
        
        const payload = {
          employeeId: this.employeeId,
          acSwitch: this.checklist.acSwitch ? 'Y' : 'N',
          lighting: this.checklist.lighting ? 'Y' : 'N',
          doorLock: this.checklist.doorLock ? 'Y' : 'N',
          time: Timestamp.fromDate(new Date()) 
        };
        
        try {
          await addDoc(collection(db, COLLECTION_NAME), payload);
          
          console.log('é€€å®¤æª¢æŸ¥å·²å®Œæˆï¼ (è³‡æ–™å°‡ç”± onSnapshot è‡ªå‹•æ›´æ–°)'); 
          alert('é€€å®¤æª¢æŸ¥å·²å®Œæˆï¼'); 
          this.resetForm(); 
        } catch (error) { 
          console.error('Firestore å¯«å…¥å¤±æ•—:', error); 
          alert('å¯«å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'); 
        }
      },
      resetForm() {
        this.checklist = { acSwitch: false, lighting: false, doorLock: false };
        if (!this.rememberMe) { 
          this.employeeId = ''; 
        }
      },
      loadRecords() {
        this.loading = true;
        
        const q = query(collection(db, COLLECTION_NAME), orderBy('time', 'desc'));
        
        if (this.unsubscribe) {
            this.unsubscribe();
        }

        this.unsubscribe = onSnapshot(q, (snapshot) => {
            this.records = snapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    employeeId: data.employeeId,
                    acSwitch: data.acSwitch,
                    lighting: data.lighting,
                    doorLock: data.doorLock,
                    time: data.time ? data.time.toDate().toISOString() : new Date().toISOString()
                };
            });

            this.loading = false;
            this.currentPage = 1; 

        }, (error) => {
            console.error('Firestore Realtime Listen error:', error);
            this.records = [];
            this.loading = false;
        });
      },
      goToPage(p) { 
        this.currentPage = p; 
      },
      formatDate(str) {
        const d = new Date(str), pad = n => String(n).padStart(2, '0');
        return `${d.getFullYear()}/${pad(d.getMonth() + 1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      },
      formatEmployeeId(id) { 
        return String(id).padStart(6, '0'); 
      }
    }
  }).mount('#app');
</script>
</body>
</html>