<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>匯率計算機＋色碼電阻</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* ===== 版面 ===== */
    body {
      margin: 0;
      background: #000;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      font-family: 'SF Pro Rounded', 'SF Pro Display', 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
      -webkit-font-smoothing: antialiased;
      font-variant-numeric: tabular-nums;
    }
    .calculator {
      position: relative;
      width: 100%;
      max-width: 480px;
      background: #000;
      padding: 20px;
      box-sizing: border-box;
    }

    /* 顯示區 */
    .display {
      position: relative;
      background: #111;
      min-height: 120px;
      color: #fff;
      padding: 20px;
      display: flex;
      justify-content: flex-end;
      align-items: flex-end;
      text-align: right;
      font-weight: 600;
      overflow-wrap: break-word;
      word-break: break-all;
      overflow-y: auto;
    }
    .display-inner {
      font-size: 60px;
      line-height: 1.2;
      white-space: normal;
    }
    .unit {
      font-size: 0.35em;
      opacity: 0.8;
      margin-right: 0.15em;
    }
    .resistor-display {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    .color-row {
      font-size: 24px;
      opacity: 0.8;
      margin-bottom: 8px;
    }
    .value-row {
      font-size: 30px;
    }
    .color-name {
      display: inline-block;
      padding: 2px 4px;
      border-radius: 3px;
      margin-right: 4px;
    }

    /* 模式切換鈕 */
    .mode-btn {
      position: absolute;
      top: 6px;
      left: 6px;
      z-index: 10;
      padding: 3px 10px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      background: #555;
      color: #fff;
      cursor: pointer;
      user-select: none;
    }
    .mode-btn:active {
      transform: scale(0.97);
    }

    /* 按鈕 */
    .buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .btn {
      width: 100%;
      aspect-ratio: 1/1;
      border: none;
      border-radius: 50%;
      background: #333;
      color: #fff;
      font-size: 36px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      box-shadow: 0 4px 0 #111;
      transition: 0.15s background-color, 0.05s transform, 0.05s box-shadow;
    }
    .btn:active {
      transform: translateY(3px);
      box-shadow: 0 1px 0 #000;
    }
    .btn:hover {
      background: #555;
    }
    .btn.gray {
      background: #a5a5a5;
      color: #000;
    }
    .btn.gray:hover {
      background: #b5b5b5;
    }
    .btn.orange {
      background: #f5a623;
      color: #fff;
    }
    .btn.orange:hover {
      background: #ffbf4a;
    }
    .btn.currency {
      font-size: 20px;
    }
    .btn.small-text {
      font-size: 24px;
    }
    button:disabled {
      opacity: 0.35;
      pointer-events: none;
    }

    /* 彩色鍵（無白邊） */
    .color-btn {
      font-size: 26px;
      line-height: 1.1;
    }
    .color-btn span {
      display: block;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="calculator">
    <div class="display">
      <button class="mode-btn" id="modeBtn" onclick="toggleMode()">色碼</button>
      <div class="display-inner" id="displayInner">0</div>
    </div>
    <div class="buttons">
      <!-- 第一排 -->
      <button class="btn gray small-text" id="taxPlusBtn" onclick="taxPlus()">Tax＋</button>
      <button class="btn gray small-text" id="taxMinusBtn" onclick="taxMinus()">Tax−</button>
      <button class="btn gray" id="backBtn" onclick="backspace()">⌫</button>
      <button class="btn orange" id="sqrtBtn" onclick="sqrtVal()">√</button>
      <!-- 第二排 -->
      <button class="btn gray" id="clearBtn" onclick="clearDisplay()">C</button>
      <button class="btn gray" id="goldBtn" onclick="handleTol('gold')">±</button>
      <button class="btn gray" id="silverBtn" onclick="handleTol('silver')">%</button>
      <button class="btn orange" id="divBtn" onclick="setOp('/')">÷</button>
      <!-- 第三～五排：0-9 -->
      <button class="btn" data-digit="7" onclick="handleDigit('7')">7</button>
      <button class="btn" data-digit="8" onclick="handleDigit('8')">8</button>
      <button class="btn" data-digit="9" onclick="handleDigit('9')">9</button>
      <button class="btn orange" id="mulBtn" onclick="setOp('*')">×</button>
      <button class="btn" data-digit="4" onclick="handleDigit('4')">4</button>
      <button class="btn" data-digit="5" onclick="handleDigit('5')">5</button>
      <button class="btn" data-digit="6" onclick="handleDigit('6')">6</button>
      <button class="btn orange" id="subBtn" onclick="setOp('-')">−</button>
      <button class="btn" data-digit="1" onclick="handleDigit('1')">1</button>
      <button class="btn" data-digit="2" onclick="handleDigit('2')">2</button>
      <button class="btn" data-digit="3" onclick="handleDigit('3')">3</button>
      <button class="btn orange" id="addBtn" onclick="setOp('+')">+</button>
      <!-- 第六排 -->
      <button class="btn orange currency" id="currencyBtn" onclick="toggleCur()">轉新<br>台幣</button>
      <button class="btn" data-digit="0" onclick="handleDigit('0')">0</button>
      <button class="btn" id="dotBtn" onclick="append('.')">.</button>
      <button class="btn orange" id="equalsBtn" onclick="evalCalc()">＝</button>
    </div>
  </div>
  <script>
    /* ===== 模式與基礎元素 ===== */
    let mode = 'calc'; // 'calc' | 'resistor'
    const disp = document.getElementById('displayInner');
    const modeBtn = document.getElementById('modeBtn');
    const goldBtn = document.getElementById('goldBtn');
    const silverBtn = document.getElementById('silverBtn');

    /* ===== 計算機邏輯 ===== */
    let cur = '0', prev = null, op = null, last = null;
    let unit = 'CNY', showU = false, wait = false, rate = 0.2462;
    (async () => {
      try {
        rate = (await (await fetch('https://api.exchangerate-api.com/v4/latest/TWD')).json()).rates.CNY;
      } catch {
        console.warn('Failed to fetch exchange rate, using default rate: 0.2462');
      }
    })();
    const fmt = n => Number((+n).toFixed(8)).toString();
    function fit() {
      const L = cur.length + (showU ? 2 : 0);
      disp.style.fontSize = (L <= 5 ? 60 : L >= 10 ? 30 : 60 - (L - 5) * 6) + 'px';
    }
    function upd() {
      if (mode !== 'calc') return;
      const u = showU ? (unit === 'TWD' ? 'NT$' : '¥') : '';
      disp.innerHTML = u ? `<span class="unit">${u}</span>${cur}` : cur;
      disp.classList.remove('resistor-display');
      disp.style.fontSize = ''; // Reset font size for calculator mode
      fit();
    }
    function append(v) {
      if (mode !== 'calc') return;
      if (cur === 'Error') cur = '0';
      if (last !== null && op === null && !['±', '%', '.'].includes(v)) {
        cur = '0';
        last = null;
      }
      if (wait) {
        cur = (v === '.' ? '0' : '') + v;
        wait = false;
      } else {
        if (v === '.' && cur.includes('.')) return;
        if (v === '±') cur = fmt(-parseFloat(cur));
        else if (v === '%') cur = fmt(parseFloat(cur) / 100);
        else cur = cur === '0' ? v : cur + v;
      }
      showU = false;
      upd();
    }
    function operate(a, b, o) {
      const r = { '+': a + b, '-': a - b, '*': a * b, '/': b ? a / b : NaN }[o];
      return isNaN(r) || !isFinite(r) ? 'Error' : r;
    }
    function setOp(o) {
      if (mode !== 'calc' || cur === 'Error') return;
      if (op && !wait) {
        const r = operate(prev, +cur, op);
        if (r === 'Error') {
          cur = 'Error';
          prev = op = null;
          wait = false;
          upd();
          return;
        }
        prev = r;
        cur = fmt(r);
        upd();
      } else {
        prev = +cur;
      }
      op = o;
      wait = true;
      showU = false;
    }
    function clearDisplay() {
      if (mode === 'calc') {
        cur = '0';
        prev = op = last = null;
        wait = showU = false;
        unit = 'CNY';
        document.getElementById('currencyBtn').innerHTML = '轉新<br>台幣';
        upd();
      } else {
        resetResistor();
      }
    }
    function calc() {
      if (mode !== 'calc' || cur === 'Error') return;
      if (!op || prev === null) return;
      const r = operate(prev, +cur, op);
      cur = r === 'Error' ? 'Error' : fmt(r);
      last = +cur;
      prev = op = null;
      wait = false;
      showU = false;
      upd();
    }
    function toggleCur() {
      if (mode !== 'calc' || cur === 'Error') return;
      const v = +cur;
      if (isNaN(v)) return;
      const currencyBtn = document.getElementById('currencyBtn');
      if (unit === 'TWD') {
        cur = fmt(v * rate);
        unit = 'CNY';
        currencyBtn.innerHTML = '轉新<br>台幣';
      } else {
        cur = fmt(v / rate);
        unit = 'TWD';
        currencyBtn.innerHTML = '轉人<br>民幣';
      }
      last = +cur;
      showU = true;
      upd();
    }
    function taxPlus() {
      if (mode !== 'calc' || cur === 'Error') return;
      const v = +cur;
      if (!isNaN(v)) {
        cur = fmt(v * 1.05);
        last = +cur;
        showU = false;
        upd();
      }
    }
    function taxMinus() {
      if (mode !== 'calc' || cur === 'Error') return;
      const v = +cur;
      if (!isNaN(v)) {
        cur = fmt(v / 1.05);
        last = +cur;
        showU = false;
        upd();
      }
    }
    function backspace() {
      if (mode !== 'calc' || cur === 'Error') return;
      if (wait) {
        cur = '0';
        wait = false;
      } else {
        cur = cur.length > 1 ? cur.slice(0, -1) : '0';
      }
      upd();
    }
    function sqrtVal() {
      if (mode !== 'calc' || cur === 'Error') return;
      const v = +cur;
      if (isNaN(v) || v < 0) {
        cur = 'Error';
        upd();
        return;
      }
      cur = fmt(Math.sqrt(v));
      last = +cur;
      showU = false;
      upd();
    }

    /* ===== 色碼電阻 ===== */
    const colorNames = ['黑', '棕', '紅', '橙', '黃', '綠', ' 藍', '紫', '灰', '白'];
    const colorHex = ['#000', '#8B4513', '#FF0000', '#FFA500', '#FFFF00', '#008000', '#0000FF', '#9400D3', '#808080', '#FFF'];
    const multLabels = ['10⁰', '10¹', '10²', '10³', '10⁴', '10⁵', '10⁶', '10⁷', '10⁸', '10⁹'];
    let digits = [], multExp = null, tol = '';
    function resetResistor() {
      digits = [];
      multExp = null;
      tol = '';
      updateResPreview();
      updateDigitButtons();
      updateTolButtons(false);
    }
    function handleDigit(d) {
      if (mode === 'calc') append(d);
      else selectDigit(parseInt(d, 10));
    }
    function selectDigit(num) {
      if (digits.length < 2) {
        digits.push(num);
        if (digits.length === 1) updateDigitButtons(false);
        if (digits.length === 2) updateDigitButtons(true);
      } else if (multExp === null) {
        multExp = num;
        updateDigitButtons(false, true);
        updateTolButtons(true);
      }
      updateResPreview();
    }
    function handleTol(t) {
      if (mode === 'calc') {
        append(t === 'gold' ? '±' : '%');
        return;
      }
      if (digits.length < 2 || multExp === null) return;
      tol = t === 'gold' ? '±5%' : '±10%';
      updateResPreview();
    }
    function formatOhm(v) {
      if (v >= 1e9) return (v / 1e9).toString().replace(/\.0+$/, '') + ' GΩ';
      if (v >= 1e6) return (v / 1e6).toString().replace(/\.0+$/, '') + ' MΩ';
      if (v >= 1e3) return (v / 1e3).toString().replace(/\.0+$/, '') + ' kΩ';
      return v + ' Ω';
    }

    /* ===== 顯示色碼與數值 ===== */
    function getColorStyle(index) {
      const isYellowOrWhite = index === 4 || index === 9;
      return `background:${colorHex[index]};color:${isYellowOrWhite ? '#000' : '#fff'}`;
    }
    function updateResPreview() {
      let colorTxt = '選 3+1 色環';
      let valueTxt = '';
      if (digits.length === 1) {
        colorTxt = `<span class="color-name" style="${getColorStyle(digits[0])}">${colorNames[digits[0]]}</span>`;
        valueTxt = '' + digits[0];
      } else if (digits.length === 2 && multExp === null) {
        colorTxt = `<span class="color-name" style="${getColorStyle(digits[0])}">${colorNames[digits[0]]}</span> <span class="color-name" style="${getColorStyle(digits[1])}">${colorNames[digits[1]]}</span>`;
        valueTxt = '' + digits[0] + digits[1];
      } else if (digits.length >= 2 && multExp !== null) {
        colorTxt = `<span class="color-name" style="${getColorStyle(digits[0])}">${colorNames[digits[0]]}</span> <span class="color-name" style="${getColorStyle(digits[1])}">${colorNames[digits[1]]}</span> <span class="color-name" style="${getColorStyle(multExp)}">${colorNames[multExp]}</span>`;
        const val = (digits[0] * 10 + digits[1]) * 10 ** multExp;
        valueTxt = formatOhm(val) + (tol ? ' ' + tol : '');
      }
      if (tol) {
        const tolColor = tol === '±5%' ? '#d4af37' : '#c0c0c0';
        const tolName = tol === '±5%' ? '金' : '銀';
        colorTxt += ` <span class="color-name" style="background:${tolColor};color:#fff">${tolName}</span>`;
      }
      disp.innerHTML = `<div class="color-row">${colorTxt}</div><div class="value-row">${valueTxt}</div>`;
      disp.classList.add('resistor-display');
    }

    function evalCalc() {
      if (mode === 'calc') calc();
      else confirmRes();
    }
    function confirmRes() {
      if (digits.length < 2 || multExp === null) return;
      if (!tol) tol = '±20%';
      const val = (digits[0] * 10 + digits[1]) * 10 ** multExp;
      const tolColor = tol === '±5%' ? '#d4af37' : '#c0c0c0';
      const tolName = tol === '±5%' ? '金' : '銀';
      disp.innerHTML = `<div class="color-row"><span class="color-name" style="${getColorStyle(digits[0])}">${colorNames[digits[0]]}</span> <span class="color-name" style="${getColorStyle(digits[1])}">${colorNames[digits[1]]}</span> <span class="color-name" style="${getColorStyle(multExp)}">${colorNames[multExp]}</span> <span class="color-name" style="background:${tolColor};color:#fff">${tolName}</span></div><div class="value-row">${formatOhm(val)} ${tol}</div>`;
      disp.classList.add('resistor-display');
      disp.style.fontSize = '20px';
      resetResistor();
    }

    /* ===== UI：模式切換與按鈕更新 ===== */
    function toggleMode() {
      if (mode === 'calc') {
        mode = 'resistor';
        modeBtn.textContent = '計算機';
        colorizeDigits(true);
        setTolLabels(true);
        disableIrrelevant(true);
        resetResistor();
      } else {
        mode = 'calc';
        modeBtn.textContent = '色碼';
        colorizeDigits(false);
        setTolLabels(false);
        disableIrrelevant(false);
        cur = '0';
        prev = op = last = null;
        wait = showU = false;
        unit = 'CNY';
        document.getElementById('currencyBtn').innerHTML = '轉新<br>台幣';
        upd();
      }
    }
    function colorizeDigits(on) {
      document.querySelectorAll('.btn[data-digit]').forEach(btn => {
        const d = parseInt(btn.dataset.digit, 10);
        if (on) {
          btn.innerHTML = `${d}<span>${colorNames[d]}</span>`;
          btn.style.background = colorHex[d];
          btn.style.color = (d === 4 || d === 9) ? '#000' : '#fff';
          btn.classList.add('color-btn');
        } else {
          btn.innerHTML = d;
          btn.style.background = '#333';
          btn.style.color = '#fff';
          btn.classList.remove('color-btn');
          btn.disabled = false;
        }
      });
    }
    function setTolLabels(on) {
      if (on) {
        goldBtn.textContent = '金';
        goldBtn.style.background = '#d4af37';
        goldBtn.style.color = '#000';
        silverBtn.textContent = '銀';
        silverBtn.style.background = '#c0c0c0';
        silverBtn.style.color = '#000';
      } else {
        goldBtn.textContent = '±';
        goldBtn.style.background = '#a5a5a5';
        goldBtn.style.color = '#000';
        silverBtn.textContent = '%';
        silverBtn.style.background = '#a5a5a5';
        silverBtn.style.color = '#000';
        goldBtn.disabled = false;
        silverBtn.disabled = false;
      }
    }
    const keepIds = ['clearBtn', 'goldBtn', 'silverBtn'];
    function disableIrrelevant(disable) {
      document.querySelectorAll('.btn').forEach(btn => {
        const isDigit = btn.dataset.digit !== undefined;
        const keep = isDigit || keepIds.includes(btn.id);
        btn.disabled = disable ? !keep : false;
      });
    }
    function updateDigitButtons(showMultipliers = false, disableAll = false) {
      document.querySelectorAll('.btn[data-digit]').forEach(btn => {
        const d = parseInt(btn.dataset.digit, 10);
        if (disableAll) {
          btn.disabled = true;
        } else if (showMultipliers) {
          btn.innerHTML = `${multLabels[d]}`;
          btn.style.background = colorHex[d];
          btn.style.color = (d === 4 || d === 9) ? '#000' : '#fff';
          btn.classList.add('color-btn');
          btn.disabled = false;
        } else {
          btn.innerHTML = `${d}<span>${colorNames[d]}</span>`;
          btn.style.background = colorHex[d];
          btn.style.color = (d === 4 || d === 9) ? '#000' : '#fff';
          btn.classList.add('color-btn');
          btn.disabled = (digits.length === 0 && d === 0);
        }
      });
    }
    function updateTolButtons(enable) {
      goldBtn.disabled = !enable;
      silverBtn.disabled = !enable;
    }

    /* ===== 初始顯示 ===== */
    upd();
  </script>
</body>
</html>