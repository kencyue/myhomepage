<!DOCTYPE html> 
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¢¨çˆ¾æœ¬å¤§å¯Œç¿ (æ”¹è‰¯ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        html, body {
    /* å¾¹åº•ç¦æ­¢ iPad æ‰‹å‹¢èˆ‡æ»¾å‹•å›å½ˆï¼Œé¿å…èª¤è§¸æ”¾å¤§ */
    position: fixed;
    overflow: hidden;
    width: 100%;
    height: 100%;
    /* ç¦æ­¢é¸å–èˆ‡å‘¼å«èœå–® */
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
    touch-action: none; /* ç¦ç”¨æ‰€æœ‰é è¨­æ‰‹å‹¢ï¼Œç”±æˆ‘å€‘æ§åˆ¶ */
}
        /* å®šç¾©æ£‹å­é¡è‰² */
        .player-0 { background-color: #ef4444; } /* ç´…è‰² */
        .player-1 { background-color: #3b82f6; } /* è—è‰² */
        .player-2 { background-color: #10b981; } /* ç¶ è‰² */
        .player-3 { background-color: #f59e0b; } /* é»ƒè‰² */

        /* Card Modal æ¨£å¼ï¼Œç¢ºä¿é«˜å°æ¯”åº¦ */
        .card-chance { background-color: #ffedd5; border: 3px solid #f97316; color: #1f2937; }
        .card-fate { background-color: #fee2e2; border: 3px solid #ef4444; color: #1f2937; }

        /* Casino å‹•ç•« */
        @keyframes slotMachineSpin {
            0% { transform: translateY(0) rotateX(0deg); opacity: 1; }
            50% { transform: translateY(-10px) rotateX(10deg); opacity: 0.8; }
            100% { transform: translateY(0) rotateX(0deg); opacity: 1; }
        }
        .slot-spinning {
            animation: slotMachineSpin 0.1s infinite alternate;
        }
        
        /* ä¿®æ­£: é€šç”¨æ¨¡æ…‹è¦–çª—å¤§å°èª¿æ•´ */
        #modal > div {
             max-width: 90%;
             max-height: 90vh;
             overflow-y: auto;
        }
        /* ä¿®æ­£: æ¨¡æ…‹è¦–çª—å…§å®¹å€åŸŸæ»¾å‹• */
        #modal-content {
             max-height: 70vh;
             overflow-y: auto;
             padding-right: 0.5rem;
        }
        
        /* [RWD ä¿®æ­£] æ£‹ç›¤æ–¹æ ¼é«˜åº¦åœ¨å°è¢å¹•ä¸Šæ›´é«˜ */
        #board-display > div {
             min-height: 10rem; 
        }

        /* [RWD ä¿®æ­£] è®“æ£‹ç›¤å®¹å™¨åœ¨æ‰‹æ©Ÿä¸Šå¡«å……æ›´å¤šç©ºé–“ */
        #board-container {
             width: 100%;
        }
        
        /* æ”¾å¤§ç©å®¶å¡ç‰‡é ­åƒ (w-12 h-12 = 48px) */
        .player-avatar-large {
            width: 48px; 
            height: 48px; 
        }
        
        /* NEW: æ£‹å­å¹³æ»‘éæ¸¡ */
        .player-token-container {
            /* ç‚ºäº†è®“å­å…ƒç´ èƒ½å¤ çµ•å°å®šä½åœ¨çˆ¶å…ƒç´ åº•éƒ¨ */
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 5px; /* ç¨å¾®æŠ¬å‡æ£‹å­ï¼Œä½¿å…¶ä¸è²¼ä½é‚Šç•Œ */
        }
        .player-token-inner {
            width: 40px; 
            height: 40px;
            font-size: 1.25rem;
            font-weight: bold;
            color: white;
            border-radius: 9999px; /* rounded-full */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* shadow-xl */
            border-width: 4px;
            border-style: solid;
            border-color: #facc15; /* border-yellow-400 */
            transition: all 0.3s ease-in-out;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* NEW: éª°å­å‹•ç•«æ¨£å¼ */
        @keyframes diceSpin {
            0% { transform: rotate(0deg) scale(1); opacity: 1; }
            25% { transform: rotate(10deg) scale(1.05); opacity: 0.9; }
            50% { transform: rotate(-10deg) scale(1); opacity: 1; }
            75% { transform: rotate(5deg) scale(1.05); opacity: 0.9; }
            100% { transform: rotate(0deg) scale(1); opacity: 1; }
        }

        .dice-spinning {
            animation: diceSpin 0.15s infinite; /* ä½¿ç”¨è¼ƒå¿«çš„é€Ÿåº¦ç„¡é™æ¬¡å‹•ç•« */
        }
        
        /* NEW: æˆ¿å±‹/å…¬å¯“/å¤§æ¨“æ¨™èªŒ */
        .house-icon {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 3px;
            margin-left: 2px;
            font-size: 8px;
            line-height: 14px;
            text-align: center;
            color: white;
            font-weight: bold;
        }
        .house { background-color: #34d399; } /* ç¶ è‰² (House) */
        .apartment { background-color: #3b82f6; } /* è—è‰² (Apartment) - 2 & 3 houses */
        .skyscraper { background-color: #ef4444; } /* ç´…è‰² (Skyscraper) - 4 houses */
        
/* ç§»é™¤æ‰€æœ‰äº’å‹•å…ƒç´ çš„é›™æ“Šç¸®æ”¾å»¶é² */
button, a, .cursor-pointer, #board-display > div {
    touch-action: manipulation;
    -webkit-user-select: none; /* é˜²æ­¢é•·æŒ‰é¸å–æ–‡å­—æ–‡å­— */
    user-select: none;
}

body {
    /* ä¿®æ­£ iPad å…¨è¢å¹•æ»¾å‹•é«”é©— */
    overscroll-behavior: none;
}

        #app {
    /* è®“å…§å®¹åœ¨å›ºå®šå®¹å™¨å…§æ»¾å‹• */
    overflow-y: auto;
    height: 100vh;
    -webkit-overflow-scrolling: touch;
}

/* æ£‹ç›¤èˆ‡æŒ‰éˆ•å…è¨±é»æ“Š */
#board-container, button, .cursor-pointer {
    touch-action: manipulation !important;
}
    </style>
</head>
<body>

    <div id="app" class="min-h-screen pt-16 p-4 md:p-8 flex flex-col items-center">
        <h1 id="game-title" class="text-3xl md:text-4xl font-extrabold mb-4 text-indigo-700 cursor-pointer select-none">å¢¨çˆ¾æœ¬å¤§å¯Œç¿ (128 æ ¼)</h1>
        
        <div class="flex items-center space-x-4 mb-4">
            <p class="text-xs md:text-sm text-gray-500">
                å›åˆ: <span id="turn-display" class="font-mono text-xs text-gray-800">1</span>
                | ç•¶å‰ç©å®¶ ID: <span id="user-id-display" class="font-mono text-xs text-gray-800">è¼‰å…¥ä¸­...</span>
            </p>
        </div>
        
        <div id="admin-alert-area" class="w-full max-w-6xl mb-4">
            </div>

        <div id="admin-buttons-container" class="fixed top-4 right-4 flex space-x-3 z-50">
            <button id="player-admin-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-200 text-xs md:text-sm hidden">
                ğŸ‘¤ ç©å®¶ç®¡ç†
            </button>
            <button id="settings-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-200 text-xs md:text-sm hidden">
                âš™ï¸ è¨­å®š
            </button>
        </div>
        
        <button id="request-join-btn" class="fixed top-4 right-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-200 z-50 text-xs md:text-sm hidden">
            ğŸ”— è«‹æ±‚åŠ å…¥éŠæˆ²
        </button>


        <div class="w-full max-w-6xl bg-white shadow-xl rounded-xl p-4 md:p-6 mb-8">

            <div id="player-stats" class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-6 md:mb-8">
                </div>

<div id="game-controls" class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 md:space-x-4 mb-6 md:mb-8">
    <div class="flex space-x-4 items-center w-full md:w-auto">
        <button id="roll-dice-btn" class="w-24 md:w-28 flex-shrink-0 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200 disabled:opacity-50 text-sm md:text-base" disabled>
            æ“²éª°
        </button>
        
        <input type="number" id="debug-steps-input" min="2" max="12" value="7" placeholder="æ­¥æ•¸ (2-12)"
               class="w-20 flex-shrink-0 p-2 border-2 border-red-500 rounded-lg shadow-md text-center text-sm font-bold text-red-600 focus:outline-none focus:ring-2 focus:ring-red-600"
               style="display: none;" />
        
        <div class="flex items-center justify-center p-2 bg-gray-100 rounded-lg shadow-inner w-28 h-12 border-2 border-gray-300 space-x-2 flex-shrink-0">
            <img id="dice-display-1" src="images/dice1.png" alt="Dice 1" class="w-8 h-8 md:w-10 md:h-10 transition duration-100">
            <img id="dice-display-2" src="images/dice2.png" alt="Dice 2" class="w-8 h-8 md:w-10 md:h-10 transition duration-100">
        </div>
    </div>
    <div class="flex space-x-2 w-full md:w-auto justify-end">
        
        <div id="extra-actions" class="flex space-x-2">
            <button id="buy-property-btn" onclick="window.showPropertyBuyModalWrapper()" class="flex-grow bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg shadow-sm transition duration-200 hidden disabled:opacity-50 text-sm">
                ğŸ  è³¼è²·åœ°ç”¢
            </button>
            <button id="manage-property-btn" onclick="window.showPropertyManagementModalWrapper()" class="flex-grow bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg shadow-sm transition duration-200 hidden disabled:opacity-50 text-sm">
                ğŸ—ï¸ åœ°ç”¢ç®¡ç†
            </button>
            <button id="use-trap-card-btn" onclick="window.showTrapTargetModalWrapper()" class="flex-grow bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg shadow-sm transition duration-200 hidden disabled:opacity-50 text-sm">
                ğŸ˜ˆ ä½¿ç”¨é™·å®³å¡
            </button>
        </div>

        <button id="bank-btn" onclick="window.showBankModal(gameState.players[gameState.turn])" class="flex-grow bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg shadow-sm transition duration-200 hidden disabled:opacity-50 text-sm" disabled>
            éŠ€è¡Œ
        </button>
        <button id="casino-btn" onclick="window.showCasinoModal(gameState.players[gameState.turn])" class="flex-grow bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-3 rounded-lg shadow-sm transition duration-200 disabled:opacity-50 text-sm" disabled>
            ğŸ° Casino
        </button>
        <button id="end-turn-btn" 
                class="flex-grow bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-200 
                       disabled:opacity-50 disabled:bg-gray-400 disabled:shadow-md text-sm md:text-base" disabled>
            çµæŸå›åˆ
        </button>
    </div>
</div>

            <div id="game-controls-emergency-area" class="w-full">
                </div>

            <div class="bg-gray-50 p-4 rounded-lg shadow-inner max-h-40 overflow-y-auto mb-6">
                <h3 class="text-lg font-semibold mb-2 text-gray-700">éŠæˆ²æ—¥èªŒ</h3>
                <ul id="game-log" class="text-sm space-y-1"></ul>
            </div>

            <div id="board-container" class="overflow-x-auto p-2 bg-gray-100 rounded-lg border border-gray-200">
                <div id="board-display" class="flex space-x-2 pb-2">
                    </div>
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm md:max-w-md lg:max-w-lg">
            <div class="flex justify-between items-center mb-4">
                        <h3 id="modal-title" class="text-xl font-bold text-gray-800">æ“ä½œ</h3>
                        <button id="modal-top-close-btn" class="text-gray-400 hover:text-gray-600 text-2xl font-bold leading-none">&times;</button>
            </div>
            
            <p id="modal-message" class="mb-6 text-gray-600"></p>
            <div id="modal-content" class="mb-4 max-h-[70vh] overflow-y-auto pr-2"> 
                </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="modal-cancel-btn" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-150">å–æ¶ˆ</button>
                <button id="modal-confirm-btn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150">ç¢ºèª</button>
            </div>
        </div>
    </div>
    
    <div id="card-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div id="card-content" class="w-full max-w-sm rounded-xl shadow-2xl p-6 text-center card-chance">
            <h3 id="card-modal-title" class="2xl font-bold mb-4">å¡ç‰‡äº‹ä»¶</h3>
            <p id="card-modal-message" class="mb-8 text-lg font-semibold"></p>
            <button id="card-modal-confirm-btn" class="py-2 px-6 bg-white text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-100 transition duration-150">ç¢ºèª</button>
        </div>
    </div>

    <script>
        // 1. å°ˆæ¡ˆ ID (ç”¨æ–¼æ§‹å»º Firestore è·¯å¾‘)
        const __app_id = "monoploy-c3855"; 
        
        // 2. Firebase é…ç½®ç‰©ä»¶çš„ JSON å­—ç¬¦ä¸²ç‰ˆæœ¬ (åŒ…å«æ‚¨çš„ apiKey, projectId ç­‰)
        const __firebase_config = '{"apiKey":"AIzaSyCUNXRAPewJkvvMqkRU4aTPY1nb268UBso","authDomain":"monoploy-c3855.firebaseapp.com","projectId":"monoploy-c3855","storageBucket":"monoploy-c3855.firebasestorage.app","messagingSenderId":"452296239400","appId":"1:452296239400:web:2b15915e5b79005771081d","measurementId":"G-84MF1YMSED"}';
        
        // 3. åˆå§‹é©—è­‰ Token
        const __initial_auth_token = ""; 

        const firebaseConfig = JSON.parse(__firebase_config);
    </script>
    <script type="module">

        import { 
            initializeApp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            getDoc, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'loading';
        let gameRef; 
        let isListenerInitialized = false; 
        let previousPlayersState = null; 
        let isRestoringModal = false;
        
        // ã€NEW: é–å®šè®Šæ•¸ã€‘é˜²æ­¢æŒ‰éˆ•é»æ“Šå¾Œï¼Œè‡ªå‹•æ¢å¾©æ©Ÿåˆ¶å†æ¬¡è§¸ç™¼å½ˆçª—
        let isProcessingAction = false; 

        let gameState = null;
        const totalSquares = 128;
        const MOVE_DELAY = 200;
        
        const DEFAULT_INITIAL_MONEY = 15000; 

        const PLAYER_COLORS = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b'];
        const PLAYER_NAMES = ['ç´…ç©å®¶', 'è—ç©å®¶', 'ç¶ ç©å®¶', 'é»ƒç©å®¶'];
        
        // NEW: éš±è—åŠŸèƒ½é»æ“Šé–“éš”
        const CLICK_THRESHOLD = 300; // milliseconds
        let clickCount = 0;
        let lastClickTime = 0;
        const TAKEOVER_TIMEOUT_MS = 60000; // 60 ç§’éæ´»èºæ™‚é–“æ‰èƒ½æ¥ç®¡
        
        // NEW: éª°å­åœ–ç‰‡è·¯å¾‘æ˜ å°„
        const DICE_IMAGES = {
            1: 'images/dice1.png',
            2: 'images/dice2.png',
            3: 'images/dice3.png',
            4: 'images/dice4.png',
            5: 'images/dice5.png',
            6: 'images/dice6.png',
        };

        // --- 2. éŠæˆ²è³‡æ–™å®šç¾© ---

        const DEFAULT_INTEREST_RATE = 0.01; 
        const DEFAULT_VOLATILITY = 50; 
        
        // ** NEW: æˆ¿ç”¢é–‹ç™¼é…ç½® **
        const HOUSE_CONFIG = {
            // æˆ¿å±‹å»ºè¨­æˆæœ¬ (ä½”åœ°ç”¢åƒ¹æ ¼çš„æ¯”ä¾‹)
            COST_MULTIPLIER: 0.5, 
            // æˆ¿å±‹æ•¸é‡çš„ç§Ÿé‡‘å€ç‡ (0: åŸºç¤ç§Ÿé‡‘, 1: 1 æˆ¿, 2: 2 æˆ¿, 3: 3 æˆ¿, 4: å¤§æ¨“)
            RENT_MULTIPLIERS: [1, 3, 5, 7, 10], 
            MAX_HOUSES: 4, // 0 æˆ¿ + 4 ç´šé–‹ç™¼ = 5 å€‹ç‹€æ…‹
            MORTGAGE_MULTIPLIER: 0.5, // æŠµæŠ¼é‡‘æ¯”ä¾‹
            MORTGAGE_SELL_TAX: 0.1, // è§£é™¤æŠµæŠ¼çš„ç¨…ç‡
        };
        // ** END NEW **

        const STOCKS_INITIAL_CONFIG = [
            { name: "Victorian Rail", symbol: "VRA", price: 500, sellPrice: 400, volatility: 30 },
            { name: "Coffee Futures", symbol: "CFE", price: 750, sellPrice: 600, volatility: 50 },
            { name: "Tram Network", symbol: "TNM", price: 300, sellPrice: 250, volatility: 20 },
        ];
        
        const COLOR_MAP = {
            'bg-green-600': '#059669', 'bg-yellow-400': '#facc15', 'bg-gray-400': '#9ca3af', 'bg-red-600': '#dc2626', 
            'bg-purple-600': '#9333ea', 'bg-yellow-200': '#fef08a', 'bg-orange-400': '#fb923c', 'bg-red-400': '#f87171',
            'bg-green-500': '#22c55e', 'bg-indigo-300': '#a5b4fc', 'bg-sky-300': '#7dd3fc', 'bg-teal-300': '#5eead4', 
            'bg-pink-300': '#f9a8d4', 'bg-gray-100': '#f3f4f6', 
            'bg-red-900': '#7f1d1d', // æ‰€å¾—ç¨…
            'bg-pink-900': '#831843' // å¥¢ä¾ˆå“ç¨…
        };

        const CHANCE_CARDS = [
            { type: 'money', amount: 800, text: 'æ©Ÿæœƒ: æ‚¨çš„å»ºç¯‰è²¸æ¬¾é€šéå¯©æ ¸ã€‚ç²å¾— $800ã€‚' },
            { type: 'money', amount: -400, text: 'æ©Ÿæœƒ: å¸‚è­°æœƒè¦æ±‚æ¸…ç†ç’°å¢ƒã€‚æ”¯ä»˜ $400ã€‚' },
            { type: 'goto_jail', text: 'æ©Ÿæœƒ: æ‚¨çš„æ±½è»Šç™¼ç”Ÿå°äº‹æ•…ï¼Œè¢«è£å®šäº¤é€šé•è¦ã€‚å‰å¾€ç›£ç„ (Jail)ã€‚' },
            { type: 'trap_money', amount: -1000, text: 'æ©Ÿæœƒ: **é™·å®³å¡** - é¸æ“‡ä¸€ä½ç©å®¶ï¼Œä»–/å¥¹å¿…é ˆæ”¯ä»˜ $1000 çš„é«˜é¡ç½°æ¬¾ã€‚' }, // NEW TRAP
            { type: 'move_relative', amount: -3, text: 'æ©Ÿæœƒ: å¿˜è¨˜å¸¶é‘°åŒ™ã€‚å¾Œé€€ 3 æ ¼ã€‚' },
            { type: 'money', amount: -100, text: 'æ©Ÿæœƒ: å’–å•¡å› ä¸­æ¯’ï¼Œéœ€æ”¯ä»˜é†«ç™‚è²»ã€‚æ”¯ä»˜ $100ã€‚' },
            { type: 'move', target: 0, text: 'æ©Ÿæœƒ: ç«¶é¸æˆåŠŸã€‚å‰å¾€èµ·é» (GO)ï¼Œç²å¾— $2000ã€‚' },
            { type: 'money', amount: 600, text: 'æ©Ÿæœƒ: è´å¾—æ‹¼å­—å¤§è³½ã€‚ç²å¾— $600ã€‚' },
            { type: 'money', amount: -200, text: 'æ©Ÿæœƒ: è³¼è²·æ˜‚è²´çš„è¨­è¨ˆå¸«æœè£ã€‚æ”¯ä»˜ $200ã€‚' },
            { type: 'move_relative', amount: 4, text: 'æ©Ÿæœƒ: å¿«é€Ÿé€šè¡Œè­‰ã€‚å‰é€² 4 æ ¼ã€‚' }, 
        ];

        const FATE_CARDS = [
            { type: 'money', amount: -50, text: 'å‘½é‹: ææ¬¾çµ¦æµæµªå‹•ç‰©ä¹‹å®¶ã€‚æ”¯ä»˜ $50ã€‚' },
            { type: 'move_relative', amount: 5, text: 'å‘½é‹: æŠ„è¿‘è·¯ã€‚å‰é€² 5 æ ¼ã€‚' },
            { type: 'trap_jail', text: 'å‘½é‹: **é™·å®³å¡** - é¸æ“‡ä¸€ä½ç©å®¶ï¼Œä»–/å¥¹å› è©æ¬ºç½ªåè¢«é€å¾€ç›£ç„ (Jail)ã€‚' }, // NEW TRAP
            { type: 'money', amount: -1000, text: 'å‘½é‹: é­é‡ç¶“æ¿Ÿè©é¨™ã€‚æå¤± $1000ã€‚' },
            { type: 'goto_jail', text: 'å‘½é‹: è¢«æ‡·ç–‘åƒèˆ‡å…§ç·šäº¤æ˜“ã€‚å‰å¾€ç›£ç„ (Jail)ã€‚' },
            { type: 'money', amount: 750, text: 'å‘½é‹: æ‰¾åˆ°ä¸€ç­†è¢«éºå¿˜çš„ç¾é‡‘ã€‚ç²å¾— $750ã€‚' },
            { type: 'money', amount: -250, text: 'å‘½é‹: ç¹³ç´è±ªè¯éŠè‰‡åœæ³Šè²»ã€‚æ”¯ä»˜ $250ã€‚' },
            { type: 'money', amount: 300, text: 'å‘½é‹: æ‚¨çš„éŠ€è¡Œå­˜æ¬¾åˆ©æ¯åˆ°å¸³ã€‚ç²å¾— $300ã€‚' },
            { type: 'move', target: 127, text: 'å‘½é‹: è¢«é‚€è«‹åƒåŠ é ‚ç´šå³°æœƒã€‚ç›´æ¥å‰å¾€çµ‚é»ã€‚ç²å¾— $5000ã€‚', reward: 5000 },
            { type: 'move_relative', amount: -5, text: 'å‘½é‹: è¿·è·¯ã€‚å¾Œé€€ 5 æ ¼ã€‚' },
        ];


        const MELBOURNE_SUBURBS = [
            "Toorak", "Brighton", "South Yarra", "Kew", "Malvern", "Armadale", "Hawthorn", "Camberwell", "Balwyn", "Doncaster",
            "Box Hill", "Glen Waverley", "Mount Waverley", "Clayton", "Oakleigh", "Bundoora", "Preston", "Reservoir", "Brunswick", "Fitzroy",
            "Carlton", "Collingwood", "Richmond", "St Kilda", "Williamstown", "Footscray", "Sunshine", "Altona", "Werribee", "Tarneit",
            "Pakenham", "Cranbourne", "Berwick", "Narre Warren", "Dandenong", "Frankston", "Mornington", "Geelong", "Bendigo", "Ballarat",
            "Port Melbourne", "Docklands", "Southbank", "Melbourne CBD", "Northcote", "Thornbury", "Coburg", "Pascoe Vale", "Essendon", "Moonee Ponds",
            "Ascot Vale", "Flemington", "Kensington", "Newport", "Seddon", "Yarraville", "Spotswood", "Fairfield", "Alphington", "Ivanhoe",
            "Heidelberg", "Greensborough", "Diamond Creek", "Eltham", "Templestowe", "Ringwood", "Croydon", "Lilydale", "Belgrave", "Dandenongs",
            "Beaconsfield", "Officer", "Clyde", "Kilsyth", "Ferntree Gully", "Rowville", "Scoresby", "Mulgrave", "Notting Hill", "Burwood",
            "Ashburton", "Glen Iris", "Surrey Hills", "Mont Albert", "Deepdene", "Canterbury", "Middle Park", "Albert Park", "Elwood", "Caulfield",
            "Murrumbeena", "Carnegie", "Bentleigh", "Moorabbin", "Cheltenham", "Sandringham", "Black Rock", "Beaumaris", "Mordialloc", "Aspendale"
        ];

        const BOARD = [];
        
        // --- 5.1 ä¿®æ­£å¾Œçš„æ£‹ç›¤ç”Ÿæˆé‚è¼¯ (å›ºå®šé–“éš” + 44 å€‹ç‰¹æ®Šæ ¼) ---
        
        // æ ¸å¿ƒå›ºå®šè§’æ ¼ (ç§»é™¤ FREE_PARKING å’Œ GOTO_JAIL)
        const fixedCornerSquares = {
            0: { name: 'èµ·é» (GO)', type: 'START', color: 'bg-green-600', action: 2000 },
            32: { name: 'ç›£ç„ (JAIL)', type: 'JAIL', color: 'bg-yellow-400' }, // ç›£ç„æ ¼ (åªä¿ç•™ä¸€å€‹)
            64: { name: 'æ‰€å¾—ç¨… (10%)', type: 'INCOME_TAX', color: 'bg-red-900', action: 0.10 }, // æ–°å¢ç¨…å‹™æ ¼
            96: { name: 'å¥¢ä¾ˆå“ç¨… ($1000)', type: 'LUXURY_TAX', color: 'bg-pink-900', action: 1000 }, // æ–°å¢ç¨…å‹™æ ¼
            127: { name: 'çµ‚é»', type: 'FINISH', color: 'bg-purple-600', action: 5000 }
        };

        // ç¸½å…± 128 æ ¼ã€‚å›ºå®šè§’æ ¼ 5 å€‹ã€‚ç‰¹æ®Šæ ¼ç¸½æ•¸ç›®æ¨™ 44 å€‹ã€‚
        // å‹•æ…‹ç‰¹æ®Šæ ¼éœ€è¦ 44 - 5 = 39 å€‹ã€‚
        const numDynamicSpecial = 39;
        const numProperties = totalSquares - Object.keys(fixedCornerSquares).length - numDynamicSpecial; // 128 - 5 - 39 = 84 å€‹åœ°ç”¢

        // 39 å€‹å‹•æ…‹ç‰¹æ®Šé¡å‹åˆ†ä½ˆ (ç¸½æ•¸ 39)
        const specialCountsV4 = {
            BANK: 9,
            CHANCE: 10, // æ©Ÿæœƒå¡
            FATE: 10,   // å‘½é‹å¡
            CASINO: 10
        };

        // 1. æº–å‚™å‹•æ…‹ç‰¹æ®Šé¡å‹åˆ—è¡¨ (ç¸½æ•¸ 39)
        const dynamicTypesToAssign = [];
        for (const type in specialCountsV4) {
            for (let i = 0; i < specialCountsV4[type]; i++) {
                dynamicTypesToAssign.push(type);
            }
        }
        
        // Fisher-Yates Shuffle
        for (let i = dynamicTypesToAssign.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [dynamicTypesToAssign[i], dynamicTypesToAssign[j]] = [dynamicTypesToAssign[j], dynamicTypesToAssign[i]];
        }
        
        // 2. ç¢ºå®šå‹•æ…‹ç‰¹æ®Šæ ¼çš„ä½ç½®
        const dynamicSpecialIndices = [];
        for (let i = 0; i < totalSquares; i++) {
            if (!fixedCornerSquares[i]) {
                dynamicSpecialIndices.push(i);
            }
        }
        
        // éš¨æ©Ÿé¸å– 39 å€‹ä½ç½®ä½œç‚ºå‹•æ…‹ç‰¹æ®Šæ ¼
        const shuffledDynamicIndices = [];
        const indicesCopy = [...dynamicSpecialIndices];
        for (let i = 0; i < numDynamicSpecial; i++) {
            const randomIndex = Math.floor(Math.random() * indicesCopy.length);
            shuffledDynamicIndices.push(indicesCopy.splice(randomIndex, 1)[0]);
        }
        
        // 3. å‰µå»ºæœ€çµ‚çš„ç‰¹æ®Šæ ¼åœ°åœ– (åŒ…å«å›ºå®šè§’æ ¼å’Œå‹•æ…‹éš¨æ©Ÿæ ¼)
        const allSpecialMap = { ...fixedCornerSquares };
        shuffledDynamicIndices.forEach((index, i) => {
            if (dynamicTypesToAssign[i]) {
                const type = dynamicTypesToAssign[i];
                let name, color;
                if (type === 'BANK') { name = 'éŠ€è¡Œæœå‹™'; color = 'bg-yellow-200'; }
                else if (type === 'CHANCE') { name = 'æ©Ÿæœƒ'; color = 'bg-orange-400'; }
                else if (type === 'FATE') { name = 'å‘½é‹'; color = 'bg-red-400'; }
                else if (type === 'CASINO') { name = 'Casino'; color = 'bg-green-500'; }

                allSpecialMap[index] = { name, type, color };
            }
        });
        
        // 4. æ‰¾å‡ºæ‰€æœ‰åœ°ç”¢æ ¼å­çš„ä½ç½®ï¼Œä¸¦å‰µå»ºåœ°ç”¢ç‰©ä»¶
        const propLocations = [];
        for (let i = 0; i < totalSquares; i++) {
            if (!allSpecialMap[i]) {
                propLocations.push(i);
            }
        }

        const propSquares = [];
        for (let i = 0; i < numProperties; i++) {
             const basePrice = 1000 + Math.floor(i / 10) * 500;
             const name = MELBOURNE_SUBURBS[i % MELBOURNE_SUBURBS.length]; 
             const color = ['bg-indigo-300', 'bg-sky-300', 'bg-teal-300', 'bg-pink-300'][(i) % 4];
             
             // ** NEW: æˆ¿ç”¢é–‹ç™¼æ–°å¢æ¬„ä½ **
             const housePrice = Math.floor(basePrice * HOUSE_CONFIG.COST_MULTIPLIER);
             propSquares.push({ 
                 index: -1, 
                 name, 
                 type: 'PROPERTY', 
                 color, 
                 owner: null, 
                 houses: 0, // 0-4ï¼Œ4 è¡¨ç¤ºæœ€é«˜ç´šåˆ¥ï¼ˆå¤§æ¨“ï¼‰
                 mortgage: false, 
                 imageUrl: null, 
                 price: basePrice, 
                 rent: Math.floor(basePrice * 0.12), // åŸºç¤ç§Ÿé‡‘
                 housePrice: housePrice,
                 rentMultipliers: HOUSE_CONFIG.RENT_MULTIPLIERS // [1, 3, 5, 7, 10]
             });
             // ** END NEW **
        }
        
        // éš¨æ©Ÿæ‰“äº‚åœ°ç”¢æ ¼å­çš„å…§éƒ¨æ•¸æ“š
        for (let i = propSquares.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [propSquares[i], propSquares[j]] = [propSquares[j], propSquares[i]];
        }

        // 5. æ ¹æ“šæœ€çµ‚åœ°åœ–å’Œæ‰“äº‚å¾Œçš„åœ°ç”¢æ ¼å­å¡«å…… BOARD
        let propIndexCounter = 0;
        for (let i = 0; i < totalSquares; i++) {
             if (allSpecialMap[i]) {
                 BOARD.push({ ...allSpecialMap[i], index: i }); 
             } else if (propIndexCounter < propSquares.length) { // ç¢ºä¿ä¸æœƒè¶…å‡ºåœ°ç”¢æ ¼çš„æ•¸é‡
                 const prop = propSquares[propIndexCounter];
                 BOARD.push({ ...prop, index: i }); 
                 propIndexCounter++;
             } else {
                 // ç†è«–ä¸Šä¸æ‡‰ç™¼ç”Ÿï¼Œä½†ä½œç‚ºä¿éšª
                 BOARD.push({ index: i, name: `ç©ºç½® #${i}`, type: 'EMPTY', color: 'bg-gray-100' });
             }
        }
        
        // --- çµæŸ 5.1 ä¿®æ­£ ---
        
        const INITIAL_BOARD_STATE = BOARD.map(square => ({
             ...square, 
             imageUrl: square.imageUrl || null 
        }));

        // --- 3. éŠæˆ²é‚è¼¯èˆ‡ç‹€æ…‹ç®¡ç† ---

        function fluctuateStockPrices(stocks) {
            const newStocks = stocks.map(stock => {
                // ä¿®æ­£ï¼šä½¿ç”¨ settings.stocksConfig ä¸­çš„ volatilityï¼Œå› ç‚ºé‚£æ˜¯è¨­å®šçš„ä¾†æº
                const volatility = gameState.settings.stocksConfig.find(s => s.symbol === stock.symbol)?.volatility || stock.volatility;
                const fluctuation = Math.floor((Math.random() - 0.5) * volatility * 2);
                let newPrice = stock.price + fluctuation;
                const newSellPrice = Math.floor(newPrice * 0.8);
                newPrice = Math.max(newPrice, newSellPrice + 10);
                return { ...stock, price: newPrice, sellPrice: newSellPrice };
            });
            return newStocks;
        }

        function getInitialGameState(initialMoney = DEFAULT_INITIAL_MONEY) {
            const initialStocksHolding = STOCKS_INITIAL_CONFIG.reduce((acc, stock) => ({ ...acc, [stock.symbol]: 0 }), {});
            // FIX: ä¿®æ­£ reduce ç®­é ­å‡½å¼åƒæ•¸çš„æ‹¬è™ŸéŒ¯èª¤
            const initialPropertyImageUrls = INITIAL_BOARD_STATE.reduce((acc, square) => {
                 if (square.type === 'PROPERTY') { acc[square.name] = null; }
                 return acc;
             }, {});


            return {
                board: INITIAL_BOARD_STATE, 
                players: [
                    // åˆå§‹ç‹€æ…‹å…¨éƒ¨è¨­ç‚º falseï¼Œåªæœ‰ P0 æœƒåœ¨åˆå§‹åŒ–æ™‚è¢«è‡ªå‹•å•Ÿç”¨
                    { id: 'p0', name: PLAYER_NAMES[0], money: initialMoney, bank: 0, stocks: { ...initialStocksHolding }, position: 0, properties: [], isPlaying: false, inJail: false, jailTurns: 0, color: PLAYER_COLORS[0], currentUserId: null, avatarUrl: null, lastActiveTimestamp: Date.now(), trapCard: null }, // **NEW: trapCard æ¬„ä½**
                    { id: 'p1', name: PLAYER_NAMES[1], money: initialMoney, bank: 0, stocks: { ...initialStocksHolding }, position: 0, properties: [], isPlaying: false, inJail: false, jailTurns: 0, color: PLAYER_COLORS[1], currentUserId: null, avatarUrl: null, lastActiveTimestamp: Date.now(), trapCard: null }, // **NEW: trapCard æ¬„ä½**
                    { id: 'p2', name: PLAYER_NAMES[2], money: initialMoney, bank: 0, stocks: { ...initialStocksHolding }, position: 0, properties: [], isPlaying: false, inJail: false, jailTurns: 0, color: PLAYER_COLORS[2], currentUserId: null, avatarUrl: null, lastActiveTimestamp: Date.now(), trapCard: null }, // **NEW: trapCard æ¬„ä½**
                    { id: 'p3', name: PLAYER_NAMES[3], money: initialMoney, bank: 0, stocks: { ...initialStocksHolding }, position: 0, properties: [], isPlaying: false, inJail: false, jailTurns: 0, color: PLAYER_COLORS[3], currentUserId: null, avatarUrl: null, lastActiveTimestamp: Date.now(), trapCard: null }, // **NEW: trapCard æ¬„ä½**
                ],
                turn: 0, 
                dice: [1, 1], // åˆå§‹éª°å­é»æ•¸ç‚º 1, 1ï¼Œæ–¹ä¾¿é¡¯ç¤ºåœ–ç‰‡
                status: 'READY', 
                log: [{ text: 'æ–°éŠæˆ²é–‹å§‹! è«‹è¨­å®šéŠç©äººæ•¸ä¸¦æ“²éª°ã€‚', time: Date.now() }],
                activeUserIds: {}, 
                gameId: 'melbourne_monopoly_game',
                gameStarted: false, 
                currentStocks: STOCKS_INITIAL_CONFIG,
                pendingJoinRequests: {}, 
                settings: {
                    interestRate: DEFAULT_INTEREST_RATE,
                    stocksConfig: STOCKS_INITIAL_CONFIG, 
                    propertyImageUrls: initialPropertyImageUrls, 
                    initialMoney: DEFAULT_INITIAL_MONEY,
                    joinApprovalRequired: true, 
                    hotSwapMode: false, 
                    suburbSummaries: {}, 
                    // ** NEW: DEBUG æ¨¡å¼é–‹é—œ (é è¨­éš±è—) **
                    debugMode: false
                },
                // **NEW: æ–°å¢ pendingAction ç‹€æ…‹ä¾†è™•ç†è³¼è²·/é™·å®³å¡é‡é–‹å½ˆçª—çš„éœ€æ±‚**
                pendingAction: {
                    type: 'none', // 'BUY_PROPERTY', 'USE_TRAP_CARD', 'BANK_SERVICE', 'CASINO_GAME', 'PROPERTY_MANAGEMENT'
                    squareIndex: null,
                    card: null, // å„²å­˜é™·å®³å¡è³‡è¨Š
                },
                round: 1, // **NEW: æ–°å¢å›åˆæ•¸**
            };
        }
        
        // **NEW: è¨ˆç®—ç§Ÿé‡‘çš„è¼”åŠ©å‡½æ•¸**
        function calculateRent(square) {
            // é€™è£¡å¿…é ˆæª¢æŸ¥ square.rentMultipliers æ˜¯å¦å­˜åœ¨
            if (square.type !== 'PROPERTY' || square.mortgage || !square.rentMultipliers) return 0;
            
            // æˆ¿å±‹ç´šåˆ¥ (0=ç„¡æˆ¿, 1=1æˆ¿, 2=2æˆ¿, 3=3æˆ¿, 4=å¤§æ¨“)
            const level = square.houses; 
            // ç¢ºä¿ level åœ¨æœ‰æ•ˆç¯„åœå…§
            const multiplier = square.rentMultipliers[level] || 1; 
            
            return square.rent * multiplier;
        }


        async function updateGameState(newState, logText = null) {
            try {
                if (!gameRef) {
                    console.error('Firestore åƒè€ƒæœªåˆå§‹åŒ–.');
                    return;
                }
                const newLog = [...newState.log];
                if (logText) {
                    const time = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    newLog.unshift({ text: `[${time}] ${logText}`, time: Date.now() });
                    while (newLog.length > 30) {
                        newLog.pop();
                    }
                }
                
                // NEW LOGIC: Update lastActiveTimestamp for the controlling user's player(s)
                const now = Date.now();
                newState.players = newState.players.map(p => {
                    // æª¢æŸ¥ç•¶å‰ç”¨æˆ¶æ˜¯å¦æ§åˆ¶äº†é€™å€‹ç©å®¶
                    if (p.currentUserId === userId) {
                        return { ...p, lastActiveTimestamp: now };
                    }
                    return p;
                });
                // END NEW LOGIC
                
                await setDoc(gameRef, { ...newState, log: newLog });
            } catch (error) {
                console.error('æ›´æ–°éŠæˆ²ç‹€æ…‹å¤±æ•—:', error);
                addLog(`**æ›´æ–°å¤±æ•—**ï¼šç„¡æ³•å¯«å…¥æ•¸æ“šåº« (${error.message})`, 'error');
            }
        }

        function saveCurrentPlayerState(currentPlayer) {
            if (!gameState) return;
            const playerIndex = gameState.players.findIndex(p => p.id === currentPlayer.id);
            if (playerIndex === -1) return;

            gameState.players = gameState.players.map((p, index) => 
                index === playerIndex ? { 
                    ...currentPlayer, 
                    stocks: { ...currentPlayer.stocks },
                    properties: [...currentPlayer.properties],
                    trapCard: currentPlayer.trapCard ? { ...currentPlayer.trapCard } : null // **NEW: ç¢ºä¿é™·å®³å¡æ·±æ‹·è²**
                } : p
            );
        }

/**
 * çµæŸå›åˆ (å·²åŠ å…¥é˜²æ­¢é€£é»é–å®š)
 */
async function endTurn() {
    // ã€ä¿®æ­£ã€‘é˜²æ­¢é‡è¤‡é»æ“Š / é€£é»
    if (isProcessingAction) return;
    isProcessingAction = true;

    // åš´æ ¼é™åˆ¶ç‹€æ…‹
    if (!gameState || (gameState.status !== 'ROLLED' && gameState.status !== 'ACTION_REQUIRED' && gameState.status !== 'READY')) {
        // ç‹€æ…‹ä¸å°æ™‚ç›´æ¥è§£é–ä¸¦è¿”å›
        isProcessingAction = false;
        return;
    }
    
    const currentTurnPlayer = gameState.players[gameState.turn];
    
    // æª¢æŸ¥æ˜¯å¦æ˜¯è‡ªå·±çš„å›åˆ
    const isGameMasterDevice = gameState.players[0] && gameState.players[0].currentUserId === userId;
    const isHotSwapMode = gameState.settings?.hotSwapMode === true;
    let isMyTurn;
    if (isHotSwapMode && isGameMasterDevice) {
        isMyTurn = true; 
    } else {
        isMyTurn = currentTurnPlayer.currentUserId === userId; 
    }

    if (!isMyTurn) {
        addLog(`éŒ¯èª¤ï¼šç¾åœ¨æ˜¯ ${currentTurnPlayer.name} çš„å›åˆï¼Œæ‚¨ç„¡æ³•çµæŸå›åˆï¼`, 'error');
        isProcessingAction = false; // ã€ä¿®æ­£ã€‘å¤±æ•—æ™‚è§£é–
        return;
    }

    gameState.currentStocks = fluctuateStockPrices(gameState.currentStocks);
    
    saveCurrentPlayerState(currentTurnPlayer);
    
    
    // ã€ä¿®æ­£ 1ï¼šç›£ç„æ¸›è¨ˆæ™‚ - åªåœ¨çµæŸç›£ç„ç©å®¶çš„å›åˆæ™‚åŸ·è¡Œã€‘
    if (currentTurnPlayer.inJail && currentTurnPlayer.jailTurns > 0) {
        currentTurnPlayer.jailTurns--;
        const remaining = currentTurnPlayer.jailTurns;
        addLog(`${currentTurnPlayer.name} ç›£ç„æœåˆ‘ä¸­ï¼Œæœ¬å›åˆçµæŸã€‚å‰©é¤˜ ${remaining} å›åˆã€‚`);

        // å¦‚æœæœåˆ‘çµæŸï¼Œæ¨™è¨˜å‡ºç„ï¼ˆä¸‹å›åˆå°±èƒ½æ“²éª°ï¼‰
        if (currentTurnPlayer.jailTurns === 0) {
            currentTurnPlayer.inJail = false;
            addLog(`${currentTurnPlayer.name} ç›£ç„æœåˆ‘æœŸæ»¿ï¼ä¸‹å›åˆå¯æ­£å¸¸æ“²éª°ã€‚`);
        }
        saveCurrentPlayerState(currentTurnPlayer); // ä¿å­˜æ›´æ–°å¾Œç‹€æ…‹
        // é€™è£¡ä¸éœ€è¦é¡å¤–çš„ updateGameStateï¼Œå› ç‚ºæœƒåœ¨ä¸‹é¢çš„é‚è¼¯ä¸­çµ±ä¸€æ›´æ–°
    }
    
    
    let nextTurn = (gameState.turn + 1) % gameState.players.length;
    let nextPlayer = gameState.players[nextTurn];
    let newRound = gameState.round; // ä¿æŒç•¶å‰å›åˆæ•¸

    // **NEW: æª¢æŸ¥æ˜¯å¦æ›è¼ª**
    if (nextTurn === 0) {
        newRound = gameState.round + 1; // å›åˆæ•¸åŠ  1
    }
    // **END NEW**

    while (!nextPlayer.isPlaying) {
        nextTurn = (nextTurn + 1) % gameState.players.length;
        nextPlayer = gameState.players[nextTurn];
        
        // **NEW: å†æ¬¡æª¢æŸ¥æ˜¯å¦è·³éè¼ªæ•¸**
        if (nextTurn === 0) {
            newRound = gameState.round + 1;
        }
        
        if (gameState.players.filter(p => p.isPlaying).length <= 1) {
            const finalWinner = gameState.players.find(p => p.isPlaying);
            addLog(`${finalWinner.name} è´å¾—äº†æ¯”è³½! éŠæˆ²çµæŸå›åˆã€‚`, 'win');
            
            const nextState = { ...gameState, turn: nextTurn, status: 'WIN', pendingAction: { type: 'none', squareIndex: null, card: null } };
            await updateGameState(nextState);
            
            isProcessingAction = false; // ã€ä¿®æ­£ã€‘çµæŸæ™‚è§£é–
            return;
        }
    }
    
    let nextTurnLog = `å›åˆçµæŸï¼Œè¼ªåˆ° ${nextPlayer.name} æ“²éª°ã€‚`;
    if (nextPlayer.inJail && nextPlayer.jailTurns > 0) {
        nextTurnLog = `å›åˆçµæŸï¼Œè¼ªåˆ° ${nextPlayer.name} (ç›£ç„æœåˆ‘ä¸­) é–‹å§‹ä»–çš„å›åˆã€‚`;
    }

    // **NEW: å‚³éæ–°çš„å›åˆæ•¸**
    const nextState = { ...gameState, turn: nextTurn, status: 'READY', round: newRound, pendingAction: { type: 'none', squareIndex: null, card: null } };
    await updateGameState(nextState, nextTurnLog);
    
    // ã€ä¿®æ­£ã€‘å»¶é²è§£é–ï¼Œçµ¦ UI æ›´æ–°å’Œç©å®¶åæ‡‰çš„æ™‚é–“ï¼Œé˜²æ­¢èª¤è§¸ä¸‹ä¸€å›åˆ
    setTimeout(() => { isProcessingAction = false; }, 1000);
}

/**
 * ç©å®¶æ“²éª° (å·²åŠ å…¥é˜²æ­¢é€£é»é–å®š)
 */
async function rollDice() {
    // ã€ä¿®æ­£ã€‘é˜²æ­¢é‡è¤‡é»æ“Š
    if (isProcessingAction) return;
    isProcessingAction = true;

    if (!gameState) {
        addLog('éŠæˆ²ç‹€æ…‹æ­£åœ¨è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™ã€‚', 'error');
        isProcessingAction = false;
        return;
    }

    if (!gameState.gameStarted) {
        addLog('éŒ¯èª¤ï¼šéŠæˆ²å°šæœªé–‹å§‹ã€‚è«‹å‰å¾€ã€ŒğŸ‘¤ ç©å®¶ç®¡ç†ã€ç¢ºèªè‡³å°‘æœ‰ 2 ä½ç©å®¶ä¸¦å„²å­˜è¨­å®šã€‚', 'error');
        isProcessingAction = false;
        return;
    }

    if (gameState.status !== 'READY') {
        addLog('éŒ¯èª¤ï¼šè«‹å…ˆå®Œæˆç•¶å‰å›åˆæ‰€éœ€çš„å‹•ä½œï¼ˆå¦‚è³¼è²·ã€éŠ€è¡Œæ“ä½œæˆ–çµæŸå›åˆå›åˆï¼‰ã€‚', 'error');
        isProcessingAction = false;
        return;
    }

    const currentPlayerIndex = gameState.turn;
    const currentPlayer = gameState.players[currentPlayerIndex];

    const isGameMasterDevice = gameState.players[0] && gameState.players[0].currentUserId === userId;
    const isHotSwapMode = gameState.settings?.hotSwapMode === true;
    let isMyTurn;
    if (isHotSwapMode && isGameMasterDevice) {
        isMyTurn = true;
    } else {
        isMyTurn = currentPlayer.currentUserId === userId;
    }
    
    if (!isMyTurn) {
        addLog(`éŒ¯èª¤ï¼šç¾åœ¨æ˜¯ ${currentPlayer.name} çš„å›åˆï¼Œè«‹ç­‰å¾…ï¼`, 'error');
        isProcessingAction = false;
        return;
    }

// ã€ä¿®æ­£ 1ï¼šç›£ç„é‚è¼¯ - æ“²éª°éšæ®µï¼ˆæ–°ç‰ˆï¼‰ã€‘
if (currentPlayer.inJail && currentPlayer.jailTurns > 0) {
    // åªè™•ç†åˆ©æ¯
    if (currentPlayer.bank > 0) {
        const interestRate = gameState.settings.interestRate;
        const interest = Math.round(currentPlayer.bank * interestRate);
        currentPlayer.bank += interest; 
        addLog(`${currentPlayer.name} çš„å®šå­˜ç²å¾— $${interest.toLocaleString()} åˆ©æ¯ã€‚`);
        saveCurrentPlayerState(currentPlayer); 
        await updateGameState(gameState);
    }

    // ç›´æ¥å½ˆå‡ºæç¤ºï¼Œè®“ç©å®¶æŒ‰ç¢ºèªçµæŸå›åˆï¼ˆå‚³å…¥æœ¬å›åˆé–‹å§‹æ™‚çš„å‰©é¤˜å›åˆæ•¸ï¼Œä¸æ¸›ï¼‰
    // showJailTurnModal æœƒè™•ç†å¾ŒçºŒçš„ endTurn
    showJailTurnModal(currentPlayer, currentPlayer.jailTurns);
    isProcessingAction = false; // å¿…é ˆåœ¨é¡¯ç¤º Modal å¾Œè§£é™¤é–å®š
    return; // ä¸æ“²éª°ï¼Œç›´æ¥çµæŸæµç¨‹
} else if (currentPlayer.inJail && currentPlayer.jailTurns === 0) {
    // åˆ‘æœŸçµæŸï¼Œå¯ä»¥æ­£å¸¸æ“²éª°
    currentPlayer.inJail = false;
    addLog(`${currentPlayer.name} å·²é›¢é–‹ç›£ç„ï¼Œé–‹å§‹æœ¬å›åˆæ“²éª°ã€‚`);
}
    
    // æ­£å¸¸å›åˆçš„åˆ©æ¯è¨ˆç®—ï¼ˆéç›£ç„ä¸­çš„ç©å®¶ï¼‰
    if (currentPlayer.bank > 0 && !currentPlayer.inJail) {
        const interestRate = gameState.settings.interestRate;
        const interest = Math.round(currentPlayer.bank * interestRate);
        currentPlayer.bank += interest; 
        addLog(`${currentPlayer.name} çš„å®šå­˜ç²å¾— $${interest.toLocaleString()} åˆ©æ¯ã€‚`);
        saveCurrentPlayerState(currentPlayer); 
        await updateGameState(gameState);
    }

    // =========================================================
    // NEW: DEBUG é‚è¼¯
    const debugInput = document.getElementById('debug-steps-input');
    let dice1, dice2, steps;
    
    if (debugInput && debugInput.value.trim() !== '' && debugInput.style.display !== 'none') {
        // ä½¿ç”¨è¼¸å…¥æ¡†çš„æ•¸å€¼
        const inputSteps = parseInt(debugInput.value);
        if (inputSteps >= 2 && inputSteps <= 12) {
            steps = inputSteps;
            // ç‚ºäº†å‹•ç•«å’Œ log çš„ä¸€è‡´æ€§ï¼Œè¨ˆç®—å‡ºå°æ‡‰çš„ dice1 å’Œ dice2
            dice1 = Math.min(6, steps - 1); // å‡è¨­ dice1 æœ€å¤§ç‚º 6
            dice2 = steps - dice1;
            if (dice2 > 6) { 
                dice2 = 6;
                dice1 = steps - 6;
            }
            // ç¢ºä¿éª°å­å€¼åœ¨ 1-6 ç¯„åœå…§
            dice1 = Math.max(1, Math.min(6, dice1));
            dice2 = Math.max(1, Math.min(6, dice2));

            addLog(`${currentPlayer.name} åµéŒ¯æ¨¡å¼ä½¿ç”¨æ­¥æ•¸: ${steps} æ­¥ã€‚`, 'debug');
        } else {
            addLog('åµéŒ¯æ­¥æ•¸ç„¡æ•ˆ (éœ€ 2~12)ï¼Œä½¿ç”¨éš¨æ©Ÿæ“²éª°ã€‚', 'error');
            dice1 = Math.floor(Math.random() * 6) + 1;
            dice2 = Math.floor(Math.random() * 6) + 1;
            steps = dice1 + dice2;
        }
    } else {
        // æ­£å¸¸éš¨æ©Ÿæ“²éª°
        dice1 = Math.floor(Math.random() * 6) + 1;
        dice2 = Math.floor(Math.random() * 6) + 1;
        steps = dice1 + dice2;
    }
    // =========================================================

    gameState.status = 'MOVING';

    currentPlayer.lastActiveTimestamp = Date.now(); // æ›´æ–°æ™‚é–“
    
    await updateGameState(gameState, `${currentPlayer.name} æ­£åœ¨æ“²éª°...`);

    await runDiceAnimation(dice1, dice2); 

    gameState.dice = [dice1, dice2];
    await updateGameState(gameState, `${currentPlayer.name} æ“²å‡ºäº† ${dice1} å’Œ ${dice2}ï¼Œå…± ${steps} æ­¥ã€‚`);
    
    await animateMove(currentPlayerIndex, steps);
    
    // ã€ä¿®æ­£ã€‘ç§»å‹•å‹•ç•«çµæŸå¾Œè§£é–
    setTimeout(() => { isProcessingAction = false; }, 500);
} 
        async function savePlayerSettings(players, newPlayerCount, currentTurn) {
            const currentPlayingCount = players.filter(p => p.isPlaying).length;
            let logText = '';
            
            // è™•ç†äººæ•¸å’Œåˆå§‹è³‡ç”¢çš„è®Šå‹•
            for (let i = 0; i < players.length; i++) {
                const wasPlaying = players[i].isPlaying;
                const isNowPlaying = i < newPlayerCount;
                
                players[i].isPlaying = isNowPlaying;

                // åªæœ‰å¾ç¦ç”¨è®Šç‚ºå•Ÿç”¨æ™‚ï¼Œæ‰é‡è¨­è³‡ç”¢
                if (!wasPlaying && isNowPlaying) {
                    const initialMoneyInput = document.getElementById(`player-initial-money-${i}`);
                    const initialMoney = parseInt(initialMoneyInput.value) || DEFAULT_INITIAL_MONEY;
                    
                    players[i].money = initialMoney;
                    players[i].bank = 0;
                    players[i].position = 0;
                    players[i].properties = [];
                    players[i].inJail = false;
                    players[i].jailTurns = 0;
                    players[i].trapCard = null; // **NEW: é‡ç½®é™·å®³å¡**
                    // ç•¶ç©å®¶è¢«é‡æ–°å•Ÿç”¨æ™‚ï¼Œæ¸…é™¤å…¶ç¶å®šçš„ç”¨æˆ¶ IDï¼Œä½¿å…¶å¯è¢«é‡æ–°èªé ˜
                    // ä½†ä¿ç•™ P0 çš„ç¶å®šç‹€æ…‹ï¼Œå› ç‚ºå®ƒå¯èƒ½æ˜¯ç®¡ç†å“¡
                    if (players[i].id !== 'p0') {
                        players[i].currentUserId = null; 
                    }
                }
                
                // è™•ç†åœ¨ç©å®¶ç®¡ç†ä¸­æ‰‹å‹•æ¸…ç©ºç¶å®š (å·²ç§»é™¤æ‰‹å‹•è¼¸å…¥ UID çš„åŠŸèƒ½ï¼Œä½†ä¿ç•™ P0 çš„ ID)
                // P0 çš„ currentUserId åªèƒ½é€šéé‡å•Ÿ/åˆå§‹åŒ–ä¾†è¨­ç½®
                if (players[i].id === 'p0') {
                    // ç¢ºä¿ P0 æ°¸é å•Ÿç”¨
                    players[i].isPlaying = true;
                }
            }

            if (newPlayerCount !== currentPlayingCount) {
                if (currentTurn >= newPlayerCount) {
                    currentTurn = 0;
                }
                logText = `ç©å®¶äººæ•¸æ›´æ”¹ç‚º ${newPlayerCount}ï¼Œå›åˆå·²é‡è¨­è‡³ P${currentTurn+1}ã€‚`;
            }

            // è™•ç†åç¨±ã€é¡è‰²å’Œé ­åƒ URL è®ŠåŒ–
            let nameColorAvatarChanged = false;
            players.forEach((player, index) => {
                const nameInput = document.getElementById(`player-name-${index}`);
                const colorInput = document.querySelector(`input[name="player-${index}-color"]:checked`);
                const avatarUrlInput = document.getElementById(`player-avatar-url-${index}`); 

                if (nameInput && player.name !== nameInput.value.trim()) {
                    player.name = nameInput.value.trim() || PLAYER_NAMES[index];
                    nameColorAvatarChanged = true;
                }
                if (colorInput && player.color !== colorInput.value) {
                    player.color = colorInput.value;
                    nameColorAvatarChanged = true;
                }
                if (avatarUrlInput && player.avatarUrl !== (avatarUrlInput.value.trim() || null)) {
                    player.avatarUrl = avatarUrlInput.value.trim() || null;
                    nameColorAvatarChanged = true;
                }
                if (!PLAYER_COLORS.includes(player.color)) {
                    player.color = PLAYER_COLORS[index];
                }
            });
            
            if (nameColorAvatarChanged && !logText) {
                logText = 'ç©å®¶åç¨±ã€é¡è‰²æˆ–é ­åƒå·²æ›´æ–°ã€‚';
            }
            if (!logText) {
                logText = 'ç©å®¶è¨­å®šå·²å„²å­˜ã€‚';
            }
            
            const isPlayingCount = players.filter(p => p.isPlaying).length;
            const gameStarted = isPlayingCount >= 2;
            if (gameStarted && !gameState.gameStarted) {
                logText += ' éŠæˆ²å·²å•Ÿå‹•ï¼';
            }

            const nextState = {
                ...gameState,
                players: players.map(p => ({...p})), 
                turn: currentTurn,
                status: 'READY',
                gameStarted: gameStarted 
            };
            
            await updateGameState(nextState, logText);
        }

/**
 * é¡¯ç¤ºç›£ç„å›åˆå½ˆçª— (ä¿®æ­£ 1: ç¢ºä¿ç¢ºèªå¾ŒçµæŸå›åˆï¼Œä¸”ç„¡å–æ¶ˆæŒ‰éˆ•)
 */
function showJailTurnModal(currentPlayer, turnsLeft) {
    // ã€ä¿®æ­£ 1ã€‘å°‡æ‰£éŒ¢é‚è¼¯ç§»åˆ° rollDice è£¡é¢ï¼Œé€™è£¡åªè² è²¬é¡¯ç¤º
    const message = turnsLeft > 0 
        ? `<p class="text-lg">æ‚¨ä»åœ¨ç›£ç„ä¸­ï¼Œæœ¬å›åˆå°‡è¢«è·³éã€‚<br/>ç›®å‰å‰©é¤˜ <strong>${turnsLeft}</strong> å›åˆï¼ˆæœ¬å›åˆçµæŸå¾Œæ¸› 1ï¼‰ã€‚</p><p class="mt-2 text-sm text-red-600 font-semibold">é»æ“Šç¢ºèªä»¥çµæŸæœ¬å›åˆã€‚</p>`
        : `<p class="text-lg text-green-600 font-bold">æ­å–œï¼æ‚¨å·²æœåˆ‘å®Œç•¢ï¼Œä¸‹å›åˆå¯æ­£å¸¸æ“²éª°åŠç§»å‹•ã€‚</p>`;

    // ã€ç›£ç„é‚è¼¯ä¿®æ­£ã€‘ç¢ºä¿é»æ“Šç¢ºèªå¾Œï¼Œå¼·åˆ¶çµæŸå›åˆï¼Œä¸”ç„¡å–æ¶ˆæŒ‰éˆ•
    showModal(
        `[${currentPlayer.name}] ç›£ç„ç‹€æ…‹æç¤º`, 
        message,
        // ç¢ºèªæŒ‰éˆ•çš„åŒæ­¥æ“ä½œ
        () => { 
            const logMessage = turnsLeft > 0 
               ? `${currentPlayer.name} ç¢ºèªå›åˆè·³éã€‚` 
               : `${currentPlayer.name} åˆ‘æœŸçµæŸï¼Œå›åˆçµæŸï¼Œä¸‹å›åˆå¯æ“²éª°ã€‚`;
            addLog(logMessage); 
            // ç¢ºä¿ Modal é—œé–‰å¾Œå†å‘¼å«ç•°æ­¥çš„ endTurn
            setTimeout(endTurn, 50); 
        },
        null,
        turnsLeft > 0 ? 'ç¢ºèªè·³éå›åˆ' : 'ç¢ºèªé›¢é–‹ç›£ç„'
    );
    // ç›£ç„ç‹€æ…‹æç¤ºï¼Œé ‚éƒ¨é—œé–‰æŒ‰éˆ•å’Œå–æ¶ˆæŒ‰éˆ•éƒ½æ‡‰è©²è¢«ç¦ç”¨æˆ–éš±è—ï¼Œåªå…è¨±é€šéç¢ºèªæŒ‰éˆ•ç¹¼çºŒ
    document.getElementById('modal-cancel-btn').classList.add('hidden');
    // è¦†å¯«é ‚éƒ¨é—œé–‰æŒ‰éˆ•çš„è¡Œç‚ºï¼Œä½¿å…¶è¡Œç‚ºèˆ‡ç¢ºèªæŒ‰éˆ•ç›¸åŒ
    document.getElementById('modal-top-close-btn').onclick = () => {
        document.getElementById('modal').classList.add('hidden');
        document.getElementById('modal').classList.remove('flex');
        const logMessage = turnsLeft > 0 
           ? `${currentPlayer.name} ç¢ºèªå›åˆè·³é (é»æ“Š X)ã€‚` 
           : `${currentPlayer.name} åˆ‘æœŸçµæŸï¼Œå›åˆçµæŸï¼Œä¸‹å›åˆå¯æ“²éª° (é»æ“Š X)ã€‚`;
        addLog(logMessage); 
        setTimeout(endTurn, 50); 
    };
}
        

/**
 * é¡¯ç¤ºç¨…å‹™å½ˆçª— (ä¿®æ­£ï¼šå°‡æ‰£æ¬¾é‚è¼¯ç§»åˆ°ç¢ºèªæŒ‰éˆ•å…§)
 */
function showTaxModal(currentPlayer, square, taxAmount) {
    
    // ğŸš¨ ä¿®æ­£ï¼šåœ¨é€™è£¡ä¸åŸ·è¡Œ currentPlayer.money -= taxAmount;
    
    const beforeMoney = currentPlayer.money; // ç¨…æ¬¾åœ¨å½ˆçª—ç¢ºèªæ™‚æ‰æ‰£é™¤

    const message = `<p class="text-lg text-gray-800">æ‚¨åœåœ¨äº† **${square.name}**ï¼</p>
                     <div class="mt-4 p-3 bg-red-50 rounded-lg border border-red-300">
                         <p class="text-sm">æ‰£æ¬¾å‰ç¾é‡‘: <span class="font-bold text-gray-700">$${beforeMoney.toLocaleString()}</span></p>
                         <p class="text-sm font-bold text-red-600">æ‡‰ç¹³ç¨…æ¬¾: -$${taxAmount.toLocaleString()}</p>
                         <hr class="my-2 border-red-200"/>
                         <p class="text-lg font-extrabold text-red-700">æ‰£æ¬¾å¾Œé¤˜é¡: $${(beforeMoney - taxAmount).toLocaleString()}</p>
                     </div>
                     <p class="mt-4 text-sm text-red-600 font-semibold">é»æ“Šç¢ºèªä»¥ç¹¼çºŒã€‚</p>`;

    showModal(
        `[${currentPlayer.name}] ç¹³ç´ç¨…æ¬¾`, 
        message,
        // ç¢ºèªæŒ‰éˆ•çš„åŒæ­¥æ“ä½œï¼šåœ¨é€™è£¡åŸ·è¡Œæ‰£æ¬¾
        () => { 
            // åŸ·è¡Œå¯¦éš›æ‰£æ¬¾
            currentPlayer.money -= taxAmount;
            
            // æª¢æŸ¥æ˜¯å¦ç ´ç”¢
            if (currentPlayer.money < 0) {
                currentPlayer.money = 0;
                currentPlayer.isPlaying = false;
                // é€™è£¡æ‡‰è©²è§¸ç™¼ç ´ç”¢è™•ç†ï¼Œä½†ç‚ºç°¡åŒ–ï¼Œåƒ…è¨˜éŒ„æ—¥èªŒ
                addLog(`${currentPlayer.name} å› ç„¡æ³•æ”¯ä»˜ç¨…æ¬¾è€Œ**ç ´ç”¢**ï¼é€€å‡ºéŠæˆ²ã€‚`, 'error');
            }

            saveCurrentPlayerState(currentPlayer); 
            const logMessage = `${currentPlayer.name} ç¢ºèªç¹³ç´ $${taxAmount.toLocaleString()} çš„ ${square.name}ã€‚`;
            
            // ç¢ºä¿ Modal é—œé–‰å¾Œå†å‘¼å«ç•°æ­¥çš„ updateGameState/endTurn
            const nextState = { ...gameState, status: 'ROLLED', pendingAction: { type: 'none', squareIndex: null, card: null } };
            setTimeout(async () => {
                await updateGameState(nextState, logMessage);
                await endTurn();
            }, 50);
        },
        null,
        'ç¢ºèªå®Œæˆ'
    );

    // ... (å¾ŒçºŒçš„ handleForcedPay é‚è¼¯ä¹Ÿéœ€è¦åŒ…å«æ‰£æ¬¾)
    const handleForcedPay = () => {
        // ... é—œé–‰ Modal çš„é‚è¼¯
        
        // åŸ·è¡Œå¯¦éš›æ‰£æ¬¾ (èˆ‡ä¸Šæ–¹ç›¸åŒ)
        currentPlayer.money -= taxAmount;
        if (currentPlayer.money < 0) {
            // ... ç ´ç”¢é‚è¼¯
        }
        saveCurrentPlayerState(currentPlayer); 

        // ... å¾ŒçºŒçš„ updateGameState/endTurn é‚è¼¯
    };
    
    // ... é‡æ–°ç¶å®šé ‚éƒ¨é—œé–‰æŒ‰éˆ•
    document.getElementById('modal-top-close-btn').onclick = handleForcedPay;
}


        /**
         * NEW: éª°å­æ»¾å‹•å‹•ç•«
         */
        function runDiceAnimation(finalDice1, finalDice2) {
             return new Promise(resolve => {
                 const dice1El = document.getElementById('dice-display-1');
                 const dice2El = document.getElementById('dice-display-2');
                 let animationCount = 0;
                 const maxRolls = 15; // æ¨¡æ“¬æ»¾å‹•çš„æ¬¡æ•¸
                 const diceValues = [1, 2, 3, 4, 5, 6];

                 dice1El.classList.add('dice-spinning');
                 dice2El.classList.add('dice-spinning');

                 const rollInterval = setInterval(() => {
                              animationCount++;
                              
                              // éš¨æ©Ÿåˆ‡æ›åœ–ç‰‡
                              const rand1 = diceValues[Math.floor(Math.random() * diceValues.length)];
                              const rand2 = diceValues[Math.floor(Math.random() * diceValues.length)];
                              
                              dice1El.src = DICE_IMAGES[rand1];
                              dice2El.src = DICE_IMAGES[rand2];

                              if (animationCount >= maxRolls) {
                                      clearInterval(rollInterval);
                                      
                                      // åœæ­¢å‹•ç•«ä¸¦é¡¯ç¤ºæœ€çµ‚çµæœ
                                      dice1El.classList.remove('dice-spinning');
                                      dice2El.classList.remove('dice-spinning');
                                      dice1El.src = DICE_IMAGES[finalDice1];
                                      dice2El.src = DICE_IMAGES[finalDice2];
                                      
                                      resolve();
                                  }
                 }, 100); // æ¯ 100 æ¯«ç§’åˆ‡æ›ä¸€æ¬¡åœ–ç‰‡
             });
        }


        async function animateMove(playerIndex, steps) {
            const player = gameState.players[playerIndex];
            const startPosition = player.position;
            let stepsTaken = 0;

            while (stepsTaken < steps) {
                await new Promise(resolve => setTimeout(resolve, MOVE_DELAY));

                stepsTaken++;
                player.position = (startPosition + stepsTaken) % totalSquares;
                
                if (player.position === 0 && stepsTaken < steps) {
                    player.money += BOARD[0].action;
                    addLog(`${player.name} ç¶“éèµ·é» (GO)ï¼Œç²å¾— $${BOARD[0].action.toLocaleString()}ã€‚`);
                }

                // åœ¨ç§»å‹•çš„æ¯ä¸€æ­¥éƒ½é€²è¡Œ UI æ›´æ–°ï¼Œä½†æ»¾å‹•åªåœ¨æœ¬åœ°ï¼ˆä¸»æ§è¨­å‚™ï¼‰åŸ·è¡Œ
                renderPlayerStats();
                renderBoardDisplay();
                
                // NEW: åªåœ¨ç™¼èµ·ç§»å‹•çš„è¨­å‚™ä¸ŠåŸ·è¡Œå¹³æ»‘æ»¾å‹•
                const targetSquare = document.getElementById(`square-${player.position}`);
                if (targetSquare) {
                    targetSquare.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                }
            }
            saveCurrentPlayerState(player);
            await updateGameState(gameState);
            
            await handleLandingAction(playerIndex);
        }

        async function handleLandingAction(currentPlayerIndex) {
            const currentPlayer = gameState.players[currentPlayerIndex];
            const newPosition = currentPlayer.position;
            const currentSquare = gameState.board[newPosition];
            let nextStatus = 'ROLLED'; 
            let logMessage = null;
            let shouldUpdateState = true; 
            
            // **NEW: é‡ç½® pendingAction**
            gameState.pendingAction = { type: 'none', squareIndex: null, card: null };

            if (currentSquare.type === 'PROPERTY') {
                if (currentSquare.owner === null) {
                    // === ç„¡ä¸»åœ°ç”¢ï¼šè³¼è²·/æ”¾æ£„ ===
                    logMessage = `${currentPlayer.name} åœåœ¨ç„¡ä¸»åœ°ç”¢ ${currentSquare.name}ï¼Œå¯é¸æ“‡è³¼è²·æˆ–ç›´æ¥çµæŸå›åˆã€‚`;
                    nextStatus = 'ROLLED';
                    
                    // å„²å­˜å¾…è™•ç†å‹•ä½œ
                    gameState.pendingAction = { type: 'BUY_PROPERTY', squareIndex: newPosition, card: null };
                    
                    // å½ˆå‡ºè³¼è²·è¦–çª—ï¼ˆä½†ä¸å½±éŸ¿ç‹€æ…‹ï¼Œä¸æœƒå¡ä½ï¼‰
                    showPropertyBuyModal(currentPlayer, currentSquare); 
                    
                } else if (currentSquare.owner !== currentPlayer.id && currentSquare.owner !== null) {
                    // === ä»–äººç‰©ç”¢ï¼šæ”¯ä»˜ç§Ÿé‡‘ ===
                    const rent = calculateRent(currentSquare);
                    const ownerPlayer = gameState.players.find(p => p.id === currentSquare.owner);
                    
                    if (!ownerPlayer || !ownerPlayer.isPlaying) {
                        logMessage = `${currentPlayer.name} åœåœ¨ ${currentSquare.name}ï¼Œä½†åœ°ä¸»å·²ç ´ç”¢ã€‚å…ç¹³éè·¯è²»ã€‚`;
                        nextStatus = 'ROLLED';
                    } else if (currentSquare.mortgage) {
                        logMessage = `${currentPlayer.name} åœåœ¨ ${currentSquare.name}ï¼Œä½†åœ°ç”¢å·²æŠµæŠ¼ã€‚å…ç¹³éè·¯è²»ã€‚`;
                        nextStatus = 'ROLLED';
                    } else if (currentPlayer.money < rent) {
                        // ç ´ç”¢æ©Ÿåˆ¶
                        currentPlayer.money = 0;
                        currentPlayer.isPlaying = false;
                        logMessage = `${currentPlayer.name} **ç ´ç”¢**! ç„¡æ³•æ”¯ä»˜ $${rent.toLocaleString()} æˆ¿ç§Ÿçµ¦ ${ownerPlayer.name}ï¼Œé€€å‡ºéŠæˆ²ã€‚`;
                        saveCurrentPlayerState(currentPlayer);
                        await updateGameState({ ...gameState, status: 'ROLLED' }, logMessage);
                        endTurn(); 
                        return; 
                    } else {
                        // å¿…é ˆä»˜ç§Ÿé‡‘ â†’ ç”¨ ACTION_REQUIRED + å½ˆçª—ï¼ˆé€™æ˜¯å”¯ä¸€æœƒå¡ä½çš„ï¼Œä½†ä»˜éŒ¢å¾Œå°±éï¼‰
                        // é€™è£¡ä¸åŸ·è¡Œæ‰£æ¬¾ï¼Œç•™çµ¦ showRentModal çš„ç¢ºèªç’°ç¯€åŸ·è¡Œï¼Œä»¥ä¿æŒäº¤æ˜“å½ˆçª—çš„åŸå­æ€§
                        showRentModal(currentPlayer, ownerPlayer, currentSquare, rent);
                        shouldUpdateState = false;
                        nextStatus = 'ACTION_REQUIRED';
                    }
                } else {
                    // ** ä¿®æ­£ï¼šè¸©åˆ°è‡ªå·±çš„åœ°ç”¢ï¼Œé€²è¡Œåœ°ç”¢ç®¡ç† **
                    logMessage = `${currentPlayer.name} åœåœ¨è‡ªå·±çš„åœ°ç”¢ ${currentSquare.name}ã€‚å¯é€²è¡Œåœ°ç”¢ç®¡ç†ã€‚`;
                    nextStatus = 'ROLLED'; // ç‹€æ…‹è¨­ç‚º ROLLEDï¼Œå…è¨±çµæŸå›åˆ
                    
                    // å„²å­˜å¾…è™•ç†å‹•ä½œ
                    gameState.pendingAction = { type: 'PROPERTY_MANAGEMENT', squareIndex: newPosition, card: null };
                    
                    // å½ˆå‡ºåœ°ç”¢ç®¡ç†è¦–çª—
                    showPropertyManagementModal(currentPlayer, currentSquare);
                }
            } else if (currentSquare.type === 'BANK') {
                // æ–°å¢ï¼šè¨˜éŒ„ pendingAction
                gameState.pendingAction = { type: 'BANK_SERVICE', squareIndex: newPosition };
                
                showBankModal(currentPlayer);
                nextStatus = 'ROLLED';  // æ”¹æˆ ROLLEDï¼Œè®“çµæŸå›åˆå¯é»
                logMessage = `${currentPlayer.name} åœåœ¨éŠ€è¡Œï¼Œå¯é€²è¡Œé‡‘èæœå‹™ã€‚`;
                shouldUpdateState = true;  // å…è¨±æ›´æ–°ç‹€æ…‹
            } else if (currentSquare.type === 'CASINO') {
                // æ–°å¢ï¼šè¨˜éŒ„ pendingAction
                gameState.pendingAction = { type: 'CASINO_GAME', squareIndex: newPosition };
                
                showCasinoModal(currentPlayer);
                nextStatus = 'ROLLED';  // æ”¹æˆ ROLLED
                logMessage = `${currentPlayer.name} åœåœ¨ Casinoï¼Œå¯ç©åƒè§’å­è€è™æ©Ÿã€‚`;
                shouldUpdateState = true;
            } else if (currentSquare.type === 'CHANCE') {
                const card = CHANCE_CARDS[Math.floor(Math.random() * CHANCE_CARDS.length)];
                
                if (card.type.startsWith('trap')) {
                    // ** Trap card logic: Set ROLLED status, enable button, show modal (non-blocking) **
                    currentPlayer.trapCard = card;
                    gameState.pendingAction = { type: 'USE_TRAP_CARD', squareIndex: newPosition, card: card };
                    logMessage = `${currentPlayer.name} ç²å¾—é™·å®³å¡: ${card.text}ï¼Œè«‹åœ¨å›åˆå…§é¸æ“‡ä½¿ç”¨æˆ–æ”¾æ£„ã€‚`;
                    showTrapTargetModal(currentPlayer, card); 
                    nextStatus = 'ROLLED';
                } else {
                    // ** FIX: Simple card logic: Apply effect immediately, show modal (non-blocking) **
                    const result = applyCardEffect(currentPlayer, card); // Applies effect and calls saveCurrentPlayerState(currentPlayer)
                    logMessage = result.logMsg;
                    
                    // Show modal as purely informational, set non-blocking flag (true)
                    showCardModal(currentPlayer, result.cardMessage, 'CHANCE', true); 
                    
                    nextStatus = 'ROLLED';
                    shouldUpdateState = true; // Allow final updateGameState call in handleLandingAction
                }
            } else if (currentSquare.type === 'FATE') {
                const card = FATE_CARDS[Math.floor(Math.random() * FATE_CARDS.length)];

                if (card.type.startsWith('trap')) {
                    // ** Trap card logic: Same as CHANCE **
                    currentPlayer.trapCard = card;
                    gameState.pendingAction = { type: 'USE_TRAP_CARD', squareIndex: newPosition, card: card };
                    logMessage = `${currentPlayer.name} ç²å¾—é™·å®³å¡: ${card.text}ï¼Œè«‹åœ¨å›åˆå…§é¸æ“‡ä½¿ç”¨æˆ–æ”¾æ£„ã€‚`;
                    showTrapTargetModal(currentPlayer, card); 
                    nextStatus = 'ROLLED'; 
                } else {
                    // ** FIX: Simple card logic: Apply effect immediately, show modal (non-blocking) **
                    const result = applyCardEffect(currentPlayer, card);
                    logMessage = result.logMsg;
                    
                    showCardModal(currentPlayer, result.cardMessage, 'FATE', true); // Show modal
                    
                    nextStatus = 'ROLLED';
                    shouldUpdateState = true; 
                }
            } 
            // ã€**ä¿®æ­£ 2**ï¼šè¸©åˆ°ç›£ç„æ ¼ (JAIL) ä¸å…¥ç„ã€‘
            else if (currentSquare.type === 'JAIL') {
                 // è¸©åˆ°ç›£ç„æ ¼ä¸å…¥ç„ï¼Œåªæ˜¯åœç•™ (åªç”¨ GOTO_JAIL å…¥ç„)
                 logMessage = `${currentPlayer.name} åœåœ¨ç›£ç„ (Just Visiting)ã€‚`;
                 nextStatus = 'ROLLED';
            }
            // ã€**çµæŸä¿®æ­£ 2**ã€‘
            else if (currentSquare.type === 'INCOME_TAX') {
                const taxRate = currentSquare.action;
                const taxAmount = Math.round(currentPlayer.money * taxRate); // 10%
                
                // **å•é¡Œ 2 ä¿®æ­£**ï¼šä½¿ç”¨å½ˆçª—é¡¯ç¤ºäº¤æ˜“éç¨‹ï¼Œä¸¦å°‡ç‹€æ…‹è¨­ç‚º ACTION_REQUIRED æš«åœå›åˆ
                showTaxModal(currentPlayer, currentSquare, taxAmount);
                shouldUpdateState = false; // ç”± TaxModal çš„ç¢ºèªæŒ‰éˆ•è™•ç† final updateGameState
                nextStatus = 'ACTION_REQUIRED';
            } else if (currentSquare.type === 'LUXURY_TAX') {
                const taxAmount = currentSquare.action;
                
                // **å•é¡Œ 2 ä¿®æ­£**ï¼šä½¿ç”¨å½ˆçª—é¡¯ç¤ºäº¤æ˜“éç¨‹ï¼Œä¸¦å°‡ç‹€æ…‹è¨­ç‚º ACTION_REQUIRED æš«åœå›åˆ
                showTaxModal(currentPlayer, currentSquare, taxAmount);
                shouldUpdateState = false; // ç”± TaxModal çš„ç¢ºèªæŒ‰éˆ•è™•ç† final updateGameState
                nextStatus = 'ACTION_REQUIRED';
            } else if (currentSquare.type === 'START') {
                logMessage = `${currentPlayer.name} åœåœ¨èµ·é»ã€‚`;
                nextStatus = 'ROLLED';
            } else if (currentSquare.type === 'FINISH') {
                currentPlayer.money += currentSquare.action;
                logMessage = `${currentPlayer.name} åˆ°é”çµ‚é»ï¼Œç²å¾— $${currentSquare.action.toLocaleString()}ï¼`;
                nextStatus = 'ROLLED';
            }

            if (shouldUpdateState) {
                const nextState = { ...gameState, status: nextStatus };
                await updateGameState(nextState, logMessage);
            }
        }
        
        // ** NEW: æ ¸å¿ƒå¡ç‰‡æ•ˆæœæ‡‰ç”¨å‡½æ•¸ (ä¸è§¸ç™¼éŠæˆ²æµç¨‹é–å®š)**
function applyCardEffect(player, card) {
Â  Â  Â  Â  Â  Â  let logMsg = card.text;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (card.type === 'money') {
Â  Â  Â  Â  Â  Â  Â  Â  player.money += card.amount;
Â  Â  Â  Â  Â  Â  Â  Â  logMsg += ` (é‡‘é¡è®Šå‹•: ${card.amount > 0 ? '+' : ''}$${card.amount.toLocaleString()})`;
Â  Â  Â  Â  Â  Â  } else if (card.type === 'goto_jail') {
Â  Â  Â  Â  Â  Â  Â  Â  const jailIndex = BOARD.findIndex(s => s.type === 'JAIL');
Â  Â  Â  Â  Â  Â  Â  Â  player.position = jailIndex !== -1 ? jailIndex : player.position;Â 
Â  Â  Â  Â  Â  Â  Â  Â  player.inJail = true;
Â  Â  Â  Â  Â  Â  Â  Â  player.jailTurns = 3;Â 
Â  Â  Â  Â  Â  Â  Â  Â  logMsg += ` (ç«‹å³å…¥ç„)`;
Â  Â  Â  Â  Â  Â  } else if (card.type === 'move_relative') {
Â  Â  Â  Â  Â  Â  Â  Â  let newPos = (player.position + card.amount);
Â  Â  Â  Â  Â  Â  Â  Â  if (newPos >= totalSquares) newPos %= totalSquares;
Â  Â  Â  Â  Â  Â  Â  Â  else if (newPos < 0) newPos = totalSquares + newPos;
Â  Â  Â  Â  Â  Â  Â  Â  player.position = newPos;
Â  Â  Â  Â  Â  Â  Â  Â  logMsg += ` (ç§»å‹•åˆ° ${BOARD[player.position].name}ï¼Œä¸åŸ·è¡Œè©²åœ°å¡ŠåŠŸèƒ½)`;
Â  Â  Â  Â  Â  Â  } else if (card.type === 'move') {
                // **ã€æ­¥é©Ÿ 1ï¼šè™•ç†ç¶“éèµ·é»çš„é‚è¼¯ã€‘**
                // è¨»ï¼šé€™æ®µé‚è¼¯é©ç”¨æ–¼æ‰€æœ‰ 'move' é¡å‹å¡ç‰‡ï¼ŒåŒ…æ‹¬ç›´æ¥ç§»å‹•åˆ°çµ‚é» (127) æˆ–èµ·é» (0)
Â  Â  Â  Â  Â  Â  Â  Â  if (card.target < player.position) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  player.money += BOARD[0].action;
                    logMsg += ` (ç¶“éèµ·é»ç²å¾— $${BOARD[0].action.toLocaleString()})`; // æ–°å¢æ—¥èªŒ
Â  Â  Â  Â  Â  Â  Â  Â  }
                
                // **ã€æ­¥é©Ÿ 2ï¼šåŸ·è¡Œå¼·åˆ¶ç§»å‹•ã€‘**Â¸Â¸Â¸
Â  Â  Â  Â  Â  Â  Â  Â  player.position = card.target % totalSquares;
                
                // **ã€æ­¥é©Ÿ 3ï¼šè™•ç†å¡ç‰‡ä¸Šçš„é¡å¤–çå‹µ (Fix: è§£æ±ºç¬ç§»åˆ°èµ·é»ä¸åŠ éŒ¢çš„å•é¡Œ)ã€‘**
                if (card.reward && card.reward > 0) {
                    player.money += card.reward;
                    logMsg += ` (å¡ç‰‡çå‹µ: +$${card.reward.toLocaleString()})`;
                }

                // **ã€æ­¥é©Ÿ 4ï¼šæ›´æ–°æ—¥èªŒã€‘**
Â  Â  Â  Â  Â  Â  Â  Â  logMsg += ` (ç§»å‹•åˆ° ${BOARD[player.position].name}ï¼Œä¸åŸ·è¡Œè©²åœ°å¡ŠåŠŸèƒ½)`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ç«‹å³å„²å­˜ç©å®¶ç‹€æ…‹ï¼Œç¢ºä¿ç‹€æ…‹åœ¨ updateGameState æ™‚è¢«æäº¤
Â  Â  Â  Â  Â  Â  saveCurrentPlayerState(player);Â 

Â  Â  Â  Â  Â  Â  return { logMsg, cardMessage: logMsg.replace(/<br\/>/g, ' ') };
Â  Â  Â  Â  }
        // ** END NEW **
        
        /**
         * é¡¯ç¤ºé™·å®³å¡ç›®æ¨™é¸æ“‡æ¨¡æ…‹è¦–çª— (æ–°å¢/ä¿®æ­£ 2)
         */
        function showTrapTargetModal(currentPlayer, card) {
            const isMyTurn = (gameState.settings?.hotSwapMode && gameState.players[0]?.currentUserId === userId) || (currentPlayer.currentUserId === userId); 

// --- æ–°å¢ï¼šè™•ç† MOVING ç‹€æ…‹çš„é‡é€£ä¿®å¾© ---
    if (gameState.status === 'MOVING' && isMyTurn && !isProcessingAction) {
        console.log("åµæ¸¬åˆ°é‡é€£ï¼Œæ­£åœ¨ç¹¼çºŒæœªå®Œæˆçš„ç§»å‹•å‹•ç•«...");
        isProcessingAction = true; // é–å®šï¼Œé˜²æ­¢é‡è¤‡è§¸ç™¼
        
        // å–å¾—éª°å­é»æ•¸
        const steps = gameState.dice[0] + gameState.dice[1];
        
        // é€™è£¡éœ€è¦ä¸€å€‹å°æŠ€å·§ï¼šanimateMove æ˜¯å¾ã€Œç›®å‰ä½ç½®ã€å¾€å¾Œèµ° steps æ­¥
        // ä½†å› ç‚ºæˆ‘å€‘å¯èƒ½å·²ç¶“ç§»å‹•åˆ°ä¸€åŠå­˜éæª”ï¼Œæˆ–è€…å‰›æ“²éª°
        // ç‚ºäº†å®‰å…¨ï¼Œæˆ‘å€‘è®“é‡é€£çš„äººç›´æ¥åŸ·è¡Œè½åœ°æª¢æŸ¥ï¼Œæˆ–å¾èµ·é»é‡æ–°è·‘ä¸€æ¬¡
        setTimeout(async () => {
            // å‘¼å«è½åœ°è™•ç†ï¼ˆé€™æœƒå°‡ç‹€æ…‹è½‰ç‚º ROLLED æˆ– ACTION_REQUIREDï¼‰
            await handleLandingAction(currentPlayerIndex);
            isProcessingAction = false;
        }, 1000);
        return; 
    }
    // --- çµæŸ MOVING ä¿®å¾© ---
            
            if (!isMyTurn) {
                // éç•¶å‰ç©å®¶åªé¡¯ç¤ºå¡ç‰‡å…§å®¹
                showCardModal(currentPlayer, card.text, card.type.includes('chance') ? 'CHANCE' : 'FATE', true);
                return;
            }

            const availableTargets = gameState.players.filter(p => p.isPlaying && p.id !== currentPlayer.id);
            
            const targetOptionsHtml = availableTargets.map(target => {
                return `
                    <button data-target-id="${target.id}" class="select-target-btn w-full py-3 px-4 mb-2 rounded-lg text-lg font-bold text-white bg-red-500 hover:bg-red-600 transition duration-150">
                        ğŸ˜ˆ é™·å®³ ${target.name}
                    </button>
                `;
            }).join('');

            const contentHtml = `
                <div id="trap-card-content">
                    <p class="text-xl font-bold text-red-600 mb-4">${card.text.replace('**é™·å®³å¡** - ', '')}</p>
                    ${availableTargets.length > 0 ? targetOptionsHtml : '<p class="text-lg font-semibold text-gray-500">æ²’æœ‰å…¶ä»–ç©å®¶åœ¨éŠæˆ²ä¸­ï¼Œç„¡æ³•ä½¿ç”¨é™·å®³å¡ã€‚</p>'}
                </div>
            `;
            
            showModal(
                `[${currentPlayer.name}] é¸æ“‡é™·å®³ç›®æ¨™`,
                `æ‚¨æŠ½åˆ°äº†ä¸€å¼µé™·å®³å¡ï¼Œè«‹é¸æ“‡è¦é™·å®³çš„å°è±¡ï¼š`,
                // é è¨­ç¢ºèªæŒ‰éˆ•çš„è¡Œç‚º (ç•¶æ²’æœ‰ç›®æ¨™æ™‚)
                () => { 
                    if (availableTargets.length === 0) {
                        performTrapCardAction(currentPlayer, null, card, 'æ”¾æ£„');
                    }
                },
                contentHtml,
                availableTargets.length > 0 ? 'å®Œæˆ/ç¨å¾Œä½¿ç”¨ (æ”¾æ£„é™·å®³å¡)' : 'ç¢ºèªæ”¾æ£„é™·å®³å¡' // ä¿®æ­£æŒ‰éˆ•æ–‡å­—
            );

            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            const topCloseBtn = document.getElementById('modal-top-close-btn');

            // å°æ–¼é™·å®³å¡ï¼Œç¢ºèªæŒ‰éˆ•é è¨­ç‚ºæ”¾æ£„ï¼Œåªæœ‰ç•¶æ²’æœ‰ç›®æ¨™æ™‚æœƒåŸ·è¡Œæ”¾æ£„é‚è¼¯
            if (availableTargets.length > 0) {
                confirmBtn.textContent = 'å®Œæˆ/ç¨å¾Œä½¿ç”¨ (æ”¾æ£„é™·å®³å¡)';
                confirmBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                confirmBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                
                // **ä¿®æ­£ï¼šç¢ºèª/æ”¾æ£„æŒ‰éˆ•å’Œ X æŒ‰éˆ•éƒ½åŸ·è¡Œæ”¾æ£„é‚è¼¯**
                const handleForfeit = () => performTrapCardAction(currentPlayer, null, card, 'æ”¾æ£„');
                confirmBtn.onclick = handleForfeit;
                cancelBtn.onclick = handleForfeit;
                topCloseBtn.onclick = handleForfeit;
                cancelBtn.classList.remove('hidden'); // ç¢ºä¿å–æ¶ˆæŒ‰éˆ•å¯è¦‹
            } else {
                // æ²’æœ‰ç›®æ¨™ï¼ŒæŒ‰éˆ•åªæœ‰ä¸€å€‹ï¼šç¢ºèªæ”¾æ£„
                cancelBtn.classList.add('hidden');
                confirmBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                confirmBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                const handleForfeitNoTarget = () => performTrapCardAction(currentPlayer, null, card, 'æ”¾æ£„');
                confirmBtn.onclick = handleForfeitNoTarget;
                topCloseBtn.onclick = handleForfeitNoTarget;
            }

            // ç¶å®šç›®æ¨™é¸æ“‡æŒ‰éˆ•
            document.querySelectorAll('.select-target-btn').forEach(button => {
                button.onclick = () => {
                    const targetId = button.dataset.targetId;
                    const targetPlayer = gameState.players.find(p => p.id === targetId);
                    if (targetPlayer) {
                        performTrapCardAction(currentPlayer, targetPlayer, card, 'ä½¿ç”¨');
                    }
                };
            });
        }

        /**
         * åŸ·è¡Œé™·å®³å¡å‹•ä½œä¸¦çµæŸå›åˆ (æ–°å¢/ä¿®æ­£ 2)
         */
        async function performTrapCardAction(currentPlayer, targetPlayer, card, actionType) {
            
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');

            let logMsg = '';
            
            if (actionType === 'ä½¿ç”¨' && targetPlayer) {
                // é™·å®³å¡ä½¿ç”¨é‚è¼¯
                if (card.type === 'trap_money') {
                    const amount = card.amount * -1; // ç½°æ¬¾æ˜¯è² å€¼ï¼Œé€™è£¡è½‰ç‚ºæ­£å€¼
                    
                    if (targetPlayer.money < amount) {
                        targetPlayer.money = 0;
                        targetPlayer.isPlaying = false;
                        logMsg = `${currentPlayer.name} å° ${targetPlayer.name} ä½¿ç”¨é™·å®³å¡ï¼${targetPlayer.name} ç„¡æ³•æ”¯ä»˜ $${amount.toLocaleString()} ç½°æ¬¾è€Œ **ç ´ç”¢**ï¼`;
                    } else {
                        targetPlayer.money -= amount;
                        logMsg = `${currentPlayer.name} å° ${targetPlayer.name} ä½¿ç”¨é™·å®³å¡ï¼Œ${targetPlayer.name} æ”¯ä»˜äº† $${amount.toLocaleString()} ç½°æ¬¾ã€‚`;
                    }
                    saveCurrentPlayerState(targetPlayer);
                    
                } else if (card.type === 'trap_jail') {
                    const jailIndex = BOARD.findIndex(s => s.type === 'JAIL');
                    targetPlayer.position = jailIndex !== -1 ? jailIndex : targetPlayer.position; 
                    targetPlayer.inJail = true;
                    targetPlayer.jailTurns = 3; 
                    logMsg = `${currentPlayer.name} å° ${targetPlayer.name} ä½¿ç”¨é™·å®³å¡ï¼Œå°‡ ${targetPlayer.name} é€å…¥ç›£ç„ (Jail)ï¼`;
                    saveCurrentPlayerState(targetPlayer);
                }
                
                // æ¸…é™¤é™·å®³å¡
                currentPlayer.trapCard = null;
                saveCurrentPlayerState(currentPlayer);
                
            } else if (actionType === 'æ”¾æ£„') {
                logMsg = `${currentPlayer.name} é¸æ“‡æ”¾æ£„ä½¿ç”¨é™·å®³å¡ (å›åˆçµæŸæ™‚è‡ªå‹•éŠ·æ¯€)ã€‚`;
                currentPlayer.trapCard = null; // æ¸…é™¤é™·å®³å¡
                saveCurrentPlayerState(currentPlayer);
            }

            // ** NEW: æ¸…é™¤ pendingAction ä¸¦çµæŸå›åˆ **
            const nextState = { ...gameState, status: 'ROLLED', pendingAction: { type: 'none', squareIndex: null, card: null } };
            setTimeout(async () => {
                await updateGameState(nextState, logMsg);
                await endTurn();
            }, 50);
        }


        function showRentModal(payer, receiver, square, amount) {
            
            // æˆ¿å±‹æ•¸é‡é¡¯ç¤º
            const houseCount = square.houses;
            let houseText = 'ç„¡æˆ¿å±‹ (åŸºç¤ç§Ÿé‡‘)';
            if (houseCount === HOUSE_CONFIG.MAX_HOUSES) {
                 houseText = 'è±ªè¯å¤§æ¨“ ğŸ¢';
            } else if (houseCount === 3) {
                 houseText = 'é«˜ç´šå…¬å¯“ ğŸ¢';
            } else if (houseCount === 2) {
                 houseText = 'ä¸­ç´šå…¬å¯“ ğŸ ';
            } else if (houseCount === 1) {
                 houseText = 'ä¸€é–“æˆ¿å±‹ ğŸ¡';
            }
            
            // è¨ˆç®—æ‰£æ¬¾å‰çš„é¤˜é¡
            const beforeMoney = payer.money;
            
            // é€™è£¡åŸ·è¡Œæ‰£æ¬¾å’ŒåŠ éŒ¢
            payer.money -= amount;
            receiver.money += amount;
            
            const message = `${payer.name} åœåœ¨äº† ${square.name} (${houseText})ï¼Œé€™æ˜¯ ${receiver.name} çš„åœ°ç”¢ã€‚<br/>
                             æ‚¨éœ€è¦æ”¯ä»˜ <span class="text-red-600 font-bold">$${amount.toLocaleString()}</span> éè·¯è²»ã€‚
                             <div class="mt-4 p-3 bg-red-50 rounded-lg border border-red-300">
                                <p class="text-sm">æ‰£æ¬¾å‰ç¾é‡‘: <span class="font-bold text-gray-700">$${beforeMoney.toLocaleString()}</span></p>
                                <p class="text-sm font-bold text-red-600">æ‡‰ç¹³ç§Ÿé‡‘: -$${amount.toLocaleString()}</p>
                                <hr class="my-2 border-red-200"/>
                                <p class="text-lg font-extrabold text-red-700">æ‰£æ¬¾å¾Œé¤˜é¡: $${payer.money.toLocaleString()}</p>
                             </div>`;
            
            showModal(
                `[${payer.name}] æ”¯ä»˜éè·¯è²»ç¢ºèª`,
                message,
                () => {
                    saveCurrentPlayerState(payer);
                    saveCurrentPlayerState(receiver);
                    
                    const logMessage = `${payer.name} å‘ ${receiver.name} æ”¯ä»˜äº† $${amount.toLocaleString()} æˆ¿ç§Ÿã€‚`;
                    // å¿…é ˆåœ¨ Modal é—œé–‰å¾Œèª¿ç”¨ updateGameState/endTurn
                    const nextState = { ...gameState, status: 'ROLLED', pendingAction: { type: 'none', squareIndex: null, card: null } };
                    setTimeout(async () => {
                        await updateGameState(nextState, logMessage);
                        await endTurn();
                    }, 50);
                },
                null,
                'ç¢ºèªæ”¯ä»˜'
            );

            // **ä¿®å¾©ï¼šé»æ“Š X ä¹Ÿå¼·åˆ¶æ”¯ä»˜ + çµæŸå›åˆï¼ˆç„¡æ³•é€ƒé¿æˆ¿ç§Ÿï¼Œå›åˆä¸å¡ï¼‰**
            const handleForcedPay = () => {
                document.getElementById('modal').classList.add('hidden');
                document.getElementById('modal').classList.remove('flex');
                saveCurrentPlayerState(payer);
                saveCurrentPlayerState(receiver);
                const logMessage = `${payer.name} å‘ ${receiver.name} æ”¯ä»˜äº† $${amount.toLocaleString()} æˆ¿ç§Ÿ (é»æ“Š X é—œé–‰è¦–çª—)ã€‚`;
                const nextState = { ...gameState, status: 'ROLLED', pendingAction: { type: 'none', squareIndex: null, card: null } };
                setTimeout(async () => {
                    await updateGameState(nextState, logMessage);
                    await endTurn();
                }, 50);
            };
            document.getElementById('modal-top-close-btn').onclick = handleForcedPay;
        }

        /**
         * è³¼è²·åœ°ç”¢æ ¸å¿ƒé‚è¼¯ (åœ¨ Modal å…§è¢«èª¿ç”¨)
         */
        async function performBuyProperty(player, square) {
             const price = square.price;
             
             player.money -= price;
             const newBoard = gameState.board.map((s, index) => {
                 if (index === square.index) {
                     // ç¢ºä¿åœ°ç”¢ç‹€æ…‹åœ¨ board é™£åˆ—ä¸­è¢«æ›´æ–° (owner, houses, mortgage)
                     return { ...s, owner: player.id, houses: s.houses || 0, mortgage: s.mortgage || false };
                 }
                 return s;
             });

             player.properties.push(square.name);

             saveCurrentPlayerState(player);
             // **NEW: æ¸…é™¤ pendingAction**
             const nextState = { ...gameState, board: newBoard, status: 'ROLLED', pendingAction: { type: 'none', squareIndex: null, card: null } };
             await updateGameState(nextState, `${player.name} è³¼è²·äº† ${square.name}ï¼Œæ”¯ä»˜ $${price.toLocaleString()}ã€‚`);
             
             // ** Bug 2 ä¿®æ­£: è³¼è²·æˆåŠŸå¾Œï¼Œåœ¨ Modal é—œé–‰å¾Œå‘¼å« endTurn **
             await endTurn(); 
        }

        /**
         * é¡¯ç¤ºåœ°ç”¢è³¼è²·/ç°¡ä»‹æ¨¡æ…‹è¦–çª— (NEW)
         */
        async function showPropertyBuyModal(currentPlayer, currentSquare) {
            
             const price = currentSquare.price;
             const canAfford = currentPlayer.money >= price;
             
             const modalTitle = `[${currentPlayer.name}] è³¼è²·åœ°ç”¢: ${currentSquare.name}`; 
             const defaultPlaceholderUrl = `https://placehold.co/300x200/4f46e5/ffffff?text=${encodeURIComponent(currentSquare.name + ' (Placeholder)')}`;
             const displayUrl = currentSquare.imageUrl || defaultPlaceholderUrl;
             
             let initialSummaryHtml = `<div class="text-center py-4 text-indigo-600 font-semibold">
                                           <span class="animate-spin inline-block w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full mr-2"></span>
                                            è¼‰å…¥ ${currentSquare.name} çš„ç°¡ä»‹...
                                         </div>`;
             
             // æª¢æŸ¥ç·©å­˜
             const cachedSummary = gameState.settings?.suburbSummaries?.[currentSquare.name];
             if (cachedSummary) {
                 initialSummaryHtml = `<p class="text-base text-gray-600">${cachedSummary.text}</p>`;
             }
             
             const contentTemplate = `
                 <div class="space-y-4">
                     <div class="p-3 bg-gray-100 rounded-lg text-center border-2 border-dashed border-gray-300">
                                <p class="text-sm text-gray-500 mb-2">åœ°ç”¢åœ–ç‰‡</p>
                                <img id="property-modal-image" src="${displayUrl}" 
                                      onerror="this.onerror=null;this.src='${defaultPlaceholderUrl}'"
                                      alt="Image for ${currentSquare.name}" class="mt-2 mx-auto rounded w-full h-auto max-h-48 object-cover"/>
                     </div>

                     <div class="bg-indigo-50 p-3 rounded-lg">
                                <p class="text-lg font-bold text-indigo-700">åƒ¹æ ¼: $${price.toLocaleString()}</p>
                                <p class="text-sm text-gray-600">åŸºç¤ç§Ÿé‡‘ (ç„¡æˆ¿å±‹): $${currentSquare.rent.toLocaleString()}</p>
                                <p class="text-sm text-gray-600">æˆ¿å±‹/å‡ç´šæˆæœ¬: $${currentSquare.housePrice.toLocaleString()}</p>
                                <p class="text-sm text-gray-600">æ‚¨çš„ç¾é‡‘: $${currentPlayer.money.toLocaleString()}</p>
                     </div>
                     
                     <div id="summary-and-source-area" class="max-h-32 overflow-y-auto pr-1">
                                 ${initialSummaryHtml}
                     </div>
                     
                     ${!canAfford ? `<p class="text-xl text-red-600 font-extrabold text-center mt-4">Oopsï¼è²·ä¸èµ·ï¼ç¾é‡‘ä¸è¶³ï¼</p>` : ''}
                 </div>
             `;
             
             showModal(
                 modalTitle, 
                 `æ‚¨åœåœ¨äº†ç„¡ä¸»åœ°ç”¢ ${currentSquare.name}ï¼Œè«‹æ±ºå®šæ˜¯å¦è³¼è²·ï¼š`,
                 // **å°‡ Action æ”¹ç‚ºåŒæ­¥å‡½å¼ï¼Œä»¥é¿å… Bug 2 çš„å•é¡Œ**
                 () => { 
                     // Confirm Action: è³¼è²·åœ°ç”¢
                     if (canAfford) {
                         // å»¶é²åŸ·è¡Œç•°æ­¥è³¼è²·å’ŒçµæŸå›åˆï¼Œç¢ºä¿ Modal å·²ç¶“é—œé–‰
                         setTimeout(() => performBuyProperty(currentPlayer, currentSquare), 50); 
                     } else {
                         // å¦‚æœéŒ¢ä¸å¤ ï¼Œç¢ºèªæŒ‰éˆ•æ˜¯ã€Œç¢ºèªé›¢é–‹ã€ï¼Œåƒ…çµæŸå›åˆ
                         setTimeout(async () => {
                             // **NEW: æ¸…é™¤ pendingAction**
                             await updateGameState({ ...gameState, status: 'ROLLED', pendingAction: { type: 'none', squareIndex: null, card: null } }, `${currentPlayer.name} å› ç¾é‡‘ä¸è¶³ï¼Œæ”¾æ£„è³¼è²· ${currentSquare.name}ã€‚`);
                             await endTurn();
                         }, 50);
                     }
                 },
                 contentTemplate,
                 canAfford ? `è³¼è²· ($${price.toLocaleString()})` : 'ç¢ºèªé›¢é–‹' 
             );
             
             // è™•ç†å–æ¶ˆ (ä¸è³¼è²·)
             const cancelBtn = document.getElementById('modal-cancel-btn');
             cancelBtn.textContent = 'æ”¾æ£„è³¼è²·/å–æ¶ˆ';
             cancelBtn.classList.remove('hidden');
             // ** Bug 1 & 2 ä¿®æ­£ï¼šè™•ç†æ”¾æ£„è³¼è²·/å–æ¶ˆé‚è¼¯ **
             const handleCancelOrClose = async () => {
                  document.getElementById('modal').classList.add('hidden');
                  document.getElementById('modal').classList.remove('flex');
                 
                  // **ç¢ºä¿ status è¨­ç‚º ROLLED ä¸¦å‘¼å« endTurn**
                  // **NEW: æ¸…é™¤ pendingAction**
                  setTimeout(async () => {
                      await updateGameState({ ...gameState, status: 'ROLLED', pendingAction: { type: 'none', squareIndex: null, card: null } }, `${currentPlayer.name} æ±ºå®šæ”¾æ£„è³¼è²· ${currentSquare.name}ã€‚`);
                      await endTurn();
                  }, 50);
             };
             
             // ** Bug 1 ä¿®æ­£ï¼šé»æ“Š X é—œé–‰æŒ‰éˆ•æ™‚ï¼ŒåŸ·è¡Œç›¸åŒçš„é‚è¼¯**
             document.getElementById('modal-top-close-btn').onclick = handleCancelOrClose;
             cancelBtn.onclick = handleCancelOrClose;
             
             if (!canAfford) {
                 // å¦‚æœè²·ä¸èµ·ï¼Œç¦ç”¨è³¼è²·æŒ‰éˆ•ï¼Œä¸¦å°‡ç¢ºèªæŒ‰éˆ•è®Šæˆå–æ¶ˆæŒ‰éˆ•çš„è¡Œç‚º
                 const confirmBtn = document.getElementById('modal-confirm-btn');
                 confirmBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                 confirmBtn.classList.add('bg-gray-400', 'hover:bg-gray-500');
                 cancelBtn.classList.add('hidden'); // æ—¢ç„¶ç¢ºèªæŒ‰éˆ•å·²ç¶“æ˜¯å–æ¶ˆè¡Œç‚ºäº†ï¼Œéš±è—å¦ä¸€å€‹å–æ¶ˆæŒ‰éˆ•
                 // ** Bug 1 ä¿®æ­£ï¼šåœ¨è²·ä¸èµ·çš„æƒ…æ³ä¸‹ï¼Œç¢ºèªæŒ‰éˆ•çš„è¡Œç‚ºèˆ‡å–æ¶ˆç›¸åŒ**
                 confirmBtn.onclick = handleCancelOrClose;
             }
             
             // --- Async load/cache logic for summary ---
             if (!cachedSummary) {
                 try {
                     const summary = await fetchSuburbSummary(currentSquare.name);
                     
                     // æˆåŠŸï¼šæ›´æ–° UI
                     const container = document.getElementById('summary-and-source-area');
                     if (container) {
                         container.innerHTML = `<p class="text-base text-gray-600">${summary.text}</p>`;
                     }
                     
                     // æˆåŠŸï¼šæ›´æ–°ç·©å­˜ä¸¦å„²å­˜åˆ° Firestore (åªæ›´æ–°ç‹€æ…‹ï¼Œä¸å¯«æ—¥èªŒ)
                     gameState.settings.suburbSummaries = {
                         ...gameState.settings.suburbSummaries,
                         [currentSquare.name]: { text: summary.text, sources: summary.sources || [] }
                     };
                     await updateGameState(gameState); 
                 
                 } catch (error) {
                     const errorMessage = `è¼‰å…¥ç°¡ä»‹å¤±æ•—: ${error.message}`;
                     const container = document.getElementById('summary-and-source-area');
                     if (container) {
                          container.innerHTML = `<p class="text-red-500 font-bold">è¼‰å…¥ç°¡ä»‹å¤±æ•—</p><p class="text-sm mt-2">${errorMessage}</p>`;
                     }
                     console.error("Gemini API Call Failed:", error);
                 }
             }
             // --- End Async load/cache logic ---
        }
        
        // --- NEW: åœ°ç”¢ç®¡ç†ç›¸é—œå‡½å¼ (åŒ…å«æˆ¿å±‹å»ºé€ å’ŒæŠµæŠ¼/è´–å›) ---
        
        /**
         * é¡¯ç¤ºåœ°ç”¢ç®¡ç†æ¨¡æ…‹è¦–çª—
         */
        async function showPropertyManagementModal(currentPlayer, currentSquare) {
             const squareIndex = currentSquare.index;
             
             const isMyTurn = (gameState.settings?.hotSwapMode && gameState.players[0]?.currentUserId === userId) || (currentPlayer.currentUserId === userId);
             
             if (!isMyTurn) {
                 addLog('éŒ¯èª¤ï¼šç¾åœ¨ä¸æ˜¯æ‚¨çš„å›åˆï¼Œç„¡æ³•é€²è¡Œåœ°ç”¢ç®¡ç†ã€‚', 'error');
                 return;
             }

             // ç¢ºä¿ modal å…§å®¹æ˜¯å³æ™‚çš„
             const renderModalContent = (player, square) => {
                 // ** é—œéµä¿®æ­£ï¼šç¢ºä¿ square ç‰©ä»¶æ˜¯ Board ä¸­è©²åœ°å¡Šçš„æœ€æ–°ç‹€æ…‹ **
                 const boardSquare = gameState.board.find(s => s.index === square.index);
                 const housePrice = boardSquare.housePrice;
                 const currentHouses = boardSquare.houses; // 0-4
                 const maxHouses = HOUSE_CONFIG.MAX_HOUSES; // 4
                 
                 // æˆ¿å±‹ç‹€æ…‹æè¿°
                 const houseDescriptions = ['ç©ºåœ°', 'æˆ¿å±‹ ğŸ¡', 'å…¬å¯“ (2æˆ¿) ğŸ ', 'è±ªè¯å…¬å¯“ (3æˆ¿) ğŸ¢', 'å¤§æ¨“ (4æˆ¿) ğŸ¢'];
                 const currentRent = calculateRent(boardSquare);
                 
                 const buyPrice = housePrice;
                 const sellPrice = Math.floor(housePrice * 0.5); // è³£å‡ºåƒ¹æ ¼ç‚ºæˆæœ¬çš„ä¸€åŠ
                 const canBuy = player.money >= buyPrice && currentHouses < maxHouses;
                 const canSell = currentHouses > 0;
                 
                 // æŠµæŠ¼ç›¸é—œ
                 const mortgageValue = Math.floor(boardSquare.price * HOUSE_CONFIG.MORTGAGE_MULTIPLIER);
                 const releaseMortgageCost = Math.floor(mortgageValue * (1 + HOUSE_CONFIG.MORTGAGE_SELL_TAX));
                 const canMortgage = !boardSquare.mortgage && currentHouses === 0; // å¿…é ˆæ¸…ç©ºæˆ¿å±‹æ‰èƒ½æŠµæŠ¼
                 const canRelease = boardSquare.mortgage && player.money >= releaseMortgageCost;

                 const houseStatusHtml = `
                      <div class="p-3 bg-indigo-50 rounded-lg shadow-inner">
                             <p class="text-lg font-bold text-indigo-700 mb-2">${boardSquare.name} (${houseDescriptions[currentHouses]})</p>
                             <div class="flex justify-between text-sm text-gray-700">
                                 <span>ç•¶å‰ç§Ÿé‡‘:</span>
                                 <span class="font-bold text-red-600">$${currentRent.toLocaleString()}</span>
                             </div>
                             <div class="flex justify-between text-sm text-gray-700">
                                 <span>åœ°ç”¢åƒ¹å€¼ (åŸºç¤):</span>
                                 <span class="font-bold">$${boardSquare.price.toLocaleString()}</span>
                             </div>
                             <div class="flex justify-between text-sm text-gray-700">
                                 <span>æˆ¿å±‹/å‡ç´šæˆæœ¬ (æ¯ç´š):</span>
                                 <span class="font-bold">$${housePrice.toLocaleString()}</span>
                             </div>
                             <div class="flex justify-between text-sm text-gray-700">
                                 <span>æŠµæŠ¼åƒ¹å€¼:</span>
                                 <span class="font-bold">$${mortgageValue.toLocaleString()}</span>
                             </div>
                             <div class="flex justify-between text-sm text-gray-700 mt-2">
                                 <span>æ‚¨çš„ç¾é‡‘:</span>
                                 <span id="mgmt-cash" class="font-bold text-green-700">$${player.money.toLocaleString()}</span>
                             </div>
                      </div>
                 `;
                 
                 const actionButtonsHtml = `
                      <div class="mt-4 border-t pt-4">
                             <p class="font-bold text-gray-700 mb-2">æˆ¿å±‹/å‡ç´šç®¡ç† (${currentHouses} / ${maxHouses})</p>
                             ${boardSquare.mortgage ? 
                                 `<p class="text-red-600 font-bold mb-2">ğŸš¨ åœ°ç”¢å·²æŠµæŠ¼ï¼Œç„¡æ³•é€²è¡Œæˆ¿å±‹äº¤æ˜“ï¼</p>` : ''}
                             <div class="flex space-x-2">
                                 <button id="buy-house-btn" class="py-2 px-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-150 flex-grow disabled:opacity-50"
                                         ${!canBuy || boardSquare.mortgage ? 'disabled' : ''} data-price="${buyPrice}">
                                     ${currentHouses === 0 ? 'è“‹æˆ¿å±‹' : (currentHouses === maxHouses - 1 ? 'è“‹å¤§æ¨“' : 'å‡ç´š')} ($${buyPrice.toLocaleString()})
                                 </button>
                                 <button id="sell-house-btn" class="py-2 px-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150 flex-grow disabled:opacity-50"
                                         ${!canSell || boardSquare.mortgage ? 'disabled' : ''} data-price="${sellPrice}">
                                     è³£å‡º/é™ç´š ($${sellPrice.toLocaleString()})
                                 </button>
                             </div>
                             <p id="house-msg" class="text-xs text-red-500 mt-2 font-semibold"></p>
                      </div>
                      
                      <div class="mt-4 border-t pt-4">
                             <p class="font-bold text-gray-700 mb-2">è²¡å‹™ç®¡ç† (${boardSquare.mortgage ? 'æŠµæŠ¼ä¸­ ğŸ”’' : 'æœªæŠµæŠ¼'})</p>
                             <div class="flex space-x-2">
                                 ${boardSquare.mortgage ? 
                                     `<button id="release-mortgage-btn" class="py-2 px-3 bg-yellow-600 text-gray-900 rounded-lg hover:bg-yellow-700 transition duration-150 flex-grow disabled:opacity-50"
                                              ${!canRelease ? 'disabled' : ''} data-price="${releaseMortgageCost}">
                                         è´–å›æŠµæŠ¼ ($${releaseMortgageCost.toLocaleString()})
                                     </button>` :
                                     `<button id="mortgage-btn" class="py-2 px-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-150 flex-grow disabled:opacity-50"
                                              ${!canMortgage ? 'disabled' : ''} data-price="${mortgageValue}">
                                         æŠµæŠ¼åœ°ç”¢ ($${mortgageValue.toLocaleString()})
                                     </button>`
                                  }
                             </div>
                             ${!canMortgage && !boardSquare.mortgage ? 
                                 `<p class="text-xs text-red-500 mt-2 font-semibold">âš ï¸ æŠµæŠ¼å‰å¿…é ˆå…ˆè³£æ‰æ‰€æœ‰ ${currentHouses} é–“æˆ¿å±‹/å»ºç¯‰ï¼</p>` : ''}
                             ${boardSquare.mortgage && !canRelease ? 
                                 `<p class="text-xs text-red-500 mt-2 font-semibold">è´–å›æŠµæŠ¼éœ€è¦ç¾é‡‘ $${releaseMortgageCost.toLocaleString()}ã€‚</p>` : ''}
                             <p id="mortgage-msg" class="text-xs text-red-500 mt-2 font-semibold"></p>
                      </div>
                 `;
                 
                 return houseStatusHtml + actionButtonsHtml;
             };
             
             // é¦–æ¬¡é¡¯ç¤º Modal
             showModal(
                 `[${currentPlayer.name}] åœ°ç”¢ç®¡ç†: ${currentSquare.name}`, 
                 'è«‹é¸æ“‡å°æ‚¨çš„åœ°ç”¢é€²è¡Œæˆ¿å±‹å‡ç´š/é™ç´šæˆ–æŠµæŠ¼/è´–å›æ“ä½œã€‚',
                 // **å°‡ Action æ”¹ç‚ºåŒæ­¥å‡½å¼ï¼Œä»¥é¿å… Bug 2 çš„å•é¡Œ**
                 () => {
                      // Confirm Action: åƒ…é—œé–‰ Modal ä¸¦çµæŸå›åˆ
                      // **NEW: æ¸…é™¤ pendingAction**
                      setTimeout(async () => {
                          await updateGameState({ ...gameState, status: 'ROLLED', pendingAction: { type: 'none', squareIndex: null, card: null } }, `${currentPlayer.name} å®Œæˆåœ°ç”¢ç®¡ç†ã€‚`);
                          await endTurn();
                      }, 50);
                 },
                 renderModalContent(currentPlayer, currentSquare),
                 'å®Œæˆç®¡ç†'
             );
             
             // è™•ç†å–æ¶ˆ (åŒå®Œæˆç®¡ç†)
             document.getElementById('modal-cancel-btn').classList.remove('hidden');
             const handleExitManagement = async () => {
                  document.getElementById('modal').classList.add('hidden');
                  document.getElementById('modal').classList.remove('flex');
                 
                  // **ç¢ºä¿ status è¨­ç‚º ROLLED ä¸¦å‘¼å« endTurn**
                  // **NEW: æ¸…é™¤ pendingAction**
                  setTimeout(async () => {
                      await updateGameState({ ...gameState, status: 'ROLLED', pendingAction: { type: 'none', squareIndex: null, card: null } }, `${currentPlayer.name} é€€å‡ºåœ°ç”¢ç®¡ç†ã€‚`);
                      await endTurn();
                  }, 50);
             };
             document.getElementById('modal-top-close-btn').onclick = handleExitManagement;
             document.getElementById('modal-cancel-btn').onclick = handleExitManagement;


             // *** æˆ¿å±‹/å‡ç´šè³¼è²·é‚è¼¯ (å•é¡Œ 3 ä¿®æ­£) ***
             document.getElementById('buy-house-btn').onclick = async () => {
                 const price = parseInt(document.getElementById('buy-house-btn').dataset.price);
                 const houseMsg = document.getElementById('house-msg');
                 
                 // é‡æ–°ç²å–æœ€æ–°çš„ square ç‹€æ…‹
                 const latestSquare = gameState.board.find(s => s.index === currentSquare.index);
                 
                 if (currentPlayer.money < price) {
                     houseMsg.textContent = 'éŒ¯èª¤ï¼šç¾é‡‘ä¸è¶³ä»¥æ”¯ä»˜å‡ç´šè²»ç”¨ï¼';
                     return;
                 }
                 // æª¢æŸ¥æ˜¯å¦å·²é”æœ€é«˜ç­‰ç´š
                 if (latestSquare.houses >= HOUSE_CONFIG.MAX_HOUSES) {
                     houseMsg.textContent = 'éŒ¯èª¤ï¼šå·²é”æœ€é«˜å‡ç´šç´šåˆ¥ï¼ˆå¤§æ¨“ï¼‰ï¼';
                     return;
                 }
                 
                 currentPlayer.money -= price;
                 // **å•é¡Œ 3 ä¿®æ­£ï¼šç›´æ¥æ›´æ–° board å…§è©²åœ°å¡Šçš„å¼•ç”¨**
                 latestSquare.houses++;
                 
                 saveCurrentPlayerState(currentPlayer);
                 const houseDescriptions = ['ç©ºåœ°', 'æˆ¿å±‹ ğŸ¡', 'å…¬å¯“ (2æˆ¿) ğŸ ', 'è±ªè¯å…¬å¯“ (3æˆ¿) ğŸ¢', 'å¤§æ¨“ (4æˆ¿) ğŸ¢'];
                 const houseDescription = houseDescriptions[latestSquare.houses];
                 const logMsg = `${currentPlayer.name} å‡ç´šäº† ${latestSquare.name} åˆ° ${houseDescription}ï¼ŒèŠ±è²» $${price.toLocaleString()}ã€‚`;
                 
                 // å¼·åˆ¶æ›´æ–°ç‹€æ…‹åˆ° Firestore (åŒæ­¥æ“ä½œ)
                 await updateGameState(gameState, logMsg);

                 // é‡æ–°æ¸²æŸ“ Modal å…§å®¹ä»¥æ›´æ–°ç‹€æ…‹å’ŒæŒ‰éˆ• (å•é¡Œ 3 ä¿®æ­£)
                 document.getElementById('modal-content').innerHTML = renderModalContent(currentPlayer, latestSquare);
                 // é‡æ–°ç¶å®šäº‹ä»¶
                 bindManagementEvents(currentPlayer, latestSquare);
                 addLog(logMsg);
             };

             // *** æˆ¿å±‹/å‡ç´šå‡ºå”®é‚è¼¯ (å•é¡Œ 4 ä¿®æ­£) ***
             document.getElementById('sell-house-btn').onclick = async () => {
                 const price = parseInt(document.getElementById('sell-house-btn').dataset.price);
                 const houseMsg = document.getElementById('house-msg');

                 // é‡æ–°ç²å–æœ€æ–°çš„ square ç‹€æ…‹
                 const latestSquare = gameState.board.find(s => s.index === currentSquare.index);

                 if (latestSquare.houses <= 0) {
                     houseMsg.textContent = 'éŒ¯èª¤ï¼šåœ°ç”¢ä¸Šæ²’æœ‰å¯å‡ºå”®çš„æˆ¿å±‹/å»ºç¯‰ï¼';
                     return;
                 }
                 
                 currentPlayer.money += price;
                 // **å•é¡Œ 4 ä¿®æ­£ï¼šç›´æ¥æ›´æ–° board å…§è©²åœ°å¡Šçš„å¼•ç”¨**
                 latestSquare.houses--;
                 
                 // æ›´æ–° gameState.board ä¸­çš„ square
                 
                 saveCurrentPlayerState(currentPlayer);
                 const houseDescriptions = ['ç©ºåœ°', 'æˆ¿å±‹ ğŸ¡', 'å…¬å¯“ (2æˆ¿) ğŸ ', 'è±ªè¯å…¬å¯“ (3æˆ¿) ğŸ¢', 'å¤§æ¨“ (4æˆ¿) ğŸ¢'];
                 const houseDescription = houseDescriptions[latestSquare.houses]; // è³£æ‰å¾Œçš„æ–°ç‹€æ…‹ (currentSquare.houses å·²æ˜¯æ–°å€¼)
                 const logMsg = `${currentPlayer.name} è³£å‡º/é™ç´šäº† ${latestSquare.name} åˆ° ${houseDescription}ï¼Œç²å¾— $${price.toLocaleString()}ã€‚`;
                 
                 // å¼·åˆ¶æ›´æ–°ç‹€æ…‹åˆ° Firestore (åŒæ­¥æ“ä½œ)
                 await updateGameState(gameState, logMsg);

                 // é‡æ–°æ¸²æŸ“ Modal å…§å®¹ä»¥æ›´æ–°ç‹€æ…‹å’ŒæŒ‰éˆ• (å•é¡Œ 4 ä¿®æ­£)
                 document.getElementById('modal-content').innerHTML = renderModalContent(currentPlayer, latestSquare);
                 // é‡æ–°ç¶å®šäº‹ä»¶
                 bindManagementEvents(currentPlayer, latestSquare);
                 addLog(logMsg);
             };
             
             // *** æŠµæŠ¼/è´–å›é‚è¼¯ (å•é¡Œ 4, 5 ä¿®æ­£) ***
             function bindManagementEvents(player, square) {
                 const mortgageBtn = document.getElementById('mortgage-btn');
                 if (mortgageBtn) {
                     mortgageBtn.onclick = async () => {
                         const value = parseInt(mortgageBtn.dataset.price);
                         const mortgageMsg = document.getElementById('mortgage-msg');

                         if (square.houses > 0) {
                             mortgageMsg.textContent = 'éŒ¯èª¤ï¼šæŠµæŠ¼å‰å¿…é ˆå…ˆè³£æ‰æ‰€æœ‰æˆ¿å±‹/å»ºç¯‰ï¼';
                             return;
                         }

                         player.money += value;
                         // **å•é¡Œ 5 ä¿®æ­£ï¼šç›´æ¥æ›´æ–° board å…§è©²åœ°å¡Šçš„å¼•ç”¨**
                         square.mortgage = true;
                         
                         saveCurrentPlayerState(player);
                         const logMsg = `${player.name} æŠµæŠ¼äº† ${square.name}ï¼Œç²å¾— $${value.toLocaleString()}ã€‚`;
                         await updateGameState(gameState, logMsg);
                         
                         // é‡æ–°æ¸²æŸ“ Modal å…§å®¹
                         document.getElementById('modal-content').innerHTML = renderModalContent(player, square);
                         bindManagementEvents(player, square); // é‡æ–°ç¶å®š
                         addLog(logMsg);
                     };
                 }
                 
                 const releaseMortgageBtn = document.getElementById('release-mortgage-btn');
                 if (releaseMortgageBtn) {
                     releaseMortgageBtn.onclick = async () => {
                         const cost = parseInt(releaseMortgageBtn.dataset.price);
                         const mortgageMsg = document.getElementById('mortgage-msg');

                         if (player.money < cost) {
                             mortgageMsg.textContent = `éŒ¯èª¤ï¼šç¾é‡‘ä¸è¶³ä»¥æ”¯ä»˜è´–å›è²»ç”¨ $${cost.toLocaleString()}ï¼`;
                             return;
                         }

                         player.money -= cost;
                         // **å•é¡Œ 5 ä¿®æ­£ï¼šç›´æ¥æ›´æ–° board å…§è©²åœ°å¡Šçš„å¼•ç”¨**
                         square.mortgage = false;
                         
                         saveCurrentPlayerState(player);
                         const logMsg = `${player.name} è´–å›äº† ${square.name}ï¼Œæ”¯ä»˜ $${cost.toLocaleString()}ã€‚`;
                         await updateGameState(gameState, logMsg);
                         
                         // é‡æ–°æ¸²æŸ“ Modal å…§å®¹
                         document.getElementById('modal-content').innerHTML = renderModalContent(player, square);
                         bindManagementEvents(player, square); // é‡æ–°ç¶å®š
                         addLog(logMsg);
                     };
                 }

                 // ç¢ºä¿æˆ¿å±‹/å‡ç´šæŒ‰éˆ•ä¹Ÿè¢«é‡æ–°ç¶å®š
                 document.getElementById('buy-house-btn').onclick = document.getElementById('buy-house-btn').onclick;
                 document.getElementById('sell-house-btn').onclick = document.getElementById('sell-house-btn').onclick;
             }
             
             // ç¶å®šäº‹ä»¶ (åŒ…å«åœ¨ showPropertyManagementModal é¦–æ¬¡å‘¼å«æ™‚ï¼Œå’Œä¹‹å¾Œçš„é‡æ–°æ¸²æŸ“)
             bindManagementEvents(currentPlayer, currentSquare);
             
        }

        // **NEW: é‡æ–°å°å‡ºçµ¦æŒ‰éˆ•èª¿ç”¨ (è™•ç†é‡æ–°æ•´ç†å¾Œé»æ“Š)**
        window.showPropertyBuyModalWrapper = () => {
            if (gameState.pendingAction.type === 'BUY_PROPERTY') {
                const currentPlayer = gameState.players[gameState.turn];
                const currentSquare = gameState.board[gameState.pendingAction.squareIndex];
                showPropertyBuyModal(currentPlayer, currentSquare);
            } else {
                addLog('éŒ¯èª¤: ç•¶å‰ä¸æ˜¯è³¼è²·åœ°ç”¢çš„æ™‚æ©Ÿã€‚', 'error');
            }
        };
        
        // **NEW: é‡æ–°å°å‡ºçµ¦æŒ‰éˆ•èª¿ç”¨ (è™•ç†é‡æ–°æ•´ç†å¾Œé»æ“Š)**
        window.showPropertyManagementModalWrapper = () => {
            if (gameState.pendingAction.type === 'PROPERTY_MANAGEMENT') {
                const currentPlayer = gameState.players[gameState.turn];
                const currentSquare = gameState.board[gameState.pendingAction.squareIndex];
                showPropertyManagementModal(currentPlayer, currentSquare);
            } else {
                addLog('éŒ¯èª¤: ç•¶å‰ä¸æ˜¯åœ°ç”¢ç®¡ç†çš„æ™‚æ©Ÿã€‚', 'error');
            }
        };

        window.showTrapTargetModalWrapper = () => {
            if (gameState.pendingAction.type === 'USE_TRAP_CARD' && gameState.players[gameState.turn].trapCard) {
                const currentPlayer = gameState.players[gameState.turn];
                showTrapTargetModal(currentPlayer, currentPlayer.trapCard);
            } else {
                addLog('éŒ¯èª¤: ç•¶å‰æ²’æœ‰é™·å®³å¡å¯ä½¿ç”¨æˆ–ä¸æ˜¯ä½¿ç”¨é™·å®³å¡çš„æ™‚æ©Ÿã€‚', 'error');
            }
        };


        // --- æ ¸å¿ƒå¡ç‰‡è™•ç†é‚è¼¯æ›´æ–° ---
        
        // èˆŠçš„ handleCardEffect è¢«æ‹†åˆ†ç‚º applyCardEffect + showCardModal
        
        function showCardModal(player, message, type, isNonBlocking) {
            const cardModal = document.getElementById('card-modal');
            const cardContent = document.getElementById('card-content');
            const cardTitle = document.getElementById('card-modal-title');
            const cardMessage = document.getElementById('card-modal-message');
            const cardConfirmBtn = document.getElementById('card-modal-confirm-btn');

            cardContent.className = `w-full max-w-sm rounded-xl shadow-2xl p-6 text-center ${type === 'CHANCE' ? 'card-chance' : 'card-fate'}`;
            cardTitle.textContent = `${type === 'CHANCE' ? 'æ©Ÿæœƒå¡' : 'å‘½é‹å¡'} [${player.name} æ“ä½œ]`; 
            cardMessage.innerHTML = message;
            
            // åªæœ‰ç•¶å‰ç©å®¶æ‰èƒ½ç¢ºèª (è€ƒæ…®ç†±æ©Ÿæ¨¡å¼)
            const isGameMasterDevice = gameState?.players[0]?.currentUserId === userId;
            const isHotSwapMode = gameState?.settings?.hotSwapMode === true;
            const isMyTurn = (isHotSwapMode && isGameMasterDevice) || (player.currentUserId === userId); 

            if (!isMyTurn) {
                cardModal.classList.add('hidden');
                cardModal.classList.remove('flex');
                return;
            }
            
            cardModal.classList.remove('hidden');
            cardModal.classList.add('flex');
            
            // ** ä¿®æ­£ï¼šå°æ–¼éé™·å®³å¡ (isNonBlocking=true)ï¼Œåªéœ€ç¢ºèªä¸¦çµæŸå›åˆ **
            cardConfirmBtn.onclick = () => {
                cardModal.classList.add('hidden');
                cardModal.classList.remove('flex');
                
                if (isNonBlocking) {
                    // ** NEW: é¿å…é‡è¤‡åŸ·è¡Œ updateGameStateï¼Œåªéœ€å‘¼å« endTurn **
                    // ç‹€æ…‹æ›´æ–°å’Œæ—¥èªŒå¯«å…¥å·²åœ¨ applyCardEffect -> handleLandingAction ä¸­å®Œæˆ
                    setTimeout(async () => {
                        // ç¢ºä¿ pendingAction è¢«æ¸…é™¤
                        const nextState = { ...gameState, pendingAction: { type: 'none', squareIndex: null, card: null } };
                        await setDoc(gameRef, nextState);
                        await endTurn();
                    }, 50);
                } else {
                    // é™·å®³å¡/ç‰¹æ®Šå¡ç‰‡ï¼ˆç†è«–ä¸Šé€™è£¡ä¸æœƒè¢«èª¿ç”¨ï¼Œå› ç‚ºé™·å®³å¡æœ‰è‡ªå·±çš„ Modalï¼‰
                    // ä½†ä½œç‚ºå®‰å…¨æ©Ÿåˆ¶ï¼Œä¹Ÿé€²è¡Œç‹€æ…‹æ¸…é™¤å’ŒçµæŸå›åˆ
                    saveCurrentPlayerState(player); 
                    const nextState = { ...gameState, status: 'ROLLED', pendingAction: { type: 'none', squareIndex: null, card: null } };
                    setTimeout(async () => {
                        await updateGameState(nextState, `å¡ç‰‡æ•ˆæœç”Ÿæ•ˆä¸¦ç¢ºèªã€‚`); 
                        await endTurn();
                    }, 50);
                }
            };
        }

        function handleCasinoLogic(currentPlayer, betAmount) {
            const symbols = ['ğŸ’', 'ğŸ‹', 'ğŸ””', 'BAR', '7ï¸âƒ£'];
            // ä¿®æ­£ï¼šç¢ºä¿çµæœæ˜¯ 5 å€‹
            const results = Array(5).fill().map(() => symbols[Math.floor(Math.random() * symbols.length)]);

            currentPlayer.money -= betAmount;
            let winnings = 0;
            let netGain = -betAmount;
            let message = '';
            let multiplier = 0;

            const resStr = results.join(' ');
            // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰çµæœéƒ½ç›¸åŒ
            const allSame = results.every(val => val === results[0]);
            // æª¢æŸ¥æ˜¯å¦æœ‰ä¸‰å€‹ç›¸åŒ
            const counts = results.reduce((acc, val) => { acc[val] = (acc[val] || 0) + 1; return acc; }, {});
            const hasThreeSame = Object.values(counts).some(count => count >= 3);
            // æª¢æŸ¥æ˜¯å¦æœ‰å…©å€‹ BAR
            const barCount = counts['BAR'] || 0;
            
            
            if (allSame) {
                // ä¿®æ­£: 5å€‹ç›¸åŒçå‹µæ›´é«˜ (å› ç‚ºç¾åœ¨æ˜¯ 5 å€‹è¼ªç›¤)
                if (results[0] === '7ï¸âƒ£') {
                    multiplier = 10;
                    message = `ğŸ° ${resStr} ğŸ° <br/> **è¶…ç´šå¤§ç!** äº”å€‹ 777ï¼Œ${multiplier} å€çé‡‘!`;
                } else if (results[0] === 'BAR') {
                    multiplier = 7;
                    message = `ğŸ° ${resStr} ğŸ° <br/> **å¤§ç!** äº”å€‹ BARï¼Œ${multiplier} å€çé‡‘!`;
                } else {
                    multiplier = 5;
                    message = `ğŸ° ${resStr} ğŸ° <br/> æ­å–œ! äº”å€‹ç›¸åŒï¼Œ${multiplier} å€çé‡‘!`;
                }
            } else if (hasThreeSame) {
                multiplier = 2;
                message = `ğŸ° ${resStr} ğŸ° <br/> æ­å–œ! ä¸‰å€‹ç›¸åŒï¼Œ${multiplier} å€çé‡‘!`;
            } else if (barCount >= 2) {
                multiplier = 1.5;
                message = `ğŸ° ${resStr} ğŸ° <br/> æ­å–œ! å…©å€‹ BARï¼Œ${multiplier} å€çé‡‘!`;
            } else {
                message = `ğŸ° ${resStr} ğŸ° <br/> å¾ˆéºæ†¾ï¼Œæœªä¸­çã€‚`;
            }
            
            winnings = betAmount * multiplier;
            netGain = winnings - betAmount;
            currentPlayer.money += winnings;

            return { winnings, message, resStr, netGain, betAmount, results };
        }

        function showCasinoModal(currentPlayer) {
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯è‡ªå·±çš„å›åˆ (è€ƒæ…®ç†±æ©Ÿæ¨¡å¼)
            const isGameMasterDevice = gameState.players[0] && gameState.players[0].currentUserId === userId;
            const isHotSwapMode = gameState.settings?.hotSwapMode === true;
            const isMyTurn = (isHotSwapMode && isGameMasterDevice) || (currentPlayer.currentUserId === userId); 

            if (!isMyTurn) {
                addLog(`éŒ¯èª¤ï¼šç¾åœ¨æ˜¯ ${currentPlayer.name} çš„å›åˆï¼Œæ‚¨ç„¡æ³•åŸ·è¡Œå‹•ä½œï¼`, 'error');
                return;
            }
            
            let totalNetGain = 0; 
            let currentBet = 0; 
            const spinSymbols = ['ğŸ’', 'ğŸ‹', 'ğŸ””', 'BAR', '7ï¸âƒ£', 'ğŸ’°', 'ğŸ’'];
            let spinIntervals = [];
            const minBet = 50;

            const contentHtml = `<div id="casino-display" class="p-4 bg-gray-50 rounded-lg text-center">
                                     <p class="text-sm text-gray-500 mb-2">è«‹é¸æ“‡æ‚¨çš„æŠ•æ³¨ç±Œç¢¼ (æœ€ä½ $${minBet})ï¼š</p>
                                     
                                     <div id="chip-buttons" class="flex justify-center space-x-2 mb-4">
                                        ${[50, 100, 500, 1000].map(chip => `
                                            <button data-chip="${chip}" 
                                                class="chip-btn w-12 h-12 rounded-full font-bold text-white shadow-xl hover:scale-105 transition duration-150 transform active:shadow-inner"
                                                style="background-color: ${chip === 50 ? '#8b5cf6' : chip === 100 ? '#3b82f6' : chip === 500 ? '#ef4444' : '#10b981'};">
                                            $${chip}
                                            </button>
                                        `).join('')}
                                     </div>

                                     <div class="flex justify-center items-center space-x-4 mb-4">
                                         <div class="p-3 border-2 border-dashed border-gray-400 rounded-lg shadow-inner bg-white">
                                            <p class="text-xs text-gray-500">ç•¶å‰æŠ•æ³¨</p>
                                            <p id="current-bet" class="text-2xl font-extrabold text-red-600">$0</p>
                                         </div>
                                         <button id="clear-bet-btn" class="py-2 px-4 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition duration-150">
                                            é€€å¹£ (C)
                                         </button>
                                     </div>

                                     <p class="text-sm text-gray-500 mb-2">ç•¶å‰ç¾é‡‘: <span id="current-cash" class="font-bold text-gray-800">$${currentPlayer.money.toLocaleString()}</span></p>
                                     
                                     <div id="casino-slots" class="flex justify-center space-x-2 text-3xl my-4 h-16 items-center">
    <span id="slot-1" class="font-extrabold text-gray-700 slot-spinning">?</span>
    <span id="slot-2" class="font-extrabold text-gray-700 slot-spinning">?</span>
    <span id="slot-3" class="font-extrabold text-gray-700 slot-spinning">?</span>
    <span id="slot-4" class="font-extrabold text-gray-700 slot-spinning">?</span>
    <span id="slot-5" class="font-extrabold text-gray-700 slot-spinning">?</span>
</div>

                                     <div id="game-result" class="font-extrabold text-lg my-4 text-gray-700">çå‹µå€ç‡: 5x ç›¸åŒ (5x), 3x ç›¸åŒ (2x), 2x BAR (1.5x)</div>
                                     <p class="text-sm text-gray-500">æœ¬æ¬¡æœå‹™ç¸½æ·¨æ”¶ç›Š: <span id="total-gain" class="font-bold text-gray-800">$0</span></p>
                                </div>`;

            showModal(
                `[${currentPlayer.name}] Casino - åƒè§’å­è€è™æ©Ÿ`, 
                `<p class="text-lg">æœ€ä½æŠ•æ³¨ $${minBet}ï¼Œé»æ“Šç±Œç¢¼æŒ‰éˆ•é€²è¡Œç´¯ç©ã€‚</p>`,
                () => {}, 
                contentHtml,
                'é–‹å§‹ç©' 
            );

            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const currentCashSpan = document.getElementById('current-cash');
            const totalGainSpan = document.getElementById('total-gain');
            const gameResultDiv = document.getElementById('game-result');
            const currentBetSpan = document.getElementById('current-bet'); 
            const slotElements = [
    document.getElementById('slot-1'),
    document.getElementById('slot-2'),
    document.getElementById('slot-3'),
    document.getElementById('slot-4'),
    document.getElementById('slot-5')
];
            
            function startSpin() {
                spinIntervals.forEach(clearInterval);
                spinIntervals = [];

                slotElements.forEach((slot, index) => {
                    slot.classList.add('slot-spinning');
                    let interval = setInterval(() => {
                        slot.textContent = spinSymbols[Math.floor(Math.random() * spinSymbols.length)];
                    }, 80 + index * 50);
                    spinIntervals.push(interval);
                });
            }

            function stopSpin(finalResults) {
                spinIntervals.forEach(clearInterval);
                slotElements.forEach((slot, index) => {
                    slot.classList.remove('slot-spinning');
                    slot.textContent = finalResults[index];
                });
            }

            modalCancelBtn.textContent = 'é›¢é–‹è³­å ´'; 
            modalCancelBtn.classList.remove('hidden');
            modalConfirmBtn.textContent = 'é–‹å§‹ç©'; 
            modalConfirmBtn.disabled = true; 

            document.querySelectorAll('.chip-btn').forEach(button => {
                button.onclick = () => {
                    const chipValue = parseInt(button.dataset.chip);
                    if (currentPlayer.money >= currentBet + chipValue) {
                        currentBet += chipValue;
                        currentBetSpan.textContent = `$${currentBet.toLocaleString()}`;
                        modalConfirmBtn.disabled = currentBet < minBet;
                        gameResultDiv.innerHTML = `<span class="text-gray-500">å·²ç´¯ç© $${currentBet.toLocaleString()} ç±Œç¢¼ã€‚</span>`;
                    } else {
                        gameResultDiv.innerHTML = `<span class="text-red-600">ç±Œç¢¼ä¸è¶³ï¼Œç„¡æ³•åŠ è¨» $${chipValue.toLocaleString()}ï¼</span>`;
                    }
                };
            });
            
            document.getElementById('clear-bet-btn').onclick = () => {
                 currentBet = 0;
                 currentBetSpan.textContent = `$0`;
                 modalConfirmBtn.disabled = true;
                 gameResultDiv.innerHTML = 'çå‹µå€ç‡: 5x ç›¸åŒ (5x), 3x ç›¸åŒ (2x), 2x BAR (1.5x)';
            };


            // ** Bug 2 ä¿®æ­£: ç¢ºä¿å–æ¶ˆå’Œç¢ºèªå‹•ä½œéƒ½æ˜¯åœ¨ Modal é—œé–‰å¾Œç•°æ­¥åŸ·è¡Œ endTurn **
            const handleCasinoExit = () => {
                spinIntervals.forEach(clearInterval);
                currentPlayer.money += currentBet; // é€€é‚„æœªæŠ•æ³¨ç±Œç¢¼

                const logMsg = `ç© Casino çµæŸå›åˆï¼Œç¸½æ·¨æ”¶ç›Š $${totalNetGain.toLocaleString()}ã€‚`;

                saveCurrentPlayerState(currentPlayer);

                document.getElementById('modal').classList.add('hidden');
                document.getElementById('modal').classList.remove('flex');

                setTimeout(async () => {
                    const nextState = {
                        ...gameState,
                        status: 'ROLLED',
                        pendingAction: { type: 'none', squareIndex: null, card: null } // é—œéµæ¸…é™¤
                    };
                    await updateGameState(nextState, logMsg);
                    await endTurn();
                }, 50);
            };

            modalCancelBtn.onclick = handleCasinoExit;
            document.getElementById('modal-top-close-btn').onclick = handleCasinoExit; // **é»æ“Š X ä¹Ÿè¦–ç‚ºé›¢é–‹**

            modalConfirmBtn.onclick = async () => { 
                const betAmount = currentBet; 
                currentBet = 0; 

                if (modalConfirmBtn.disabled || betAmount < minBet) return; 

                if (currentPlayer.money < betAmount) {
                    gameResultDiv.innerHTML = `<span class="text-red-600 text-xl">ç¾é‡‘ä¸è¶³ $${betAmount.toLocaleString()}! è«‹é›¢é–‹è³­å ´ã€‚</span>`;
                    modalConfirmBtn.disabled = true;
                    return;
                }
                
                currentBetSpan.textContent = `$0`; 
                modalConfirmBtn.disabled = true; 
                startSpin();

                await new Promise(resolve => setTimeout(resolve, 1500)); 

                const { message, netGain, results } = handleCasinoLogic(currentPlayer, betAmount);
                totalNetGain += netGain;

                stopSpin(results);
                
                saveCurrentPlayerState(currentPlayer);
                await updateGameState(gameState, `${currentPlayer.name} æŠ•æ³¨ $${betAmount.toLocaleString()}ï¼Œæ·¨æ”¶ç›Š $${netGain.toLocaleString()}ã€‚`);

                gameResultDiv.innerHTML = `<p class="text-base">${message}</p>`;
                currentCashSpan.textContent = `$${currentPlayer.money.toLocaleString()}`;
                
                if (totalNetGain >= 0) {
                    totalGainSpan.className = 'font-bold text-green-600';
                } else {
                    totalGainSpan.className = 'font-bold text-red-600';
                }
                totalGainSpan.textContent = `$${totalNetGain.toLocaleString()}`;

                if (currentPlayer.money >= minBet) { 
                    modalConfirmBtn.disabled = true; 
                    gameResultDiv.innerHTML += `<p class="text-base text-gray-500 mt-2">è«‹é»æ“Šç±Œç¢¼ç´¯ç©ä¸‹æ¬¡æŠ•æ³¨ã€‚</p>`;
                } else {
                    modalConfirmBtn.disabled = true;
                    modalCancelBtn.classList.remove('hidden');
                    gameResultDiv.innerHTML += `<p class="text-base text-red-500 mt-2">ç¾é‡‘ä¸è¶³ï¼Œè«‹é»æ“Šã€Œé›¢é–‹è³­å ´ã€ã€‚</p>`;
                }
            };
            
            modalConfirmBtn.classList.remove('hidden');
            // ** Bug 1 ä¿®æ­£: ç¢ºä¿é ‚éƒ¨é—œé–‰æŒ‰éˆ•åŸ·è¡Œé€€å‡ºé‚è¼¯**
            document.getElementById('modal-top-close-btn').onclick = handleCasinoExit;
        }

        function showBankModal(currentPlayer) {
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯è‡ªå·±çš„å›åˆ (è€ƒæ…®ç†±æ©Ÿæ¨¡å¼)
            const isGameMasterDevice = gameState.players[0] && gameState.players[0].currentUserId === userId;
            const isHotSwapMode = gameState.settings?.hotSwapMode === true;
            const isMyTurn = (isHotSwapMode && isGameMasterDevice) || (currentPlayer.currentUserId === userId); 
            
            if (!isMyTurn) {
                addLog(`éŒ¯èª¤ï¼šç¾åœ¨æ˜¯ ${currentPlayer.name} çš„å›åˆï¼Œæ‚¨ç„¡æ³•åŸ·è¡Œå‹•ä½œï¼`, 'error');
                return;
            }
            
            const interestRate = gameState.settings.interestRate;
            
            // --- NEW: ç²å–è‚¡ç¥¨åˆ—è¡¨ä¸¦æ–°å¢è¨ºæ–·è³‡è¨Š ---
            // é€™è£¡ç›´æ¥ä½¿ç”¨ currentStocksï¼Œå› ç‚º onSnapshot é‚è¼¯å·²ç¢ºä¿å…¶èˆ‡ stocksConfig åŒæ­¥
            const availableStocks = gameState.currentStocks;
            const stockCountDiagnostic = availableStocks.length;

            const stockTradingHtml = availableStocks.map(stock => {
                 // å¿…é ˆå¾ settings.stocksConfig ä¸­ç²å– volatility æ‰èƒ½åœ¨å„²å­˜æ™‚ä½¿ç”¨
                 const stockConfig = gameState.settings.stocksConfig.find(s => s.symbol === stock.symbol);
                 const volatilityDisplay = stockConfig ? stockConfig.volatility : DEFAULT_VOLATILITY;
                 
                 return `
                              <div class="flex items-center space-x-2 mb-2 p-1 border-b border-gray-200">
                                  <p class="font-semibold text-sm w-16">${stock.symbol}</p>
                                  <p class="text-xs text-gray-700 w-20">è²·: $${stock.price.toLocaleString()}</p>
                                  <p class="text-xs text-gray-700 w-20">è³£: $${stock.sellPrice.toLocaleString()}</p>
                                  <input type="number" id="stock-amount-${stock.symbol}" value="1" min="1" step="1" class="w-12 p-1 border rounded text-center text-xs"/>
                                  <button data-symbol="${stock.symbol}" data-action="buy" class="stock-action-btn py-1 px-2 bg-emerald-500 text-white rounded text-xs hover:bg-emerald-600">è²·å…¥</button>
                                  <button data-symbol="${stock.symbol}" data-action="sell" class="stock-action-btn py-1 px-2 bg-red-500 text-white rounded text-xs hover:bg-red-600">è³£å‡º</button>
                                  <p class="text-xs text-gray-500">æŒè‚¡: <span id="player-stocks-${stock.symbol}" class="font-bold text-gray-800">${currentPlayer.stocks[stock.symbol] || 0}</span></p>
                              </div>
                            `;
            }).join('');

            const contentHtml = `
                 <div class="bg-gray-100 p-4 rounded-lg text-sm text-gray-700 mb-4">
                      <p class="font-semibold mb-2 text-base text-gray-800">ç•¶å‰è³‡ç”¢ (å®šå­˜åˆ©ç‡: ${(interestRate * 100).toFixed(2)}%)</p>
                      <p>ç¾é‡‘ (å¯äº¤æ˜“): <span id="bank-cash" class="font-bold text-gray-800">$${currentPlayer.money.toLocaleString()}</span></p>
                      <p>å®šå­˜ (è³ºåˆ©æ¯): <span id="bank-deposit-display" class="font-bold text-gray-800">$${currentPlayer.bank.toLocaleString()}</span></p>
                 </div>

                 <div class="mb-4 border-b pb-4">
                      <p class="font-bold mb-2">å®šå­˜æœå‹™</p>
                      <input type="number" id="bank-amount" value="1000" min="100" step="100" class="w-1/3 p-2 border rounded-lg text-center mr-2 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                      <button id="deposit-btn" class="py-2 px-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150">å­˜æ¬¾</button>
                      <button id="withdraw-btn" class="py-2 px-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition duration-150">ææ¬¾</button>
                      <p id="bank-msg" class="text-xs text-red-500 mt-1"></p>
                 </div>

                 <div class="mb-4">
                      <p class="font-bold mb-2">è‚¡ç¥¨äº¤æ˜“ (åƒ¹æ ¼å·²æ›´æ–°)</p>
                      <p class="text-sm font-semibold text-indigo-600 mb-2">ğŸ“Š ç•¶å‰é¡¯ç¤ºçš„è‚¡ç¥¨ç¸½æ•¸: ${stockCountDiagnostic} æ”¯</p>
                      <p id="stock-msg" class="text-xs text-red-500 mt-1"></p>
                      <div id="stock-trading-list">
                            ${stockTradingHtml}
                      </div>
                 </div>
             `;
            showModal(
                `[${currentPlayer.name}] éŠ€è¡Œæœå‹™`, 
                'æ­¡è¿ä½¿ç”¨éŠ€è¡Œæœå‹™ï¼Œé€™è£¡ä¹Ÿæä¾›è‚¡ç¥¨äº¤æ˜“ã€‚',
                // **å°‡ Action æ”¹ç‚ºåŒæ­¥å‡½å¼ï¼Œä»¥é¿å… Bug 2 çš„å•é¡Œ**
                () => { 
                    // Modal Confirm Action: è¨­ç½®ç‹€æ…‹ç‚º ROLLEDï¼Œè®“ç©å®¶å¯ä»¥çµæŸå›åˆ
                    // ä½¿ç”¨ setTimeout ç¢ºä¿ Modal é—œé–‰å¾Œå†åŸ·è¡Œç•°æ­¥æ“ä½œ
                    setTimeout(async () => {
                        await updateGameState({ ...gameState, status: 'ROLLED', pendingAction: { type: 'none', squareIndex: null, card: null } }, `${currentPlayer.name} å®ŒæˆéŠ€è¡Œæ“ä½œã€‚`); 
                        await endTurn(); 
                    }, 50);
                },
                contentHtml,
                'å®Œæˆæœå‹™'
            );

            document.getElementById('modal-confirm-btn').textContent = 'å®Œæˆæœå‹™';
            // document.getElementById('modal-cancel-btn').classList.add('hidden'); // çµ±ä¸€åœ¨ showModal å…§è™•ç†
            document.getElementById('modal-confirm-btn').classList.remove('hidden');

            const bankCash = document.getElementById('bank-cash');
            const bankDeposit = document.getElementById('bank-deposit-display'); // FIX: Corrected ID lookup
            const bankMsg = document.getElementById('bank-msg');
            const stockMsg = document.getElementById('stock-msg');
            const bankAmountInput = document.getElementById('bank-amount');

            document.getElementById('deposit-btn').onclick = async () => {
                const amount = parseInt(bankAmountInput.value) || 0;
                bankMsg.textContent = '';
                if (amount <= 0 || currentPlayer.money < amount) {
                    bankMsg.textContent = 'éŒ¯èª¤ï¼šé‡‘é¡å¿…é ˆå¤§æ–¼ 0 ä¸”ä¸è¶…éç¾é‡‘ï¼';
                    return;
                }
                currentPlayer.money -= amount;
                currentPlayer.bank += amount;
                saveCurrentPlayerState(currentPlayer);
                await updateGameState(gameState, `${currentPlayer.name} å­˜æ¬¾ $${amount.toLocaleString()} åˆ°å®šå­˜ã€‚`);
                bankCash.textContent = `$${currentPlayer.money.toLocaleString()}`;
                bankDeposit.textContent = `$${currentPlayer.bank.toLocaleString()}`;
            };

            document.getElementById('withdraw-btn').onclick = async () => {
                const amount = parseInt(bankAmountInput.value) || 0;
                bankMsg.textContent = '';
                if (amount <= 0 || currentPlayer.bank < amount) {
                    bankMsg.textContent = 'éŒ¯èª¤ï¼šé‡‘é¡å¿…é ˆå¤§æ–¼ 0 ä¸”ä¸è¶…éå­˜æ¬¾ï¼';
                    return;
                }
                currentPlayer.money += amount;
                currentPlayer.bank -= amount;
                saveCurrentPlayerState(currentPlayer);
                await updateGameState(gameState, `${currentPlayer.name} å¾å®šå­˜ææ¬¾ $${amount.toLocaleString()}ã€‚`);
                bankCash.textContent = `$${currentPlayer.money.toLocaleString()}`;
                bankDeposit.textContent = `$${currentPlayer.bank.toLocaleString()}`; 
            };

            document.querySelectorAll('#stock-trading-list .stock-action-btn').forEach(button => {
                button.onclick = async () => {
                    const symbol = button.dataset.symbol;
                    const action = button.dataset.action;
                    // ä½¿ç”¨æœ€æ–°çš„ currentStocks æ•¸æ“š
                    const stock = gameState.currentStocks.find(s => s.symbol === symbol); 
                    const quantityInput = document.getElementById(`stock-amount-${symbol}`);
                    const quantity = parseInt(quantityInput.value) || 0;
                    const playerStockSpan = document.getElementById(`player-stocks-${symbol}`);
                    stockMsg.textContent = '';

                    if (quantity <= 0) {
                        stockMsg.textContent = 'éŒ¯èª¤ï¼šæ•¸é‡å¿…é ˆå¤§æ–¼ 0ï¼';
                        return;
                    }
                    
                    if (!stock) {
                         stockMsg.textContent = 'éŒ¯èª¤ï¼šè‚¡ç¥¨è³‡è¨Šä¸å­˜åœ¨ã€‚';
                         return;
                    }
                    
                    // NEW FIX: ç¢ºä¿æŒè‚¡é‡å·²åˆå§‹åŒ– (è§£æ±ºæ–°å¢è‚¡ç¥¨å¾Œç„¡æ³•è³¼è²·çš„å•é¡Œ)
                    if (typeof currentPlayer.stocks[symbol] === 'undefined') {
                         currentPlayer.stocks[symbol] = 0;
                    }

                    if (action === 'buy') {
                        const cost = quantity * stock.price;
                        if (currentPlayer.money < cost) {
                            stockMsg.textContent = `éŒ¯èª¤ï¼šç¾é‡‘ä¸è¶³ä»¥æ”¯ä»˜ $${cost.toLocaleString()} (è²·å…¥åƒ¹ $${stock.price.toLocaleString()})ã€‚`;
                            return;
                        }
                        currentPlayer.money -= cost;
                        // ç¢ºä¿ currentPlayer.stocks ä¸­æœ‰è©²è‚¡ç¥¨çš„æ¢ç›®
                        currentPlayer.stocks = { ...currentPlayer.stocks, [symbol]: (currentPlayer.stocks[symbol] || 0) + quantity }; 
                        saveCurrentPlayerState(currentPlayer);
                        await updateGameState(gameState, `${currentPlayer.name} è²·å…¥ ${quantity} è‚¡ ${symbol}ï¼ŒèŠ±è²» $${cost.toLocaleString()}ã€‚`);

                    } else if (action === 'sell') {
                        const revenue = quantity * stock.sellPrice;
                        if ((currentPlayer.stocks[symbol] || 0) < quantity) {
                            stockMsg.textContent = `éŒ¯èª¤ï¼šæŒè‚¡æ•¸é‡ä¸è¶³ (æŒæœ‰ ${currentPlayer.stocks[symbol] || 0})ï¼`;
                            return;
                        }
                        currentPlayer.money += revenue;
                        currentPlayer.stocks = { ...currentPlayer.stocks, [symbol]: (currentPlayer.stocks[symbol] || 0) - quantity };
                        saveCurrentPlayerState(currentPlayer);
                        await updateGameState(gameState, `${currentPlayer.name} è³£å‡º ${quantity} è‚¡ ${symbol}ï¼Œç²å¾— $${revenue.toLocaleString()}ã€‚`);
                    }

                    bankCash.textContent = `$${currentPlayer.money.toLocaleString()}`;
                    playerStockSpan.textContent = currentPlayer.stocks[symbol];
                };
            });
            
            // ** ä¿®å¾©ï¼šé»æ“Š X æˆ–é›¢é–‹éŠ€è¡Œæ™‚ï¼Œå¼·åˆ¶çµæŸéŠ€è¡Œå‹•ä½œï¼Œè®“å›åˆå¯ä»¥ç¹¼çºŒ **
            const handleBankExit = async () => {
                // ã€æ–°å¢ã€‘é˜²æ­¢é‡è¤‡è§¸ç™¼ä¸¦é–å®šè‡ªå‹•æ¢å¾©
                if (isProcessingAction) return;
                isProcessingAction = true;

                document.getElementById('modal').classList.add('hidden');
                document.getElementById('modal').classList.remove('flex');

                // é—œéµï¼šæ¸…é™¤ pendingAction
                const nextState = {
                    ...gameState,
                    status: 'ROLLED',
                    pendingAction: { type: 'none', squareIndex: null, card: null }
                };

                await updateGameState(nextState, `${currentPlayer.name} é›¢é–‹éŠ€è¡Œæœå‹™ï¼ˆæœªå®Œæˆæ“ä½œï¼‰ã€‚`);
                await endTurn();
                
                // ã€æ–°å¢ã€‘å®‰å…¨è§£é– (é›–ç„¶é€šå¸¸é é¢ç‹€æ…‹è®Šæ›´å¾Œä¸éœ€è¦ï¼Œä½†ä»¥é˜²è¬ä¸€)
                setTimeout(() => { isProcessingAction = false; }, 2000);
            };

            // é ‚éƒ¨ X æŒ‰éˆ•
            document.getElementById('modal-top-close-btn').onclick = handleBankExit;

            // å¦‚æœæœ‰å–æ¶ˆæŒ‰éˆ•ï¼ˆé›–ç„¶ç›®å‰éš±è—ï¼‰ï¼Œä¹Ÿç¶å®šåŒæ¨£é‚è¼¯
            const cancelBtn = document.getElementById('modal-cancel-btn');
            if (!cancelBtn.classList.contains('hidden')) {
                cancelBtn.onclick = handleBankExit;
            }

            // ã€Œå®Œæˆæœå‹™ã€ç¢ºèªæŒ‰éˆ•ï¼ˆåŸæœ¬å°±çµæŸå›åˆï¼Œä¿æŒä¸è®Šï¼‰
            document.getElementById('modal-confirm-btn').onclick = async () => {
                // ã€æ–°å¢ã€‘é–å®šè‡ªå‹•æ¢å¾©
                if (isProcessingAction) return;
                isProcessingAction = true;

                document.getElementById('modal').classList.add('hidden');
                document.getElementById('modal').classList.remove('flex');

                await updateGameState({ ...gameState, status: 'ROLLED', pendingAction: { type: 'none', squareIndex: null, card: null } }, `${currentPlayer.name} å®ŒæˆéŠ€è¡Œæ“ä½œã€‚`);
                await endTurn();

                // ã€æ–°å¢ã€‘å®‰å…¨è§£é–
                setTimeout(() => { isProcessingAction = false; }, 2000);
            };
        }

        function showSettingsModal() {
            // NEW: åªæœ‰ P0 ç®¡ç†å“¡å¯ä»¥é€²å…¥è¨­å®š
            if (gameState.players[0].currentUserId !== userId) {
                addLog('éŒ¯èª¤ï¼šåªæœ‰ P0 ç©å®¶ï¼ˆç®¡ç†å“¡ï¼‰å¯ä»¥ä¿®æ”¹è¨­å®šã€‚', 'error');
                return;
            }

            const currentSettings = gameState.settings;
            let currentStocks = [...currentSettings.stocksConfig]; // ä½¿ç”¨ let å…è¨±åœ¨æœ¬åœ°ä¿®æ”¹

            const renderStockList = () => {
                const listContainer = document.getElementById('stock-list-container');
                if (!listContainer) return;

                listContainer.innerHTML = currentStocks.map(stock => {
                    // å˜—è©¦å¾å‹•æ…‹åƒ¹æ ¼ä¸­ç²å–ç•¶å‰å¸‚åƒ¹
                    const marketPrice = gameState.currentStocks.find(s => s.symbol === stock.symbol)?.price || 'N/A';
                    
                    return `
                             <div class="flex items-center space-x-2 border-b py-2">
                                 <p class="font-bold text-gray-700 w-1/3">${stock.name} (${stock.symbol})</p>
                                 <p class="text-sm text-gray-600 w-1/4">æ³¢å‹•åº¦: ${stock.volatility}</p>
                                 <p class="text-sm text-gray-600 w-1/4">å¸‚åƒ¹: $${marketPrice.toLocaleString()}</p>
                                 <button data-symbol="${stock.symbol}" data-action="remove" class="remove-stock-btn py-1 px-2 bg-red-500 text-white rounded text-xs hover:bg-red-600 transition duration-150">åˆªé™¤</button>
                             </div>
                           `;
                }).join('');

                document.querySelectorAll('.remove-stock-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const symbolToRemove = e.target.dataset.symbol;
                        currentStocks = currentStocks.filter(s => s.symbol !== symbolToRemove);
                        renderStockList();
                    };
                });
            };


            const contentHtml = `
                 <div class="space-y-4">
                    
                     <div class="border-b pb-3">
                          <label for="setting-initial-money" class="font-bold text-gray-700 block mb-2">é è¨­åˆå§‹é‡‘éŒ¢ (ç”¨æ–¼é‡å•Ÿ/ç©å®¶å•Ÿç”¨):</label>
                          <input type="number" id="setting-initial-money" value="${currentSettings.initialMoney}" min="1000" step="500" class="w-full p-2 border rounded-lg text-center font-bold text-gray-800"/>
                          <p class="text-xs text-gray-500 mt-1">ç•¶å‰é è¨­å€¼: $${currentSettings.initialMoney.toLocaleString()}</p>
                     </div>
                     
                     <div class="border-b pb-3">
                          <label for="setting-interest-rate" class="font-bold text-gray-700 block mb-2">å®šå­˜åˆ©ç‡ (æ¯å›åˆï¼Œä¾‹å¦‚ 0.01 = 1%):</label>
                          <input type="number" id="setting-interest-rate" value="${currentSettings.interestRate}" min="0.001" step="0.005" class="w-full p-2 border rounded-lg text-center font-bold text-gray-800"/>
                          <p class="text-xs text-gray-500 mt-1">ç•¶å‰: ${(currentSettings.interestRate * 100).toFixed(2)}%</p>
                     </div>

                     <div class="border-b pb-3">
                          <label for="setting-hot-swap-mode" class="font-bold text-gray-700 block mb-2">
                              **ç†±æ©Ÿæ¨¡å¼** (å–®äººå¤šè§’æ“ä½œ)
                          </label>
                          <div class="flex items-center justify-between">
                              <p class="text-xs text-gray-500 w-3/4">å•Ÿç”¨å¾Œï¼Œåªæœ‰æ§åˆ¶ P0 çš„è¨­å‚™å¯ä»¥æ§åˆ¶æ‰€æœ‰å•Ÿç”¨ç©å®¶çš„å›åˆã€‚</p>
                              <label class="relative inline-flex items-center cursor-pointer">
                                   <input type="checkbox" id="setting-hot-swap-mode" ${currentSettings.hotSwapMode ? 'checked' : ''} value="" class="sr-only peer">
                                   <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 dark:peer-focus:ring-indigo-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-indigo-600"></div>
                              </label>
                          </div>
                     </div>

                     <div class="border-b pb-3">
                          <label for="setting-debug-mode" class="font-bold text-gray-700 block mb-2">
                              **æ“²éª°åµéŒ¯æ¨¡å¼** (å¼·åˆ¶è¼¸å…¥æ­¥æ•¸)
                          </label>
                          <div class="flex items-center justify-between">
                              <p class="text-xs text-red-500 w-3/4">å•Ÿç”¨å¾Œï¼Œæ“²éª°æŒ‰éˆ•æ—æœƒå‡ºç¾æ­¥æ•¸è¼¸å…¥æ¡† (åƒ… P0 è£ç½®å¯è¦‹/ä½¿ç”¨)ã€‚</p>
                              <label class="relative inline-flex items-center cursor-pointer">
                                   <input type="checkbox" id="setting-debug-mode" ${currentSettings.debugMode ? 'checked' : ''} value="" class="sr-only peer">
                                   <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 dark:peer-focus:ring-indigo-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-indigo-600"></div>
                              </label>
                          </div>
                     </div>
                     <div class="border-b pb-3">
                          <p class="font-bold text-gray-700 mb-2">åŠ å…¥éŠæˆ²å¯©æ ¸ç‹€æ…‹:</p>
                          <p class="text-sm text-indigo-600 font-semibold">âœ… å·²å¼·åˆ¶å•Ÿç”¨ (æ‰€æœ‰æ–°ç©å®¶åŠ å…¥éŠæˆ²å‰éƒ½éœ€è¦ P0 ç®¡ç†å“¡åœ¨ã€Œç©å®¶ç®¡ç†ã€ä¸­æ‰¹å‡†)</p>
                     </div>

                     <div class="mb-4">
                          <p class="font-bold mb-2 text-gray-700">è‚¡ç¥¨ç®¡ç† (${currentStocks.length} æ”¯)</p>
                          <div id="stock-list-container" class="max-h-40 overflow-y-auto mb-4">
                              </div>
                          
                          <div class="p-3 bg-gray-50 rounded-lg space-y-2">
                              <p class="font-semibold text-sm">æ–°å¢è‚¡ç¥¨ (æ³¢å‹•åº¦é è¨­ç‚º ${DEFAULT_VOLATILITY})</p>
                              <input type="text" id="new-stock-symbol" placeholder="ä»£è™Ÿ (å¦‚: NEW)" maxlength="4" class="w-1/3 p-2 border rounded text-xs" />
                              <input type="text" id="new-stock-name" placeholder="åç¨± (å¦‚: æ–°å…¬å¸)" class="w-1/3 p-2 border rounded text-xs" />
                              <input type="number" id="new-stock-price" placeholder="åˆå§‹è²·åƒ¹" value="400" min="100" class="w-1/3 p-2 border rounded text-xs" />
                              <button id="add-stock-btn" class="w-full py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition duration-150">æ–°å¢è‚¡ç¥¨</button>
                              <p id="stock-admin-msg" class="text-xs text-red-500 mt-1"></p>
                          </div>
                     </div>

                     <div class="pt-4 border-t border-red-300">
                          <p class="font-bold mb-2 text-red-700">å±éšªå€åŸŸï¼šéŠæˆ²ç®¡ç†</p>
                          <button id="restart-game-btn" class="w-full py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150 font-bold">
                              ğŸ’¥ é‡æ–°å•Ÿå‹•éŠæˆ² (é‡è¨­é€²åº¦)
                          </button>
                          <p class="text-xs text-gray-500 mt-1">æ­¤æ“ä½œå°‡æ¸…é™¤æ‰€æœ‰ç©å®¶é€²åº¦ï¼Œè«‹è¬¹æ…æ“ä½œã€‚</p>
                          <p class="text-xs text-red-500 mt-1 font-bold">âš ï¸ æ³¨æ„ï¼šé»æ“Šæ­¤æŒ‰éˆ•å°‡å¥—ç”¨æ–°çš„æ£‹ç›¤çµæ§‹ã€‚</p>
                     </div>
                 </div>
             `;
            
            showModal(
                `[ç®¡ç†å“¡] è¨­å®š`, 
                'å®šå­˜åˆ©ç‡ã€é è¨­åˆå§‹é‡‘éŒ¢ã€ç†±æ©Ÿæ¨¡å¼åŠè‚¡ç¥¨åå–®è®Šæ›´å°‡æ–¼å„²å­˜å¾Œç”Ÿæ•ˆã€‚',
                async () => {
                    const newInterestRate = parseFloat(document.getElementById('setting-interest-rate').value);
                    const newInitialMoney = parseInt(document.getElementById('setting-initial-money').value);
                    const newHotSwapMode = document.getElementById('setting-hot-swap-mode').checked; 
                    const newDebugMode = document.getElementById('setting-debug-mode').checked; // NEW: Debug æ¨¡å¼

                    
                    gameState.settings.interestRate = newInterestRate;
                    gameState.settings.stocksConfig = currentStocks; 
                    gameState.settings.initialMoney = newInitialMoney;
                    gameState.settings.hotSwapMode = newHotSwapMode; 
                    gameState.settings.debugMode = newDebugMode; // NEW: Debug æ¨¡å¼
                    
                    const updatedStocks = [];
                    currentStocks.forEach(newStockConfig => {
                         const existingStock = gameState.currentStocks.find(s => s.symbol === newStockConfig.symbol);
                         if (existingStock) {
                             // ä¿ç•™ç¾æœ‰è‚¡ç¥¨çš„å‹•æ…‹åƒ¹æ ¼
                             updatedStocks.push({ ...existingStock, volatility: newStockConfig.volatility });
                         } else {
                             // æ–°å¢è‚¡ç¥¨ï¼Œä½¿ç”¨è¨­å®šçš„åˆå§‹åƒ¹ä¸¦è¨ˆç®—è³£åƒ¹ (FIX: ç¢ºä¿ä½¿ç”¨ newStockConfig.volatility)
                             const initialPrice = newStockConfig.price; 
                             updatedStocks.push({
                                 name: newStockConfig.name,
                                 symbol: newStockConfig.symbol,
                                 price: initialPrice,
                                 sellPrice: Math.floor(initialPrice * 0.8),
                                 volatility: newStockConfig.volatility, 
                             });
                         }
                    });

                    // åŒæ­¥ç©å®¶çš„æŒè‚¡çµæ§‹ï¼Œç¢ºä¿æ–°è‚¡ç¥¨æœ‰åˆå§‹çš„ 0 è‚¡è¨˜éŒ„
                    gameState.players.forEach(player => {
                         const updatedPlayerStocks = {};
                         // éæ­·æœ€æ–°çš„è‚¡ç¥¨åˆ—è¡¨ (currentStocks)
                         currentStocks.forEach(stock => {
                             updatedPlayerStocks[stock.symbol] = player.stocks[stock.symbol] || 0;
                         });
                         player.stocks = updatedPlayerStocks;
                         saveCurrentPlayerState(player); 
                    });

                    gameState.currentStocks = updatedStocks;
                    
                    await updateGameState(gameState, `ç®¡ç†å“¡æ›´æ–°äº†éŠæˆ²è¨­å®š (åˆ©ç‡: ${(newInterestRate * 100).toFixed(2)}%, ç†±æ©Ÿæ¨¡å¼: ${newHotSwapMode ? 'å•Ÿç”¨' : 'ç¦ç”¨'})ã€‚`);
                },
                contentHtml,
                'å„²å­˜è¨­å®š'
            );
            
            renderStockList();

            document.getElementById('add-stock-btn').onclick = () => {
                const symbolInput = document.getElementById('new-stock-symbol');
                const nameInput = document.getElementById('new-stock-name');
                const priceInput = document.getElementById('new-stock-price');
                const msg = document.getElementById('stock-admin-msg');

                const symbol = symbolInput.value.toUpperCase().trim();
                const name = nameInput.value.trim();
                const price = parseInt(priceInput.value);

                if (symbol.length < 3 || symbol.length > 4 || name === '' || price < 100 || isNaN(price)) {
                    msg.textContent = 'éŒ¯èª¤ï¼šä»£è™Ÿéœ€ 3-4 å­—å…ƒï¼Œåç¨±ä¸å¯ç‚ºç©ºï¼Œåˆå§‹åƒ¹éœ€ > 100ã€‚';
                    return;
                }
                if (currentStocks.some(s => s.symbol === symbol)) {
                    msg.textContent = `éŒ¯èª¤ï¼šè‚¡ç¥¨ä»£è™Ÿ ${symbol} å·²å­˜åœ¨ã€‚`;
                    return;
                }

                // FIX: æ–°å¢è‚¡ç¥¨æ™‚ç¢ºä¿ volatility æœ‰å€¼
                currentStocks.push({ 
                    name: name, 
                    symbol: symbol, 
                    price: price, 
                    sellPrice: Math.floor(price * 0.8), 
                    volatility: DEFAULT_VOLATILITY // é è¨­ 50
                });

                symbolInput.value = '';
                nameInput.value = '';
                priceInput.value = '400';
                msg.textContent = `å·²æ–°å¢ ${symbol}ï¼Œè«‹é»æ“Šã€Œå„²å­˜è¨­å®šã€ä»¥ç”Ÿæ•ˆã€‚`;
                renderStockList(); 
            };
            
            document.getElementById('restart-game-btn').onclick = () => {
                showModal(
                    'âš ï¸ ç¢ºèªé‡æ–°å•Ÿå‹•éŠæˆ²',
                    '<p class="text-red-600 font-bold">æ‚¨ç¢ºå®šè¦é‡è¨­æ‰€æœ‰ç©å®¶çš„é€²åº¦å’Œè³‡ç”¢å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼</p><p class="mt-2 text-sm">éŠæˆ²å°‡å›åˆ°åˆå§‹ç‹€æ…‹ã€‚</p>',
                    restartGame, 
                    null,
                    'ç¢ºèªé‡å•ŸéŠæˆ²'
                );
                // ç¢ºä¿é‡å•Ÿå½ˆçª—å¯ä»¥å–æ¶ˆ
                document.getElementById('modal-cancel-btn').classList.remove('hidden'); 
            };
            
            document.getElementById('modal-cancel-btn').classList.remove('hidden');
        }
        
        // ** NEW FIX: æš´éœ²çµ¦å…¨å±€ä½œç”¨åŸŸ **
        window.showPlayerAdminModal = showPlayerAdminModal;
        // ** END NEW FIX **

        /**
         * è™•ç†ç©å®¶åŠ å…¥è«‹æ±‚çš„æ‰¹å‡†æˆ–æ‹’çµ•ã€‚
         * åªæœ‰ P0 æ§åˆ¶è€…å¯ä»¥èª¿ç”¨ã€‚
         */
        async function handleJoinRequest(requestingUserId, action) {
            if (!gameState) return;

            const gameMaster = gameState.players[0];
            const isGameMasterDevice = gameMaster && gameMaster.currentUserId === userId;

            if (!isGameMasterDevice) {
                addLog('éŒ¯èª¤ï¼šåªæœ‰éŠæˆ²ç®¡ç†å“¡ (P0 æ§åˆ¶è€…) å¯ä»¥æ‰¹å‡†åŠ å…¥è«‹æ±‚ã€‚', 'error');
                return;
            }

            const playerId = gameState.pendingJoinRequests[requestingUserId];
            const playerIndex = gameState.players.findIndex(p => p.id === playerId);
            const playerName = gameState.players[playerIndex]?.name || `è§’è‰² ID: ${playerId}`;
            let logMsg = '';

            if (action === 'approve' && playerIndex !== -1) {
                // 1. ç¶å®šç©å®¶è§’è‰²
                gameState.players[playerIndex].currentUserId = requestingUserId;
                
                // 2. æ¸…é™¤å…¶ä»–å¯èƒ½éŒ¯èª¤æ®˜ç•™çš„ ID 
                gameState.players.forEach((p, index) => {
                     if (index !== playerIndex && p.currentUserId === requestingUserId) {
                         // å°‡è©²ç”¨æˆ¶å¾å…¶ä»–è§’è‰²è§£é™¤ç¶å®š (å¦‚æœä»–ä¸å°å¿ƒèªé ˜äº†å¤šå€‹)
                         p.currentUserId = null;
                     }
                });
                // ç¢ºä¿åªç¶å®šçµ¦è¢«æ‰¹å‡†çš„è§’è‰²
                gameState.players[playerIndex].currentUserId = requestingUserId; 

                logMsg = `ç®¡ç†å“¡æ‰¹å‡†äº†ç”¨æˆ¶ ${requestingUserId.substring(0, 8)}... åŠ å…¥ï¼Œæ§åˆ¶ ${playerName}ã€‚`;
            } else if (action === 'reject') {
                // ä¸åšä»»ä½•ç¶å®šï¼Œåªè¨˜éŒ„æ—¥èªŒ
                logMsg = `ç®¡ç†å“¡æ‹’çµ•äº†ç”¨æˆ¶ ${requestingUserId.substring(0, 8)}... åŠ å…¥è«‹æ±‚ (è§’è‰²: ${playerName})ã€‚`;
            } else {
                addLog('éŒ¯èª¤ï¼šç„¡æ•ˆçš„æ“ä½œæˆ–ç©å®¶è§’è‰²ä¸å­˜åœ¨ã€‚', 'error');
                return;
            }

            // ç§»é™¤è«‹æ±‚
            delete gameState.pendingJoinRequests[requestingUserId];
            
            // å„²å­˜ç‹€æ…‹
            await updateGameState(gameState, logMsg);
            
            // ç”±æ–¼ onSnapshot æœƒè§¸ç™¼ showPlayerAdminModal é‡æ–°æ¸²æŸ“ï¼Œé€™è£¡ä¸éœ€è¦æ‰‹å‹•å‘¼å«
            // showPlayerAdminModal(); 
        }

        /**
         * è¸¢å‡ºç©å®¶ï¼Œè§£é™¤ç¶å®š (åŠŸèƒ½ 4)
         */
        async function kickPlayer(playerIdToKick) {
             if (!gameState) return;

             const gameMaster = gameState.players[0];
             if (gameMaster.currentUserId !== userId) {
                 addLog('éŒ¯èª¤ï¼šåªæœ‰éŠæˆ²ç®¡ç†å“¡ (P0 æ§åˆ¶è€…) å¯ä»¥è¸¢äººã€‚', 'error');
                 return;
             }
             
             // P0 ä¸èƒ½è¸¢è‡ªå·±
             if (playerIdToKick === 'p0') {
                 addLog('éŒ¯èª¤ï¼šç®¡ç†å“¡ç„¡æ³•å°‡è‡ªå·±å¾æ§åˆ¶æ¬Šä¸­ç§»é™¤ã€‚', 'error');
                 return;
             }

             const playerIndex = gameState.players.findIndex(p => p.id === playerIdToKick);
             if (playerIndex === -1) return;

             const playerToKick = gameState.players[playerIndex];
             const kickedUserId = playerToKick.currentUserId;
             const playerName = playerToKick.name;

             playerToKick.currentUserId = null; // è§£é™¤ç¶å®š

             saveCurrentPlayerState(playerToKick);

             // æ¸…é™¤å¾…è™•ç†è«‹æ±‚ (å¦‚æœè©²ç”¨æˆ¶ä¹‹å‰æœ‰è«‹æ±‚ï¼Œè¸¢äººå¾Œä¹Ÿæ‡‰æ¸…é™¤)
             for (const reqId in gameState.pendingJoinRequests) {
                 if (gameState.pendingJoinRequests[reqId] === playerIdToKick) {
                      delete gameState.pendingJoinRequests[reqId];
                 }
             }

             const logMsg = `ç®¡ç†å“¡å°‡ ${playerName} (ç”¨æˆ¶ ID: ${kickedUserId ? kickedUserId.substring(0, 8) + '...' : 'N/A'}) ç§»é™¤äº†æ§åˆ¶æ¬Šã€‚`;
             await updateGameState(gameState, logMsg);
             
             // ç”±æ–¼ onSnapshot æœƒè§¸ç™¼ showPlayerAdminModal é‡æ–°æ¸²æŸ“ï¼Œé€™è£¡ä¸éœ€è¦æ‰‹å‹•å‘¼å«
        }

        window.handleJoinRequestWrapper = handleJoinRequest;
        window.kickPlayer = kickPlayer;


        function showPlayerAdminModal() {
            // NEW: åªæœ‰ P0 ç®¡ç†å“¡å¯ä»¥é€²å…¥è¨­å®š
            if (gameState.players[0].currentUserId !== userId) {
                addLog('éŒ¯èª¤ï¼šåªæœ‰ P0 ç©å®¶ï¼ˆç®¡ç†å“¡ï¼‰å¯ä»¥ä¿®æ”¹è¨­å®šã€‚', 'error');
                return;
            }

            const currentPlayers = gameState.players;
            const isGameStarted = gameState.gameStarted;
            
            // åˆ¤æ–·éŠæˆ²ç®¡ç†å“¡
            const gameMaster = currentPlayers[0];
            const isGameMasterDevice = gameMaster && gameMaster.currentUserId === userId;
            const pendingRequests = gameState.pendingJoinRequests;
            const approvalRequired = gameState.settings.joinApprovalRequired; 
            
            // ç©å®¶æ•¸é‡é¸æ“‡
            const playerCountHtml = `
                 <div class="border-b pb-3 mb-4">
                      <label for="player-count-select" class="font-bold text-gray-700 block mb-2">è¨­å®šéŠç©äººæ•¸ (æœ€å°‘ 2 ä½):</label>
                      <select id="player-count-select" 
                              class="w-full p-2 border rounded-lg text-center font-bold text-gray-800 ${isGameStarted ? 'bg-gray-200 cursor-not-allowed' : 'focus:outline-none focus:ring-2 focus:ring-indigo-500'}"
                              ${isGameStarted ? 'disabled' : ''}>
                            ${[1, 2, 3, 4].map(n => 
                                `<option value="${n}" ${currentPlayers.filter(p => p.isPlaying).length === n ? 'selected' : ''}>${n} ä½ç©å®¶</option>`
                               ).join('')}
                      </select>
                      ${isGameStarted 
                              ? '<p class="text-xs text-red-500 mt-1 font-semibold">éŠæˆ²å·²é–‹å§‹ï¼Œç„¡æ³•æ›´æ”¹äººæ•¸ã€‚è«‹é»æ“Šè¨­å®šä¸­çš„ã€Œé‡å•ŸéŠæˆ²ã€ã€‚</p>' 
                              : (currentPlayers.filter(p => p.isPlaying).length < 2 
                                      ? '<p class="text-xs text-red-500 mt-1 font-semibold">éœ€è‡³å°‘ 2 ä½ç©å®¶æ‰èƒ½é–‹å§‹éŠæˆ²ã€‚</p>'
                                      : '<p class="text-xs text-green-500 mt-1 font-semibold">éŠæˆ²äººæ•¸å·²æ»¿è¶³ï¼Œå¯é–‹å§‹æ“²éª°ã€‚</p>')}
                 </div>
             `;

            // å€‹åˆ¥ç©å®¶è¨­å®š
            const playerSettingsHtml = currentPlayers.map((player, index) => {
                const isPlaying = player.isPlaying;
                const isDisabled = !isPlaying;
                const isCurrentUserId = player.currentUserId || '';
                const isMyPlayer = player.currentUserId === userId;
                
                const isP0 = player.id === 'p0';
                
                // æ±ºå®šæ˜¯å¦é¡¯ç¤ºè¸¢äººæŒ‰éˆ• (åŠŸèƒ½ 4)
                const kickButton = isCurrentUserId && (isGameMasterDevice && !isP0) 
                    ? `<button data-player-id="${player.id}" onclick="window.kickPlayer('${player.id}')" 
                                     class="py-1 px-3 bg-red-500 text-white rounded text-xs hover:bg-red-600 transition duration-150 ml-auto">
                                     è¸¢å‡º/è§£ç¶
                                     </button>`
                    : '';


                return `
                     <div class="p-3 mb-3 rounded-lg border ${isPlaying ? 'bg-white border-indigo-200' : 'bg-gray-100 border-gray-300'}" id="player-settings-div-${index}">
                            <div class="flex items-center mb-2">
                                     ${player.avatarUrl
                                         ? `<img src="${player.avatarUrl}" 
                                                  alt="${player.name} Avatar" 
                                                  class="w-8 h-8 rounded-full mr-2 object-cover" 
                                                  style="width: 32px; height: 32px;"
                                                  onerror="this.onerror=null;this.src='https://placehold.co/32x32/${player.color.substring(1)}/ffffff?text=${player.name[0] || '?'}'"/>`
                                         : `<div class="w-8 h-8 rounded-full mr-2" style="background-color: ${player.color};"></div>`
                                          }
                                        <p class="font-bold">ç©å®¶ ${index + 1}: ${player.name} ${isMyPlayer ? '(æ‚¨çš„è§’è‰²)' : ''}</p>
                                        <span class="text-xs text-gray-500 ml-auto">${isPlaying ? '(å•Ÿç”¨ä¸­)' : '(å·²ç¦ç”¨)'}</span>
                                        ${kickButton} 
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">åç¨±:</label>
                                            <input type="text" id="player-name-${index}" value="${player.name}" placeholder="ç©å®¶åç¨±" 
                                                    class="w-full p-2 border rounded-lg text-sm mb-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                                                    ${isDisabled ? 'disabled' : ''}/>
                                            
                                            <label class="block text-xs text-gray-600 mb-1">åˆå§‹é‡‘éŒ¢ (åƒ…é‡å•Ÿç”Ÿæ•ˆ):</label>
                                            <input type="number" id="player-initial-money-${index}" value="${player.money}" min="1000" step="500" placeholder="åˆå§‹é‡‘éŒ¢"
                                                    class="w-full p-2 border rounded-lg text-sm mb-2 focus:outline-none focus:ring-2 focus:ring-green-500" 
                                                    ${isDisabled ? 'disabled' : ''}/>
                                        </div>

                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">é¡è‰²:</label>
                                            <div class="flex space-x-2 mb-2">
                                                ${PLAYER_COLORS.map((color, colorIndex) => `
                                                    <input type="radio" id="player-${index}-color-${colorIndex}" name="player-${index}-color" value="${color}" 
                                                            class="hidden peer" ${player.color === color ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                                                    <label for="player-${index}-color-${colorIndex}" 
                                                            class="w-6 h-6 rounded-full cursor-pointer border-2 border-transparent peer-checked:border-indigo-600 transition duration-150"
                                                            style="background-color: ${color};">
                                                    </label>
                                                `).join('')}
                                            </div>
                                            <label class="block text-xs text-gray-600 mb-1">é ­åƒ URL (32x32):</label>
                                            <input type="url" id="player-avatar-url-${index}" value="${player.avatarUrl || ''}" placeholder="http://example.com/avatar.png" 
                                                    class="w-full p-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500"
                                                    ${isDisabled ? 'disabled' : ''}/>
                                        </div>
                            </div>
                            
                            <div class="mt-4 pt-2 border-t border-gray-200">
                                         <label class="block text-xs text-gray-600 mb-1">ç¶å®šç”¨æˆ¶ ID (ç•¶å‰æ“ä½œè€…):</label>
                                         <p class="text-sm font-mono text-gray-700 break-words bg-yellow-50 p-2 rounded-lg">
                                                 ${isCurrentUserId || '<span class="text-gray-400">ç„¡äººèªé ˜/ç•™ç©º</span>'}
                                         </p>
                                         <p class="text-xs text-gray-500 mt-1">æ­¤æ¬„ä½æ‰‹å‹•ç·¨è¼¯å·²ç¦ç”¨ã€‚è«‹ä½¿ç”¨ã€Œèªé ˜ã€æˆ–ã€Œè¸¢å‡ºã€æŒ‰éˆ•ã€‚</p>
                            </div>
                     </div>
                 `;
            }).join('');
            
            // å¾…è™•ç†è«‹æ±‚ UI
            let joinRequestHtml = '';
            if (approvalRequired && isGameMasterDevice) {
                 const requestKeys = Object.keys(pendingRequests);
                 if (requestKeys.length > 0) {
                      const requestsList = requestKeys.map(reqId => {
                          const playerId = pendingRequests[reqId];
                          const playerName = currentPlayers.find(p => p.id === playerId)?.name || `è§’è‰² ID: ${playerId}`;
                          return `
                                     <div class="flex justify-between items-center p-2 bg-yellow-50 rounded-lg border border-yellow-300 mb-2">
                                         <p class="text-sm font-semibold">ç”¨æˆ¶ ${reqId.substring(0, 8)}... è«‹æ±‚èªé ˜ ${playerName}</p>
                                         <div class="flex space-x-2">
                                             <button onclick="window.handleJoinRequestWrapper('${reqId}', 'approve')" class="py-1 px-3 bg-green-500 text-white rounded text-xs hover:bg-green-600">æ‰¹å‡†</button>
                                             <button onclick="window.handleJoinRequestWrapper('${reqId}', 'reject')" class="py-1 px-3 bg-gray-500 text-white rounded text-xs hover:bg-gray-600">æ‹’çµ•</button>
                                         </div>
                                     </div>
                                     `;
                      }).join('');
                      
                      joinRequestHtml = `
                                     <div class="mt-6 pt-4 border-t border-yellow-500">
                                         <p class="font-bold text-yellow-700 mb-3">å¾…è™•ç†çš„åŠ å…¥è«‹æ±‚ (${requestKeys.length})</p>
                                         ${requestsList}
                                     </div>
                                     `;
                 } else {
                      joinRequestHtml = `
                                     <div class="mt-6 pt-4 border-t border-gray-200">
                                         <p class="font-bold text-green-700 mb-1">å¾…è™•ç†çš„åŠ å…¥è«‹æ±‚ (0)</p>
                                         <p class="text-xs text-gray-500">ç›®å‰æ²’æœ‰æ–°çš„ç”¨æˆ¶è«‹æ±‚åŠ å…¥éŠæˆ²ã€‚</p>
                                     </div>
                                     `;
                 }
            } else if (approvalRequired && !isGameMasterDevice) {
                 joinRequestHtml = `
                                 <div class="mt-6 pt-4 border-t border-gray-200">
                                     <p class="font-bold text-red-700 mb-1">åŠ å…¥å¯©æ ¸å·²å•Ÿç”¨</p>
                                     <p class="text-xs text-gray-500">æ‚¨éœ€è¦ç­‰å¾… P0 ç©å®¶æ‰¹å‡†æ‚¨çš„åŠ å…¥è«‹æ±‚å¾Œæ‰èƒ½èªé ˜è§’è‰²ã€‚</p>
                                 </div>
                               `;
            }

            
            const contentHtml = `
                 <div id="player-admin-content" class="space-y-4">
                      ${playerCountHtml}
                      <div id="individual-player-settings">${playerSettingsHtml}</div>
                      <p id="player-admin-msg" class="text-sm text-green-600 mt-2 font-semibold"></p>
                      ${joinRequestHtml} 
                      </div>
             `;

            const modalWasOpen = !document.getElementById('modal').classList.contains('hidden');

            // å¦‚æœ Modal å·²ç¶“é–‹å•Ÿï¼Œå‰‡åªæ›´æ–°å…§å®¹ï¼Œé¿å…é–ƒçˆ
            if (modalWasOpen && document.getElementById('modal-title').textContent.includes('ç©å®¶ç®¡ç†')) {
                 document.getElementById('modal-content').innerHTML = contentHtml;
                 return;
            }
            
            // æ­£å¸¸é¡¯ç¤ºæµç¨‹
            showModal(
                `ğŸ‘¤ ç©å®¶ç®¡ç†èˆ‡è¨­ç½®`, 
                'åœ¨é€™è£¡èª¿æ•´éŠç©äººæ•¸ã€ç©å®¶åç¨±ã€åˆå§‹é‡‘éŒ¢å’Œä»£è¡¨é¡è‰²/é ­åƒã€‚',
                async () => {
                    const playerCountSelect = document.getElementById('player-count-select');
                    const newPlayerCount = parseInt(playerCountSelect.value);
                    
                    if (!isGameStarted && newPlayerCount < 2) {
                        document.getElementById('player-admin-msg').textContent = 'éŒ¯èª¤ï¼šè‡³å°‘éœ€è¦ 2 ä½ç©å®¶æ‰èƒ½é–‹å§‹éŠæˆ²ã€‚';
                        return;
                    }
                    
                    const playersCopy = gameState.players.map(p => ({...p})); 

                    await savePlayerSettings(playersCopy, newPlayerCount, gameState.turn);
                    document.getElementById('player-admin-msg').textContent = 'è¨­å®šå·²æˆåŠŸå„²å­˜ï¼';
                },
                contentHtml,
                'å„²å­˜ç©å®¶è¨­å®š'
            );

            document.getElementById('modal-cancel-btn').classList.remove('hidden');
            
            document.getElementById('player-count-select').onchange = (e) => {
                if (isGameStarted) return;
                
                const count = parseInt(e.target.value);
                document.getElementById('player-admin-msg').textContent = `æ³¨æ„ï¼šæ›´æ”¹äººæ•¸å¾Œè«‹é»æ“Šã€Œå„²å­˜ç©å®¶è¨­å®šã€ä»¥ç”Ÿæ•ˆã€‚`;
                
                for (let i = 0; i < 4; i++) {
                    const playerDiv = document.getElementById(`player-settings-div-${i}`);
                    // P0 æ°¸é å•Ÿç”¨
                    const enable = i === 0 || i < count; 
                    
                    playerDiv.querySelectorAll('input, select, button').forEach(el => {
                        el.disabled = !enable;
                    });

                    if (enable) {
                         playerDiv.classList.replace('bg-gray-100', 'bg-white');
                         playerDiv.classList.replace('border-gray-300', 'border-indigo-200');
                    } else {
                         playerDiv.classList.replace('bg-white', 'bg-gray-100');
                         playerDiv.classList.replace('border-indigo-200', 'border-gray-300');
                    }
                }
            };
        }
        
        // ** NEW FIX: æš´éœ²çµ¦å…¨å±€ä½œç”¨åŸŸ **
        window.showPlayerAdminModal = showPlayerAdminModal;
        // ** END NEW FIX **

        /**
         * å˜—è©¦èªé ˜ä¸€å€‹å¯ç”¨çš„ç©å®¶è§’è‰² (åŠŸèƒ½ 2: æ‰‹å‹•/è«‹æ±‚)
         * @param {boolean} isManualClaim - æ˜¯å¦ç‚ºä½¿ç”¨è€…é»æ“ŠæŒ‰éˆ•æ‰‹å‹•ç™¼èµ·çš„èªé ˜ (å½±éŸ¿æ˜¯å¦è¨˜éŒ„æ—¥èªŒå’Œè·³è½‰åˆ°è«‹æ±‚æ¨¡å¼)
         */
        async function claimPlayerSlot(isManualClaim = false, playerIdToClaim = null) { 
             if (!gameState || userId === 'loading') return;
             
             // 1. æª¢æŸ¥è‡ªå·±æ˜¯å¦å·²ç¶“èªé ˜äº†è§’è‰²
             const existingPlayer = gameState.players.find(p => p.currentUserId === userId);
             if (existingPlayer) {
                 if (isManualClaim) addLog(`æ‚¨å·²æ˜¯ ${existingPlayer.name}ï¼Œç„¡éœ€é‡è¤‡èªé ˜ã€‚`);
                 setControlState(); 
                 return;
             }
             
             const gameMaster = gameState.players[0];
             const isGameMasterDevice = gameMaster && gameMaster.currentUserId === userId;
             
             // --- A. ç®¡ç†å“¡ P0 è‡ªå‹•èªé ˜ (åƒ…åœ¨å•Ÿå‹•æ™‚åŸ·è¡Œï¼Œä¸” P0 å°šæœªè¢«ç¶å®š) ---
             if (gameMaster && gameMaster.id === 'p0' && gameMaster.currentUserId === null && !isManualClaim) {
                 gameMaster.currentUserId = userId; 
                 gameMaster.isPlaying = true; 
                 gameMaster.lastActiveTimestamp = Date.now(); // è¨­ç½®åˆå§‹æ´»èºæ™‚é–“
                 saveCurrentPlayerState(gameMaster);
                 await updateGameState(gameState, `ç®¡ç†å“¡ P0 (${gameMaster.name}) è‡ªå‹•èªé ˜å®Œæˆã€‚`);
                 return; 
             }
             
             // --- B. å°‹æ‰¾ä¸¦èªé ˜/è«‹æ±‚å…¶ä»–è§’è‰² (P1, P2, P3) ---
             
             let playerToClaim;
             if (playerIdToClaim) {
                 playerToClaim = gameState.players.find(p => p.id === playerIdToClaim);
             } else {
                 // å¦‚æœæ²’æœ‰æŒ‡å®š IDï¼Œå°‹æ‰¾ç¬¬ä¸€å€‹æœªè¢«èªé ˜ä¸”å·²å•Ÿç”¨çš„è§’è‰²ï¼ˆé€™æ˜¯çµ¦æµ®å‹•æŒ‰éˆ•ç”¨çš„é‚è¼¯ï¼‰
                 playerToClaim = gameState.players.find(p => p.id !== 'p0' && p.isPlaying && p.currentUserId === null);
             }

             if (!playerToClaim || !playerToClaim.isPlaying || playerToClaim.currentUserId !== null) {
                 if (isManualClaim) addLog('ç›®å‰æ²’æœ‰å¯èªé ˜çš„ç©å®¶è§’è‰²ã€‚è«‹ç®¡ç†å“¡åœ¨ã€Œç©å®¶ç®¡ç†ã€ä¸­å•Ÿç”¨æ–°çš„è§’è‰²ã€‚', 'error');
                 return;
             }
             
             // å¦‚æœä¸æ˜¯æ‰‹å‹•é»æ“Šï¼Œå‰‡ä¸ç¹¼çºŒåŸ·è¡Œï¼ˆé¿å…ä¸å¿…è¦çš„è«‹æ±‚ï¼‰
             if (!isManualClaim) return;
             
             const approvalRequired = gameState.settings.joinApprovalRequired;
             
             // --- åˆ¤æ–·æ˜¯å¦éœ€è¦å¯©æ ¸ ---
             if (approvalRequired && !isGameMasterDevice) { 
                 // æäº¤è«‹æ±‚
                 if (gameState.pendingJoinRequests[userId] !== playerToClaim.id) {
                      // æª¢æŸ¥æ˜¯å¦æ­£åœ¨è«‹æ±‚å…¶ä»–è§’è‰²ï¼Œå¦‚æœæ˜¯ï¼Œå‰‡æç¤º
                      const isRequestingOtherPlayer = Object.keys(gameState.pendingJoinRequests).some(reqId => 
                                      reqId !== userId && gameState.pendingJoinRequests[reqId] === playerToClaim.id
                      );
                      
                      if (isRequestingOtherPlayer) {
                           addLog(`è§’è‰² ${playerToClaim.name} æ­£åœ¨è¢«å…¶ä»–ç”¨æˆ¶è«‹æ±‚ä¸­ï¼Œè«‹é¸æ“‡å…¶ä»–è§’è‰²ã€‚`, 'error');
                           return;
                      }
                      
                      gameState.pendingJoinRequests = { ...gameState.pendingJoinRequests, [userId]: playerToClaim.id };
                      
                      await updateGameState(gameState, `æ–°ç”¨æˆ¶ (ID: ${userId.substring(0, 8)}...) è«‹æ±‚åŠ å…¥éŠæˆ² (è§’è‰²: ${playerToClaim.name})ã€‚ç­‰å¾… P0 å¯©æ ¸ã€‚`);
                      addLog(`æ‚¨çš„åŠ å…¥è«‹æ±‚ (è§’è‰²: ${playerToClaim.name}) å·²é€å‡ºï¼Œè«‹ç­‰å¾…éŠæˆ²ç®¡ç†å“¡ (P0) æ‰¹å‡†ã€‚`, 'info');
                 } else {
                      addLog(`æ‚¨çš„åŠ å…¥è«‹æ±‚ (è§’è‰²: ${playerToClaim.name}) æ­£åœ¨ç­‰å¾… P0 æ‰¹å‡†ä¸­...`, 'info');
                 }
                 return; 
             }
             
             // --- ç„¡éœ€å¯©æ ¸çš„è‡ªå‹•èªé ˜ï¼ˆæˆ– P0 è¨­å‚™èªé ˜ï¼‰ ---
             if (isManualClaim && isGameMasterDevice) {
                 // å¦‚æœæ˜¯ P0 ç®¡ç†å“¡é»æ“Šï¼Œå‰‡ç›´æ¥èªé ˜ (ç¹éè«‹æ±‚æ©Ÿåˆ¶)
                  playerToClaim.currentUserId = userId; 
                  playerToClaim.lastActiveTimestamp = Date.now();
                 
                  // æ¸…é™¤ç•¶å‰ç”¨æˆ¶å¯èƒ½ç¶å®šçš„å…¶ä»–è§’è‰²
                  gameState.players.forEach(p => {
                      if (p.currentUserId === userId && p.id !== playerToClaim.id) {
                          p.currentUserId = null;
                      }
                  });
                 
                  if (gameState.pendingJoinRequests[userId]) {
                       delete gameState.pendingJoinRequests[userId];
                  }

                  saveCurrentPlayerState(playerToClaim);
                 
                  // ç«‹å³æ›´æ–°æœ¬åœ° UIï¼Œé¿å… Firestore å»¶é²
                  renderPlayerStats();
                  setControlState(); 
                 
                  const logMsg = `ç®¡ç†å“¡æ‰‹å‹•å°‡ ${playerToClaim.name} ç¶å®šçµ¦ç•¶å‰ç”¨æˆ¶ (ID: ${userId.substring(0, 8)}...)ã€‚`;
                  await updateGameState(gameState, logMsg);
                  addLog(`æˆåŠŸèªé ˜ ${playerToClaim.name}ã€‚`);
                  return;
             }
        }
        
        /**
         * è™•ç†ç©å®¶è³‡è¨Šå¡é»æ“Šäº‹ä»¶ (å•é¡Œ 6 ä¿®æ­£)
         */
        window.handlePlayerCardClick = (playerIndex) => { 
             if (!gameState || userId === 'loading') return;
             
             const clickedPlayer = gameState.players[playerIndex];
             const existingPlayer = gameState.players.find(p => p.currentUserId === userId);
             
             // 1. å¦‚æœé»æ“Šçš„æ˜¯è‡ªå·±ï¼Œæˆ–è‡ªå·±å·²èªé ˜è§’è‰²ï¼Œé¡¯ç¤ºè³‡ç”¢
             if (existingPlayer || clickedPlayer.currentUserId === userId) {
                 window.showPlayerAssetsModal(clickedPlayer.id);
                 return;
             }
             
             // 2. å¦‚æœé»æ“Šçš„è§’è‰²æ˜¯å•Ÿç”¨ä¸­ä¸”ç„¡äººèªé ˜ï¼Œå‰‡å½ˆçª—ç¢ºèªèªé ˜/è«‹æ±‚
             if (clickedPlayer.isPlaying && clickedPlayer.currentUserId === null) {
                  const isPending = gameState?.pendingJoinRequests ? Object.keys(gameState.pendingJoinRequests).includes(userId) : false;
                  
                  if (isPending) {
                       // å¦‚æœå·²ç¶“æœ‰è«‹æ±‚ï¼Œæç¤ºæ­£åœ¨ç­‰å¾…
                       const requestedPlayerId = gameState.pendingJoinRequests[userId];
                       const requestedPlayer = gameState.players.find(p => p.id === requestedPlayerId);
                       showModal(
                            'âš ï¸ è«‹æ±‚æ­£åœ¨è™•ç†ä¸­',
                            `<p class="text-lg">æ‚¨å·²ç¶“è«‹æ±‚èªé ˜ **${requestedPlayer.name}** è§’è‰²ã€‚è«‹ç­‰å¾…éŠæˆ²ç®¡ç†å“¡ (P0) æ‰¹å‡†ã€‚</p>`,
                            () => {},
                            null,
                            'ç¢ºèª'
                       );
                       return;
                   }
                  
                  // å½ˆçª—ç¢ºèª
                  showModal(
                               'ğŸ”— èªé ˜è§’è‰²è«‹æ±‚',
                               `<p class="text-lg">æ‚¨ç¢ºå®šè¦è«‹æ±‚èªé ˜ **${clickedPlayer.name}** è§’è‰²å—ï¼Ÿ</p>
                                     <p class="mt-2 text-sm text-red-500">æ­¤æ“ä½œéœ€è¦éŠæˆ²ç®¡ç†å“¡ (P0) æ‰¹å‡†ã€‚</p>`,
                               () => {
                                    // ç¢ºèªå¾ŒåŸ·è¡Œèªé ˜/è«‹æ±‚é‚è¼¯
                                    claimPlayerSlot(true, clickedPlayer.id); 
                               },
                               null,
                               'ç¢ºèªèªé ˜'
                             );
                   document.getElementById('modal-cancel-btn').classList.remove('hidden'); 
                  
             } else if (clickedPlayer.isPlaying && clickedPlayer.currentUserId !== null) {
                  // è§’è‰²å·²è¢«å…¶ä»–äººèªé ˜
                  addLog(`éŒ¯èª¤ï¼š${clickedPlayer.name} è§’è‰²å·²è¢«å…¶ä»–ç”¨æˆ¶èªé ˜ã€‚`, 'error');
             } else {
                  // è§’è‰²å·²ç¦ç”¨
                  addLog(`éŒ¯èª¤ï¼š${clickedPlayer.name} è§’è‰²å·²ç¦ç”¨ã€‚`, 'error');
             }
        };


        /**
         * [é‡æ–°å•Ÿç”¨] ç®¡ç†å“¡å¼·åˆ¶æ¥ç®¡åŠŸèƒ½ (ç”¨æ–¼è§£æ±º P0 é•·æ™‚é–“é›¢ç·šå•é¡Œ)
         */
        async function forceAdminTakeover() {
             if (!gameState || !gameState.players[0]) return;
             
             const gameMaster = gameState.players[0];

             if (gameMaster.currentUserId === userId) {
                  addLog('æ‚¨å·²ç¶“æ˜¯éŠæˆ²ç®¡ç†å“¡ (P0)ï¼ç„¡éœ€å¼·åˆ¶æ¥ç®¡ã€‚', 'info');
                  return;
             }
             
             // æª¢æŸ¥ P0 æ˜¯å¦å·²è¢«ç¶å®š
             if (gameMaster.currentUserId === null) {
                  addLog('P0 è§’è‰²å°šæœªèªé ˜ï¼Œè«‹ä½¿ç”¨ã€Œè«‹æ±‚åŠ å…¥éŠæˆ²ã€æŒ‰éˆ•èªé ˜ä¸€å€‹ç©ºé–’è§’è‰²ã€‚', 'info');
                  return;
             }
             
             // æª¢æŸ¥ P0 æ˜¯å¦è™•æ–¼éæ´»èºç‹€æ…‹ (60 ç§’)
             const timeSinceLastActive = Date.now() - gameMaster.lastActiveTimestamp;
             if (timeSinceLastActive < TAKEOVER_TIMEOUT_MS) {
                  addLog(`ç„¡æ³•æ¥ç®¡ï¼šç®¡ç†å“¡ (${gameMaster.name}) æœ€è¿‘ (${Math.floor(timeSinceLastActive / 1000)} ç§’å‰) ä»è™•æ–¼æ´»èºç‹€æ…‹ã€‚éœ€ç­‰å¾… 60 ç§’éæ´»èºã€‚`, 'error');
                  return;
             }
             
             // å¼·åˆ¶æ¥ç®¡ P0 è§’è‰²
             const playersCopy = gameState.players.map(p => {
                  if (p.id === 'p0') {
                      return { ...p, currentUserId: userId, lastActiveTimestamp: Date.now() };
                  }
                  // æ¸…é™¤ç•¶å‰ç”¨æˆ¶å¯èƒ½ç¶å®šçš„å…¶ä»–è§’è‰²
                  if (p.currentUserId === userId) {
                       return { ...p, currentUserId: null };
                  }
                  return p;
             });
             
             // æ¸…ç©ºå¾…è™•ç†è«‹æ±‚ (é¿å…æ¥ç®¡å¾ŒèˆŠçš„è«‹æ±‚ä»ç„¶æŒ‡å‘ P0)
             const pendingJoinRequests = {};
             
             const nextState = { 
                  ...gameState, 
                  players: playersCopy, 
                  pendingJoinRequests: pendingJoinRequests 
             };
             
             await updateGameState(nextState, `ğŸš¨ ç·Šæ€¥æ¥ç®¡ï¼šç”¨æˆ¶ ${userId.substring(0, 8)}... å¼·åˆ¶æ¥ç®¡äº†ç®¡ç†å“¡ P0 è§’è‰² (åŸç”¨æˆ¶é•·æ™‚é–“ä¸æ´»èº)ã€‚`);
             
             showModal(
                  'ğŸš¨ ç®¡ç†å“¡æ¥ç®¡æˆåŠŸ',
                  `<p class="text-lg text-red-600 font-bold">æ‚¨å·²æˆåŠŸå¼·åˆ¶æ¥ç®¡ç®¡ç†å“¡ (P0) è§’è‰²ï¼</p><p class="mt-2 text-sm">ç¾åœ¨æ‚¨å¯ä»¥æ§åˆ¶è¨­å®šå’Œç©å®¶ç®¡ç†ã€‚</p>`,
                  () => {},
                  null,
                  'ç¢ºèª'
             );
        }


        async function fetchSuburbSummary(suburbName) {
             // !!! éƒ¨ç½²è­¦å‘Š !!!
             // åœ¨ Canvas æ²™ç›’ç’°å¢ƒå¤–ï¼ˆä¾‹å¦‚ Neocitiesï¼‰å‘¼å«æ­¤ APIï¼Œå°‡æœƒå› ç‚ºç¼ºå°‘ä¼ºæœå™¨ç«¯èº«ä»½é©—è­‰
             // è€Œå°è‡´ 403 éŒ¯èª¤ã€‚åœ¨å¤–éƒ¨éƒ¨ç½²æ™‚ï¼Œæ‚¨éœ€è¦å»ºç«‹ä¸€å€‹ä¼ºæœå™¨ç«¯ä»£ç† (Server-Side Proxy)
             // ä¾†å®‰å…¨åœ°å„²å­˜ API Key ä¸¦ä»£ç‚ºå‘¼å«æ­¤æœå‹™ã€‚
             const systemPrompt = "Act as a local historian and real estate expert. Provide a concise, single-paragraph summary of this Melbourne suburb, focusing on its character, significance, and history. The response must be in Traditional Chinese.";
             const userQuery = `Summarize the Melbourne suburb: ${suburbName}`;
             const apiKey = "" 
             // ä¿®æ­£ï¼šç§»é™¤ URL ä¸­çš„ ?key=${apiKey}ï¼Œé¿å…åœ¨é‹è¡Œç’°å¢ƒè‡ªå‹•æ³¨å…¥å¯†é‘°æ™‚ç™¼ç”Ÿè¡çªï¼Œå°è‡´ 403 éŒ¯èª¤ã€‚
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`;
             
             const payload = {
                 contents: [{ parts: [{ text: userQuery }] }],
                 tools: [{ "google_search": {} }],
                 systemInstruction: {
                      parts: [{ text: systemPrompt }]
                 },
             };

             let result;
             for (let attempt = 0; attempt < 5; attempt++) {
                  try {
                       const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                       });
                       
                       if (!response.ok) {
                            const errorBody = await response.json();
                            throw new Error(`API éŒ¯èª¤ (ç‹€æ…‹ç¢¼ ${response.status}): ${errorBody.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                       }
                       
                       result = await response.json();
                       break; 
                      } catch (error) {
                            if (attempt === 4) throw new Error("API call failed after multiple retries: " + error.message);
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                       }
             }

             const candidate = result.candidates?.[0];

             if (candidate && candidate.content?.parts?.[0]?.text) {
                 const text = candidate.content.parts[0].text;

                 let sources = [];
                 const groundingMetadata = candidate.groundingMetadata;
                 if (groundingMetadata && groundingMetadata.groundingAttributions) {
                      sources = groundingMetadata.groundingAttributions
                                      .map(attribution => ({ uri: attribution.web?.uri, title: attribution.web?.title }))
                                      .filter(source => source.uri && source.title);
                 }

                 return { text, sources };

             } else {
                 throw new Error(result.promptFeedback?.blockReason || "æœªç”Ÿæˆæ–‡æœ¬ (å¯èƒ½é•åå®‰å…¨æ”¿ç­–æˆ–å…§å®¹è¢«å±è”½)ã€‚");
             }
        }
        
        /**
         * é¡¯ç¤ºåœ°ç”¢ç°¡ä»‹æ¨¡æ…‹è¦–çª— (å•é¡Œ 3 ä¿®æ­£: ç¢ºä¿å¯é»æ“Š)
         */
        async function showPropertyInfoModal(square, currentPlayer) {
             if (!gameState) return; // ç¢ºä¿æœ‰ç‹€æ…‹
             const squareIndex = gameState.board.findIndex(s => s.name === square.name && s.type === 'PROPERTY');
             const currentSquare = gameState.board[squareIndex];
             const propertyName = currentSquare.name;

             const currentImageUrl = currentSquare.imageUrl || '';
             const defaultPlaceholderUrl = `https://placehold.co/300x200/4f46e5/ffffff?text=${encodeURIComponent(currentSquare.name + ' (Placeholder)')}`;
             const displayUrl = currentImageUrl || defaultPlaceholderUrl;

             const modalTitle = `[${currentPlayer.name}] åœ°ç”¢ç°¡ä»‹: ${currentSquare.name}`; 
             
             // --- Helper to render summary in modal ---
             function renderSummary(summaryData, isError = false) {
                  const container = document.getElementById('summary-and-source-area');
                  if (!container) return;
                  
                  if (isError) {
                       container.innerHTML = `<p class="text-red-500 font-bold">è¼‰å…¥ç°¡ä»‹å¤±æ•—</p><p class="text-sm mt-2">${summaryData}</p>`;
                       return;
                  }
                  
                  const summaryHtml = `<p class="text-base text-gray-600">${summaryData.text}</p>`;
                  
                  const sourcesHtml = summaryData.sources?.length > 0 ? 
                                     `<div class="mt-4 pt-2 border-t border-gray-200 text-xs text-gray-500">
                                          <p class="font-semibold mb-1">ä¾†æºåƒè€ƒ:</p>
                                          <ul class="list-disc list-inside space-y-1">${summaryData.sources.map(s => `<li><a href="${s.uri}" target="_blank" class="text-blue-500 hover:underline">${s.title}</a></li>`).join('')}</ul>
                                      </div>` : '';
                  
                  container.innerHTML = summaryHtml + sourcesHtml;
             }
             // --- End Helper ---

             // Check cache first
             const cachedSummary = gameState.settings?.suburbSummaries?.[propertyName];
             
             let initialSummaryHtml;
             if (cachedSummary) {
                  initialSummaryHtml = ''; // Will be rendered immediately by renderSummary after modal opens
             } else {
                  // Use loading state if not cached
                  initialSummaryHtml = `<div id="suburb-summary-container">
                                              <div class="text-center py-4 text-indigo-600 font-semibold">
                                                  <span class="animate-spin inline-block w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full mr-2"></span>
                                                   è¼‰å…¥ ${currentSquare.name} çš„ç°¡ä»‹...
                                               </div>
                                             </div>`;
             }

             // *** NEW: æˆ¿å±‹å’Œç§Ÿé‡‘è©³æƒ…é¡¯ç¤º ***
             const isOwned = currentSquare.owner !== null;
             const ownerName = isOwned ? (gameState.players.find(p => p.id === currentSquare.owner)?.name || 'æœªçŸ¥') : 'ç„¡ä¸»';
             const currentHouses = currentSquare.houses;
             const rentDetails = currentSquare.rentMultipliers.map((multiplier, index) => {
                 const levelName = index === 0 ? 'ç„¡æˆ¿å±‹ (åŸºç¤)' : (index === HOUSE_CONFIG.MAX_HOUSES ? 'å¤§æ¨“ ğŸ¢' : `æˆ¿å±‹ ${index} ğŸ¡`);
                 const rent = currentSquare.rent * multiplier;
                 return `<span class="text-xs ${index === currentHouses ? 'font-bold text-red-600' : 'text-gray-600'}">${levelName}: $${rent.toLocaleString()}</span>`;
             }).join(' | ');


             const contentTemplate = `
                  <div class="space-y-4">
                          <div class="bg-gray-100 p-4 rounded-lg">
                               <p class="font-bold text-gray-800 mb-2">åœ°ç”¢ç‹€æ…‹</p>
                               <p class="text-sm text-gray-700">åœ°ç”¢æ‰€æœ‰è€…: <span class="font-bold">${ownerName}</span></p>
                               <p class="text-sm text-gray-700">åœ°ç”¢åƒ¹æ ¼: <span class="font-bold">$${currentSquare.price.toLocaleString()}</span></p>
                               <p class="text-sm text-gray-700">æˆ¿å±‹æ•¸: <span class="font-bold">${currentHouses} / ${HOUSE_CONFIG.MAX_HOUSES}</span> (${currentSquare.mortgage ? 'å·²æŠµæŠ¼ ğŸ”’' : 'æœªæŠµæŠ¼'})</p>
                               <p class="text-sm text-gray-700 mt-2">å‡ç´šè²»ç”¨ (æ¯ç´š): <span class="font-bold">$${currentSquare.housePrice.toLocaleString()}</span></p>
                          </div>
                          
                          <div class="p-4 bg-yellow-50 rounded-lg overflow-x-auto">
                               <p class="font-bold text-gray-700 mb-2 whitespace-nowrap">ç§Ÿé‡‘è©³æƒ… (${currentSquare.rent.toLocaleString()} x å€ç‡)</p>
                               <div class="flex space-x-3 whitespace-nowrap">
                                   ${rentDetails}
                               </div>
                          </div>


                          <div class="bg-gray-100 p-4 rounded-lg text-center border-2 border-dashed border-gray-300">
                               <p class="text-sm text-gray-500 mb-2">åœ°ç”¢åœ–ç‰‡</p>
                               <img id="property-modal-image" src="${displayUrl}" 
                                      onerror="this.onerror=null;this.src='${defaultPlaceholderUrl}'"
                                      alt="Image for ${currentSquare.name}" class="mt-2 mx-auto rounded w-full h-auto max-h-48 object-cover"/>
                          </div>
                          
                          <div id="summary-and-source-area">
                                  ${initialSummaryHtml}
                          </div>
                          
                          <div class="mt-4 pt-4 border-t border-gray-200">
                               <p class="font-bold text-gray-700 mb-2">åœ–ç‰‡è¨­å®š (å¯è¨­å®šæŒä¹…åŒ– URL)</p>
                               <input type="url" id="image-url-input" value="${currentImageUrl}" placeholder="è¼¸å…¥åœ–ç‰‡ URL (ä¾‹å¦‚: https://...)" class="w-full p-2 border rounded-lg text-sm mb-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
                               <button id="save-image-url-btn" class="w-full py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-150 disabled:opacity-50">å„²å­˜åœ–ç‰‡ URL</button>
                               <p id="image-url-msg" class="text-xs text-red-500 mt-1"></p>
                          </div>
                  </div>
             `;
             // *** END NEW ***
             
             showModal(modalTitle, 'åœ°ç”¢ç°¡ä»‹èˆ‡åœ–ç‰‡è¨­å®š:', () => {}, contentTemplate, 'é—œé–‰');
             
             // ä¿®æ­£ 1: é ‚éƒ¨é—œé–‰æŒ‰éˆ•äº‹ä»¶
             document.getElementById('modal-top-close-btn').onclick = () => {
                  document.getElementById('modal').classList.add('hidden');
                  document.getElementById('modal').classList.remove('flex');
             };

             const confirmBtn = document.getElementById('modal-confirm-btn');
             confirmBtn.textContent = 'é—œé–‰';
             confirmBtn.onclick = () => {
                  document.getElementById('modal').classList.add('hidden');
                  document.getElementById('modal').classList.remove('flex');
             };
             
             // ç¶å®šå„²å­˜åœ–ç‰‡æŒ‰éˆ•
             document.getElementById('save-image-url-btn').onclick = async () => {
                  const urlInput = document.getElementById('image-url-input');
                  const newUrl = urlInput.value.trim();
                  const msg = document.getElementById('image-url-msg');

                  if (squareIndex === -1) { msg.textContent = 'éŒ¯èª¤: ç„¡æ³•æ‰¾åˆ°åœ°ç”¢ç´¢å¼•ã€‚'; return; }
                  
                  const newBoard = gameState.board.map((s, index) => {
                       if (index === squareIndex) { return { ...s, imageUrl: newUrl || null }; }
                       return s;
                  });
                  
                  const propertyName = currentSquare.name;
                  gameState.settings.propertyImageUrls = {
                       ...gameState.settings.propertyImageUrls,
                       [propertyName]: newUrl || null 
                  };

                  const nextState = { ...gameState, board: newBoard };
                  await updateGameState(nextState, `${currentPlayer.name} æ›´æ–°äº†åœ°ç”¢ ${currentSquare.name} çš„åœ–ç‰‡ URLã€‚`);
                  
                  msg.textContent = 'åœ–ç‰‡ URL å·²å„²å­˜ä¸¦åŒæ­¥ï¼';
                  const imageElement = document.getElementById('property-modal-image');
                  if (imageElement) { imageElement.src = newUrl || defaultPlaceholderUrl; }
             };

             // --- Async load/cache logic ---
             if (cachedSummary) {
                  renderSummary(cachedSummary);
             } else {
                  // åŸ·è¡Œ Gemini API å‘¼å«
                  try {
                       const summary = await fetchSuburbSummary(propertyName);
                       
                       // æˆåŠŸï¼šæ›´æ–° UI
                       renderSummary(summary);
                       
                       // æˆåŠŸï¼šæ›´æ–°ç·©å­˜ä¸¦å„²å­˜åˆ° Firestore
                       gameState.settings.suburbSummaries = {
                               ...gameState.settings.suburbSummaries,
                               [propertyName]: {
                                    text: summary.text,
                                    sources: summary.sources,
                               }
                       };
                       // åªæ›´æ–°ç‹€æ…‹ï¼Œä¸éœ€è¦é¡å¤–æ—¥èªŒ
                       await updateGameState(gameState); 
                       
                      } catch (error) {
                             const errorMessage = error.message.includes("API call failed") ? 
                                  `é€£ç·šæˆ– API å‘¼å«å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡è©¦ã€‚` : 
                                  `å…§å®¹ç”Ÿæˆå¤±æ•— (å¯èƒ½å…§å®¹è¢«å±è”½): ${error.message}`;
                              
                             renderSummary(errorMessage, true);
                             console.error("Gemini API Call Failed:", error);
                      }
             }
             // --- End Async load/cache logic ---
        }
        
        /**
         * è™•ç†æ£‹ç›¤æ–¹æ ¼é»æ“Šäº‹ä»¶
         */
        function handleSquareClick(squareIndex) { // FIX: Changed from arrow function assignment
             if (!gameState) {
                 addLog('éŠæˆ²ç‹€æ…‹å°šæœªè¼‰å…¥ï¼Œç„¡æ³•æŸ¥çœ‹åœ°ç”¢è³‡è¨Šã€‚', 'info');
                 return;
             }
             const square = gameState.board[squareIndex];
             // ç²å–ç•¶å‰ç”¨æˆ¶æ§åˆ¶çš„ç©å®¶ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨å›åˆç©å®¶ä½œç‚ºé è¨­
             const currentPlayer = gameState.players.find(p => p.currentUserId === userId) || gameState.players[gameState.turn];
             
             if (square.type === 'PROPERTY') {
                 showPropertyInfoModal(square, currentPlayer);
             }
        }
        window.handleSquareClick = handleSquareClick; // FIX: Explicitly expose

        /**
         * é¡¯ç¤ºè³‡ç”¢æ¨¡æ…‹è¦–çª— (å•é¡Œ 6 ä¿®æ­£: é¡¯ç¤ºç©å®¶ç¸½è³‡ç”¢)
         */
        function showPlayerAssetsModal(playerId) { // FIX: Changed from arrow function assignment
             if (!gameState) return;
             const player = gameState.players.find(p => p.id === playerId);
             // [ä¿®æ­£ 5] ä¸é¡¯ç¤ºæœªå•Ÿç”¨ç©å®¶çš„è³‡ç”¢è©³æƒ…
             if (!player || !player.isPlaying) { 
                 addLog(`${player.name} å·²ç ´ç”¢æˆ–æœªå•Ÿç”¨ï¼Œç„¡æ³•æŸ¥çœ‹è³‡ç”¢è©³æƒ…ã€‚`, 'info');
                 return;
             }

             let totalStockValue = 0;
             const stockDetails = gameState.currentStocks.map(stock => {
                 const count = player.stocks[stock.symbol] || 0; // FIX: Use stock.symbol instead of s.symbol 
                 if (count > 0) {
                     const value = count * stock.price;
                     totalStockValue += value;
                     return `
                              <div class="flex justify-between text-sm py-1 border-b border-gray-100">
                                  <span class="font-semibold">${stock.name} (${stock.symbol})</span>
                                  <span class="text-gray-600">æŒè‚¡: ${count} è‚¡</span>
                                  <span class="text-emerald-600">å¸‚åƒ¹: $${stock.price.toLocaleString()}</span>
                                  <span class="font-bold">ç¸½å€¼: $${value.toLocaleString()}</span>
                              </div>
                             `;
                 }
                 return '';
             }).filter(d => d !== '').join('');

             let totalPropertyValue = 0;

             const propertyDetailsHtml = player.properties.length > 0
                 ? player.properties.map(propName => {
                      const square = gameState.board.find(s => s.name === propName); // ** ä¿®æ­£ï¼šä½¿ç”¨ gameState.board **
                      if (!square) return ''; 
                      
                      const rent = calculateRent(square); // è¨ˆç®—ç•¶å‰ç§Ÿé‡‘
                      const rentDisplay = square.mortgage ? 'æŠµæŠ¼ä¸­ ğŸ”’' : `$${rent.toLocaleString()}`;
                      const houseCount = square.houses;
                      
                      // è¨ˆç®—åœ°ç”¢ç¸½åƒ¹å€¼ (åœ°ç”¢åƒ¹æ ¼ + æˆ¿å±‹æˆæœ¬)
                      const houseCost = square.housePrice * houseCount;
                      const propertyValue = square.price + houseCost;
                      totalPropertyValue += propertyValue;

                      const color = square.color;
                      const hexColor = COLOR_MAP[color] || '#9ca3af'; 
                      
                      let houseIcon = '';
                      if (houseCount > 0) {
                           houseIcon = Array(houseCount).fill(0).map((_, i) => {
                                let iconClass, iconText;
                                if (i === HOUSE_CONFIG.MAX_HOUSES - 1) { 
                                    iconClass = 'skyscraper'; iconText = 'å¤§'; // å¤§æ¨“
                                } else if (i >= 2) { 
                                    iconClass = 'apartment'; iconText = 'å…¬'; // å…¬å¯“
                                } else {
                                    iconClass = 'house'; iconText = 'æˆ¿'; // æˆ¿å±‹
                                }
                                return `<span class="house-icon ${iconClass}">${iconText}</span>`;
                           }).join('');
                      }
                      
                      // **å•é¡Œ 6 ä¿®æ­£ï¼šé»æ“Šåœ°ç”¢å¡ç‰‡æŸ¥çœ‹è©³ç´°è³‡è¨Š**
                      return `
                                 <div class="inline-flex items-center px-3 py-1 rounded-full shadow-sm text-xs font-semibold 
                                      bg-white border-2 border-gray-300 transition duration-150 hover:shadow-md cursor-pointer"
                                      onclick="window.handleSquareClick(${square.index})" 
                                      title="é»æ“ŠæŸ¥çœ‹ ${propName} ç°¡ä»‹"
                                      style="border-color: ${hexColor};">
                                      
                                     <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${hexColor};"></span>
                                     
                                     <span class="text-gray-800 mr-2 whitespace-nowrap">${propName}</span>
                                     
                                     ${houseIcon}
                                     
                                     <span class="text-gray-500 whitespace-nowrap ml-2">(${rentDisplay})</span>
                                 </div>
                                 `;
                   }).join('')
                   : '<p class="text-sm text-gray-500">ç„¡å·²è³¼åœ°ç”¢ã€‚</p>';

             // NEW: ç¸½è³‡ç”¢è¨ˆç®—åŒ…å«æˆ¿å±‹åƒ¹å€¼
             const totalAssets = player.money + player.bank + totalStockValue + totalPropertyValue;


             const contentHtml = `
                  <div class="space-y-4">
                          <div class="p-3 bg-indigo-50 rounded-lg shadow-inner">
                               <p class="text-2xl font-extrabold text-indigo-700">ç¸½è³‡ç”¢: $${totalAssets.toLocaleString()}</p>
                          </div>

                          <div class="border-b pb-2">
                               <p class="font-bold text-gray-700">ç¾é‡‘èˆ‡å®šå­˜</p>
                               <p class="text-sm">ç¾é‡‘: <span class="font-semibold">$${player.money.toLocaleString()}</span></p>
                               <p class="text-sm">å®šå­˜: <span class="font-semibold">$${player.bank.toLocaleString()}</span> (åˆ©ç‡: ${(gameState.settings.interestRate * 100).toFixed(2)}%)</p>
                          </div>

                          <div>
                               <p class="font-bold text-gray-700 mb-2">è‚¡ç¥¨æŠ•è³‡çµ„åˆ (ç¸½åƒ¹å€¼ $${totalStockValue.toLocaleString()})</p>
                               <div class="max-h-40 overflow-y-auto space-y-1 p-2 bg-white border rounded">
                                       ${stockDetails || '<p class="text-sm text-gray-500">ç„¡æŒè‚¡ã€‚</p>'}
                               </div>
                          </div>

                          <div>
                               <p class="font-bold text-gray-700 mb-2">å·²è³¼åœ°ç”¢ (${player.properties.length} å¡Š, ç¸½åƒ¹å€¼ $${totalPropertyValue.toLocaleString()})</p>
                               <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto p-2 bg-white border rounded">
                                       ${propertyDetailsHtml}
                               </div>
                          </div>
                  </div>
             `;

             showModal(
                 `[${player.name}] ç©å®¶è³‡ç”¢å ±å‘Š`,
                 'ä»¥ä¸‹æ˜¯æ‚¨ç›®å‰çš„è²¡å‹™å’Œåœ°ç”¢ç‹€æ³ï¼š',
                 () => {}, 
                 contentHtml,
                 'é—œé–‰'
             );
        }
        window.showPlayerAssetsModal = showPlayerAssetsModal; // FIX: Explicitly expose
        
        /**
         * æ¸²æŸ“é ‚éƒ¨è­¦å ±å€ (æ–°å¢åŠŸèƒ½)
         */
        function renderHeaderAlerts() {
            const alertArea = document.getElementById('admin-alert-area');
            alertArea.innerHTML = ''; // æ¸…é™¤èˆŠè­¦å ±

            if (!gameState || userId === 'loading') return;

            const gameMaster = gameState.players[0];
            const isGameMasterDevice = gameMaster && gameMaster.currentUserId === userId;
            const pendingRequests = gameState.pendingJoinRequests;
            const requestKeys = Object.keys(pendingRequests);
            const pendingCount = requestKeys.length;
            
            // **[NEW] æ›´æ–°å›åˆæ•¸é¡¯ç¤º**
            document.getElementById('turn-display').textContent = gameState.round;

            if (isGameMasterDevice && pendingCount > 0) {
                // æ‰¾å‡ºç¬¬ä¸€å€‹è«‹æ±‚çš„ç”¨æˆ¶ ID å’Œè§’è‰² ID
                const requestingUserId = requestKeys[0]; // First user in queue
                const requestedPlayerId = pendingRequests[requestKeys[0]];
                const requestedPlayer = gameState.players.find(p => p.id === requestedPlayerId);
                const playerName = requestedPlayer ? requestedPlayer.name : 'æœªçŸ¥è§’è‰²';
                
                // é¡¯ç¤ºçš„ç”¨æˆ¶ ID ç¸®çŸ­
                const displayUserId = requestingUserId.substring(0, 8) + '...';
                
                const message = `
                      <div class="p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-lg shadow-md flex justify-between items-center flex-wrap gap-2">
                          <span class="font-bold">âš ï¸ å¾…è™•ç†çš„åŠ å…¥è«‹æ±‚ (${pendingCount})</span>
                          <span class="text-sm text-gray-700 truncate max-w-[40%]">
                              ç”¨æˆ¶ ${displayUserId} è«‹æ±‚èªé ˜ ${playerName}ã€‚
                          </span>
                          <div class="flex space-x-2 flex-shrink-0">
                               <button onclick="window.handleJoinRequestWrapper('${requestingUserId}', 'approve')" 
                                       class="py-1 px-3 bg-green-500 text-white text-xs font-bold rounded hover:bg-green-600 transition">
                                       âœ… æ‰¹å‡†
                               </button>
                               <button onclick="window.handleJoinRequestWrapper('${requestingUserId}', 'reject')" 
                                       class="py-1 px-3 bg-gray-500 text-white text-xs font-bold rounded hover:bg-gray-600 transition">
                                       âŒ æ‹’çµ•
                               </button>
                               ${pendingCount > 1 ? `
                                       <button onclick="window.showPlayerAdminModal()" 
                                               class="py-1 px-3 bg-yellow-500 text-white text-xs font-bold rounded hover:bg-yellow-600 transition">
                                               +${pendingCount - 1}
                                       </button>
                               ` : ''}
                          </div>
                      </div>
                    `;
                alertArea.innerHTML = message;
            }
        }


        function renderPlayerStats() {
            const statsDiv = document.getElementById('player-stats');
            
            // [ä¿®æ­£ 5] åªæ¸²æŸ“ isPlaying=true çš„ç©å®¶
            statsDiv.innerHTML = gameState.players
                .filter(p => p.isPlaying)
                .map((player, index) => {
                // å¿…é ˆä½¿ç”¨ findIndex ä¾†åŒ¹é…åœ¨å®Œæ•´é™£åˆ—ä¸­çš„ç´¢å¼•
                const playerGlobalIndex = gameState.players.findIndex(p => p.id === player.id);
                const isCurrent = gameState.turn === playerGlobalIndex;
                const isClaimed = player.currentUserId !== null;
                const isMyPlayer = player.currentUserId === userId;
                
                const stockSummary = gameState.currentStocks.map(s => {
                    const count = player.stocks[s.symbol] || 0; 
                    return count > 0 ? `${s.symbol}: ${count}` : null;
                }).filter(Boolean).join(' | ');
                
                // ä¿®æ­£ 2: é»æ“Šèªé ˜é‚è¼¯èª¿æ•´
                let cardClass = '';
                let buttonAction = `window.handlePlayerCardClick(${playerGlobalIndex})`;
                let cardTitle = '';
                
                if (isMyPlayer) {
                    cardClass = 'shadow-2xl border-indigo-700 ring-2 ring-indigo-500 cursor-pointer hover:bg-indigo-100';
                    cardTitle = `é»æ“ŠæŸ¥çœ‹æ‚¨çš„è³‡ç”¢`;
                } else if (player.isPlaying && !isClaimed) {
                    // å¯è¢«èªé ˜çš„å¡ç‰‡
                    cardClass = 'shadow-lg border-green-500 ring-2 ring-green-300 cursor-pointer hover:bg-green-50';
                    cardTitle = `é»æ“Šè«‹æ±‚èªé ˜ ${player.name}`;
                } else if (isClaimed) {
                    cardClass = 'shadow-lg border-gray-300 cursor-default';
                    cardTitle = `å·²è¢« ${player.currentUserId.substring(0, 8)}... èªé ˜`;
                } else {
                    cardClass = 'opacity-30 border-gray-300 cursor-default';
                    cardTitle = 'è§’è‰²å·²ç¦ç”¨æˆ–ç ´ç”¢';
                }
                
                const isUserUnbound = !gameState.players.some(p => p.currentUserId === userId);
                const isClaimable = player.isPlaying && !isClaimed;

                const buttonDisabledClass = isMyPlayer || (isClaimable && isUserUnbound) ? 'hover:scale-105 cursor-pointer' : 'cursor-default';
                
                // ã€ä¿®æ­£ 3ã€‘æ–°å¢ç¶ è‰²æ‰“å‹¾ç¬¦è™Ÿ (âœ…)
                const controlInfo = player.currentUserId 
                     ? (player.currentUserId === userId ? 'æ‚¨ (æ§åˆ¶ä¸­) âœ…' : `ID: ${player.currentUserId.substring(0, 8)}...`)
                     : 'ç„¡ä¸» (å¯èªé ˜)'; 

                // ã€ä¿®æ­£ 3.1ã€‘æ”¾å¤§ç©å®¶å¡ç‰‡ä¸Šçš„é ­åƒåˆ° w-12 h-12 (48px)
                const avatarContent = `<button 
                                             class="player-avatar-large rounded-full mr-2 object-cover overflow-hidden transition duration-150 shadow-md flex-shrink-0 ${buttonDisabledClass}" 
                                             onclick="${buttonAction}" 
                                             title="${cardTitle}">
                                             ${player.avatarUrl
                                                 ? `<img src="${player.avatarUrl}" 
                                                          alt="${player.name} Avatar" 
                                                          class="w-full h-full object-cover" 
                                                          onerror="this.onerror=null;this.src='https://placehold.co/48x48/${player.color.substring(1)}/ffffff?text=${player.name[0] || '?'}'"/>`
                                                 : `<div class="w-full h-full flex justify-center items-center text-lg font-bold text-white" 
                                                          style="background-color: ${player.color};">${player.name[0] || '?'}</div>`
                                                         }
                                             </button>`;

                return `
                     <div class="p-4 rounded-xl border-2 ${isCurrent ? 'border-4 border-yellow-500 bg-yellow-50' : cardClass} transition duration-200"
                              onclick="${buttonAction}" title="${cardTitle}">
                              <div class="flex items-center justify-between mb-2">
                                     <div class="flex items-center">
                                         ${avatarContent}
                                         
                                         <h4 class="font-bold text-lg text-gray-800">
                                             ${player.name}
                                         </h4>
                                     </div>
                                     <span class="text-xs text-gray-500">${controlInfo}</span>
                              </div>
                              <p class="text-xl font-extrabold text-gray-900">$${player.money.toLocaleString()}</p>
                              <p class="text-sm text-gray-500">å®šå­˜: <span class="font-bold text-gray-800">$${player.bank.toLocaleString()}</span></p> 
                              <p class="text-xs text-gray-400 truncate mt-1" title="${stockSummary || 'ç„¡æŒè‚¡'}">æŒè‚¡: ${stockSummary || 'ç„¡'}</p> 
                              <p class="text-xs text-gray-500 truncate mt-1" title="${player.properties.join(', ')}">ä½ç½®: ${gameState.board[player.position].name} (${player.position}) ${player.inJail ? `(ç›£ç„ä¸­ï¼Œå‰© ${player.jailTurns} å›åˆ)` : ''}</p>
                          </div>
                     `;
            }).join('');
        }

        function renderBoardDisplay() {
            const boardDiv = document.getElementById('board-display');
            
            if (!gameState || !gameState.board) {
                boardDiv.innerHTML = '<p class="text-center text-gray-500 py-4">æ£‹ç›¤æ•¸æ“šè¼‰å…¥ä¸­...</p>';
                return;
            }
            
            const currentPlayerId = gameState.players[gameState.turn].id;

            boardDiv.innerHTML = gameState.board.map((square, index) => { 
                const playersAtSquare = gameState.players.filter(p => p.position === index && p.isPlaying);
                const isOwned = square.owner !== null; 
                const ownerPlayer = isOwned ? gameState.players.find(p => p.id === square.owner) : null;
                const ownerColor = ownerPlayer ? ownerPlayer.color : 'transparent';
                
                let textColor = 'text-white'; 
                if (square.color.includes('-300') || square.color === 'bg-yellow-400' || square.color === 'bg-gray-400' || square.color === 'bg-red-600' || square.color === 'bg-yellow-200' || square.color === 'bg-orange-400' || square.color === 'bg-red-400' || square.color === 'bg-gray-100' || square.color === 'bg-green-500') {
                     textColor = 'text-gray-800';
                }
                if (square.color.includes('bg-green-600') || square.color.includes('bg-red-600') || square.color.includes('bg-purple-600') || square.color === 'bg-red-900' || square.color === 'bg-pink-900') {
                     textColor = 'text-white';
                }
                
                const hexColor = COLOR_MAP[square.color] || '#f3f4f6'; 
                const hasPlayer = playersAtSquare.length > 0;

                const baseClass = `min-w-[120px] h-32 p-2 rounded-lg shadow-xl border-b-4 border-r-2 border-gray-500 flex flex-col justify-between transition-all duration-300 transform cursor-pointer`;
                const activeClass = hasPlayer ? 'scale-105 border-yellow-500 border-4' : '';

                // --- NEW: è™•ç†æ£‹å­é‡ç–Šé‚è¼¯ (åªé¡¯ç¤ºä¸€å€‹æ£‹å­ï¼Œå„ªå…ˆé¡¯ç¤ºç•¶å‰ç©å®¶) ---
                let tokensToRender = [];
                if (playersAtSquare.length > 0) {
                    const currentTurnPlayerAtSquare = playersAtSquare.find(p => p.id === currentPlayerId);
                    
                    // å„ªå…ˆé¡¯ç¤ºç•¶å‰å›åˆçš„ç©å®¶ï¼Œå¦‚æœä»–/å¥¹åœ¨é€™æ ¼
                    if (currentTurnPlayerAtSquare) {
                         tokensToRender = [currentTurnPlayerAtSquare];
                    } else {
                         // å¦å‰‡ï¼Œé¡¯ç¤ºè©²æ ¼ä¸Šçš„ç¬¬ä¸€å€‹ç©å®¶
                         tokensToRender = [playersAtSquare[0]];
                    }
                }

                const playerTokensHtml = tokensToRender.map(p => {
                    const highlightClass = 'border-yellow-400 ring-2 ring-yellow-400'; 
                    
                    // NEW: æª¢æŸ¥ custom avatar URL
                    let tokenStyle = `background-color: ${p.color};`;
                    let tokenContent = p.name[0] || '?';
                    let tokenClass = '';

                    if (p.avatarUrl) {
                         tokenStyle = `background-image: url('${p.avatarUrl}'); background-size: cover; background-position: center;`; 
                         tokenContent = '';
                    } else {
                         tokenClass = 'text-white';
                    }

                    return `<div class="player-token-container"> 
                                     <div class="player-token-inner ${tokenClass} ${highlightClass}" 
                                          style="${tokenStyle}">
                                          ${tokenContent}
                                     </div>
                                 </div>`;
                }).join('');
                // --- END NEW: è™•ç†æ£‹å­é‡ç–Šé‚è¼¯ ---
                
                // *** NEW: æˆ¿å±‹æ•¸é‡é¡¯ç¤ºé‚è¼¯ ***
                let houseIconsHtml = '';
                if (square.type === 'PROPERTY' && square.houses > 0) {
                     const houseCount = square.houses;
                     // æ ¹æ“šæˆ¿å±‹æ•¸é‡ï¼Œæ¸²æŸ“ä¸åŒåœ–æ¨™
                     houseIconsHtml = Array(houseCount).fill(0).map((_, i) => {
                          let iconClass, iconText;
                          if (i === HOUSE_CONFIG.MAX_HOUSES - 1) { 
                              iconClass = 'skyscraper'; iconText = 'å¤§'; 
                          } else if (i >= 2) { 
                              iconClass = 'apartment'; iconText = 'å…¬'; 
                          } else {
                              iconClass = 'house'; iconText = 'æˆ¿'; 
                          }
                          return `<span class="house-icon ${iconClass}">${iconText}</span>`;
                     }).join('');
                }
                
                // ç§Ÿé‡‘æˆ–åƒ¹æ ¼é¡¯ç¤º
                let priceOrRentHtml = '';
                if (square.type === 'PROPERTY') {
                    if (square.mortgage) {
                         priceOrRentHtml = `<p class="text-xs text-red-600 font-bold">å·²æŠµæŠ¼ ğŸ”’</p>`;
                    } else {
                         const currentRent = calculateRent(square);
                         priceOrRentHtml = `<p class="text-xs ${textColor}">ç§Ÿ: $${currentRent.toLocaleString()}</p>`;
                    }
                } else if (square.action) {
                    priceOrRentHtml = `<p class="text-xs ${textColor}">é‡‘é¡: $${square.action.toLocaleString()}</p>`;
                } else {
                    priceOrRentHtml = `<p class="text-xs ${textColor}">${square.type}</p>`;
                }


                return `
                     <div id="square-${index}" 
                             class="${baseClass} ${activeClass} relative" 
                             style="background-color: ${hexColor};"
                             onclick="${square.type === 'PROPERTY' ? `handleSquareClick(${index})` : ''}"> 
                             <div class="flex justify-between items-center w-full">
                                 <p class="text-xs font-semibold overflow-hidden whitespace-nowrap ${textColor}">#${index} ${square.name}</p>
                                 <div class="flex">
                                     ${houseIconsHtml}
                                 </div>
                             </div>
                             
                             ${priceOrRentHtml}
                             
                             ${isOwned ? `<div class="h-1 w-full rounded-full shadow-inner" style="background-color: ${ownerColor};"></div>` : '<div class="h-1 w-full"></div>'}
                             <div class="w-full h-10 relative"> ${playerTokensHtml}
                             </div>
                     </div>
                     `;
            }).join('');
            
            // NEW: å¾é€™è£¡ç§»é™¤è‡ªå‹•æ»¾å‹•é‚è¼¯ã€‚ç¾åœ¨æ»¾å‹•åªåœ¨ animateMove ä¸­é‹è¡Œã€‚
        }

        function addLog(text, type = 'info') {
            const logElement = document.getElementById('game-log');
            // æ­¤è™•åªè¨˜éŒ„æ—¥èªŒï¼Œå¯¦éš›æ¸²æŸ“å’Œæ¨£å¼ç”± onSnapshot è™•ç†
            // logElement.prepend(logItem); // ç§»é™¤ä¸å¿…è¦çš„ DOM æ“ä½œ
        }

        /**
         * è¨­ç½®æŒ‰éˆ•çš„å•Ÿç”¨/ç¦ç”¨ç‹€æ…‹
         */
        function setControlState() {
            
            // --- NEW: ç®¡ç†å“¡/è«‹æ±‚æŒ‰éˆ•æ§åˆ¶ (åŠŸèƒ½ 1 & 2) ---
            const gameMaster = gameState ? gameState.players[0] : null;
            const isGameMasterDevice = gameMaster && gameMaster.currentUserId === userId;
            const existingPlayer = gameState ? gameState.players.find(p => p.currentUserId === userId) : null;
            const isAdminReady = gameMaster && gameMaster.currentUserId !== null; 
            
            // åŠŸèƒ½ 1: åªæœ‰ P0 æ§åˆ¶è€…çœ‹åˆ°è¨­å®š/ç®¡ç†æŒ‰éˆ•
            const adminButtons = [document.getElementById('settings-btn'), document.getElementById('player-admin-btn')];
            // ä¿®æ­£ï¼šç¾åœ¨æŒ‰éˆ•ä½æ–¼å®¹å™¨å…§ï¼Œåªéœ€è¦æ§åˆ¶æŒ‰éˆ•çš„ `hidden` å±¬æ€§å³å¯
            adminButtons.forEach(btn => btn.classList.toggle('hidden', !isGameMasterDevice));
            
            // NEW: Debug Input é¡¯ç¤ºæ§åˆ¶
            const debugInput = document.getElementById('debug-steps-input');
            if (debugInput) {
                 debugInput.style.display = (isGameMasterDevice && gameState?.settings?.debugMode) ? 'block' : 'none';
            }


            // åŠŸèƒ½ 2: æµ®å‹•è«‹æ±‚æŒ‰éˆ• (å·²ç¦ç”¨ï¼Œé¼“å‹µé»æ“Šå¡ç‰‡èªé ˜)
            document.getElementById('request-join-btn').classList.toggle('hidden', true); 
            
            // --- éŠæˆ²ä¸­æ§åˆ¶é‚è¼¯ ---

            if (!gameState || gameState.status === 'WIN' || !gameState.gameStarted) {
                document.getElementById('roll-dice-btn').disabled = true;
                document.getElementById('end-turn-btn').disabled = true;
                setControlVisibility('none');
                
                if (gameState && !gameState.gameStarted && gameState.players.filter(p => p.isPlaying).length > 0) {
                    addLog('æç¤ºï¼šéŠæˆ²äººæ•¸ä¸è¶³ 2 ä½ã€‚è«‹å‰å¾€ã€ŒğŸ‘¤ ç©å®¶ç®¡ç†ã€è¨­å®šäººæ•¸ä¸¦å„²å­˜ä»¥é–‹å§‹éŠæˆ²ã€‚', 'info');
                } else if (gameState && !gameState.gameStarted && gameState.players.filter(p => p.isPlaying).length === 0) {
                    addLog('æç¤ºï¼šæ­£åœ¨ç­‰å¾…éŠæˆ²åˆå§‹åŒ–ä¸¦èªé ˜æ‚¨çš„ç©å®¶è§’è‰²...', 'info');
                }
                
                // NEW: ç¢ºä¿åˆå§‹éª°å­åœ–ç‰‡é¡¯ç¤ºç‚º 1, 1
                const dice1El = document.getElementById('dice-display-1');
                const dice2El = document.getElementById('dice-display-2');
                dice1El.src = DICE_IMAGES[gameState?.dice[0] || 1];
                dice2El.src = DICE_IMAGES[gameState?.dice[1] || 1];
                
                return; 
            }
            
            // --- éŠæˆ²ä¸­æ§åˆ¶é‚è¼¯ ---

            const currentPlayerIndex = gameState.turn;
            const currentPlayer = gameState.players[currentPlayerIndex];
            
            // åŠŸèƒ½ 5: ç†±æ©Ÿæ¨¡å¼åˆ¤æ–·
            const isGameMasterDeviceChecker = gameState.players[0] && gameState.players[0].currentUserId === userId;
            const isHotSwapMode = gameState.settings?.hotSwapMode === true;
            let isMyTurn;
            if (isHotSwapMode && isGameMasterDeviceChecker) {
                // ç†±æ©Ÿæ¨¡å¼ä¸‹ï¼ŒP0 è¨­å‚™å¯ä»¥æ§åˆ¶ä»»ä½•è¼ªåˆ°å›åˆçš„ç©å®¶
                isMyTurn = true; 
            } else {
                // ç·šä¸Šæ¨¡å¼/é P0 è¨­å‚™ï¼šå¿…é ˆæ˜¯è‡ªå·±ç¶å®šçš„è§’è‰²
                isMyTurn = currentPlayer.currentUserId === userId; 
            }

            // [ä¿®æ­£ 1] ç›£ç„æœåˆ‘æœŸé–“ç¦ç”¨æ“²éª°
            const isInJailAndServing = currentPlayer.inJail && currentPlayer.jailTurns > 0;
            
            // --- ä¿®æ­£ 2.1: MOVING ç‹€æ…‹æ™‚å…¨éƒ¨ç¦ç”¨ ---
            if (gameState.status === 'MOVING') {
                document.getElementById('roll-dice-btn').disabled = true;
                document.getElementById('end-turn-btn').disabled = true;
                setControlVisibility('none');
                return; 
            }
            // --- END ä¿®æ­£ 2.1 ---
            
            // ã€ä¸»è¦ä¿®æ­£ 1ï¼šè§£é™¤å¡ä½ã€‘
            // Roll Dice æŒ‰éˆ•å•Ÿç”¨é‚è¼¯
            document.getElementById('roll-dice-btn').disabled = !(isMyTurn && gameState.status === 'READY' && currentPlayer.isPlaying && !isInJailAndServing); // ç›£ç„æœåˆ‘æ™‚ READY ç‹€æ…‹ä¹Ÿç¦ç”¨æ“²éª°
            
            // End Turn æŒ‰éˆ•å•Ÿç”¨é‚è¼¯
            // ç›£ç„æœåˆ‘æœŸé–“å…è¨±çµæŸå›åˆï¼ˆé»æ“Šç›£ç„å½ˆçª—çš„ç¢ºèªæŒ‰éˆ•æœƒå‘¼å« endTurnï¼‰
            document.getElementById('end-turn-btn').disabled = !(isMyTurn && (gameState.status === 'ACTION_REQUIRED' || gameState.status === 'ROLLED' || isInJailAndServing) && currentPlayer.isPlaying);
            
            // NEW: éª°å­åœ–ç‰‡æ›´æ–°
            const dice1El = document.getElementById('dice-display-1');
            const dice2El = document.getElementById('dice-display-2');
            dice1El.src = DICE_IMAGES[gameState.dice[0]];
            dice2El.src = DICE_IMAGES[gameState.dice[1]];
            
            // èª¿æ•´çµæŸå›åˆæŒ‰éˆ•çš„é¡è‰²
            const endTurnBtn = document.getElementById('end-turn-btn');
            // ç§»é™¤èˆŠçš„é¡è‰²é¡åˆ¥
            endTurnBtn.classList.remove('bg-indigo-700', 'hover:bg-indigo-800', 'bg-gray-600', 'hover:bg-gray-700');
            
            if (isMyTurn && (gameState.status === 'ACTION_REQUIRED' || gameState.status === 'ROLLED' || isInJailAndServing)) {
                // å¦‚æœéœ€è¦å‹•ä½œæˆ–å·²ç¶“æ“²éª°ï¼Œå‰‡ç‚ºäº®è‰² (æç¤ºå¯é»æ“Š)
                endTurnBtn.classList.add('bg-indigo-700', 'hover:bg-indigo-800');
            } else {
                // å¦å‰‡ç‚ºæš—è‰²
                endTurnBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
            }


            // **NEW: è™•ç†é¡å¤–å‹•ä½œæŒ‰éˆ• (è³¼è²·åœ°ç”¢ã€é™·å®³å¡ã€åœ°ç”¢ç®¡ç†)**
            const pendingType = gameState.pendingAction?.type;
            
            if (!isMyTurn) {
                setControlVisibility('none'); // ç„¡ä¸»æŒ‰éˆ•
            } else if (gameState.status === 'ACTION_REQUIRED') {
                const currentSquare = gameState.board[currentPlayer.position];
                const squareType = currentSquare.type;
                
                // å¿…é ˆæ˜¯ ACTION_REQUIREDï¼Œä¸”åœåœ¨ BANK æˆ– CASINO æ‰èƒ½ä½¿ç”¨
                if (squareType === 'BANK' && pendingType === 'BANK_SERVICE') {
                    setControlVisibility('bank');
                } else if (squareType === 'CASINO' && pendingType === 'CASINO_GAME') {
                    setControlVisibility('casino');
                } else if (squareType === 'PROPERTY' && currentSquare.owner !== null && currentSquare.owner !== currentPlayer.id && !currentSquare.mortgage) {
                    // è™•æ–¼ä»˜ç§Ÿé‡‘çš„ ACTION_REQUIRED ç‹€æ…‹ï¼Œä¸é¡¯ç¤ºå…¶ä»–æŒ‰éˆ•
                    setControlVisibility('none');
                } else {
                    setControlVisibility('none');
                }
            } else if (pendingType === 'BUY_PROPERTY') {
                // å¦‚æœæ˜¯ ROLLED ç‹€æ…‹ï¼Œä½†æœ‰å¾…è™•ç†çš„è³¼è²·å‹•ä½œï¼ˆè¸©åˆ°ç„¡ä¸»åœ°ç”¢å¾Œï¼‰
                setControlVisibility('buy'); 
            } else if (pendingType === 'PROPERTY_MANAGEMENT') {
                // å¦‚æœæ˜¯ ROLLED ç‹€æ…‹ï¼Œä½†æœ‰å¾…è™•ç†çš„åœ°ç”¢ç®¡ç†å‹•ä½œï¼ˆè¸©åˆ°è‡ªå·±çš„åœ°ç”¢å¾Œï¼‰
                setControlVisibility('manage'); 
            } else if (pendingType === 'USE_TRAP_CARD') {
                // å¦‚æœæ˜¯ ROLLED ç‹€æ…‹ï¼Œä½†æœ‰å¾…è™•ç†çš„é™·å®³å¡å‹•ä½œï¼ˆæŠ½åˆ°é™·å®³å¡å¾Œï¼‰
                setControlVisibility('trap');
            } else {
                setControlVisibility('none');
            }
        }

        // **NEW: æ“´å±• setControlVisibility å‡½æ•¸ä»¥åŒ…å« buy, trap, manage**
        function setControlVisibility(action) {
             // ç¢ºä¿é€™è£¡åŒ…å«äº†æ‰€æœ‰æ§åˆ¶æŒ‰éˆ•çš„ ID
             const controls = ['bank', 'casino', 'buy', 'trap', 'manage']; 
             controls.forEach(c => {
                 let btnId;
                 if (c === 'buy') btnId = 'buy-property-btn';
                 else if (c === 'trap') btnId = 'use-trap-card-btn';
                 else if (c === 'manage') btnId = 'manage-property-btn';
                 else if (c === 'bank') btnId = 'bank-btn';
                 else if (c === 'casino') btnId = 'casino-btn';
                 
                 const btn = document.getElementById(btnId);
                 if (btn) {
                     if (c === action) {
                          btn.classList.remove('hidden');
                          btn.disabled = false;
                     } else {
                          btn.classList.add('hidden');
                          btn.disabled = true;
                     }
                 }
             });
        }
        // **END NEW**

        async function retryFirestoreOperation(operation, maxRetries = 5) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                     return await operation();
                } catch (error) {
                     if (error.code && (error.code === 'permission-denied' || error.message.includes('Missing or insufficient permissions'))) {
                          console.warn(`Firestore æ¬Šé™ä¸è¶³ï¼Œç¬¬ ${attempt + 1} æ¬¡é‡è©¦...`, error.message);
                     } else if (error.message.includes("Document not found")) {
                          throw error;
                     } else {
                          console.warn(`Firestore æ“ä½œå¤±æ•—ï¼Œç¬¬ ${attempt + 1} æ¬¡é‡è©¦...`, error.message);
                     }
                     
                     if (attempt === maxRetries - 1) {
                          throw error;
                     }
                     const delay = Math.pow(2, attempt) * 1000;
                     await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

async function restartGame() {
    const savedSettings = gameState.settings;
    const oldPlayers = gameState.players;

    // === é—œéµï¼šå¼·åˆ¶é‡æ–°ç”Ÿæˆ BOARDï¼Œè®“ä½ çš„ intervalSpecialIndices ä¿®æ”¹çœŸæ­£ç”Ÿæ•ˆ ===
    // é€™æœƒé‡æ–°åŸ·è¡Œæ•´å€‹æ£‹ç›¤ç”Ÿæˆé‚è¼¯ï¼ˆåŒ…å«ç‰¹æ®Šæ ¼ä½ç½®åˆ†é… + åœ°ç”¢éš¨æ©Ÿæ‰“äº‚ï¼‰
    const freshInitialState = getInitialGameState(savedSettings.initialMoney);

    // === æ­¥é©Ÿ1ï¼šå–å‡ºå‰›ç”Ÿæˆçš„ boardï¼Œæº–å‚™åªæ‰“äº‚åœ°ç”¢æ ¼ ===
    let newBoard = JSON.parse(JSON.stringify(freshInitialState.board)); // æ·±æ‹·è²æ–°ç”Ÿæˆçš„æ£‹ç›¤

// å–å‡ºæ‰€æœ‰åœ°ç”¢æ ¼
const propertySquares = newBoard.filter(sq => sq.type === 'PROPERTY');
// æ´—ç‰Œåœ°ç”¢æ ¼é †åºï¼ˆFisher-Yatesï¼‰
for (let i = propertySquares.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [propertySquares[i], propertySquares[j]] = [propertySquares[j], propertySquares[i]];
}
// é‡å»ºæ£‹ç›¤ï¼šç‰¹æ®Šæ ¼ä½ç½®ä¸è®Šï¼Œåœ°ç”¢æ ¼ç”¨æ´—ç‰Œå¾Œçš„é †åºå¡«å›å»
let propIndex = 0;
newBoard = newBoard.map((square, i) => { // â† æ–°å¢ i åƒæ•¸ï¼ˆä½ç½®ç´¢å¼•ï¼‰
    if (square.type === 'PROPERTY') {
        const prop = propertySquares[propIndex++]; // å–å‡ºæ´—ç‰Œå¾Œçš„åœ°ç”¢
        return { ...prop, index: i }; // â† é—œéµï¼šå¼·åˆ¶è¨­ç½®æ–° index = i
    }
    return { ...square, index: i }; // â† ç‰¹æ®Šæ ¼ä¹Ÿæ›´æ–° indexï¼ˆä¿éšªï¼‰
});

    // === æ­¥é©Ÿ2ï¼šå»ºç«‹æœ€çµ‚çš„ initialGameState ===
    const initialGameState = getInitialGameState(savedSettings.initialMoney);

    // ä½¿ç”¨æˆ‘å€‘å‰›å‰›ã€Œç‰¹æ®Šæ ¼ä¾æ–°è¨­å®š + åœ°ç”¢å·²æ´—ç‰Œã€çš„æ£‹ç›¤
    initialGameState.board = newBoard;

    // å®Œæ•´ä¿ç•™æ‰€æœ‰è¨­å®šï¼ˆåœ–ç‰‡ã€ç°¡ä»‹ã€è‚¡ç¥¨ç­‰ï¼‰
    initialGameState.settings = JSON.parse(JSON.stringify(savedSettings)); // æ·±æ‹·è²ç¢ºä¿ä¸å½±éŸ¿èˆŠçš„

    // ä¿ç•™ç©å®¶åç¨±ã€é¡è‰²ã€é ­åƒï¼Œä½†é‡ç½®éŠæˆ²é€²åº¦
    initialGameState.players = initialGameState.players.map((p, index) => {
        const oldP = oldPlayers[index] || p;
        return {
            ...p,
            name: oldP.name,
            color: oldP.color,
            avatarUrl: oldP.avatarUrl,
            isPlaying: index === 0,			// åªå•Ÿç”¨ P0
            currentUserId: null,			// å…¨éƒ¨è§£é™¤ç¶å®š
            money: savedSettings.initialMoney,
            bank: 0,
            stocks: { ...p.stocks },		// é‡ç½®æŒè‚¡ç‚º 0
            position: 0,
            inJail: false,
            jailTurns: 0,
            properties: [],
            lastActiveTimestamp: Date.now(),
            trapCard: null, // **NEW: é‡ç½®é™·å®³å¡**
        };
    });

    // å¼·åˆ¶å°‡ P0 ç¶å®šçµ¦é‡å•ŸéŠæˆ²çš„äºº
    if (initialGameState.players[0]) {
        initialGameState.players[0].currentUserId = userId;
        initialGameState.players[0].isPlaying = true;
        initialGameState.turn = 0;
    }

    // å…¶ä»–ç‹€æ…‹é‡ç½®
    initialGameState.gameStarted = false;
    initialGameState.status = 'READY';
    initialGameState.pendingJoinRequests = {};
    initialGameState.pendingAction = { type: 'none', squareIndex: null, card: null }; // **NEW: æ¸…é™¤ pendingAction**
    initialGameState.round = 1; // **NEW: é‡ç½®å›åˆæ•¸**

    // è‚¡ç¥¨åƒ¹æ ¼ï¼šä¿ç•™ç•¶å‰æ³¢å‹•å¾Œçš„åƒ¹æ ¼ï¼ˆå¯æ”¹æˆé‡ç½®çš„è©±æŠŠé€™è¡Œæ”¹æ‰ï¼‰
    initialGameState.currentStocks = gameState.currentStocks.map(s => ({
        ...s,
        sellPrice: Math.floor(s.price * 0.8)
    }));

    // æ—¥èªŒæç¤º
    initialGameState.log = [{
        text: `éŠæˆ²å·²é‡æ–°å•Ÿå‹•ï¼ç‰¹æ®Šæ ¼å·²ä¾æœ€æ–°è¨­å®šé‡æ–°é…ç½®ï¼Œåœ°ç”¢é¡¯ç¤ºé †åºå·²éš¨æ©Ÿé‡æ’ï¼Œæ‰€æœ‰åœ–ç‰‡èˆ‡ç°¡ä»‹éƒ½å®Œæ•´ä¿ç•™ã€‚`,
        time: Date.now()
    }];

    // å¯«å…¥ Firestore
    await updateGameState(initialGameState, 'éŠæˆ²é‡å•ŸæˆåŠŸï¼Œæ–°æ£‹ç›¤å·²ç”Ÿæˆ');

    // é—œé–‰ç¢ºèªè¦–çª—
    document.getElementById('modal').classList.add('hidden');
    document.getElementById('modal').classList.remove('flex');
}
        function showModal(title, message, confirmAction, contentHtml = null, confirmText = 'ç¢ºèª') {
            document.getElementById('modal-title').textContent = title.split(']')[0] + ']'; // ç¢ºä¿åªé¡¯ç¤ºæ¨™é¡Œå‰åŠéƒ¨
            document.getElementById('modal-message').innerHTML = message;
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = contentHtml || '';
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            const topCloseBtn = document.getElementById('modal-top-close-btn');

            // è¨­ç½®å®Œæ•´æ¨™é¡Œ (ç¢ºä¿é ‚éƒ¨æ¨™é¡Œå€åŸŸè¶³å¤ å¯¬ï¼Œä¸åŒ…å« message)
            document.getElementById('modal-title').innerHTML = title; 

            // ã€UI/UX ä¿®æ­£ã€‘é‡ç½®å–æ¶ˆæŒ‰éˆ•çš„æ–‡å­—ï¼Œé¿å…å¾ Casino å½ˆçª—ç¹¼æ‰¿ã€Œé›¢é–‹è³­å ´ã€
            cancelBtn.textContent = 'å–æ¶ˆ'; 
            
            confirmBtn.textContent = confirmText;
            
            // è™•ç†ç¢ºèªæŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
            const closeAndReset = () => {
                document.getElementById('modal').classList.add('hidden');
                document.getElementById('modal').classList.remove('flex');
                // é‡è¨­ç¢ºèªæŒ‰éˆ•æ¨£å¼ï¼Œç¢ºä¿è²·ä¸èµ·æ™‚çš„æ¨£å¼ä¸æœƒæ®˜ç•™
                confirmBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                confirmBtn.classList.remove('bg-gray-400', 'hover:bg-gray-500');
            };
            
            // è™•ç†é ‚éƒ¨é—œé–‰æŒ‰éˆ•
            topCloseBtn.onclick = closeAndReset;

            if (confirmText === 'é—œé–‰' || confirmText === 'é–‹å§‹éŠæˆ²') {
                confirmBtn.onclick = closeAndReset;
                cancelBtn.classList.add('hidden');
            } else {
                confirmBtn.onclick = () => {
                    // å…ˆåŸ·è¡Œ Actionï¼Œå†é—œé–‰ Modal
                    confirmAction();
                    closeAndReset(); // å¦‚æœ Action æˆåŠŸï¼Œå‰‡é—œé–‰
                };
            }

            // è™•ç†å–æ¶ˆæŒ‰éˆ•çš„å¯è¦‹æ€§å’Œè¡Œç‚º
            const isPersistentModal = title.includes('ç¢ºèªé‡æ–°å•Ÿå‹•éŠæˆ²') || title.includes('ç©å®¶ç®¡ç†') || title.includes('è¨­å®š') || title.includes('èªé ˜è§’è‰²è«‹æ±‚') || title.includes('æ”¯ä»˜éè·¯è²»ç¢ºèª') || title.includes('é¸æ“‡é™·å®³ç›®æ¨™') || title.includes('è³¼è²·åœ°ç”¢') || title.includes('éŠ€è¡Œæœå‹™') || title.includes('åœ°ç”¢ç°¡ä»‹') || title.includes('ç›£ç„ç‹€æ…‹æç¤º') || title.includes('åœ°ç”¢ç®¡ç†') || title.includes('ç¹³ç´ç¨…æ¬¾') || title.includes('Casino');

            if (isPersistentModal) {
                 if (title.includes('æ”¯ä»˜éè·¯è²»ç¢ºèª') || title.includes('ç›£ç„ç‹€æ…‹æç¤º') || title.includes('ç®¡ç†å“¡æ¥ç®¡æˆåŠŸ') || title.includes('ç¹³ç´ç¨…æ¬¾')) {
                      // å°æ–¼æ”¯ä»˜ã€ç›£ç„å’Œç¨…å‹™å½ˆçª—ï¼Œä¸å…è¨±å–æ¶ˆ
                      cancelBtn.classList.add('hidden');
                 } else {
                      cancelBtn.classList.remove('hidden');
                 }
                 
                 // å°æ–¼åœ°ç”¢è³¼è²·å’Œé™·å®³å¡ï¼Œå–æ¶ˆæŒ‰éˆ•åœ¨å„è‡ªçš„ Modal å‡½å¼ä¸­è¢«è¦†å¯«äº†è¡Œç‚º
                 if (!title.includes('è³¼è²·åœ°ç”¢') && !title.includes('é¸æ“‡é™·å®³ç›®æ¨™') && !title.includes('Casino') && !title.includes('åœ°ç”¢ç®¡ç†') && !title.includes('éŠ€è¡Œæœå‹™')) {
                      cancelBtn.onclick = closeAndReset;
                 }
            } else if (title.includes('Casino')) {
                 // Casino é‚è¼¯åœ¨ showCasinoModal ä¸­å–®ç¨è™•ç†
            } else {
                 cancelBtn.classList.add('hidden');
            }
            
            // ç¢ºä¿é Casino æ¨¡æ…‹è¦–çª—çš„é ‚éƒ¨é—œé–‰æŒ‰éˆ•æ°¸é å­˜åœ¨
            topCloseBtn.classList.remove('hidden');


            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
        }

async function listenForGameState() {
    gameRef = doc(db, `artifacts/${appId}/public/data/melbourne_monopoly`, 'game_master');
    console.log(`[${userId}] Using gameRef path: ${gameRef.path}`);

    let shouldInitialize = false;
    let docExists = false;
    try {
        await retryFirestoreOperation(async () => {
            const docSnapshot = await getDoc(gameRef);
            if (!docSnapshot.exists()) {
                shouldInitialize = true;
                throw new Error("Game document needs initialization.");
            }
            docExists = true;
        }, 5);

    } catch (error) {
        if (error.message.includes("Game document needs initialization")) {
            shouldInitialize = true;
            console.log(`[${userId}] éŠæˆ²æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°‡å˜—è©¦åˆå§‹åŒ–ã€‚`);
        } else {
            console.error(`[${userId}] åˆå§‹è®€å–æ™‚é‡åˆ°åš´é‡éŒ¯èª¤ï¼š`, error);
            addLog(`åˆå§‹è®€å–å¤±æ•—ï¼šç„¡æ³•ç¢ºèªéŠæˆ²ç‹€æ…‹ (${error.message})`, 'error');
            return;
        }
    }

    if (shouldInitialize && !docExists) {
        try {
            console.log(`[${userId}] å˜—è©¦å‰µå»ºæ–°çš„å…¬å…±éŠæˆ²å¯¦ä¾‹ã€‚`);
            const initialGameState = getInitialGameState(DEFAULT_INITIAL_MONEY);

            initialGameState.gameStarted = false;
            initialGameState.status = 'READY';

            if (initialGameState.players[0]) {
                initialGameState.players[0].currentUserId = userId;
                initialGameState.players[0].isPlaying = true;
            }
            await retryFirestoreOperation(async () => {
                await setDoc(gameRef, initialGameState);
            }, 5);

            console.log(`[${userId}] æˆåŠŸå‰µå»ºæ–°æ–‡ä»¶ä¸¦åˆå§‹åŒ–éŠæˆ²ç‹€æ…‹ã€‚`);
        } catch (writeError) {
            console.error(`[${userId}] å¯«å…¥æ–°æ–‡ä»¶å¤±æ•—ï¼Œç„¡æ³•å•Ÿå‹•éŠæˆ²ï¼š`, writeError);
            addLog(`åˆå§‹åŒ–å¤±æ•—ï¼šç„¡æ³•å¯«å…¥æ•¸æ“šåº«ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ Firestore æ¬Šé™ã€‚`, 'error');
            return;
        }
    }

    // è¨­ç½®ç›£è½å™¨
    onSnapshot(gameRef, (doc) => {
        if (doc.exists()) {
            const newGameState = doc.data();

     // --- ã€æ ¸å¿ƒä¿®æ­£ï¼šMOVING ç‹€æ…‹é‡é€£æ¢å¾©é‚è¼¯ã€‘ ---
        if (newGameState.status === 'MOVING') {
            const currentPlayerIndex = newGameState.turn;
            const currentPlayer = newGameState.players[currentPlayerIndex];
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºè‡ªå·±çš„å›åˆ (è€ƒæ…®ç†±æ©Ÿæ¨¡å¼)
            const isGameMasterDevice = newGameState.players[0]?.currentUserId === userId;
            const isHotSwapMode = newGameState.settings?.hotSwapMode === true;
            const isMyTurn = (isHotSwapMode && isGameMasterDevice) || (currentPlayer.currentUserId === userId);

            // å¦‚æœæ˜¯æˆ‘è¼ªåˆ°ï¼Œä¸”ç‹€æ…‹æ˜¯ MOVINGï¼Œä»£è¡¨æˆ‘å‰›é‡æ•´é€²ä¾†ï¼Œå‹•ç•«æ²’è·‘å®Œ
            if (isMyTurn && !isProcessingAction) {
                console.log("åµæ¸¬åˆ°ç§»å‹•ä¸­é‡æ•´ï¼Œæ­£åœ¨æ¢å¾©è©²æ ¼çš„åŠŸèƒ½è¦–çª—...");
                isProcessingAction = true; // é˜²æ­¢é‡è¤‡è§¸ç™¼

                // å»¶é²ä¸€ä¸‹ç¢ºä¿æ•¸æ“šè¼‰å…¥å®Œç•¢
                setTimeout(async () => {
                    gameState = newGameState; // æ›´æ–°æœ¬åœ°ç‹€æ…‹
                    // ç›´æ¥è§¸ç™¼è½åœ°é‚è¼¯ï¼šé€™æœƒæ ¹æ“šç©å®¶ç•¶å‰ä½ç½®å½ˆå‡ºã€Œè³¼è²·ã€ã€ã€Œç§Ÿé‡‘ã€æˆ–ã€Œå¡ç‰‡ã€è¦–çª—
                    await handleLandingAction(currentPlayerIndex);
                    isProcessingAction = false;
                }, 800);
                return;
            }
        }
        // --- ã€ä¿®å¾©çµæŸã€‘ ---
            
            
            // --- ç¢ºä¿ currentStocks èˆ‡ stocksConfig åŒæ­¥ï¼ˆæ–°å¢è‚¡ç¥¨æ™‚è‡ªå‹•åˆå§‹åŒ–åƒ¹æ ¼ï¼‰---
            let needsStockUpdate = false;
            const stocksConfig = newGameState.settings.stocksConfig || [];
            const currentStocks = newGameState.currentStocks || [];

            const updatedCurrentStocks = [...currentStocks];
            stocksConfig.forEach(configStock => {
                const existingDynamicStock = currentStocks.find(s => s.symbol === configStock.symbol);

                if (!existingDynamicStock) {
                    console.log(`[${userId}] åµæ¸¬åˆ°æ–°è‚¡ç¥¨ï¼š${configStock.symbol}ï¼Œæ­£åœ¨åˆå§‹åŒ–å‹•æ…‹åƒ¹æ ¼ã€‚`);
                    updatedCurrentStocks.push({
                        name: configStock.name,
                        symbol: configStock.symbol,
                        price: configStock.price,
                        sellPrice: Math.floor(configStock.price * 0.8),
                        volatility: configStock.volatility || DEFAULT_VOLATILITY,
                    });
                    needsStockUpdate = true;
                }
            });
            if (needsStockUpdate) {
                console.log(`[${userId}] stocksConfig/currentStocks ä¸ä¸€è‡´ï¼Œå¼·åˆ¶åŒæ­¥ã€‚`);
                newGameState.currentStocks = updatedCurrentStocks;
                setDoc(gameRef, { ...newGameState, log: newGameState.log });
            }
            // --- çµæŸåŒæ­¥ ---

            // --- æª¢æŸ¥åŠ å…¥/è¢«è¸¢å‡ºæç¤º ---
            if (previousPlayersState) {
                const myPlayer = newGameState.players.find(p => p.currentUserId === userId);
                const oldBoundPlayer = previousPlayersState.find(p => p.currentUserId === userId);

                if (myPlayer && (!oldBoundPlayer || oldBoundPlayer.id !== myPlayer.id)) {
                    const wasPending = gameState.pendingJoinRequests ? Object.keys(gameState.pendingJoinRequests).includes(userId) : false;
                    if (wasPending || !oldBoundPlayer) {
                        showModal(
                            'âœ… æˆåŠŸåŠ å…¥éŠæˆ²',
                            `<p class="text-lg">æ­å–œæ‚¨ï¼Œæ‚¨ç¾åœ¨æ˜¯ **${myPlayer.name}**ï¼è«‹ç­‰å¾…æ‚¨çš„å›åˆé–‹å§‹ã€‚</p>`,
                            () => {},
                            null,
                            'é–‹å§‹éŠæˆ²'
                        );
                    }
                }

                const amIBoundNow = newGameState.players.some(p => p.currentUserId === userId);
                if (oldBoundPlayer && !amIBoundNow) {
                    showModal(
                        'âš ï¸ è§’è‰²ç¶å®šå·²è§£é™¤',
                        `<p class="text-lg text-red-600 font-bold">æ‚¨å°è§’è‰² **${oldBoundPlayer.name}** çš„æ§åˆ¶æ¬Šå·²è¢«éŠæˆ²ç®¡ç†å“¡è§£é™¤ã€‚</p><p class="mt-2 text-sm">æ‚¨å¯ä»¥é»æ“Šå…¶ä»–ç©ºé–’å¡ç‰‡é‡æ–°è«‹æ±‚åŠ å…¥ã€‚</p>`,
                        () => {},
                        null,
                        'ç¢ºèª'
                    );
                }
            }
            previousPlayersState = JSON.parse(JSON.stringify(newGameState.players));
            gameState = newGameState;

            // æ¢å¾©å„²å­˜çš„åœ–ç‰‡ URL
            if (gameState.settings && gameState.settings.propertyImageUrls) {
                const savedImageUrls = gameState.settings.propertyImageUrls;
                gameState.board = gameState.board.map(square => {
                    if (square.type === 'PROPERTY' && savedImageUrls[square.name]) {
                        return { ...square, imageUrl: savedImageUrls[square.name] };
                    }
                    return square;
                });
            }

            // P0 è‡ªå‹•èªé ˜ï¼ˆåƒ…é¦–æ¬¡ï¼‰
            claimPlayerSlot(false);

            renderPlayerStats();
            renderBoardDisplay();

            // === çµ‚æ¥µè‡ªå‹•æ¢å¾©æ©Ÿåˆ¶ï¼šé‡æ–°æ•´ç†å¾Œ ACTION_REQUIRED/ROLLED æ™‚å¼·åˆ¶å½ˆå‡ºå¿…è¦è¦–çª— ===
            // **é—œéµä¿®æ­£ï¼šæ–°å¢å° BUY_PROPERTY å’Œ USE_TRAP_CARD çš„è™•ç†**
            if (gameState.status === 'ACTION_REQUIRED' || gameState.status === 'ROLLED' || gameState.status === 'READY') {
                const currentPlayerIndex = gameState.turn;
                const currentPlayer = gameState.players[currentPlayerIndex];

                const isGameMasterDevice = gameState.players[0]?.currentUserId === userId;
                const isHotSwapMode = gameState.settings?.hotSwapMode === true;
                const isMyTurn = (isHotSwapMode && isGameMasterDevice) || (currentPlayer.currentUserId === userId);
                const isModalOpen = document.getElementById('modal').classList.contains('flex') || document.getElementById('card-modal').classList.contains('flex');

                // ã€ä¿®æ”¹å¾Œã€‘ï¼šåŠ å…¥ !isProcessingAction åˆ¤æ–·
                if (isMyTurn && !isModalOpen && !isRestoringModal && !isProcessingAction) {
                    const currentSquare = gameState.board[currentPlayer.position];
                    const pendingType = gameState.pendingAction?.type;
                    isRestoringModal = true; 
                    
                    // 1. ä»–äººç‰©ç”¢ (ç§Ÿé‡‘æ”¯ä»˜)
                    if (gameState.status === 'ACTION_REQUIRED' && currentSquare.type === 'PROPERTY' && currentSquare.owner !== null && currentSquare.owner !== currentPlayer.id) {
                        const ownerPlayer = gameState.players.find(p => p.id === currentSquare.owner);
                        const rent = calculateRent(currentSquare);
                        // é‡æ–°å½ˆå‡ºç§Ÿé‡‘æ”¯ä»˜è¦–çª—
                        showRentModal(currentPlayer, ownerPlayer, currentSquare, rent);
                        addLog(`[è‡ªå‹•æ¢å¾©] åµæ¸¬åˆ°ä»–äººç‰©ç”¢ã€Œ${currentSquare.name}ã€ï¼Œç§Ÿé‡‘æ”¯ä»˜è¦–çª—å·²å¼·åˆ¶é‡æ–°å½ˆå‡ºï¼`, 'info');
                    }
                    // 2. ç›£ç„è·³éå›åˆæç¤º (Jail Turn)
                    // ã€**ä¿®æ­£**ï¼šè™•ç†ç›£ç„å½ˆçª—çš„è‡ªå‹•æ¢å¾©ï¼Œç¢ºä¿ jailTurns > 0 æ™‚å½ˆå‡ºã€‘
                    // åªæœ‰åœ¨ READY ç‹€æ…‹ä¸‹ï¼Œä¸”ç¢ºå®šåœ¨ç›£ç„ä¸­ä½†æ²’æœ‰æ“²éª°å‹•ä½œï¼ˆå‰›è¼ªåˆ°æˆ–åˆ·æ–°é é¢ï¼‰æ‰å½ˆå‡º
                    else if (gameState.status === 'READY' && currentPlayer.inJail && currentPlayer.jailTurns > 0) {
                        // é€™è£¡åœ¨ onSnapshot æª¢æŸ¥ä¸¦å½ˆå‡ºæ¨¡æ…‹ï¼Œè®“ç©å®¶é»æ“Šã€Œç¢ºèªã€ä¾†èµ°å®Œç›£ç„æµç¨‹
                        // rollDice è£¡é¢çš„é‚è¼¯æœƒè™•ç†ç‹€æ…‹è½‰ç§»å’Œ jailTurns æ¸›å°‘
                        showJailTurnModal(currentPlayer, currentPlayer.jailTurns);
                        addLog(`[è‡ªå‹•æ¢å¾©] åµæ¸¬åˆ°ç›£ç„æœåˆ‘ä¸­ï¼Œç›£ç„æç¤ºè¦–çª—å·²å¼·åˆ¶é‡æ–°å½ˆå‡ºï¼`, 'info');
                    }
                    // 2.5 ç¨…å‹™æ”¯ä»˜ (æ–°å¢)
                    else if (gameState.status === 'ACTION_REQUIRED' && (currentSquare.type === 'INCOME_TAX' || currentSquare.type === 'LUXURY_TAX')) {
                         const taxAmount = currentSquare.type === 'INCOME_TAX' ? Math.round(currentPlayer.money * currentSquare.action) : currentSquare.action;
                         showTaxModal(currentPlayer, currentSquare, taxAmount);
                         addLog(`[è‡ªå‹•æ¢å¾©] åµæ¸¬åˆ°ç¨…å‹™æ”¯ä»˜æœªå®Œæˆï¼Œç¨…å‹™å½ˆçª—å·²å¼·åˆ¶é‡æ–°å½ˆå‡ºï¼`, 'info');
                    }
                    // 3. ç„¡ä¸»åœ°ç”¢
                    else if (pendingType === 'BUY_PROPERTY') {
                        showPropertyBuyModal(currentPlayer, currentSquare);
                        addLog(`[è‡ªå‹•æ¢å¾©] åµæ¸¬åˆ°ç„¡ä¸»åœ°ç”¢ã€Œ${currentSquare.name}ã€ï¼Œè³¼è²·è¦–çª—å·²å¼·åˆ¶é‡æ–°å½ˆå‡ºï¼`, 'info');
                    }
                    // 4. é™·å®³å¡
                    else if (pendingType === 'USE_TRAP_CARD' && currentPlayer.trapCard !== null) {
                        showTrapTargetModal(currentPlayer, currentPlayer.trapCard);
                        addLog(`[è‡ªå‹•æ¢å¾©] åµæ¸¬åˆ°é™·å®³å¡ï¼Œç›®æ¨™é¸æ“‡è¦–çª—å·²å¼·åˆ¶é‡æ–°å½ˆå‡ºï¼`, 'info');
                    }
                    // 5. éŠ€è¡Œæœå‹™ï¼ˆæ–°å¢ï¼‰
                    else if (pendingType === 'BANK_SERVICE') {
                        showBankModal(currentPlayer);
                        addLog(`[è‡ªå‹•æ¢å¾©] åµæ¸¬åˆ°éŠ€è¡Œæœå‹™æœªå®Œæˆï¼ŒéŠ€è¡Œå½ˆçª—å·²å¼·åˆ¶é‡æ–°å½ˆå‡ºï¼`, 'info');
                    }
                    // 6. Casinoï¼ˆæ–°å¢ï¼‰
                    else if (pendingType === 'CASINO_GAME') {
                        showCasinoModal(currentPlayer);
                        addLog(`[è‡ªå‹•æ¢å¾©] åµæ¸¬åˆ° Casino æœªå®Œæˆï¼ŒCasino å½ˆçª—å·²å¼·åˆ¶é‡æ–°å½ˆå‡ºï¼`, 'info');
                    }
                    // 7. åœ°ç”¢ç®¡ç†ï¼ˆæ–°å¢ï¼‰
                    else if (pendingType === 'PROPERTY_MANAGEMENT') {
                        showPropertyManagementModal(currentPlayer, currentSquare);
                        addLog(`[è‡ªå‹•æ¢å¾©] åµæ¸¬åˆ°åœ°ç”¢ç®¡ç†æœªå®Œæˆï¼Œåœ°ç”¢ç®¡ç†å½ˆçª—å·²å¼·åˆ¶é‡æ–°å½ˆå‡ºï¼`, 'info');
                    }
                    // ä¸€ç§’å¾Œè§£é–ï¼Œé¿å…çŸ­æ™‚é–“å…§é‡è¤‡è§¸ç™¼
                    setTimeout(() => { isRestoringModal = false; }, 1000);
                }
            }

            // === çµ‚æ¥µä¿éšªï¼šå¦‚æœ ACTION_REQUIRED ä½†æ²’æœ‰ä»»ä½•è¦–çª—ï¼Œé¡¯ç¤ºç´…è‰²å¼·åˆ¶çµæŸå›åˆæŒ‰éˆ• ===
            if (gameState.status === 'ACTION_REQUIRED' || gameState.pendingAction?.type === 'BUY_PROPERTY' || gameState.pendingAction?.type === 'USE_TRAP_CARD' || gameState.pendingAction?.type === 'PROPERTY_MANAGEMENT' || gameState.pendingAction?.type === 'BANK_SERVICE' || gameState.pendingAction?.type === 'CASINO_GAME') {
                const currentPlayerIndex = gameState.turn;
                const currentPlayer = gameState.players[currentPlayerIndex];

                const isGameMasterDevice = gameState.players[0]?.currentUserId === userId;
                const isHotSwapMode = gameState.settings?.hotSwapMode === true;
                const isMyTurn = (isHotSwapMode && isGameMasterDevice) || (currentPlayer.currentUserId === userId);
                const modalVisible = document.getElementById('modal').classList.contains('flex');
                const cardModalVisible = document.getElementById('card-modal').classList.contains('flex');

                // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰å¿…è¦çš„ Action éƒ½æ²’æœ‰å½ˆçª—ï¼Œä¸”ä¸æ˜¯åœ¨è™•ç† Rent/Jail/Card å¿…é ˆç­‰å¾…çš„ç‹€æ…‹
                const isStuck = isMyTurn && !modalVisible && !cardModalVisible && gameState.status !== 'MOVING';
                
                // æ’é™¤ä¸éœ€è¦å¼·åˆ¶çµæŸçš„ç‹€æ³ï¼š
                // åªæœ‰ç•¶ action æ˜¯ç§Ÿé‡‘æ™‚ï¼Œæ‰ä¸å…è¨±å¼·åˆ¶çµæŸï¼Œå› ç‚ºç§Ÿé‡‘ Modal ä¸å…è¨±é—œé–‰ã€‚
                const isRentRequired = gameState.status === 'ACTION_REQUIRED' && gameState.board[currentPlayer.position].type === 'PROPERTY' && gameState.board[currentPlayer.position].owner !== null && gameState.board[currentPlayer.position].owner !== currentPlayer.id && !gameState.board[currentPlayer.position].mortgage;

                if (isStuck && !isRentRequired) {
                    let forceBtn = document.getElementById('force-end-turn-btn');
                    if (!forceBtn) {
                        const controlsArea = document.getElementById('game-controls-emergency-area'); // ä¿®æ­£ï¼šä½¿ç”¨æ–°å¢çš„å€åŸŸ
                        forceBtn = document.createElement('button');
                        forceBtn.id = 'force-end-turn-btn';
                        forceBtn.textContent = 'ğŸš¨ å¼·åˆ¶çµæŸå›åˆ (å¡ä½æ•‘æ€¥)';
                        forceBtn.className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-xl shadow-2xl transition-all duration-200 text-base w-full md:w-auto mx-auto mb-4 border-4 border-red-400 animate-pulse';
                        forceBtn.onclick = async () => {
                            const currentSquare = gameState.board[currentPlayer.position];
                            // **NEW: æ¸…é™¤æ‰€æœ‰ pendingAction å’Œ trapCard**
                            currentPlayer.trapCard = null;
                            const logMsg = `${currentPlayer.name} ä½¿ç”¨ã€Œå¼·åˆ¶çµæŸå›åˆã€è„«å›°ï¼ˆç›¸ç•¶æ–¼æ”¾æ£„ç•¶å‰å‹•ä½œï¼‰ã€‚`;
                            await updateGameState({ ...gameState, status: 'ROLLED', pendingAction: { type: 'none', squareIndex: null, card: null } }, logMsg);
                            await endTurn();
                            forceBtn.remove();
                        };
                        // å°‡æŒ‰éˆ•æ’å…¥åˆ° controlsArea çš„åº•éƒ¨
                        controlsArea.appendChild(forceBtn);
                        addLog(`ğŸš¨ å›åˆä¼¼ä¹å¡ä½ï¼å·²å‡ºç¾ç´…è‰²ã€Œå¼·åˆ¶çµæŸå›åˆã€æŒ‰éˆ•ï¼Œé»æ“Šå³å¯ç¹¼çºŒéŠæˆ²ï¼ˆç­‰åŒæ”¾æ£„ç•¶å‰å‹•ä½œï¼‰ã€‚`, 'error');
                    }
                } else {
                    const existingForceBtn = document.getElementById('force-end-turn-btn');
                    if (existingForceBtn) existingForceBtn.remove();
                }
            } else {
                const existingForceBtn = document.getElementById('force-end-turn-btn');
                if (existingForceBtn) existingForceBtn.remove();
            }
            // === çµ‚æ¥µä¿éšªçµæŸ ===

            setControlState();
            renderHeaderAlerts();

            // æ—¥èªŒæ¸²æŸ“ï¼ˆæœ€æ–°åœ¨ä¸Šï¼Œç´…è‰²é«˜äº®ï¼‰
            const logElement = document.getElementById('game-log');
            logElement.innerHTML = gameState.log.map((item, index) => {
                const isNewest = index === 0;
                const colorClass = isNewest ? 'text-red-600 font-bold' : 'text-gray-700';
                return `<li class="${colorClass} text-sm">${item.text}</li>`;
            }).join('');
        } else {
            console.warn('éŠæˆ²æ–‡ä»¶å·²è¢«åˆªé™¤æˆ–ä¸å­˜åœ¨!');
            addLog('è­¦å‘Šï¼šéŠæˆ²æ–‡ä»¶å·²è¢«åˆªé™¤æˆ–ç„¡æ³•è¨ªå•ï¼Œè«‹é‡å•Ÿç¶²é æˆ–æª¢æŸ¥æ¬Šé™ã€‚', 'error');
        }
    }, (error) => {
        console.error(`[${userId}] onSnapshot ç›£è½å¤±æ•— (Firebase éŒ¯èª¤)ï¼š`, error);
        addLog(`æ•¸æ“šåŒæ­¥å¤±æ•—ï¼š${error.message}ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šæˆ–æ¬Šé™è¨­å®šã€‚`, 'error');
    });
}

        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error('Firebase é…ç½®ç¼ºå¤±!');
                document.getElementById('user-id-display').textContent = 'éŒ¯èª¤: Firebase é…ç½®ç¼ºå¤±';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // é¡¯ç¤ºç•¶å‰ç”¨æˆ¶ ID çš„å‰ 8 ä½ä»¥ä¾›åƒè€ƒ
                        document.getElementById('user-id-display').textContent = `${userId.substring(0, 8)}... (æ‚¨çš„ ID)`;
                        if (!isListenerInitialized) {
                            listenForGameState();
                            isListenerInitialized = true;
                        }
                    } else {
                        console.log('æœªç™»å…¥');
                        userId = 'loading';
                        isListenerInitialized = false; 
                        document.getElementById('user-id-display').textContent = 'æœªèªè­‰';
                    }
                });
                
                // --- éŠæˆ²æ¨™é¡Œéš±è—åŠŸèƒ½ç›£è½å™¨ (é‡æ–°å•Ÿç”¨) ---
                document.getElementById('game-title').addEventListener('click', () => {
                    const currentTime = Date.now();
                    
                    if (currentTime - lastClickTime < CLICK_THRESHOLD) {
                        clickCount++;
                    } else {
                        clickCount = 1;
                    }

                    lastClickTime = currentTime;

                    if (clickCount === 3) {
                        console.log('Triple click detected, attempting admin takeover...');
                        clickCount = 0; // Reset immediately
                        forceAdminTakeover(); 
                    }
                });


                // --- éŠæˆ²æ§åˆ¶æŒ‰éˆ•ç›£è½å™¨ ---
                // ç”±æ–¼ endTurn å’Œ rollDice å·²ç¶“è¢«ç§»è‡³é ‚å±¤ä½œç”¨åŸŸï¼Œç¾åœ¨æ‡‰è©²å¯ä»¥è¢«æ­£ç¢ºå¼•ç”¨
                document.getElementById('roll-dice-btn').addEventListener('click', rollDice);
                document.getElementById('end-turn-btn').addEventListener('click', endTurn);
                
                // **NEW: ç¶å®šè³¼è²·åœ°ç”¢ã€åœ°ç”¢ç®¡ç†å’Œé™·å®³å¡æŒ‰éˆ•**
                document.getElementById('buy-property-btn').addEventListener('click', window.showPropertyBuyModalWrapper);
                document.getElementById('manage-property-btn').addEventListener('click', window.showPropertyManagementModalWrapper);
                document.getElementById('use-trap-card-btn').addEventListener('click', window.showTrapTargetModalWrapper);
                
                document.getElementById('settings-btn').addEventListener('click', () => {
                    if (!gameState) { addLog("éŠæˆ²ç‹€æ…‹å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å€™ã€‚", 'error'); return; }
                    showSettingsModal();
                }); 
                document.getElementById('player-admin-btn').addEventListener('click', () => {
                    if (!gameState) { addLog("éŠæˆ²ç‹€æ…‹å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å€™ã€‚", 'error'); return; }
                    showPlayerAdminModal();
                }); 
                
                document.getElementById('casino-btn').addEventListener('click', () => {
                     const currentPlayer = gameState.players[gameState.turn];
                     if(gameState.status === 'ROLLED' && gameState.board[currentPlayer.position].type === 'CASINO'){
                          showCasinoModal(currentPlayer);
                     } else {
                          addLog('éŒ¯èª¤: ç¾åœ¨ä¸æ˜¯é€²è¡Œ Casino æ“ä½œçš„æ™‚æ©Ÿã€‚', 'error');
                     }
                 });

                document.getElementById('bank-btn').addEventListener('click', () => {
                     const currentPlayer = gameState.players[gameState.turn];
                     if(gameState.status === 'ROLLED' && gameState.board[currentPlayer.position].type === 'BANK'){ 
                          showBankModal(currentPlayer);
                     } else {
                          addLog('éŒ¯èª¤: ç¾åœ¨ä¸æ˜¯é€²è¡ŒéŠ€è¡Œæ“ä½œçš„æ™‚æ©Ÿã€‚', 'error');
                     }
                 });
                
                // NEW: æµ®å‹•æŒ‰éˆ•ç¶å®š (ç”±æ–¼å¡ç‰‡é»æ“Šå·²å¯¦ç¾ï¼Œæ­¤æŒ‰éˆ•åŠŸèƒ½è¢«å¼±åŒ–ï¼Œåªåœ¨æœ‰å¯èªé ˜æ§½ä½æ™‚ä½œç‚ºæé†’)
                document.getElementById('request-join-btn').addEventListener('click', () => {
                      const unclaimedSlot = gameState?.players?.find(p => p.id !== 'p0' && p.isPlaying && p.currentUserId === null);
                      
                      if (unclaimedSlot) {
                              // å½ˆå‡ºä¸€å€‹é¸è§’æç¤ºï¼Œé¼“å‹µé»æ“Šå¡ç‰‡
                              showModal(
                                   'ğŸ”— é¸æ“‡ä¸€å€‹è§’è‰²åŠ å…¥',
                                   `<p class="text-lg">è«‹ç›´æ¥é»æ“Šä¸Šæ–¹è³‡è¨Šé¢æ¿ä¸­ï¼Œ<span class="text-green-600 font-bold">é‚Šæ¡†ç‚ºç¶ è‰²</span> ä¸” <span class="text-gray-500 font-semibold">æ§åˆ¶è³‡è¨Šé¡¯ç¤ºã€Œç„¡ä¸» (å¯èªé ˜)ã€</span> çš„ç©å®¶è³‡è¨Šå¡ï¼Œä»¥ç™¼èµ·èªé ˜è«‹æ±‚ã€‚</p>`,
                                   () => {},
                                   null,
                                   'ç¢ºèª'
                                 );
                      } else {
                                  addLog('ç›®å‰æ²’æœ‰å¯èªé ˜çš„ç©å®¶è§’è‰²ã€‚è«‹ç®¡ç†å“¡åœ¨ã€Œç©å®¶ç®¡ç†ã€ä¸­å•Ÿç”¨æ–°çš„è§’è‰²ã€‚', 'error');
                      }
                  });


            } catch (e) {
                console.error('Firebase/Auth åˆå§‹åŒ–å¤±æ•—:', e);
                document.getElementById('user-id-display').textContent = 'éŒ¯èª¤: åˆå§‹åŒ–å¤±æ•—';
            }
        }

        window.onload = initializeFirebase;
        
    </script>
</body>
</html>
