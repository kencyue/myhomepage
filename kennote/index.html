<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Kennote todolist</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<link rel="stylesheet" type="text/css" href="style.css?ver=1">
<style>
/* ç¢ºä¿æ¨™é¡Œè¼¸å…¥æ¡†ä½”æ»¿å¯¬åº¦ */
.modal-input-new {
    width: 100%;
    padding: 10px;
    border: 1px solid #E2E8F0;
    border-radius: 6px;
    font-size: 16px;
    margin-bottom: 15px; 
}
/* æ¨™ç±¤å®¹å™¨æ¨£å¼ */
.tag-selection-container {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
    justify-content: flex-start;
}
/* æ¨™ç±¤æŒ‰éˆ•åŸºç¤æ¨£å¼ */
.tag-btn {
    padding: 6px 14px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.2s, color 0.2s, border 0.2s, opacity 0.2s;
    white-space: nowrap; 
}

/* ç¢ºä¿èˆŠçš„ modal-field-row çµæ§‹è¢«å®Œå…¨éš±è— */
.modal-field-row {
    display: none !important; 
}
</style>
</head>
<body>
<div id="loginScreen">    
    <img src="icon/logo.png" alt="Kennote Logo" id="loginLogo"> 
    <p>è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</p>    
    <button id="btnGoogleSignIn" class="login-btn">      
      <img src="icon/google.png" alt="Google ç™»å…¥" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">      
      Google ç™»å…¥    
    </button>
</div> 

<div id="appContent" style="display: none;">
  <header class="header-flex">  
    <div class="logo-box">    
      <img src="icon/logo.png" alt="keá¹…ote" class="logo">  
    </div>
    <button id="btnLogout" class="nt-btn nt-ghost">ç™»å‡º</button>
  </header>

  <div class="toolbar" style="display:none">  
    
  </div>

  <div id="main">
    <div id="dateBar">  
      <button id="btnPrevDay" class="date-nav-btn">    <img src="icon/previous.png" alt="å‰ä¸€å¤©" class="date-nav-icon">  </button>
      <div id="dateCenter" class="date-center">    
        <button id="btnToday" class="nt-btn nt-ghost">ä»Šæ—¥</button>    
        <div class="date-display">      <img src="icon/date.png" class="icon" alt="æ—¥æœŸ">      <span id="currentDateText"></span>    </div>    
        <div id="dateBarIcon">â–¾</div>  
      </div>
      <button id="btnNextDay" class="date-nav-btn">    <img src="icon/next.png" alt="å¾Œä¸€å¤©" class="date-nav-icon">  </button>
    </div>

    <div class="add-filter-row">  
      <button class="nt-btn nt-primary icon-btn" id="btnSearch">    <img src="icon/search.png" alt="æœå°‹"> æœå°‹  </button>
      <button class="nt-btn nt-primary icon-btn" id="btnAdd">    <img src="icon/edit.png" alt="æ–°å¢"> æ–°å¢è¨˜äº‹  </button>
      <div id="filterBar">    
        <button class="nt-btn nt-ghost active" data-filter="">å…¨éƒ¨</button>    
        <button class="nt-btn nt-ghost" data-filter="ç§äºº">ç§äºº</button>    
        <button class="nt-btn nt-ghost" data-filter="å·¥ä½œ">å·¥ä½œ</button>  
      </div>
    </div>
    <div id="noteList"></div>
  </div>
</div>
<input type="hidden" id="currentDate">

<div id="noteModal" class="modal-overlay">  
    <div class="modal-content">    
        <div class="modal-header" id="noteModalHeader">æ–°å¢è¨˜äº‹</div>    
        
        <div class="modal-field-label">æ¨™é¡Œ</div>    
        <div class="modal-field-row-new" style="display: flex;">  
            <input type="text" id="noteTitleInput" class="modal-input-new">
        </div>
        
        <div class="modal-field-label">åˆ†é¡æ¨™ç±¤</div>
        <div id="noteCategoryTags" class="tag-selection-container" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
            </div>

        <div class="modal-field-label">å…§å®¹</div>    
        <textarea id="noteContentInput" class="modal-textarea"></textarea>    
        
        <div class="modal-field-row" style="display: none;"></div> 
        
        <div class="modal-footer">       
            <button class="nt-btn nt-ghost"  id="noteModalCancel">å–æ¶ˆ</button>       
            <button class="nt-btn nt-primary" id="noteModalSave">å„²å­˜</button>    
        </div>  
    </div>
</div>
<div id="calendarModal" class="modal-overlay">  <div class="modal-content">    <div class="calendar-header">      <button class="calendar-nav-btn" id="calPrev">&lt;</button>      <div class="calendar-title" id="calTitle"></div>      <button class="calendar-nav-btn" id="calNext">&gt;</button>    </div>    <div class="calendar-weekdays">      <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>    </div>    <div class="calendar-grid" id="calendarGrid"></div>  </div></div>
<script>
/* ============================================================
===== Firebase/Firestore/Auth é…ç½®åŠè³‡æ–™åº«æ›¿æ›é‚è¼¯ (V9 Compat) =====
============================================================
*/
// ğŸ”¥ æ‚¨çš„ Firebase å°ˆæ¡ˆé…ç½® 
const firebaseConfig = {
    apiKey: "AIzaSyD17BCkojSaGiuGzubNGMg-HKGJn5il79o",
    authDomain: "kennote-58073.firebaseapp.com",
    projectId: "kennote-58073",
    appId: "1:1000941899656:web:5c2f62f428b9609520743d",
};

// å…¨åŸŸè®Šæ•¸
let auth = null;
let db = null;
let currentUserID = null;
let editingId = null;
let currentFilter = "";
let calendarMonth = new Date();
calendarMonth.setDate(1);
let noteDateSet = new Set();
let allUserNotesCache = []; 

// åˆå§‹åŒ– Firebase
const app = firebase.initializeApp(firebaseConfig);
auth = firebase.auth();
db = firebase.firestore();

/* =============================
    èº«ä»½é©—è­‰ (Authentication) - ã€ç™»å…¥é‚è¼¯ä¿æŒä¸è®Šã€‘
============================= */
auth.onAuthStateChanged(async (user) => {
    const loginScreen = document.getElementById("loginScreen");
    const appContent = document.getElementById("appContent");

    if (user) {
        currentUserID = user.uid;
        
        // ç™»å…¥ï¼šéš±è— loginScreenï¼Œé¡¯ç¤º appContent (ä¸»ç•«é¢)
        loginScreen.style.display = "none";
        appContent.style.display = "flex"; 

        const today = formatDate(new Date());
        setCurrentDateStr(today);

        // å•Ÿå‹• Firestore è®€å–
        await fetchAllNotesForCache(); 
        loadNotesForCurrentDate();
        loadBackupList(); // å‘¼å«åœç”¨å‡½å¼ä¾†è¨­ç½®é¸å–®è¨Šæ¯

    } else {
        currentUserID = null;
        
        // æœªç™»å…¥ï¼šé¡¯ç¤º loginScreenï¼Œéš±è— appContent
        loginScreen.style.display = "flex";
        appContent.style.display = "none";
        
        document.getElementById("noteList").innerHTML = '';
        allUserNotesCache = [];
    }
});

document.getElementById("btnGoogleSignIn").onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider);
};

document.getElementById("btnLogout").onclick = () => {
    auth.signOut();
};

/* =============================
    Firestore CRUD æ›¿ä»£ IndexedDB 
============================= */
// è®€å–æŸæ—¥æœŸçš„è¨˜äº‹ (å¾æœ¬åœ°å¿«å–)
function loadNotesForCurrentDate() {
    if (!currentUserID) return;
    const targetDate = getCurrentDateStr();
    const notesToday = allUserNotesCache
        .filter(n => n.date === targetDate);
             renderNotes(notesToday);
}

// å¾ Firestore ç²å–æ‰€æœ‰è¨˜äº‹åˆ°æœ¬åœ°å¿«å–ï¼Œä¸¦æ›´æ–°æœˆæ›†é»é»
async function fetchAllNotesForCache() {
    if (!currentUserID) return;
    try {
        const snapshot = await db.collection("users").doc(currentUserID).collection("notes").get();
        allUserNotesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // æ›´æ–°æœˆæ›†é»é»
        noteDateSet.clear();
        allUserNotesCache.forEach(n => {
            if (n.date) noteDateSet.add(n.date);
        });
        renderCalendar(); // æ›´æ–°æœˆæ›†

        return allUserNotesCache; // è¿”å›å¿«å–æ•¸æ“šä¾›æœå°‹ä½¿ç”¨
    } catch (e) {
        // éš”é›¢éŒ¯èª¤
        console.error("Error fetching documents: ", e);
        if (e.code === 'permission-denied') {
             alert("è­¦å‘Šï¼šFirestore è¦å‰‡è¨­å®šéŒ¯èª¤ï¼Œç„¡æ³•è®€å–è¨˜äº‹ï¼è«‹æª¢æŸ¥ Consoleï¼");
        }
        return [];
    }
}

// å„²å­˜/æ›´æ–°è¨˜äº‹ (Save/Update)
async function saveNoteToDB(note, docId = null) {
    if (!currentUserID) return;
    const noteRef = db.collection("users").doc(currentUserID).collection("notes");
        
    let newNoteData = { ...note };
    delete newNoteData.id;
    
    // ğŸ”¥ã€æœ€å°æ”¹å‹•ï¼šç§»é™¤ undefined æ¬„ä½ã€‘
    Object.keys(newNoteData).forEach(key => {
        if (newNoteData[key] === undefined) {
            delete newNoteData[key];
        }
    });

    try {
        if (docId) {
            await noteRef.doc(docId).update(newNoteData);
        } else {
            await noteRef.add(newNoteData);
        }
        await fetchAllNotesForCache(); // æ›´æ–°å¿«å–
        loadNotesForCurrentDate();
    } catch (e) {
        console.error("Error saving document: ", e);
        alert("å„²å­˜å¤±æ•—ï¼š" + e.message);
    }
}

// åˆªé™¤è¨˜äº‹ (Delete)
async function deleteNote(id) {
    if (!currentUserID) return;
    try {
        if (confirm("ç¢ºå®šåˆªé™¤é€™ç­†è¨˜äº‹ï¼Ÿ")) {
            await db.collection("users").doc(currentUserID).collection("notes").doc(id).delete();
            await fetchAllNotesForCache(); // æ›´æ–°å¿«å–
            loadNotesForCurrentDate();
        }
    } catch (e) {
        console.error("Error deleting document: ", e);
        alert("åˆªé™¤å¤±æ•—ï¼š" + e.message);
    }
}

// æ¨™è¨˜å®Œæˆ / æœªå®Œæˆ
async function markNoteDone(id, done_date) {
    if (!currentUserID) return;
    try {
        await db.collection("users").doc(currentUserID).collection("notes").doc(id).update({
            done_date: done_date,
            // æ’åºæ¬„ä½æ¸…ç©ºï¼Œè®“ Sortable.js æŠŠå®ƒä¸Ÿåˆ°æœ€åº•ä¸‹
            order_index: firebase.firestore.FieldValue.delete()
        });
        await fetchAllNotesForCache(); // æ›´æ–°å¿«å–
        loadNotesForCurrentDate();
    } catch (e) {
        console.error("Error updating done status: ", e);
    }
}

// æ¬ç§»è¨˜äº‹ (Move: æ”¹æ—¥æœŸ + å–æ¶ˆå®Œæˆ)
async function moveNoteToDate(noteId, newDate) {
    if (!currentUserID) return;
    try {
        await db.collection("users").doc(currentUserID).collection("notes").doc(noteId).update({
            date: newDate,
            done_date: null,
            order_index: firebase.firestore.FieldValue.delete()
        });
        // ğŸš¨ ä¸å¼·åˆ¶è·³è½‰ï¼Œåªé‡æ–°æ•´ç†
        await fetchAllNotesForCache();
        loadNotesForCurrentDate();
        return true;
    } catch (e) {
        console.error("Error moving note: ", e);
        return false;
    }
}

// è¤‡è£½è¨˜äº‹ (Copy: å‰µå»ºæ–°è¨˜äº‹) - ğŸš© ä¿®æ­£ order_index éŒ¯èª¤
async function copyNoteToDate(originalNote, newDate) {
    if (!currentUserID) return;
    const newNote = {
        date: newDate,
        title: originalNote.title,
        content: originalNote.content,
        category: originalNote.category,
        done_date: null,
        // ç§»é™¤ order_index: firebase.firestore.FieldValue.delete()ï¼Œå› ç‚º add() ä¸æ”¯æ´
    };
    try {
        await db.collection("users").doc(currentUserID).collection("notes").add(newNote);
        await fetchAllNotesForCache();
        loadNotesForCurrentDate();
        return true;
    } catch (e) {
        console.error("Error copying note: ", e);
        return false;
    }
}

// æ’åºåŠŸèƒ½ï¼šå„²å­˜æ–°çš„ order_index
async function saveNoteOrder(id, index) {
    if (!currentUserID) return;
    try {
        await db.collection("users").doc(currentUserID).collection("notes").doc(id).update({
            order_index: index
        });
    } catch(e) {
        console.error("Error saving order: ", e);
    }
}


/* =============================    é›²ç«¯å‚™ä»½ / é‚„åŸ / åˆªé™¤ (åŠŸèƒ½å·²åœç”¨)============================= */
function loadBackupList() {
    // è©²å‡½å¼ç¾åœ¨åªè² è²¬åˆå§‹åŒ–é¸å–®çš„é¡¯ç¤ºï¼Œä½†ç›®å‰ç„¡é ˆæ“ä½œã€‚
}


/* ================================================================= 
    å„ªåŒ–å¾Œçš„ JS é‚è¼¯ (å·¥å…·å‡½æ•¸ã€æ¸²æŸ“ã€äº‹ä»¶) 
=================================================================*/
/* =============================    å·¥å…·å‡½æ•¸ + æ¨™ç±¤æ¸²æŸ“åŠŸèƒ½ (é¡è‰²é‚è¼¯å·²æ›´æ–°) ============================= */
function truncateTitle(title) {  return title.length > 10 ? title.slice(0, 10) + "â€¦" : title;}     
function formatDate(date) {  const y = date.getFullYear();  const m = String(date.getMonth() + 1).padStart(2, "0");  const d = String(date.getDate()).padStart(2, "0");  return `${y}-${m}-${d}`;}    
function formatTime(date) {  const h = String(date.getHours()).padStart(2, "0");  const m = String(date.getMinutes()).padStart(2, "0");  const s = String(date.getSeconds()).padStart(2, "0");  return `${h}:${m}:${s}`;}    
function formatDateTime(date) {  return `${formatDate(date)} ${formatTime(date)}`;}

function getCurrentDateStr() {  return document.getElementById("currentDate").value;}
function setCurrentDateStr(str) {  document.getElementById("currentDate").value = str;  document.getElementById("currentDateText").textContent = str;}

const CATEGORIES = ["", "ç§äºº", "å·¥ä½œ"]; // å¯ç”¨çš„æ‰€æœ‰åˆ†é¡é¸é …

// ğŸ”¥ ä¿®æ”¹: æ ¹æ“šæ‚¨çš„è¦æ±‚è¿”å›èƒŒæ™¯é¡è‰²
function getCategoryColor(category) {
    const colors = {
        "": "#ffffff",      // ä¸åˆ†é¡: ç™½åº•
        "ç§äºº": "#8B5E34",   // ç§äºº: æ£•è‰²
        "å·¥ä½œ": "#4A5568",   // å·¥ä½œ: æ·±ç°è‰²
        "å­¸ç¿’": "#9C27B0"  
    };
    return colors[category] || "#1b1b1b"; 
}

// ğŸ”¥ æ–°å¢: æ±ºå®šæ–‡å­—é¡è‰² (ä¸åˆ†é¡ç‚ºé»‘å­—ï¼Œå…¶ä»–ç‚ºç™½å­—)
function getCategoryTextColor(category) {
    if (category === "") {
        return "#1b1b1b"; // ä¸åˆ†é¡: é»‘å­—
    }
    return "white"; // å…¶ä»–: ç™½å­—
}

// ğŸ”¥ ä¿®æ­£ï¼šå°‡ Hover æ•ˆæœåŠ å…¥åˆ° renderCategoryTags å‡½æ•¸ä¸­
function renderCategoryTags(currentCategory) {
    const container = document.getElementById("noteCategoryTags");
    if (!container) return;

    container.innerHTML = ''; 

    CATEGORIES.forEach(category => {
        const btn = document.createElement("button");
        btn.textContent = category || "ä¸åˆ†é¡"; 
        btn.className = "nt-btn tag-btn"; // ä½¿ç”¨ç¾æœ‰çš„é¡å
        btn.dataset.category = category;

        // --- æ¨£å¼å®šç¾© ---
        const defaultBg = "#ffffff";
        const defaultText = "#1b1b1b";
        const categoryBg = getCategoryColor(category);
        const categoryText = getCategoryTextColor(category);

        const applyDefaultStyle = (element) => {
            // åˆå§‹ç‹€æ…‹ï¼šç™½åº•é»‘å­—
            element.style.backgroundColor = defaultBg;
            element.style.color = defaultText;
            element.style.border = '1px solid #E2E8F0';
            element.style.opacity = '1';
            element.style.transition = '0.2s';
            element.style.outline = 'none';
        };

        const applyActiveStyle = (element) => {
            // Active ç‹€æ…‹ï¼šä½¿ç”¨åˆ†é¡é¡è‰²ä½œç‚ºèƒŒæ™¯å’Œæ–‡å­—è‰²ï¼Œä¸¦åŠ ä¸Šè—è‰²é‚Šæ¡†
            element.style.backgroundColor = categoryBg;
            element.style.color = categoryText;
            element.style.outline = `2px solid ${categoryText}`; // æ–‡å­—è‰²å…§é‚Šæ¡†
        }
        
        const applyHoverStyle = (element, cat) => {
            // Hover ç‹€æ…‹ï¼šä¸åˆ†é¡è®Šé»‘åº•ç™½å­—ï¼Œå…¶ä»–è®Šæˆåˆ†é¡è‰²
            if (cat === "") {
                element.style.backgroundColor = '#1b1b1b';
                element.style.color = 'white';
                element.style.border = '1px solid #1b1b1b';
            } else {
                element.style.backgroundColor = categoryBg;
                element.style.color = categoryText;
                element.style.border = `1px solid ${categoryBg}`;
            }
        }


        // åˆå§‹ç‹€æ…‹
        applyDefaultStyle(btn);

        if (category === currentCategory) {
            btn.classList.add("active");
            applyActiveStyle(btn);
        } 
        
        // --- äº‹ä»¶è™•ç† ---

        btn.onmouseenter = () => {
            if (!btn.classList.contains('active')) {
                applyHoverStyle(btn, category);
            }
        };

        btn.onmouseleave = () => {
            if (!btn.classList.contains('active')) {
                applyDefaultStyle(btn);
            } else {
                applyActiveStyle(btn); // ç¢ºä¿ Active ç‹€æ…‹çš„æ¨£å¼ç¶­æŒä¸è®Š
            }
        };


        btn.onclick = (e) => {
            e.preventDefault(); 
            
            // æ¸…é™¤æ‰€æœ‰ active ç‹€æ…‹
            container.querySelectorAll('.tag-btn').forEach(b => {
                b.classList.remove('active');
                applyDefaultStyle(b);
            });
            
            // è¨­å®šç•¶å‰ active ç‹€æ…‹
            btn.classList.add('active');
            applyActiveStyle(btn);
        };

        container.appendChild(btn);
    });
}


// ğŸ‘‡ æ•ˆèƒ½å„ªåŒ–å¾Œçš„ renderNotes å‡½æ•¸ (ä½¿ç”¨ DocumentFragment + innerHTML)
function renderNotes(notesArr) {
    if (currentFilter) {
        notesArr = notesArr.filter(n => n.category === currentFilter);
    }
    const listEl = document.getElementById("noteList");
    listEl.innerHTML = ""; // æ¸…ç©ºèˆŠåˆ—è¡¨

    // ğŸŒŸ é—œéµæ•ˆèƒ½å„ªåŒ–ï¼šä½¿ç”¨ DocumentFragment ğŸŒŸ
    const fragment = document.createDocumentFragment();

    // ğŸŸ¢ åˆ†æˆã€Œæœªå®Œæˆã€èˆ‡ã€Œå·²å®Œæˆã€
    const undone = notesArr.filter(n => !n.done_date);
    const done   = notesArr.filter(n => n.done_date);

    // ä¾ç…§ order_index æ’åºæœªå®Œæˆçš„é …ç›®
    undone.sort((a, b) => (a.order_index ?? 99999) - (b.order_index ?? 99999));


    // ğŸŸ£ æ¸²æŸ“(æœªå®Œæˆåœ¨ä¸Š â†’ å·²å®Œæˆåœ¨ä¸‹)
    ([...undone, ...done]).forEach(note => {
        const item = document.createElement("div");
        item.className = "note-item";
        if (note.done_date) item.classList.add("completed"); 
        item.dataset.id = note.id; 

        const isDone = !!note.done_date;
        const doneTagHtml = isDone 
            ? `<span class="done-date">âœ” ${note.done_date}</span>` 
            : '';
            
        // ğŸ”¥ è¨­ç½®èƒŒæ™¯è‰² (background) å’Œæ–‡å­—é¡è‰² (color)
        const bgColor = getCategoryColor(note.category);
        const textColor = getCategoryTextColor(note.category);
        
        const categoryTagHtml = note.category 
            ? `<div class="note-category-tag" style="background:${bgColor}; color: ${textColor};">${note.category}</div>` 
            : '';
        
        // å°‡ note ç‰©ä»¶è½‰æ›ç‚º JSON å­—ä¸²ä¸¦é€²è¡Œ HTML ç·¨ç¢¼
        const noteForCopy = JSON.stringify(note).replace(/"/g, '&quot;');
        
        item.innerHTML = `
            <input type="checkbox" class="note-checkbox" data-note-id="${note.id}" ${isDone ? 'checked' : ''}>
            <div class="note-title">
                <span class="title-text ${isDone ? 'done' : ''}">${truncateTitle(note.title || "(ç„¡æ¨™é¡Œ)")}</span>
                ${doneTagHtml}
            </div>
            ${categoryTagHtml}
            <div class="note-actions">
                <button class="nt-btn icon-btn" title="é»æ“Šé¸æ“‡è¦æ¬ç§»çš„æ—¥æœŸ" onclick="event.stopPropagation(); startMoveMode('${note.id}')">
                    <img src="icon/move.png" alt="move">
                </button>
                <button class="nt-btn icon-btn" title="é»æ“Šé¸æ“‡è¦è¤‡è£½çš„æ—¥æœŸ" onclick="event.stopPropagation(); startCopyMode('${noteForCopy}')">
                    <img src="icon/copy.png" alt="copy">
                </button>
                <button class="nt-btn nt-danger icon-btn" ondblclick="event.stopPropagation(); deleteNote('${note.id}')">
                    <img src="icon/round.png" alt="åˆªé™¤">
                </button>
            </div>
        `;
        
        // é‡æ–°ç¶å®š Checkbox äº‹ä»¶ (å› ç‚ºä½¿ç”¨äº† innerHTMLï¼Œæœƒè¦†è“‹æ‰åŸä¾†çš„ç¶å®š)
        const chk = item.querySelector(".note-checkbox");
        if (chk) {
            // ç”±æ–¼ onClick æ˜¯åœ¨ HTML ä¸­å®šç¾©ï¼Œé€™è£¡ä½¿ç”¨addEventListenerç¢ºä¿äº‹ä»¶ä¸éºå¤±
            chk.addEventListener('click', (ev) => {
                ev.stopPropagation();
                const doneDate = chk.checked ? formatDateTime(new Date()) : null;
                markNoteDone(note.id, doneDate);
            });
        }

        // é‡æ–°ç¶å®š Edit äº‹ä»¶
        const titleEl = item.querySelector(".note-title");
        if(titleEl) {
             titleEl.addEventListener('click', () => openNoteModal(note));
        }

        fragment.appendChild(item);
    });
    
    // ğŸŒŸ ä¸€æ¬¡æ€§å°‡ DocumentFragment å…§å®¹æ’å…¥åˆ° DOM ä¸­ ğŸŒŸ
    listEl.appendChild(fragment);
    
    initSortable(); // æ¯æ¬¡æ¸²æŸ“å®Œé‡æ–°åˆå§‹åŒ– Sortable.js
}


/* =============================    å½ˆçª— (Modal) - ğŸ”¥ é‚è¼¯ä¿®æ”¹å€å¡Š ğŸ”¥ ============================= */
function openNoteModal(note) {
    editingId = note ? note.id : null;

    document.getElementById("noteModalHeader").textContent =
        note ? "ç·¨è¼¯è¨˜äº‹" : "æ–°å¢è¨˜äº‹";

    document.getElementById("noteTitleInput").value = note?.title || "";
    document.getElementById("noteContentInput").value = note?.content || "";
    
    // ğŸ”¥ å‘¼å«æ–°çš„æ¨™ç±¤æ¸²æŸ“å‡½æ•¸ï¼Œä¸¦å¸¶å…¥ç•¶å‰åˆ†é¡
    renderCategoryTags(note?.category || "");


    // ç¢ºä¿å½ˆçª—æ¬„ä½é¡¯ç¤ºï¼ˆæ–°çµæ§‹ï¼‰
    document.querySelectorAll(".modal-field-label").forEach(el => el.style.display = "");
    document.getElementById("noteTitleInput").style.display = "";
    document.getElementById("noteContentInput").style.display = "";
    document.getElementById("noteModalSave").style.display = "";
    
    // é¡¯ç¤ºæ–°çµæ§‹çš„ row å’Œ tags
    document.querySelector(".modal-field-row-new").style.display = "flex"; 
    document.getElementById("noteCategoryTags").style.display = "flex";

    // éš±è—èˆŠçš„ row (é˜²æ­¢æœå°‹çµæœçš„é‚è¼¯éŒ¯èª¤)
    const oldRow = document.querySelector(".modal-field-row");
    if (oldRow) oldRow.style.display = "none";
    
    const sr = document.getElementById("searchResultArea");
    if (sr) sr.remove(); // ç¢ºä¿æ¸…é™¤æœå°‹è¡¨æ ¼

    document.getElementById("noteModal").style.display = "flex";
}


function closeNoteModal() {
    document.getElementById("noteModal").style.display = "none";
}

async function handleSaveNote() {
    const title = document.getElementById("noteTitleInput").value.trim();
    const content = document.getElementById("noteContentInput").value.trim();
    
    // ğŸ”¥ æ›¿æ›ï¼šå¾æ¨™ç±¤æŒ‰éˆ•ä¸­ç²å–é¸ä¸­çš„ category
    const activeTag = document.querySelector("#noteCategoryTags .active");
    const category = activeTag ? activeTag.dataset.category : "";

    const dateStr = getCurrentDateStr();

    if (!title && !content) return closeNoteModal();

    const noteData = { 
        date: dateStr, 
        title, 
        content, 
        category,
        done_date: null // æ–°å¢æˆ–ç·¨è¼¯æ™‚ï¼Œé è¨­ç‚ºæœªå®Œæˆ
    };

    if (!editingId) {
        await saveNoteToDB(noteData);
    } else {
        // å¾å¿«å–ä¸­æ‰¾åˆ°èˆŠè¨˜äº‹ï¼Œä¿ç•™ order_index
        const oldNote = allUserNotesCache.find(n => n.id === editingId);
        if (oldNote) {
            noteData.done_date = oldNote.done_date || null; // ä¿ç•™å®Œæˆç‹€æ…‹
            noteData.order_index = oldNote.order_index;
            await saveNoteToDB(noteData, editingId);
        }
    }
    closeNoteModal();
}


/* =============================    æœˆæ›†ç›¸é—œ (ç„¡è®Šæ›´) ============================= */
function renderCalendar() {
    const grid = document.getElementById("calendarGrid");
    grid.innerHTML = "";

    const year = calendarMonth.getFullYear();
    const month = calendarMonth.getMonth();
    document.getElementById("calTitle").textContent = `${year} å¹´ ${month + 1} æœˆ`;

    const firstDay = new Date(year, month, 1);
    const firstWeekday = firstDay.getDay();
    const nextMonthFirst = new Date(year, month + 1, 1);
    const daysInMonth = new Date(nextMonthFirst - 1).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();

    const selectedDateStr = getCurrentDateStr();
    const todayStr = formatDate(new Date());

    for (let i = 0; i < 42; i++) {
        const cell = document.createElement("div");
        cell.className = "calendar-cell";
        const inner = document.createElement("div");
        inner.className = "calendar-cell-inner";

        let dateNum, offset;
        if (i < firstWeekday) {
            dateNum = daysInPrevMonth - firstWeekday + 1 + i;
            offset = -1;
            cell.classList.add("other-month");
        } else if (i >= firstWeekday + daysInMonth) {
            dateNum = i - (firstWeekday + daysInMonth) + 1;
            offset = 1;
            cell.classList.add("other-month");
        } else {
            dateNum = i - firstWeekday + 1;
            offset = 0;
        }

        const cellDate = new Date(year, month + offset, dateNum);
        const cellDateStr = formatDate(cellDate);

        inner.textContent = dateNum;
        if (cellDateStr === todayStr) cell.classList.add("today");
        
        // æª¢æŸ¥æ˜¯å¦æœ‰è¨˜äº‹
        if (noteDateSet.has(cellDateStr)) {
            cell.classList.add("has-note");
            // æª¢æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆè¨˜äº‹ (ç‚ºäº†é¡¯ç¤ºé»é»)
            const hasUndone = allUserNotesCache.some(n => n.date === cellDateStr && !n.done_date);
            if (hasUndone) {
                inner.innerHTML += '<div class="calendar-dot"></div>';
            }
        }
        
        if (cellDateStr === selectedDateStr) cell.classList.add("selected");

        cell.dataset.date = cellDateStr;
        cell.onclick = () => {
            setCurrentDateStr(cellDateStr);
            loadNotesForCurrentDate();
            closeCalendarModal();
        };

        cell.appendChild(inner);
        grid.appendChild(cell);
    }
}

function openCalendarModal() {
    document.getElementById("calendarModal").style.display = "flex";
    renderCalendar();
}
function closeCalendarModal() {
    document.getElementById("calendarModal").style.display = "none";
}
function shiftCalendarMonth(offset) {
    calendarMonth.setMonth(calendarMonth.getMonth() + offset);
    renderCalendar();
}

/* =============================    onload å…¨æµç¨‹å•Ÿå‹• (æ›´æ–°å½ˆçª—é—œé–‰é‚è¼¯) ============================= */
window.onload = () => {
    // åˆ†é¡æŒ‰éˆ•äº‹ä»¶
    document.querySelectorAll("#filterBar button").forEach(btn => {
        btn.onclick = () => {
            currentFilter = btn.dataset.filter; // "" / ç§äºº / å·¥ä½œ

            // æ¨™è¨˜ active
            document.querySelectorAll("#filterBar button")
                .forEach(b => b.classList.remove("active"));
            btn.classList.add("active");

            loadNotesForCurrentDate(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        };
    });
    
    // æœˆæ›†èˆ‡è¨˜äº‹å½ˆçª—
    document.getElementById("dateBar").onclick = openCalendarModal;
    document.getElementById("calPrev").onclick = () => shiftCalendarMonth(-1);
    document.getElementById("calNext").onclick = () => shiftCalendarMonth(1);
    document.getElementById("btnAdd").onclick = () => openNoteModal(null);
    document.getElementById("noteModalCancel").onclick = closeNoteModal;
    document.getElementById("noteModalSave").onclick = handleSaveNote;
    
    // æ—¥æœŸåˆ‡æ›
    document.getElementById("btnPrevDay").onclick = (e) => {
        e.stopPropagation();
        const cur = new Date(getCurrentDateStr());
        cur.setDate(cur.getDate() - 1);
        setCurrentDateStr(formatDate(cur));
        loadNotesForCurrentDate();
    };

    document.getElementById("btnNextDay").onclick = (e) => {
        e.stopPropagation();
        const cur = new Date(getCurrentDateStr());
        cur.setDate(cur.getDate() + 1);
        setCurrentDateStr(formatDate(cur));
        loadNotesForCurrentDate();
    };  
    
    document.getElementById("btnToday").onclick = (ev) => {
        ev.stopPropagation();          // â† é˜²æ­¢é–‹æœˆæ›†ï¼ï¼
        const today = formatDate(new Date());
        setCurrentDateStr(today);
        loadNotesForCurrentDate();      // â† ç›´æ¥æ›´æ–°åˆ—è¡¨
    };
    
    // é»å½ˆçª—å¤–é—œé–‰
    ["noteModal", "calendarModal"].forEach(id => {
        const modal = document.getElementById(id);
        if (modal) {
            modal.addEventListener("click", (ev) => {
                if (ev.target === modal) {
                    // å¦‚æœæ­¤æ™‚æœ‰æœå°‹è¡¨æ ¼ï¼Œè¦æ¢å¾©åŸæ¨£ï¼
                    const sr = document.getElementById("searchResultArea");
                    if (sr) sr.remove();

                    // æ¢å¾©æ­£å¸¸çš„ç·¨è¼¯è¡¨å–®é¡¯ç¤º (æ–°çµæ§‹)
                    document.querySelectorAll(".modal-field-label").forEach(el => el.style.display = "");
                    document.querySelector(".modal-field-row-new").style.display = "flex";
                    document.getElementById("noteTitleInput").style.display = "";
                    document.getElementById("noteContentInput").style.display = "";
                    document.getElementById("noteModalSave").style.display = "";
                    document.getElementById("noteCategoryTags").style.display = "flex";
                    // ç¢ºä¿èˆŠçš„ row éš±è—
                    const oldRow = document.querySelector(".modal-field-row");
                    if (oldRow) oldRow.style.display = "none";

                    modal.style.display = "none";
                }
            });
        }
    });
};


/* =============================    ç´” JavaScript æœå°‹åŠŸèƒ½ (ä½¿ç”¨æœ¬åœ°å¿«å–) - ğŸ”¥ é‚è¼¯ä¿®æ”¹å€å¡Š ğŸ”¥ ============================= */
document.getElementById("btnSearch").onclick = async () => {
    if (!currentUserID) return alert("è«‹å…ˆç™»å…¥");
    const kw = prompt("è«‹è¼¸å…¥æœå°‹é—œéµå­—ï¼š");
    if (!kw) return;

    // ä½¿ç”¨æœ€æ–°çš„å¿«å–è³‡æ–™
    const notes = allUserNotesCache;
    const keyword = kw.toLowerCase(); // è½‰ç‚ºå°å¯«ä»¥å¯¦ç¾ä¸å€åˆ†å¤§å°å¯«çš„æœå°‹
    
    // 1. ç›´æ¥åœ¨æœ¬åœ°å¿«å–é™£åˆ—ä¸Šé€²è¡Œéæ¿¾
    const searchResults = notes.filter(note => {
        const title = (note.title || "").toLowerCase();
        const content = (note.content || "").toLowerCase();
        
        // åˆ¤æ–·æ¨™é¡Œæˆ–å…§å®¹æ˜¯å¦åŒ…å«é—œéµå­—
        return title.includes(keyword) || content.includes(keyword);
    });

    if (searchResults.length === 0) return alert("æŸ¥ç„¡è³‡æ–™ï¼");

    // 2. è½‰æ›çµæœæ ¼å¼ä»¥åŒ¹é… showSearchResults é æœŸçš„é™£åˆ—çµæ§‹
    // é€™è£¡æˆ‘å€‘å°‡ç‰©ä»¶è½‰æ›å›é¡ä¼¼ SQLite.exec() è¼¸å‡ºçš„äºŒç¶­é™£åˆ—æ ¼å¼
    const rows = searchResults.map(n => [
        n.id, 
        n.date, 
        n.title, 
        n.content, 
        n.done_date 
    ]);
    

    showSearchResults(rows);
};

//é€™æ”¯ functionï¼šé¡¯ç¤ºæœå°‹çµæœåœ¨åŸæœ¬çš„ modal è£¡
function showSearchResults(rows) {
    const modal = document.getElementById("noteModal");
    modal.style.display = "flex";

    // â­ ä¿®æ­£é»ï¼šåœ¨æ’å…¥æ–°çš„æœå°‹è¡¨æ ¼å‰ï¼Œå…ˆç§»é™¤èˆŠçš„ â­
    const existingArea = document.getElementById("searchResultArea");
    if (existingArea) {
        existingArea.remove();
    }
    // â­ ä¿®æ­£é»çµæŸ â­

    // é¡¯ç¤ºæ¨™é¡Œ
    document.getElementById("noteModalHeader").textContent = `æœå°‹çµæœï¼ˆ${rows.length}ç­†ï¼‰`;

    // éš±è—åŸæœ¬è¼¸å…¥æ¬„ä½ (æ–°çµæ§‹)
    document.querySelectorAll(".modal-field-label").forEach(el => el.style.display = "none");
    document.getElementById("noteTitleInput").style.display = "none";
    document.getElementById("noteContentInput").style.display = "none";
    document.getElementById("noteModalSave").style.display = "none";
    
    // ğŸ”¥ éš±è—æ–°çµæ§‹çš„ row å’Œ tags
    document.querySelector(".modal-field-row-new").style.display = "none"; 
    document.getElementById("noteCategoryTags").style.display = "none";


    // ä¸­é–“æ’å…¥è¡¨æ ¼ï¼ˆä¸ç ´å£ footerï¼‰
    const tempArea = document.createElement("div");
    tempArea.id = "searchResultArea";
    tempArea.style.maxHeight = "60vh";
    tempArea.style.overflowY = "auto";
    
    // â­ è¡¨æ ¼è¨­è¨ˆèˆ‡æ¬„ä½èª¿æ•´ (ä¿æŒä¸è®Š) â­
    tempArea.innerHTML = `
        <style>
            .search-table {
                width:100%; 
                border-collapse:separate; 
                border-spacing: 0 8px; 
            }
            .search-table th {
                font-weight: bold;
                color: #A0AEC0; 
                padding: 12px 15px;
                text-align: left;
                border-bottom: 2px solid #E2E8F0;
                position: sticky; 
                top: 0;
                background-color: #fff; 
                z-index: 10;
            }
            .search-row {
                cursor: pointer;
                background-color: #F7FAFC; 
                transition: background-color 0.2s;
                border-radius: 8px;
                overflow: hidden; 
            }
            .search-row:hover {
                background-color: #EDF2F7; 
            }
            .search-row td {
                padding: 10px 15px;
                border-top: 1px solid #E2E8F0;
            }
            .search-row:first-child td {
                border-top: none;
            }
            .search-row.completed-row {
                opacity: 0.6;
            }
            .search-title {
                font-weight: 500;
            }
            .search-date {
                font-size: 0.9em;
                color: #4A5568;
            }
            .search-done {
                color: #38A169; 
                font-weight: bold;
                text-align: center;
            }
        </style>
        <table class="search-table">
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>æ¨™é¡Œ</th>
                    <th style="width: 50px; text-align: center;">å®Œæˆ</th>
                </tr>
            </thead>
            <tbody>
                ${rows.map(r => {
                    const id = r[0]; // ID åœ¨ç´¢å¼• 0
                    const date = r[1]; // æ—¥æœŸåœ¨ç´¢å¼• 1
                    const title = r[2] || '(ç„¡æ¨™é¡Œ)'; // æ¨™é¡Œåœ¨ç´¢å¼• 2
                    const isDone = r[4]; // å®Œæˆç‹€æ…‹åœ¨ç´¢å¼• 4
                    
                    return `
                        <tr class="search-row ${isDone ? 'completed-row' : ''}" data-id="${id}">
                            <td class="search-date">${date}</td>
                            <td class="search-title">${truncateTitle(title)}</td>
                            <td class="search-done">${isDone ? 'âœ”' : ''}</td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;

    // æ’å…¥åœ¨æŒ‰éˆ•å€ä¸Šæ–¹
    const modalContent = document.querySelector(".modal-content");
    const modalFooter = document.querySelector(".modal-footer");
    modalContent.insertBefore(tempArea, modalFooter);

    // é»è¡¨æ ¼ â†’ é–‹åŸæœ¬ç·¨è¼¯æ¨¡å¼
    document.querySelectorAll(".search-row").forEach(tr => {
        tr.onclick = () => {
            const id = tr.dataset.id;
            openEditFromSearch(id);
        };
    });
}

//é»æœå°‹çµæœ â†’ ç”¨åŸæœ¬ modal ç·¨è¼¯è¨˜äº‹
function openEditFromSearch(id) {
    const note = allUserNotesCache.find(n => n.id === id);
    if (note) {

        // ğŸ‘‰ å…ˆæ¸…é™¤æœå°‹è¡¨æ ¼
        const sr = document.getElementById("searchResultArea");
        if (sr) sr.remove();

        // âœ¨ é‡æ–°é¡¯ç¤ºè¼¸å…¥æ¬„ä½ (æ–°çµæ§‹)
        document.querySelectorAll(".modal-field-label").forEach(el => el.style.display = "");
        document.querySelector(".modal-field-row-new").style.display = "flex";
        document.getElementById("noteTitleInput").style.display = "";
        document.getElementById("noteContentInput").style.display = "";
        document.getElementById("noteModalSave").style.display = "";
        document.getElementById("noteCategoryTags").style.display = "flex";

        openNoteModal(note);    // â† å†æ‰“é–‹åŸç·¨è¼¯æ¨¡å¼
    }
}


/* =============================    æ‹–æ›³æ’åº (Sortable.js) - ğŸŒŸ å„ªåŒ–é‚è¼¯ ğŸŒŸ 2px solid============================= */
let sortable = null;
function initSortable() {
    const list = document.getElementById("noteList");
    
    // æª¢æŸ¥ä¸¦éŠ·æ¯€èˆŠçš„å¯¦ä¾‹
    if (sortable && typeof sortable.destroy === 'function') sortable.destroy(); 

    // åªæœ‰æœªå®Œæˆçš„å¯ä»¥æ‹–æ›³ (é‚è¼¯ä¸è®Š)
    sortable = new Sortable(list, {
        animation: 150,
        ghostClass: "dragging",
        filter: ".completed",
        preventOnFilter: false,
        handle: ".note-category-tag",
        
        onEnd: async function (evt) { // ğŸŒŸ æ”¹æˆ async ğŸŒŸ
            if (evt.oldIndex === evt.newIndex) return;

            const undoneItems = Array.from(list.children)
                .filter(el => !el.classList.contains("completed"));
            
            // ğŸŒŸ ä½¿ç”¨ Promise.all ç­‰å¾…æ‰€æœ‰ Firestore æ›´æ–°å®Œæˆ ğŸŒŸ
            const updatePromises = undoneItems.map((el, index) => {
                const id = el.dataset.id;
                return saveNoteOrder(id, index); 
            });
            
            // ç­‰å¾…æ‰€æœ‰æ’åºæ›´æ–°å®Œæˆ
            await Promise.all(updatePromises);
            
            // ç¢ºä¿æ‰€æœ‰æ›´æ–°å®Œæˆå¾Œï¼Œæ‰é‡æ–°ç²å–å¿«å–ä¸¦æ¸²æŸ“
            await fetchAllNotesForCache(); 
            loadNotesForCurrentDate();
        }
    });
}

// ==================== é»æ“Šæ¬ç§»/è¤‡è£½æŒ‰éˆ• â†’ é¸æ“‡ä»»æ„æ—¥æœŸ ===================
let targetNoteForMove = null;
let targetNoteForCopy = null;

function removeMoveHint() {
    const hint = document.getElementById("moveHint");
    if (hint) hint.remove();
}

// æ³¨æ„ï¼šé€™è£¡å‚³å…¥çš„ note æ˜¯å­—ä¸² (HTML onlick å‚³éçš„ JSON å­—ä¸²)
function startCopyMode(noteString) {
    try {
        targetNoteForCopy = JSON.parse(noteString.replace(/&quot;/g, '"'));
    } catch (e) {
        console.error("Error parsing note string for copy mode:", e);
        return;
    }
    targetNoteForMove = null;
    removeMoveHint();

    openCalendarModal();

    const hint = document.createElement("div");
    hint.id = "moveHint";
    hint.textContent = "è«‹é¸æ“‡è¦è¤‡è£½åˆ°çš„æ—¥æœŸ";
    hint.style.cssText = `
        position:fixed;top:20px;left:50%;transform:translateX(-50%);
        background:rgba(0,0,0,0.92);color:#fff;padding:12px 22px;
        border-radius:30px;z-index:9999;font-size:15px;pointer-events:none;
        box-shadow:0 4px 20px rgba(0,0,0,0.4);
    `;
    document.body.appendChild(hint);

    const cells = document.querySelectorAll("#calendarGrid .calendar-cell");
    cells.forEach(cell => {
        cell.style.cursor = "copy";
        cell.onclick = async function () {
            const newDate = this.dataset.date;
            const success = await copyNoteToDate(targetNoteForCopy, newDate);
            
            // æ¸…ç†
            targetNoteForCopy = null;
            closeCalendarModal(); 
            removeMoveHint();
            // if(success) alert(`å·²æˆåŠŸè¤‡è£½åˆ° ${newDate}`); // ä¾è¦æ±‚ç§»é™¤å½ˆçª—
            
            if (newDate === getCurrentDateStr()) {
                loadNotesForCurrentDate();
            }
        };
    });
}    

function startMoveMode(noteId) {
    targetNoteForMove = { id: noteId };
    targetNoteForCopy = null;
    removeMoveHint();

    openCalendarModal();

    const hint = document.createElement("div");
    hint.id = "moveHint";
    hint.textContent = "è«‹é¸æ“‡è¦æ¬ç§»çš„æ—¥æœŸ";
    hint.style.cssText = `
        position:fixed;top:20px;left:50%;transform:translateX(-50%);
        background:rgba(0,0,0,0.92);color:#fff;padding:12px 22px;
        border-radius:30px;z-index:9999;font-size:15px;pointer-events:none;
        box-shadow:0 4px 20px rgba(0,0,0,0.4);
    `;
    document.body.appendChild(hint);

    const cells = document.querySelectorAll("#calendarGrid .calendar-cell");
    cells.forEach(cell => {
        cell.style.cursor = "pointer";

        cell.onclick = async function () {
            const newDate = this.dataset.date;
            const success = await moveNoteToDate(targetNoteForMove.id, newDate);
            
            // æ¸…ç†
            targetNoteForMove = null;
            closeCalendarModal();
            removeMoveHint();
            // if(success) alert(`å·²æ¬ç§»åˆ° ${newDate}`); // ä¾è¦æ±‚ç§»é™¤å½ˆçª—
        };
    });
}

// å®Œå…¨æ¥ç®¡é—œé–‰æœˆæ›†ï¼ˆä»»ä½•æ–¹å¼é—œé–‰éƒ½æ¸…ç†ä¹¾æ·¨ï¼Œä¸¦æ¢å¾©æ—¥æ›†åŸæœ¬çš„é»æ“Šè¡Œç‚ºï¼‰
const originalClose = closeCalendarModal;
closeCalendarModal = function () {
    const inMoveOrCopyMode = targetNoteForMove || targetNoteForCopy;

    originalClose(); // åŸ·è¡ŒåŸæœ¬çš„é—œé–‰å‹•ä½œ (éš±è— modal)

    if (inMoveOrCopyMode) {
        targetNoteForMove = null;
        targetNoteForCopy = null;
        removeMoveHint();
        
        // æ¢å¾©æœˆæ›†åŸæœ¬çš„é»æ“Šè¡Œç‚º (é‡æ–°å‘¼å« renderCalendar å³å¯æ¢å¾©)
        renderCalendar();
    }
};
</script>
</body>
</html>