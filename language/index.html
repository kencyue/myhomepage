<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ—…éŠæ—¥æ–‡ï½œå¤šæª” MDï¼ˆé€å­— rubyï¼‹æ¯åˆ—èªé€Ÿï¼‰</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    :root {
      --bg: #f4f7fa;
      --card: #ffffff;
      --line: #d1d5db;
      --ink: #1f2a44;
      --muted: #6b7280;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      background: var(--bg);
      color: var(--ink);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC",
        "Hiragino Kaku Gothic ProN", "Meiryo", Arial, sans-serif;
      line-height: 1.5;
    }

    header {
      max-width: 980px;
      margin: 0 auto 16px;
      padding: 16px;
      background: var(--card);
      border-radius: 12px;
      box-shadow: var(--shadow);
    }

    h1 {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0 0 8px;
      color: var(--ink);
    }

    .hint {
      color: var(--muted);
      font-size: 0.875rem;
      line-height: 1.4;
    }

    .chips {
      max-width: 980px;
      margin: 12px auto;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      background: #e5e7eb;
      color: var(--ink);
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 0.875rem;
      cursor: pointer;
      user-select: none;
      transition: var(--transition);
    }

    .chip:hover {
      background: #d1d5db;
    }

    .chip.active {
      background: var(--accent);
      color: #fff;
    }

    #list {
      max-width: 980px;
      margin: 0 auto;
    }

    .row {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
      margin: 12px 0;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .row:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }

    .top {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .tag {
      font-size: 0.75rem;
      color: #fff;
      background: var(--accent);
      padding: 4px 12px;
      border-radius: 999px;
    }

    .btns {
      margin-left: auto;
      display: flex;
      gap: 8px;
    }

    button.btn {
      border: none;
      background: var(--accent);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    button.btn:hover {
      background: var(--accent-hover);
    }

    .jp {
      font-size: 1.125rem;
      line-height: 2;
      margin-top: 8px;
      word-break: keep-all;
    }

    ruby {
      ruby-position: over;
      ruby-align: center;
    }

    rt {
      font-size: 0.75em;
      color: var(--muted);
      line-height: 1.3;
      letter-spacing: 0.02em;
    }

    .rom {
      font-size: 0.875rem;
      color: var(--muted);
      margin-top: 6px;
      font-style: italic;
    }

    .en,
    .zh {
      font-size: 0.9375rem;
      margin-top: 6px;
      color: var(--ink);
    }

    .rate {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
    }

    .rate label {
      font-size: 0.875rem;
      color: var(--ink);
    }

    .rate input[type="range"] {
      flex: 1;
      min-width: 160px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .rate .val {
      min-width: 48px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      color: var(--ink);
      font-size: 0.875rem;
    }

    .foot {
      max-width: 980px;
      margin: 16px auto 0;
      color: var(--muted);
      font-size: 0.875rem;
      text-align: center;
    }

    @media (max-width: 600px) {
      body {
        padding: 12px;
      }

      header {
        padding: 12px;
      }

      h1 {
        font-size: 1.125rem;
      }

      .chip {
        padding: 6px 12px;
        font-size: 0.8125rem;
      }

      .row {
        padding: 12px;
        margin: 8px 0;
      }

      .jp {
        font-size: 1rem;
      }

      .btns {
        gap: 6px;
      }

      button.btn {
        padding: 6px 10px;
        font-size: 0.8125rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-plane"></i> æ—…éŠæ—¥æ–‡ï¼ˆä¸­ãƒ»æ—¥ã€ˆå«å‡å/ç¾…é¦¬éŸ³ã€‰ãƒ»è‹±ï¼‰</h1>
    <div class="hint">è³‡æ–™åœ¨ <code>md/</code>ï¼›æ¸…å–® <code>md/catalog.md</code>ï¼ˆæ ¼å¼ï¼š<code>æª”å|åˆ†é¡å</code>ï¼‰ã€‚é»æ•´åˆ—æ’­ ğŸ‡¯ğŸ‡µï¼›å³å´å¯æ’­ ğŸ‡¯ğŸ‡µ/ğŸ‡ºğŸ‡¸/ğŸ‡¹ğŸ‡¼ã€‚</div>
  </header>

  <div class="chips" id="chips"></div>
  <main id="list"></main>
  <div class="foot">è‹¥ç„¡è²éŸ³ï¼šè«‹å…ˆåœ¨ç€è¦½å™¨æ‰‹å‹•æ’­æ”¾ä»»æ„éŸ³è¨Šã€æˆ–é—œé–‰éœéŸ³æ¨¡å¼ï¼ˆiOS/Safari éœ€è§£é–è‡ªå‹•æ’­æ”¾ï¼‰ã€‚</div>

<script>
let catalog = [];        // [{file, cat}]
let currentCat = 'å…¨éƒ¨';
let allItems = [];       // ç•¶å‰é¡¯ç¤ºçš„å¥å­
let speakTimer = null;   // é˜²æŠ–
let listHandlersBound = false;

// ---------- åˆå§‹åŒ– ----------
(async function init(){
  try{
    const catTxt = await fetch('md/catalog.md').then(r=>r.text());
    catalog = parseCatalog(catTxt);
    renderChips(catalog);
    await loadAllAndRender();
  }catch(err){
    console.error(err);
    document.getElementById('list').innerHTML =
      `<div style="color:#b91c1c">è®€å– catalog.md å¤±æ•—ï¼š${escapeHtml(String(err))}</div>`;
  }
})();

// ---------- catalog ----------
function parseCatalog(text){
  return text.split(/\r?\n/)
    .map(l=>l.trim())
    .filter(l=>l && !l.startsWith('#'))
    .map(l=>{
      const [f,c] = l.split('|');
      return { file:(f||'').trim(), cat:(c||'').trim() || (f||'').replace(/\.\w+$/,'') };
    })
    .filter(x=>x.file);
}

function renderChips(cats){
  const wrap = document.getElementById('chips');
  wrap.innerHTML = [
    `<div class="chip active" onclick="filterCat('å…¨éƒ¨', this)">å…¨éƒ¨</div>`,
    ...cats.map(c=>`<div class="chip" onclick="filterCat('${escapeAttr(c.cat)}', this)">${escapeHtml(c.cat)}</div>`)
  ].join('');
}

// ---------- è¼‰å…¥ / åˆ‡æ› ----------
async function loadAllAndRender(){
  const results = [];
  for (const c of catalog){
    try{
      const txt = await fetch('md/' + c.file).then(r=>r.text());
      results.push(...parsePhrasesMd(txt, c.cat));
    }catch(err){
      console.warn('è®€å–å¤±æ•—:', c.file, err);
    }
  }
  allItems = results;
  renderList(allItems);
}

async function filterCat(cat, el){
  currentCat = cat;
  document.querySelectorAll('.chip').forEach(n=>n.classList.remove('active'));
  el.classList.add('active');
  if (cat === 'å…¨éƒ¨'){ await loadAllAndRender(); return; }

  const hit = catalog.find(x=>x.cat === cat);
  if (!hit){ document.getElementById('list').innerHTML = `<div>æ‰¾ä¸åˆ°åˆ†é¡ï¼š${escapeHtml(cat)}</div>`; return; }

  try{
    const txt = await fetch('md/' + hit.file).then(r=>r.text());
    allItems = parsePhrasesMd(txt, hit.cat);
    renderList(allItems);
  }catch(err){
    document.getElementById('list').innerHTML =
      `<div style="color:#b91c1c">è®€å– ${escapeHtml(hit.file)} å¤±æ•—ï¼š${escapeHtml(String(err))}</div>`;
  }
}

// ---------- è§£æå–®ä¸€é¡åˆ¥ md ----------
function parsePhrasesMd(md, catName){
  const lines = md.split(/\r?\n/);
  const items = [];
  let cur = null;

  for (const raw of lines){
    const line = raw.trim();
    if (!line) continue;

    if (line.startsWith('- JP:')){
      if (cur) items.push(cur);
      cur = { cat: catName || 'ä¸€èˆ¬', jp: line.replace(/^- JP:\s*/, ''), rom: '', en: '', zh: '' };
      continue;
    }
    if (!cur) continue;

    if (/^ROMAJI[:ï¼š]/i.test(line)) { cur.rom = line.replace(/^ROMAJI[:ï¼š]\s*/i, ''); continue; }
    if (/^EN[:ï¼š]/i.test(line))     { cur.en  = line.replace(/^EN[:ï¼š]\s*/i,     ''); continue; }
    if (/^ZH[:ï¼š]/i.test(line))     { cur.zh  = line.replace(/^ZH[:ï¼š]\s*/i,     ''); continue; }
  }
  if (cur) items.push(cur);
  return items;
}

// ---------- å·¥å…·ï¼šè·³è„« ----------
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

// ---------- ç™¼éŸ³ï¼ˆç´”å‡åã€æ¯åˆ—èªé€Ÿ 0.1â€“1.0ï¼‰ ----------
function speak(text, lang, rate){
  if (!text) return;
  if (speakTimer) clearTimeout(speakTimer);
  speechSynthesis.cancel();
  speakTimer = setTimeout(()=>{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang || 'ja-JP';
    const r = Math.max(0.1, Math.min(1.0, typeof rate === 'number' ? rate : 1.0));
    u.rate = r;
    u.pitch = 1.0;
    speechSynthesis.speak(u);
  }, 150);
}

// ---------- åˆ¤æ–·æ¨™è¨˜æ–¹å‘ä¸¦ä¿®æ­£ï¼ˆæ‡‰ç‚º <æ¼¢å­—|å‡å>ï¼‰ ----------
function fixOrder(kanji, kana) {
  const reKanji = /[\u4E00-\u9FFFã€…ã€†ã€¤]/;
  const reKana  = /[\u3040-\u309F\u30A0-\u30FFãƒ¼]/;
  const leftLooksKanaOnly = !reKanji.test(kanji) && reKana.test(kanji);
  const rightHasKanji     = reKanji.test(kana);
  return (leftLooksKanaOnly && rightHasKanji) ? { kanji: kana, kana: kanji } : { kanji, kana };
}

// ---------- å‡ååˆ†çµ„ï¼ˆæŠŠ ã£/ã‚ƒ/ã‚…/ã‚‡/ã/ãƒ/ã…/ã‡/ã‰/ãƒ¼ ç­‰é»åˆ°å‰ä¸€å€‹ï¼‰ ----------
function splitKanaGroups(kana){
  const small = /[ããƒã…ã‡ã‰ã‚ƒã‚…ã‚‡ã‚¡ã‚£ã‚¥ã‚§ã‚©ãƒ£ãƒ¥ãƒ§ãƒ®ã‚ã£ãƒƒãƒ¼]/;
  const out = [];
  for (const ch of kana){
    if (out.length && small.test(ch)) out[out.length-1] += ch;
    else out.push(ch);
  }
  return out;
}

// ---------- é€å­— ruby ç”¢ç”Ÿå™¨ï¼ˆé•·åº¦ä¸ç­‰åšã€Œåˆç†åˆ†é…ã€ï¼‰ ----------
function interCharRuby(kanji, kana){
  const kChars = Array.from(kanji);
  const groups = splitKanaGroups(kana);

  if (kChars.length === 0 || groups.length === 0) {
    return `<ruby>${escapeHtml(kanji)}<rt>${escapeHtml(kana)}</rt></ruby>`;
  }

  if (groups.length < kChars.length){
    return `<ruby>${escapeHtml(kanji)}<rt>${escapeHtml(kana)}</rt></ruby>`;
  }

  const base = Math.floor(groups.length / kChars.length);
  const rest = groups.length % kChars.length;

  let idx = 0, html = '<ruby>';
  for (let i=0;i<kChars.length;i++){
    const take = base + (i < rest ? 1 : 0);
    const part = groups.slice(idx, idx+take).join('');
    idx += take;
    html += `<rb>${escapeHtml(kChars[i])}</rb><rt>${escapeHtml(part)}</rt>`;
  }
  html += '</ruby>';
  return html;
}

// ---------- é¡¯ç¤ºï¼šæŠŠ <æ¼¢å­—|ã‹ãª> è½‰æˆé€å­— rubyï¼Œä¸¦ä¿®æ­£æ–¹å‘ ----------
function toRubySmart(input){
  if (!input) return '';
  const parts = [];
  const tagRe = /<([^<>|]+)\|([^<>|]+)>/g;
  let last = 0, m;
  while ((m = tagRe.exec(input))){
    if (m.index > last) parts.push({type:'text', value: input.slice(last, m.index)});
    let {kanji, kana} = fixOrder(m[1], m[2]);
    parts.push({type:'tag', kanji, kana});
    last = tagRe.lastIndex;
  }
  if (last < input.length) parts.push({type:'text', value: input.slice(last)});

  return parts.map(p=>{
    if (p.type === 'text') return escapeHtml(p.value);
    return interCharRuby(p.kanji, p.kana);
  }).join('');
}

// ---------- æœ—è®€ï¼šæŠŠ <æ¼¢å­—|å‡å> è½‰ç´”å‡åï¼ˆä¹Ÿåšæ–¹å‘ä¿®æ­£ï¼‰ ----------
function jpSpeakable(s){
  if (!s) return '';
  let t = s.replace(/&lt;([^&<>|]+)\|([^&<>|]+)&gt;/g, (_m, a, b) => fixOrder(a,b).kana);
  t = t.replace(/<([^<>|]+)\|([^<>|]+)>/g, (_m, a, b) => fixOrder(a,b).kana);
  return t.replace(/[<>]/g, '');
}

// ---------- æ¯åˆ—èªé€Ÿæ›´æ–° ----------
function updateRowRate(inputEl){
  const row = inputEl.closest('.row');
  if (!row) return;
  const val = Math.max(0.1, Math.min(1.0, parseFloat(inputEl.value) || 1.0));
  row.dataset.rate = String(val);
  const v = row.querySelector('.rate .val');
  if (v) v.textContent = val.toFixed(1) + 'x';
}

// ---------- æ¸²æŸ“ ----------
function renderList(items){
  const list = document.getElementById('list');
  if (!items.length){
    list.innerHTML = `<div class="row">æ­¤åˆ†é¡æš«ç„¡å¥å­ã€‚</div>`;
    return;
  }
  list.innerHTML = items.map(it => rowHtml(it)).join('');

  if (!listHandlersBound){
    list.addEventListener('pointerdown', e=>{
      if (e.target && e.target.matches('input[type="range"]')) e.stopPropagation();
    }, {capture:true});
    list.addEventListener('click', e=>{
      if (e.target && e.target.matches('input[type="range"]')) e.stopPropagation();
    }, {capture:true});
    listHandlersBound = true;
  }
}

function rowHtml(it){
  const jpRaw = it.jp || '';
  const say    = escapeAttr(jpSpeakable(jpRaw));
  const jpHtml = toRubySmart(jpRaw);
  const initRate = 1.0;

  return `
  <section class="row"
           data-say="${say}"
           data-rate="${initRate}"
           onclick="speak(this.dataset.say, 'ja-JP', parseFloat(this.dataset.rate)||1)">
    <div class="top">
      <span class="tag">${escapeHtml(it.cat || '')}</span>
      <div class="btns">
        <button class="btn" onclick="event.stopPropagation(); speak(this.closest('.row').dataset.say, 'ja-JP', parseFloat(this.closest('.row').dataset.rate)||1)">
          <i class="fas fa-volume-up"></i> ğŸ‡¯ğŸ‡µ
        </button>
        <button class="btn" onclick="event.stopPropagation(); speak(\`${escapeHtml(it.en||'')}\`, 'en-US', parseFloat(this.closest('.row').dataset.rate)||1)">
          <i class="fas fa-volume-up"></i> ğŸ‡ºğŸ‡¸
        </button>
        <button class="btn" onclick="event.stopPropagation(); speak(\`${escapeHtml(it.zh||'')}\`, 'zh-TW', parseFloat(this.closest('.row').dataset.rate)||1)">
          <i class="fas fa-volume-up"></i> ğŸ‡¹ğŸ‡¼
        </button>
      </div>
    </div>
    <div class="jp">${jpHtml}</div>
    <div class="rom">${escapeHtml(it.rom || '')}</div>
    <div class="en">${escapeHtml(it.en || '')}</div>
    <div class="zh">${escapeHtml(it.zh || '')}</div>
    <div class="rate" onclick="event.stopPropagation()">
      <label><i class="fas fa-tachometer-alt"></i> èªé€Ÿ</label>
      <input type="range" min="0.1" max="1" step="0.1" value="${initRate}"
             oninput="event.stopPropagation(); updateRowRate(this)"
             onclick="event.stopPropagation()"
             onpointerdown="event.stopPropagation()"
             ontouchstart="event.stopPropagation()" />
      <span class="val">${initRate.toFixed(1)}x</span>
    </div>
  </section>`;
}
</script>
</body>
</html>