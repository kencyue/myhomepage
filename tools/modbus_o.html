<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Modbus RSâ€‘485 æŒ‡ä»¤ç”¢ç”Ÿå™¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex flex-col items-center">
  <h1 class="text-2xl font-bold mb-4">Modbus RSâ€‘485 æŒ‡ä»¤ç”¢ç”Ÿå™¨(æ¸¬è©¦)</h1>

  <!-- ğŸ“Œ è¨­å®šå€ -->
  <div class="w-full max-w-md bg-white rounded-xl shadow p-4 space-y-4">
    <div class="flex flex-col gap-2">
      <label class="font-medium" for="slave">è£ç½®ä½å€ (Slave ID)</label>
      <input id="slave" type="number" min="1" max="247" value="1" class="border rounded p-2 w-full" />
    </div>

    <div class="flex flex-col gap-2">
      <label class="font-medium" for="fc">åŠŸèƒ½ç¢¼ (Function Code)</label>
      <select id="fc" class="border rounded p-2 w-full">
        <option value="03">03 è®€å–ä¿æŒæš«å­˜å™¨ (Read Holding Registers)</option>
        <option value="06">06 å¯«å…¥å–®æš«å­˜å™¨ (Write Single Register)</option>
      </select>
    </div>

    <div class="flex flex-col gap-2">
      <label class="font-medium" for="reg">å¯„å­˜å™¨ä½å€</label>
      <select id="reg" class="border rounded p-2 w-full">
        <option value="0001">0x0001 é–‹é—œç‹€æ…‹</option>
        <option value="0002">0x0002 é‹è½‰æ¨¡å¼</option>
        <option value="0003">0x0003 é¢¨é‡æ¨¡å¼</option>
        <option value="000D">0x000D OA æ¿ƒåº¦å€¼</option>
        <option value="000E">0x000E æ›æ°£é¢¨é‡ç´šåˆ¥</option>
        <option value="0011">0x0011 å®šæ™‚å•Ÿå‹• (æ™‚)</option>
        <option value="0012">0x0012 å®šæ™‚å•Ÿå‹• (åˆ†)</option>
        <option value="0016">0x0016 æ¯é€±æ’ç¨‹ (æ—¥)</option>
        <option value="0017">0x0017 æ¯é€±æ’ç¨‹ (ä¸€)</option>
        <option value="001A">0x001A å–®å…ƒä½å€è¨­å®š</option>
      </select>
    </div>

    <!-- æ•¸å€¼æˆ–ç­†æ•¸è¼¸å…¥ -->
    <div id="valueBlock" class="flex flex-col gap-2">
      <label class="font-medium" for="value">å¯«å…¥æ•¸å€¼ (åå…­é€²ä½æˆ–åé€²ä½çš†å¯)</label>
      <input id="value" type="text" placeholder="ä¾‹å¦‚ 0x01 æˆ– 1" class="border rounded p-2 w-full" />
    </div>

    <div id="quantityBlock" class="hidden flex flex-col gap-2">
      <label class="font-medium" for="qty">è®€å–ç­†æ•¸ (Quantity)</label>
      <input id="qty" type="number" min="1" max="125" value="1" class="border rounded p-2 w-full" />
    </div>

    <button id="gen" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded p-2">ç”¢ç”ŸæŒ‡ä»¤</button>
  </div>

  <!-- ğŸ“‹ è¼¸å‡ºå€ -->
  <div class="w-full max-w-md mt-6">
    <label class="font-medium">è¼¸å‡º (HEX å­—ä¸²)ï¼š</label>
    <textarea id="output" rows="3" readonly class="border rounded p-2 w-full mt-2 font-mono"></textarea>
  </div>

<script>
// CRCâ€‘16/Modbus (poly 0xA001, init 0xFFFF)
function crc16(buf) {
  let crc = 0xFFFF;
  for (let b of buf) {
    crc ^= b;
    for (let i = 0; i < 8; i++) {
      const carry = crc & 0x0001;
      crc >>= 1;
      if (carry) crc ^= 0xA001;
    }
  }
  return crc;
}

function hex(n, len = 2) {
  return n.toString(16).toUpperCase().padStart(len, '0');
}

function generate() {
  const slave = parseInt(document.getElementById('slave').value);
  const fc    = parseInt(document.getElementById('fc').value, 10);
  const reg   = parseInt(document.getElementById('reg').value, 16);

  let frame = [slave, fc, reg >> 8, reg & 0xFF];

  if (fc === 3) { // è®€å–ä¿æŒæš«å­˜å™¨
    const qty = parseInt(document.getElementById('qty').value);
    frame.push(qty >> 8, qty & 0xFF);
  } else if (fc === 6) { // å¯«å…¥å–®æš«å­˜å™¨
    let valRaw = document.getElementById('value').value.trim();
    if (valRaw.startsWith('0x') || valRaw.startsWith('0X')) {
      valRaw = parseInt(valRaw, 16);
    } else {
      valRaw = parseInt(valRaw, 10);
    }
    frame.push(valRaw >> 8, valRaw & 0xFF);
  }

  const crc = crc16(frame);
  frame.push(crc & 0xFF, crc >> 8); // ä½ä½åœ¨å‰

  const out = frame.map(b => hex(b)).join(' ');
  document.getElementById('output').value = out;
}

document.getElementById('gen').addEventListener('click', generate);

// åˆ‡æ›è¼¸å…¥å€é¡¯ç¤º
function toggleInput() {
  const fc = parseInt(document.getElementById('fc').value, 10);
  if (fc === 3) {
    document.getElementById('quantityBlock').classList.remove('hidden');
    document.getElementById('valueBlock').classList.add('hidden');
  } else {
    document.getElementById('quantityBlock').classList.add('hidden');
    document.getElementById('valueBlock').classList.remove('hidden');
  }
}

document.getElementById('fc').addEventListener('change', toggleInput);
// åˆå§‹ç‹€æ…‹
toggleInput();
</script>
</body>
</html>
