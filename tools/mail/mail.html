<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“§ Panasonic è¯çµ¡ä¿¡ç®±å¿«é€Ÿè¤‡è£½ (æœ€çµ‚ç©©å®šç‰ˆ)</title>
<style>
/* ... CSS æ¨£å¼èˆ‡å‰ä¸€ç‰ˆæœ¬ä¿æŒä¸€è‡´ ... */
body {
    font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
    background: #eef2f5;
    margin: 0; padding: 20px;
    color: #333;
}

h2 {
    text-align: center;
    margin-bottom: 14px;
    font-size: 1.3rem;
}

#tableWrapper {
    max-width: 1000px;
    margin: 0 auto;
}

/* =====================================
    â˜… é ç±¤æ¨£å¼ (Tabs)
===================================== */
.tab-container {
    max-width: 1000px;
    margin: 0 auto 10px;
    background-color: white;
    box-shadow: 0 2px 4px rgba(0,0,0,.1);
}

.tab-buttons {
    display: flex;
    border-bottom: 1px solid #ccc;
}

.tab-button {
    background-color: #f1f1f1;
    border: none;
    outline: none;
    cursor: pointer;
    padding: 10px 20px;
    transition: 0.3s;
    font-size: 1rem;
    color: #555;
}

.tab-button:hover {
    background-color: #ddd;
}

.tab-button.active {
    background-color: white;
    border-top: 3px solid #0078d7;
    border-bottom: none;
    font-weight: bold;
    color: #0078d7;
}

/* å…§å®¹å€å¡Š */
.tab-content {
    display: none;
    padding: 10px 0;
}

.tab-content.active {
    display: block;
}

/* =====================================
    è¶…è–„ç‰ˆ Tableï¼ˆä¸æ²è»¸ï¼‰
===================================== */
table {
    border-collapse: collapse;
    width: 100%;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,.15);
    font-size: 18px;
}

th, td {
    border: 1px solid #ccc;
    padding: 2px 4px;
    height: 22px;
    white-space: nowrap;
    text-align: center;
    user-select: none;
    cursor: default;
}

th {
    background: #0078d7;
    color: #fff;
    font-size: 13px;
    padding: 6px 4px;
    cursor: pointer;
}
th:hover { background: #005ea6; }

/* =====================================
    td æ•´æ ¼ã€ŒæŒ‰éˆ•åŒ–ã€
===================================== */
td {
    background: #f8f9fc;
    transition: 0.15s;
}

/* å¯é»æ“Šé¸å–å¤šé …çš„æ¬„ä½ (å–®ä½, éƒ¨é–€, å€åŸŸ) */
td[data-unit], td[data-dept], td[data-area] {
    cursor: pointer;
    background: #f1f1f1;
}
td[data-unit]:hover, td[data-dept]:hover, td[data-area]:hover {
    background: #e0f0ff;
}

/* å¯é»æ“Šé¸å–å–®é …çš„æ¬„ä½ (äººå/mail) */
td[data-mail] {
    cursor: pointer;
    background: #f8f9fc;
}
td[data-mail]:hover {
    background: #e4efff;
}

/* ä¸å¯é»æ“Šæ¬„ä½ (åˆ†æ©Ÿ, æˆ–ç„¡æ•¸æ“šçš„æ ¼å­) */
td:not([data-mail]):not([data-unit]):not([data-dept]):not([data-area]) {
    cursor: default;
    background: #f1f1f1;
}

td.selected {
    background: #0078d7 !important;
    color: white !important;
    font-weight: bold;
    box-shadow: inset 0 0 3px rgba(0,0,0,0.2);
}

/* =====================================
    ç‹€æ…‹åˆ—
===================================== */
.status {
    text-align: center;
    margin-top: 10px;
    color: #0078d7;
    font-size: 13px;
    min-height: 1.2em;
}
</style>
</head>
<body>

<h2>ğŸ“§ Panasonic è¯çµ¡ä¿¡ç®±å¿«é€Ÿè¤‡è£½</h2>

<div class="tab-container">
    <div class="tab-buttons">
        <button class="tab-button active" onclick="openTab('station', this)">æœå‹™ç«™</button>
        <button class="tab-button" onclick="openTab('domain', this)">æœå‹™æœ¬éƒ¨</button>
        <button class="tab-button" onclick="openTab('ptw', this)">PTW</button>
    </div>

    <div id="station" class="tab-content active">
        <div id="tableWrapper">
            <table class="mailTable" data-json="cs_station.json" data-type="station"></table>
        </div>
        <div class="status">ï¼ˆæœªé¸å–ï¼‰</div>
    </div>

    <div id="domain" class="tab-content">
        <div id="tableWrapper">
            <table class="mailTable" data-json="cs_domain.json" data-type="domain"></table>
        </div>
        <div class="status">ï¼ˆæœªé¸å–ï¼‰</div>
    </div>

    <div id="ptw" class="tab-content">
        <div id="tableWrapper">
            <table class="mailTable" data-json="PTW.json" data-type="ptw"></table>
        </div>
        <div class="status">ï¼ˆæœªé¸å–ï¼‰</div>
    </div>
</div>


<script type="module">
let selectedMailsMap = new Map();

document.addEventListener("DOMContentLoaded", () => {
    loadTabContent('station');
});

// =====================================
// â˜… é ç±¤åˆ‡æ›é‚è¼¯
// =====================================
window.openTab = function(tabId, buttonElement) {
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });

    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });

    document.getElementById(tabId).classList.add('active');
    buttonElement.classList.add('active');

    loadTabContent(tabId);
}

function loadTabContent(tabId) {
    const tabContent = document.getElementById(tabId);
    const table = tabContent.querySelector('.mailTable');

    if (table.rows.length > 0) {
        return;
    }

    const jsonFile = table.dataset.json;
    const tableType = table.dataset.type;

    selectedMailsMap.set(tabId, new Set());

    table.addEventListener("click", e => {
        const td = e.target.closest("td");
        const th = e.target.closest("th");

        // å„ªå…ˆè™•ç† TH (è¡¨é ­)
        if (th && th.dataset.role) {
            handleHeader(th.dataset.role, table, tabId);
            return;
        }
        
        // è™•ç† TD (è¡¨æ ¼å…§å®¹)
        if (!td) return;
        
        // å„ªå…ˆç´š 1: é»æ“Šäººåå–®å…ƒæ ¼ (æœ€ç²¾ç¢ºçš„é»æ“Š)
        if (td.dataset.mail) {
             handleCellClick(td, tabId); 
        } 
        // å„ªå…ˆç´š 2: é»æ“Šéƒ¨é–€å–®å…ƒæ ¼ (åƒ…é©ç”¨æ–¼éƒ¨é–€åˆ—ï¼Œäººåå„²å­˜æ ¼å·²è¢«ä¸Šä¸€å€‹æ¢ä»¶æ’é™¤)
        else if (td.dataset.dept && tableType !== "station") {
            handleDeptClick(td, tabId); 
        } 
        // å„ªå…ˆç´š 3: é»æ“Šå–®ä½/å€åŸŸå–®å…ƒæ ¼ (æœ€å¯¬æ³›çš„é»æ“Š)
        else if (td.dataset.area) { 
            if (tableType === "station") {
                handleAreaClick(td, tabId); 
            } else {
                handleUnitClick(td, tabId); 
            }
        }
    });

    loadMails(table, jsonFile, tableType, tabId);
}

// =====================================
// â˜… è¼‰å…¥è³‡æ–™ä¸¦å»ºç«‹è¡¨æ ¼
// =====================================
async function loadMails(table, jsonFile, tableType, tabId) {
    let data = [];
    try {
        const res = await fetch(jsonFile);
        if (!res.ok) {
            throw new Error(`Failed to load ${jsonFile}: ${res.statusText}`);
        }
        data = await res.json();
    } catch (error) {
        const statusElement = document.getElementById(tabId).querySelector(".status");
        statusElement.textContent = `âŒ è³‡æ–™è¼‰å…¥å¤±æ•—: ${error.message}`;
        console.error("Fetch error:", error);
        return;
    }

    if (!data.length) return;

    const headerRow = document.createElement("tr");

    let columns;
    let mainColumnKey;
    let roles;

    if (tableType === "station") {
        columns = ["å€åŸŸ", "è™•é•·", "ç¶“ç†", "ç«™é•·"];
        mainColumnKey = "å€åŸŸ";
        roles = { "å€åŸŸ": "ALL", "è™•é•·": "è™•é•·", "ç¶“ç†": "ç¶“ç†", "ç«™é•·": "ç«™é•·" };
    } else { // domain æˆ– ptw
        columns = ["å–®ä½", "éƒ¨é–€", "äººå", "åˆ†æ©Ÿ"];
        mainColumnKey = "å–®ä½";
        roles = { "å–®ä½": "ALL", "éƒ¨é–€": "", "äººå": "äººå", "åˆ†æ©Ÿ": "" };
    }

    columns.forEach(col => {
        const th = document.createElement("th");
        th.textContent = col;
        th.dataset.role = roles[col] || ""; 
        headerRow.appendChild(th);
    });
    table.appendChild(headerRow);


    data.forEach(row => {
        const tr = document.createElement("tr");

        const mainCell = document.createElement("td");
        mainCell.textContent = row[mainColumnKey];
        mainCell.dataset.area = row[mainColumnKey]; 
        
        if (tableType !== "station" && row[mainColumnKey]) {
            mainCell.dataset.unit = row[mainColumnKey];
        }
        tr.appendChild(mainCell);

        columns.slice(1).forEach(colName => {
            const cellData = row[colName];
            const td = document.createElement("td");

            if (tableType === "station") {
                if (cellData && cellData.mail) {
                    td.dataset.mail = cellData.mail.trim();
                    td.textContent = cellData.name || "";
                    td.dataset.role = colName; 
                } else {
                    td.textContent = "";
                }
            } else { 
                if (colName === "éƒ¨é–€") {
                    td.textContent = cellData || "";
                    if (cellData) {
                       td.dataset.dept = cellData;
                       if (row["å–®ä½"]) td.dataset.unit = row["å–®ä½"];
                    }
                } else if (colName === "äººå") {
                    if (cellData && cellData.mail) {
                        td.dataset.mail = cellData.mail.trim();
                        td.textContent = cellData.name || "";
                        if (row["å–®ä½"]) td.dataset.unit = row["å–®ä½"];
                        if (row["éƒ¨é–€"]) td.dataset.dept = row["éƒ¨é–€"];
                    } else {
                        td.textContent = "";
                    }
                } else if (colName === "åˆ†æ©Ÿ") {
                    const nameData = row["äººå"];
                    td.textContent = (nameData && nameData.ext) || "";
                }
            }
            tr.appendChild(td);
        });

        table.appendChild(tr);
    });
}


// =====================================
// â˜… æ ¸å¿ƒé¸å–é‚è¼¯ (åªå½±éŸ¿ selectedMails é›†åˆ)
// =====================================

function toggleSelect(td, select, selectedMails) {
    const mail = td.dataset.mail;
    if (!mail) return;

    if (select) {
        td.classList.add("selected");
        selectedMails.add(mail);
    } else {
        td.classList.remove("selected");
        selectedMails.delete(mail);
    }
}

// =====================================
// â˜… è¦–è¦ºåŒæ­¥å·¥å…·å‡½å¼ (åªå½±éŸ¿ classList)
// =====================================

function syncVisualState(table, selectedMails) {
    // åŒæ­¥æ‰€æœ‰å–®ä½å’Œéƒ¨é–€æ ¼çš„è¦–è¦ºç‹€æ…‹
    table.querySelectorAll('td[data-unit], td[data-dept]').forEach(cell => {
        const unitValue = cell.dataset.unit;
        const deptValue = cell.dataset.dept;
        let mailCells;
        
        if (unitValue) {
            mailCells = Array.from(table.querySelectorAll(`td[data-mail][data-unit="${unitValue}"]`));
        } else if (deptValue) {
            mailCells = Array.from(table.querySelectorAll(`td[data-mail][data-dept="${deptValue}"]`));
        } else {
            return;
        }

        if (mailCells.length > 0) {
            const allSelected = mailCells.every(c => c.classList.contains("selected"));
            cell.classList.toggle("selected", allSelected);
        }
    });

    // é¡å¤–è™•ç†æœå‹™ç«™çš„ Area è¦–è¦ºç‹€æ…‹
    const tableType = table.dataset.type;
    if (tableType === "station") {
        table.querySelectorAll('td[data-area]').forEach(cell => {
            const tr = cell.parentElement;
            const mailCells = Array.from(tr.querySelectorAll("td[data-mail]"));
            if (mailCells.length > 0) {
                const allSelected = mailCells.every(c => c.classList.contains("selected"));
                cell.classList.toggle("selected", allSelected);
            }
        });
    }
}


// =====================================
// â˜… é»æ“Šè™•ç†å‡½å¼
// =====================================

/** è™•ç†é»æ“Šã€Œå€åŸŸã€æ¬„ä½ (æœå‹™ç«™å°ˆç”¨ï¼šé¸å–å–®åˆ—æ‰€æœ‰éƒµä»¶) */
function handleAreaClick(td, tabId) {
    const selectedMails = selectedMailsMap.get(tabId);
    const tr = td.parentElement;
    const mailCells = Array.from(tr.querySelectorAll("td[data-mail]"));
    const allSelected = mailCells.every(c => c.classList.contains("selected"));

    mailCells.forEach(cell => {
        toggleSelect(cell, !allSelected, selectedMails);
    });
    
    // è¦–è¦ºåŒæ­¥
    td.classList.toggle("selected", !allSelected);

    copyMails(tabId);
}

/** è™•ç†é»æ“Šã€Œå–®ä½ã€æ¬„ä½ (æœå‹™æœ¬éƒ¨/PTWï¼šé¸å–æ‰€æœ‰ç›¸åŒå–®ä½çš„éƒµä»¶) */
function handleUnitClick(td, tabId) {
    const selectedMails = selectedMailsMap.get(tabId);
    const table = td.closest('table');
    const unitValue = td.dataset.unit;

    if (!unitValue) return;

    const unitMailCells = Array.from(table.querySelectorAll(`td[data-mail][data-unit="${unitValue}"]`));
    const allSelected = unitMailCells.every(c => c.classList.contains("selected"));

    unitMailCells.forEach(cell => {
        toggleSelect(cell, !allSelected, selectedMails);
    });

    // è¦–è¦ºåŒæ­¥
    syncVisualState(table, selectedMails);
    
    copyMails(tabId);
}


/** è™•ç†é»æ“Šã€Œéƒ¨é–€ã€æ¬„ä½ (åŒéƒ¨é–€å…¨é¸/åé¸) */
function handleDeptClick(td, tabId) {
    const selectedMails = selectedMailsMap.get(tabId);
    const table = td.closest('table');
    const deptValue = td.dataset.dept;

    if (!deptValue) return;

    const deptMailCells = Array.from(table.querySelectorAll(`td[data-mail][data-dept="${deptValue}"]`));
    const allSelected = deptMailCells.every(c => c.classList.contains("selected"));

    deptMailCells.forEach(cell => {
        toggleSelect(cell, !allSelected, selectedMails);
    });

    // è¦–è¦ºåŒæ­¥
    syncVisualState(table, selectedMails);

    copyMails(tabId);
}

/** â˜… è™•ç†é»æ“Šã€Œäººåã€æ¬„ä½ (åªé¸å–å–®æ ¼) - çµ‚æ¥µéš”é›¢ç‰ˆæœ¬ */
function handleCellClick(td, tabId) {
    const selectedMails = selectedMailsMap.get(tabId);
    const mail = td.dataset.mail;

    if (!mail) return;

    const isSelecting = !td.classList.contains("selected");
    
    // 1. éš”é›¢ï¼šåªé‡å°è¢«é»æ“Šçš„ TD åŸ·è¡Œé¸å–/åé¸æ“ä½œ
    //    é€™ä¸æœƒå½±éŸ¿ä»»ä½•å…¶ä»– TD çš„ selectedMails ç‹€æ…‹
    toggleSelect(td, isSelecting, selectedMails);

    // 2. [é‡è¦] ç§»é™¤æ‰€æœ‰è¦–è¦ºåŒæ­¥é‚è¼¯
    //    æˆ‘å€‘å°‡å–®ä½/éƒ¨é–€çš„è¦–è¦ºç‹€æ…‹æ›´æ–°ï¼Œäº¤ç”±ç”¨æˆ¶é»æ“Šå–®ä½/éƒ¨é–€æ™‚æ‰è§¸ç™¼ã€‚
    //    é€™æ¶ˆé™¤äº†é»æ“Šäººåæ™‚ï¼Œé€£é–åæ‡‰å°è‡´å–®ä½/éƒ¨é–€é«˜äº®çš„å¯èƒ½æ€§ã€‚
    //    (å¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥æ‰‹å‹•é»æ“Šå–®ä½/éƒ¨é–€ä¾†æ›´æ–°è¦–è¦ºç‹€æ…‹)

    copyMails(tabId);
}

/** è™•ç†é»æ“Šè¡¨é ­ (å–®æ¬„é¸å–/åé¸) */
function handleHeader(role, table, tabId) {
    const selectedMails = selectedMailsMap.get(tabId);
    const rows = Array.from(table.querySelectorAll("tr")).slice(1);
    const headers = Array.from(table.querySelectorAll("th"));

    let targetTds;
    
    // æœå‹™ç«™å–®ä¸€è§’è‰²é¸å– (è™•é•·, ç¶“ç†, ç«™é•·)
    if (role === "è™•é•·" || role === "ç¶“ç†" || role === "ç«™é•·") {
        const index = headers.findIndex(th => th.dataset.role === role);
        if (index < 0) return;

        // ç¯©é¸å‡ºè©²è§’è‰²æ¬„ä½ä¸­æ‰€æœ‰å¸¶æœ‰ mail çš„å„²å­˜æ ¼
        targetTds = rows.map(r => r.children[index]).filter(td => td.dataset.mail);
        
    } else if (role === "ALL" || role === "äººå") {
        // å…¨é¸ (å€åŸŸ/å–®ä½æˆ–äººåè¡¨é ­)
        targetTds = table.querySelectorAll("td[data-mail]");
        
    } else {
        return;
    }
    
    const allSelected = Array.from(targetTds).every(td => td.classList.contains("selected"));

    // åŸ·è¡Œé¸å–/åé¸æ“ä½œ
    targetTds.forEach(td => toggleSelect(td, !allSelected, selectedMails));

    // åŒæ­¥è¦–è¦ºç‹€æ…‹
    syncVisualState(table, selectedMails);
    
    // é¡å¤–è™•ç† TH æœ¬èº«çš„è¦–è¦ºç‹€æ…‹
    const th = headers.find(h => h.dataset.role === role);
    if (th) th.classList.toggle("selected", !allSelected);


    copyMails(tabId);
}


// =====================================
// â˜… è¤‡è£½åŠç‹€æ…‹æ›´æ–°
// =====================================
function copyMails(tabId) {
    const selectedMails = selectedMailsMap.get(tabId);
    if (!selectedMails) return;

    const arr = Array.from(selectedMails);
    const statusElement = document.getElementById(tabId).querySelector(".status");

    if (!arr.length) {
        statusElement.textContent = "ï¼ˆæœªé¸å–ï¼‰";
        return;
    }

    navigator.clipboard.writeText(arr.join("; ")).then(() => {
        statusElement.textContent = `âœ” å·²è¤‡è£½ ${arr.length} å€‹`;
    });
}
</script>

</body>
</html>