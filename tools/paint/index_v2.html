<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"/>
<title>åœ–ç‰‡æ¨™è¨»å·¥å…·</title>
<link rel="icon" type="image/png" sizes="32x32" href="../../images/paint.png">
<!-- CropperJS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css">
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>

<style>
/* ===== å…±ç”¨ ===== */
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  background:#f5f5f5;padding:1rem;
  display:flex;flex-direction:column;align-items:center;
}
h1{font-size:1.2rem;margin-bottom:1rem;}
input[type=file]{display:none;}

/* ===== æŒ‰éˆ• ===== */
.btn-row{
  display:flex;flex-wrap:wrap;gap:.5rem;
  justify-content:center;margin-bottom:1rem;
}
.btn{
  all:unset;cursor:pointer;
  width:50px;height:50px;border-radius:8px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:#e0e0e0;color:#555;
  box-shadow:0 1px 3px rgba(0,0,0,.14);
  transition:background .2s,color .2s,transform .1s;
}
.btn:hover{transform:translateY(-1px);}
.btn .ico{font-size:1.25rem;line-height:1;text-align:center;width:100%;}
.btn .label{font-size:.6rem;line-height:1;margin-top:.1rem;user-select:none;text-align:center;width:100%;}
.btn.on-success{background:#e8f5e9;color:#1b5e20;}
.btn.on-warn   {background:#fff9c4;color:#7f6000;}
.btn.on-danger {background:#ffebee;color:#b71c1c;}
.btn.on-primary{background:#c5e1ff;color:#003c8f;}

/* ===== æ‹–æ‹‰å€ ===== */
#drop-zone{
  width:100%;max-width:420px;padding:2rem;border:2px dashed #aaa;border-radius:8px;
  background:#fff;color:#666;text-align:center;cursor:pointer;margin-bottom:1rem;
  transition:.2s;
}
#drop-zone.dragover{background:#e0f7fa;border-color:#00796b;color:#00796b;}

/* ===== å·¥ä½œå€ ===== */
#canvasWrap{position:relative;display:none;max-width:100%;}
#imgBase{max-width:100%;max-height:70vh;border-radius:4px;display:block;}
#markupLayer{position:absolute;left:0;top:0;touch-action:none;cursor:crosshair;}
.cropper-container{max-width:100%!important;max-height:70vh!important;}
</style>
</head>
<body>

<h1>åœ–ç‰‡æ¨™è¨»å·¥å…·</h1>

<!-- éš±è— input -->
<input type="file" id="fileGallery" accept="image/*">
<input type="file" id="fileCamera"  accept="image/*" capture="environment">

<!-- é¸åœ– -->
<div class="btn-row" id="selectBtns">
  <button class="btn" id="btnGallery"><span class="ico">ğŸ“</span><span class="label">ç›¸ç°¿</span></button>
  <button class="btn" id="cameraBtn" ><span class="ico">ğŸ“·</span><span class="label">æ‹ç…§</span></button>
</div>

<!-- æ‹–æ‹‰ -->
<div id="drop-zone">æˆ–æ‹–æ‹‰åœ–ç‰‡åˆ°é€™è£¡</div>

<!-- å·¥ä½œå€ -->
<div id="canvasWrap">
  <img    id="imgBase" alt="">
  <canvas id="markupLayer"></canvas>
</div>

<!-- å·¥å…·åˆ— -->
<div class="btn-row" id="toolBar" style="display:none">
  <!-- è£åˆ‡ -->
  <button class="btn" id="cropTool"   data-color="success"><span class="ico">âœ‚ï¸</span><span class="label">è£åˆ‡</span></button>
  <button class="btn" id="cancelCrop" data-color="danger" style="display:none"><span class="ico">âŒ</span><span class="label">å–æ¶ˆ</span></button>

  <!-- ç­†åˆ· -->
  <button class="btn" id="penRed"        data-color="danger"><span class="ico">ğŸ–ï¸</span><span class="label">ç´…ç­†</span></button>
  <button class="btn" id="penYellow"     data-color="warn"  ><span class="ico">ğŸ–Œï¸</span><span class="label">è¢å…‰</span></button>

  <!-- åœ–å½¢ -->
  <button class="btn" id="ellipseRed"    data-color="danger"><span class="ico">â­•</span><span class="label">ç´…åœˆ</span></button>
  <button class="btn" id="rectRed"       data-color="danger"><span class="ico">ğŸŸ¥</span><span class="label">ç´…æ¡†</span></button>

  <!-- é«˜äº® -->
  <button class="btn" id="highlightOval" data-color="primary"><span class="ico">âšª</span><span class="label">é«˜äº®åœ“</span></button>
  <button class="btn" id="highlightRect" data-color="primary"><span class="ico">â¬œ</span><span class="label">é«˜äº®</span></button>

  <!-- å…¶ä»– -->
  <button class="btn" id="undoBtn"><span class="ico">ğŸ”™</span><span class="label">ä¸Šä¸€æ­¥</span></button>
  <button class="btn" id="shareBtn" data-color="primary"><span class="ico">ğŸ“¤</span><span class="label">åˆ†äº«</span></button>
  <button class="btn" id="downloadBtn"data-color="primary"><span class="ico">â¬‡ï¸</span><span class="label">ä¸‹è¼‰</span></button>
  <button class="btn" id="resetBtn"><span class="ico">ğŸ§¹</span><span class="label">æ¸…é™¤ç•«å¸ƒ</span></button>
  <button class="btn" id="reload" onclick="confirm('ç¢ºå®šè¦é‡æ–°è¼‰å…¥ï¼Ÿ') && location.reload()"><span class="ico">ğŸ”„</span><span class="label">é‡æ–°è¼‰å…¥</span></button>

</div>

<script>
/* ========= å¿«æ· ========= */
const $ = id => document.getElementById(id);
const mobile = /Android|iPhone|iPad|iPod|Windows/i.test(navigator.userAgent);

/* ========= DOM ========= */
const fGal = $('fileGallery'), fCam = $('fileCamera');
const selBtns=$('selectBtns'), drop=$('drop-zone'), wrap=$('canvasWrap'),
      img=$('imgBase'), cv=$('markupLayer'), bar=$('toolBar');
const cropBtn=$('cropTool'), cancelBtn=$('cancelCrop');
const penRed=$('penRed'), penYel=$('penYellow'),
      ellipse=$('ellipseRed'), rectRed=$('rectRed');
const hiRect=$('highlightRect'), hiOval=$('highlightOval');
const undo=$('undoBtn'), dl=$('downloadBtn'),
      share=$('shareBtn'), reset=$('resetBtn'),
      btnGal=$('btnGallery'), camBtn=$('cameraBtn');
const ctx = cv.getContext('2d');

/* ========= ç‹€æ…‹ ========= */
let mode='none', cropper=null, stream=null;
let drawing=false, sx=0, sy=0, preview=null;
const UM=10, markStack=[], cropStack=[];
let hasMask=false; // é«˜äº®é®ç½©æ˜¯å¦å·²å­˜åœ¨

/* ========= å·¥å…·äº®èµ· ========= */
const tools=[cropBtn,penRed,penYel,ellipse,rectRed,hiRect,hiOval];
function active(btn){
  tools.forEach(b=>b.className='btn');
  if(btn)btn.classList.add(`on-${btn.dataset.color}`);
}

/* ========= ç•«å¸ƒå°ºå¯¸ ========= */
function fitCanvas(){
  cv.width = img.clientWidth;
  cv.height= img.clientHeight;
}
window.addEventListener('resize',()=>{if(wrap.style.display!=='none')fitCanvas();});

/* ========= è¼‰å…¥åœ–ç‰‡ ========= */
function load(file){
  const r=new FileReader();
  r.onload=e=>{img.src=e.target.result;img.onload=enterWorkArea;};
  r.readAsDataURL(file);
}

/* ========= é€²å…¥å·¥ä½œå€ ========= */
function enterWorkArea(){
  selBtns.style.display='none';
  drop.style.display='none';
  wrap.style.display='block';
  bar.style.display='flex';
  fitCanvas();ctx.clearRect(0,0,cv.width,cv.height);
  markStack.length=0;cropStack.length=0;
  mode='none';active(null);hasMask=false;
  cropper&&cropper.destroy();cropper=null;toggleCrop(false);
}

/* ========= æ§åˆ¶è£åˆ‡ ========= */
function toggleCrop(on){
  cancelBtn.style.display = on ? 'flex' : 'none'; // ä¿æŒ flex ä»¥ç½®ä¸­
  cv.style.pointerEvents = on ? 'none':'auto';
  cropBtn.querySelector('.ico').textContent   = on?'âœ”ï¸':'âœ‚ï¸';
  cropBtn.querySelector('.label').textContent = on?'å¥—ç”¨':'è£åˆ‡';
  on?active(cropBtn):active(null);
}

/* ========= Undo ========= */
function pushMark(){
  if(markStack.length>=UM)markStack.shift();
  markStack.push(ctx.getImageData(0,0,cv.width,cv.height));
}
function pushCrop(){
  if(cropStack.length>=UM)cropStack.shift();
  cropStack.push(img.src);
}

/* ========= ä¸‹è¼‰/åˆ†äº« ========= */
function mergedCanvas(){
  cropper&&applyCrop(); // è‹¥é‚„åœ¨è£åˆ‡ï¼Œå…ˆå¥—ç”¨
  const o=document.createElement('canvas');
  o.width=img.naturalWidth;o.height=img.naturalHeight;
  const ct=o.getContext('2d');
  ct.drawImage(img,0,0);ct.drawImage(cv,0,0,o.width,o.height);
  return o;
}
function saveFile(){
  if(!img.src)return;
  const o=mergedCanvas(),d=new Date();
  const f=`crop_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}${String(d.getSeconds()).padStart(2,'0')}.png`;
  const a=document.createElement('a');a.download=f;a.href=o.toDataURL();a.click();
}
function webShare(){
  if(!navigator.share||!img.src)return;
  mergedCanvas().toBlob(async b=>{
    try{await navigator.share({files:[new File([b],'image.png',{type:b.type})],title:'åˆ†äº«åœ–ç‰‡'});}catch{}
  });
}

/* ========= äº‹ä»¶ï¼šè¼‰åœ–/æ‹–æ‹‰/æ‹ç…§ ========= */
btnGal.onclick=()=>fGal.click();
fGal.onchange=e=>e.target.files[0]&&load(e.target.files[0]);
camBtn.onclick=()=>mobile?fCam.click():openCam();
fCam.onchange=e=>e.target.files[0]&&load(e.target.files[0]);

if(!mobile){ // æ‹–æ‹‰
  ['dragenter','dragover'].forEach(t=>drop.addEventListener(t,e=>{e.preventDefault();drop.classList.add('dragover');}));
  ['dragleave','dragend','drop'].forEach(t=>drop.addEventListener(t,()=>drop.classList.remove('dragover')));
  drop.addEventListener('drop',e=>{e.preventDefault();e.dataTransfer.files[0]&&load(e.dataTransfer.files[0]);});
}

/* ========= æ¡Œæ©Ÿæ”å½± ========= */
async function openCam(){
  try{stream=await navigator.mediaDevices.getUserMedia({video:true});}
  catch{return alert('ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿ');}
  const v=document.createElement('video');
  v.autoplay=true;v.playsInline=true;v.srcObject=stream;
  wrap.innerHTML='';wrap.appendChild(v);wrap.style.display='block';
  selBtns.style.display='none';drop.style.display='none';bar.style.display='flex';
  v.onloadedmetadata=()=>v.play();
  v.onclick=()=>{
    const c=document.createElement('canvas');
    c.width=v.videoWidth;c.height=v.videoHeight;
    c.getContext('2d').drawImage(v,0,0);
    img.src=c.toDataURL();
    img.onload=()=>{
      stream.getTracks().forEach(t=>t.stop());
      wrap.innerHTML='';wrap.appendChild(img);wrap.appendChild(cv);
      enterWorkArea();
    };
  };
}

/* ========= æ¨¡å¼åˆ‡æ› ========= */
function setMode(m){
  if(cropper)cancelBtn.click();
  mode=m;
  active(
    m==='penRed'       ?penRed   :
    m==='penYellow'    ?penYel   :
    m==='ellipse'      ?ellipse  :
    m==='rectRed'      ?rectRed  :
    m==='highlightRect'?hiRect   :
    m==='highlightOval'?hiOval   :null
  );
}
penRed   .onclick=()=>setMode('penRed');
penYel   .onclick=()=>setMode('penYellow');
ellipse  .onclick=()=>setMode('ellipse');
rectRed  .onclick=()=>setMode('rectRed');
hiRect   .onclick=()=>setMode('highlightRect');
hiOval   .onclick=()=>setMode('highlightOval');

/* ========= è£åˆ‡é‚è¼¯ ========= */
function startCrop(){
  if(!img.src)return;
  if(!cropper){
    cropper=new Cropper(img,{viewMode:1,responsive:true});
    toggleCrop(true);
  }else applyCrop();
}
function applyCrop(){
  pushCrop();
  const c=cropper.getCroppedCanvas();
  img.src=c.toDataURL();
  img.onload=()=>{cropper.destroy();cropper=null;toggleCrop(false);fitCanvas();}
}
cropBtn  .onclick=startCrop;
cancelBtn.onclick=()=>{cropper&&(cropper.destroy(),cropper=null,toggleCrop(false));};

/* ========= ç•«åœ–äº‹ä»¶ ========= */

cv.addEventListener('pointerdown',e=>{
  if(mode==='none')return;
  drawing=true;pushMark();
  const r=cv.getBoundingClientRect();
  sx=e.clientX-r.left;sy=e.clientY-r.top;
  /* === ç­†åˆ· === */
  if(mode.startsWith('pen')){
    ctx.lineCap='round';
    ctx.lineWidth=(mode==='penYellow'?18:3);
    ctx.strokeStyle=(mode==='penYellow')?'rgba(255,255,0,0.5)':'red';
    ctx.beginPath();ctx.moveTo(sx,sy);
  }
  /* === é«˜äº® (é¦–æ¬¡ç•«é®ç½©) === */
  if((mode==='highlightRect'||mode==='highlightOval')&&!hasMask){
    ctx.fillStyle='rgba(0,0,0,0.55)';
    ctx.fillRect(0,0,cv.width,cv.height);
    hasMask=true;
  }
  preview=ctx.getImageData(0,0,cv.width,cv.height);
});

cv.addEventListener('pointermove',e=>{
  if(!drawing)return;
  const r=cv.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top,w=x-sx,h=y-sy;
  if(mode.startsWith('pen')){
    ctx.lineTo(x,y);ctx.stroke();return;
  }
  ctx.putImageData(preview,0,0);
  switch(mode){
    case 'ellipse':
      drawEllipse(sx,sy,w,h);break;
    case 'rectRed':
      drawRect(sx,sy,w,h);break;
    case 'highlightRect':
      highlightRect(w,h);break;
    case 'highlightOval':
      highlightOval(w,h);break;
  }
});

cv.addEventListener('pointerup',finishDraw);
cv.addEventListener('pointercancel',finishDraw);

function finishDraw(e){
  if(!drawing)return;drawing=false;
  const r=cv.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top,w=x-sx,h=y-sy;
  ctx.putImageData(preview,0,0);
  switch(mode){
    case 'ellipse':
      drawEllipse(sx,sy,w,h);break;
    case 'rectRed':
      drawRect(sx,sy,w,h);break;
    case 'highlightRect':
      highlightRect(w,h);break;
    case 'highlightOval':
      highlightOval(w,h);break;
    case 'penRed':
    case 'penYellow':
      ctx.lineTo(x,y);ctx.stroke();break;
  }
}

/* ========= ç•«åœ–å·¥å…·å‡½å¼ ========= */
function drawEllipse(x0,y0,w,h){
  ctx.strokeStyle='red';ctx.lineWidth=3;
  ctx.beginPath();
  ctx.ellipse(x0+w/2,y0+h/2,Math.abs(w/2),Math.abs(h/2),0,0,Math.PI*2);
  ctx.stroke();
}
function drawRect(x0,y0,w,h){
  ctx.strokeStyle='red';ctx.lineWidth=3;
  ctx.strokeRect(x0,y0,w,h);
}
function highlightRect(w,h){
  ctx.clearRect(sx,sy,w,h);
}
function highlightOval(w,h){
  ctx.save();
  ctx.beginPath();
  ctx.ellipse(sx+w/2,sy+h/2,Math.abs(w/2),Math.abs(h/2),0,0,Math.PI*2);
  ctx.clip();
  ctx.clearRect(0,0,cv.width,cv.height);
  ctx.restore();
}

/* ========= ä¸Šä¸€æ­¥ ========= */
undo.onclick=()=>{
  if(markStack.length){
    ctx.putImageData(markStack.pop(),0,0);
  }else if(cropStack.length){
    img.src=cropStack.pop();img.onload=fitCanvas;
  }
};

/* ========= ä¸‹è¼‰ / åˆ†äº«  ========= */
dl   .onclick=saveFile;
share.onclick=webShare;

/* ========= é‡è¨­ï¼ˆå›åˆ°è¼‰å…¥å¾Œçš„ç¬¬ä¸€æ­¥ï¼‰ ========= */
reset.onclick = () => {
  /* 1. çµæŸè£åˆ‡ï¼æ”å½±æµç¨‹ä½†ä¿ç•™åœ–ç‰‡ */
  if (cropper) { cropper.destroy(); cropper = null; }
  if (stream)  { stream.getTracks().forEach(t => t.stop()); stream = null; }

  /* 2. æ¸…ç©ºæ¨™è¨»å±¤å›åˆ°ä¹¾æ·¨ç•«å¸ƒ */
  ctx.clearRect(0, 0, cv.width, cv.height);
  markStack.length = 0;
  hasMask = false;

  /* 3. é‚„åŸ UI ç‹€æ…‹ */
  cv.style.pointerEvents = 'auto';          // è‹¥å‰›åœ¨è£åˆ‡æ¨¡å¼
  cancelBtn.style.display = 'none';
  cropBtn.querySelector('.ico').textContent   = 'âœ‚ï¸';
  cropBtn.querySelector('.label').textContent = 'è£åˆ‡';
  active(null);
  mode = 'none';
};


/* ===== é˜²ä¸‹æ‹‰é‡æ•´(è¼•é‡) ===== */
let lastY=0;
window.addEventListener('touchstart',e=>{lastY=e.touches[0].clientY;},{passive:true});
window.addEventListener('touchmove',e=>{
  const y=e.touches[0].clientY;
  if(window.pageYOffset===0 && y>lastY) e.preventDefault();
},{passive:false});
</script>
</body>
</html>
