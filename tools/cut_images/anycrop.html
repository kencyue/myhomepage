<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>åœ–ç‰‡è£åˆ‡å·¥å…·</title>
<link rel="icon" type="image/png" sizes="32x32" href="../../images/cropp.png">
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css">

<style>
  *{box-sizing:border-box;}
  body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
    margin:0;padding:1rem;background:#f5f5f5;
    display:flex;flex-direction:column;align-items:center;
  }
  h1{font-size:1.4rem;margin:0 0 1rem;}
  #drop-zone{
    width:100%;max-width:420px;padding:2rem;
    border:2px dashed #aaa;border-radius:8px;
    background:#fff;color:#666;text-align:center;
    transition:.2s;cursor:pointer;margin-bottom:1rem;
  }
  #drop-zone.dragover{background:#e0f7fa;border-color:#00796b;color:#00796b;}

  /* é¡¯ç¤ºåœ–ç‰‡ï¼ˆé™åˆ¶å¤§å°ï¼‰ */
  #image{
    max-width:100%;max-height:70vh;
    display:none;border-radius:4px;object-fit:contain;
  }
  /* Cropper å®¹å™¨ä¹Ÿé™åˆ¶å¤§å° */
  .cropper-container{
    max-width:100%!important;max-height:70vh!important;
  }

  /* WebRTC å½±åƒé è¦½ */
  #video{
    max-width:100%;max-height:70vh;border-radius:4px;
    display:none;
  }

  canvas{display:none;margin-top:1rem;max-width:100%;}
  .btn-row{display:flex;gap:.75rem;flex-wrap:wrap;
           justify-content:center;margin-bottom:1rem;}
input[type="file"] {
  display: none; /* âœ… éš±è— input file */
}

.btn {
  all: unset;
  padding: 0.6rem 1.4rem;
  font-size: 1rem;
  font-weight: 500;
  border-radius: 8px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  min-width: 120px;
  background: #e0e0e0;
  color: #333;
  transition: background 0.2s ease, transform 0.1s ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.btn:hover {
  background: #d5d5d5;
  transform: translateY(-1px);
}

/* âœ… ä½¿ç”¨ä¸€è‡´è‰²ç³» + å¾®å¦™è®ŠåŒ–æå‡è³ªæ„Ÿ */
.gallery {
  background: #f5f5f5;
  color: #333;
}
.gallery:hover {
  background: #e0e0e0;
}

.camera {
  background: #fef3e0;
  color: #8a5a00;
}
.camera:hover {
  background: #fddca5;
}

.crop {
  background: #e8f5e9;
  color: #2e7d32;
}
.crop:hover {
  background: #c8e6c9;
}

.reset {
  background: #ffebee;
  color: #c62828;
}
.reset:hover {
  background: #ffcdd2;
}

</style>
</head>
<body>

<h1>ğŸ“· åœ–ç‰‡è£åˆ‡å·¥å…·</h1>

<!-- éš±è—æª”æ¡ˆ inputï¼ˆè¡Œå‹•è£ç½®æ‹ç…§ / ç›¸ç°¿ï¼‰ -->
<input type="file" id="fileGallery" accept="image/*">
<input type="file" id="fileCamera"  accept="image/*" capture="environment">

<!-- ä¸»é¸æ“‡æŒ‰éˆ• -->
<div class="btn-row" id="selectBtns">
  <button class="btn gallery" onclick="fileGallery.click()">ğŸ“ å¾ç›¸ç°¿é¸æ“‡</button>
  <button class="btn camera"  id="cameraBtn">ğŸ“· æ‹ç…§</button>
</div>

<!-- æ‹–æ‹‰å€ï¼ˆåƒ…æ¡Œæ©Ÿé¡¯ç¤ºï¼‰-->
<div id="drop-zone">æˆ–æ‹–æ‹‰åœ–ç‰‡åˆ°é€™è£¡</div>

<!-- æ¡Œæ©Ÿæ”å½±æ©Ÿé è¦½ -->
<video id="video" autoplay playsinline></video>
<div class="btn-row" id="camCtrls" style="display:none">
  <button class="btn crop"  id="snapBtn">ğŸ“¸ æ“·å–</button>
  <button class="btn reset" id="cancelCamBtn">âœ–ï¸ å–æ¶ˆ</button>
</div>

<!-- è£åˆ‡åœ–ç‰‡ -->
<img id="image" alt="å¾…è£åˆ‡åœ–ç‰‡">
<canvas id="preview"></canvas>

<!-- è£åˆ‡ / é‡è¨­ -->
<div class="btn-row">
  <button class="btn crop"  id="cropBtn">âœ‚ï¸ è£åˆ‡ä¸¦ä¸‹è¼‰</button>
  <button class="btn reset" id="resetBtn">ğŸ”„ é‡æ–°é¸åœ–</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>
<script>
  /* ---------------- è®Šæ•¸ ---------------- */
  const isMobile = /Android|iPhone|iPad|iPod|Windows Phone|IEMobile|Mobile/i
                   .test(navigator.userAgent);              // â˜…â˜… è¡Œå‹•è£ç½®åˆ¤æ–·
  const fileGallery = document.getElementById('fileGallery');
  const fileCamera  = document.getElementById('fileCamera');
  const dropZone    = document.getElementById('drop-zone');
  const selectBtns  = document.getElementById('selectBtns');
  const cameraBtn   = document.getElementById('cameraBtn');
  const image       = document.getElementById('image');
  const video       = document.getElementById('video');
  const camCtrls    = document.getElementById('camCtrls');
  const snapBtn     = document.getElementById('snapBtn');
  const cancelCamBtn= document.getElementById('cancelCamBtn');
  const canvas      = document.getElementById('preview');
  const cropBtn     = document.getElementById('cropBtn');
  const resetBtn    = document.getElementById('resetBtn');
  let cropper, stream;

  /* ------------ è£ç½®å·®ç•° UI èª¿æ•´ ------------ */
  if(isMobile){
    dropZone.style.display = 'none';        // æ‰‹æ©Ÿéš±è—æ‹–æ‹‰å€ â˜…â˜…
    cameraBtn.onclick = ()=>fileCamera.click();  // æ‰‹æ©Ÿä»ç”¨ <input capture>
  }else{
    cameraBtn.onclick = openCamera;          // æ¡Œæ©Ÿâ†’WebRTC â˜…â˜…
  }

  /* ---------- è¦–çª—æ”¹è®Šæ™‚é‡ç®— maxHeight ---------- */
  function setMaxHeight(){
    const spare = 220;
    const h = (window.innerHeight - spare) + 'px';
    image.style.maxHeight = h;
    video.style.maxHeight = h;
    document.querySelectorAll('.cropper-container').forEach(c=>{
      c.style.maxHeight = h;
    });
  }
  window.addEventListener('resize', setMaxHeight);

  /* ------------- é¡¯ç¤ºåœ–ç‰‡ ------------- */
  function showImage(src){
    image.src = src;
    image.style.display='block';
    video.style.display='none';
    camCtrls.style.display='none';
    dropZone.style.display = isMobile ? 'none' : 'none';
    selectBtns.style.display='none';
    setMaxHeight();
    if(cropper) cropper.destroy();
    cropper = new Cropper(image, {
  viewMode: 1,
  responsive: true,
  background: false,
  dragMode: 'move',
  movable: true,
  zoomable: true,
  scalable: false,
  toggleDragModeOnDblclick: false
});

  }

  /* ------------- è®€æª” (ç›¸ç°¿ / æ‹–æ‹‰) ------------- */
  function loadImage(file){
    const reader = new FileReader();
    reader.onload = e=>showImage(e.target.result);
    reader.readAsDataURL(file);
  }

  /* input è§¸ç™¼ */
  fileGallery.onchange = e=>e.target.files[0] && loadImage(e.target.files[0]);
  fileCamera .onchange = e=>e.target.files[0] && loadImage(e.target.files[0]);

  /* ---------- æ‹–æ‹‰ (æ¡Œæ©Ÿ) ---------- */
  if(!isMobile){
    ['dragenter','dragover'].forEach(ev=>{
      dropZone.addEventListener(ev,e=>{
        e.preventDefault();dropZone.classList.add('dragover');
      });
    });
    ['dragleave','dragend','drop'].forEach(ev=>{
      dropZone.addEventListener(ev,e=>{
        dropZone.classList.remove('dragover');
      });
    });
    dropZone.addEventListener('drop',e=>{
      e.preventDefault();
      if(e.dataTransfer.files[0]) loadImage(e.dataTransfer.files[0]);
    });
  }

  /* ---------- WebRTC æ”å½±æ©Ÿ (æ¡Œæ©Ÿ) ---------- */
  async function openCamera(){
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:true});
    }catch(err){
      alert('ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿï¼š'+err);
      return;
    }
    video.srcObject   = stream;
    video.style.display='block';
    camCtrls.style.display='flex';
    dropZone.style.display='none';
    selectBtns.style.display='none';
    setMaxHeight();
  }

  /* æ“·å–å½±åƒ */
  snapBtn.onclick = ()=>{
    if(!stream) return;
    const vWidth  = video.videoWidth;
    const vHeight = video.videoHeight;
    const tempCv  = document.createElement('canvas');
    tempCv.width  = vWidth;
    tempCv.height = vHeight;
    tempCv.getContext('2d').drawImage(video,0,0);
    const dataURL = tempCv.toDataURL('image/png');
    stopCamera();
    showImage(dataURL);
  };

  /* å–æ¶ˆæ”å½±æ©Ÿ */
  cancelCamBtn.onclick = ()=>{ stopCamera(); resetUI(); };
  function stopCamera(){
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    video.style.display='none';
    camCtrls.style.display='none';
  }

  /* ---------- è£åˆ‡ä¸¦ä¸‹è¼‰ ---------- */
  cropBtn.onclick = ()=>{
    if(!cropper) return;
    const cropped = cropper.getCroppedCanvas();
    canvas.width  = cropped.width;
    canvas.height = cropped.height;
    canvas.getContext('2d').drawImage(cropped,0,0);
    canvas.style.display='none';
    const link = document.createElement('a');
    const now = new Date();
const y = now.getFullYear();
const m = String(now.getMonth()+1).padStart(2, '0');
const d = String(now.getDate()).padStart(2, '0');
const h = String(now.getHours()).padStart(2, '0');
const min = String(now.getMinutes()).padStart(2, '0');
const s = String(now.getSeconds()).padStart(2, '0');
link.download = `crop_${y}${m}${d}${h}${min}${s}.png`;

    link.href     = canvas.toDataURL();
    link.click();
  };

  /* ---------- é‡è¨­ ---------- */
  resetBtn.onclick = resetUI;
  function resetUI(){
    cropper && cropper.destroy();
    image .style.display='none';
    canvas.style.display='none';
    selectBtns.style.display='flex';
    if(!isMobile) dropZone.style.display='block';
    fileGallery.value=''; fileCamera.value='';
  }
</script>
</body>
</html>
