<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code 掃描器</title>
    <link rel="icon" type="image/png" sizes="32x32" href="../../images/qrcode.png">
    <!-- UI Framework & QR Library -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
  <div class="w-full max-w-lg bg-white rounded-2xl shadow-lg p-6">
    <h1 class="text-2xl font-bold text-center lstext-gray-800 mb-4">QR Code 掃描器</h1>

    <!-- 影像畫面 -->
    <div id="videoContainer" class="relative w-full aspect-square mb-4 overflow-hidden hidden">
      <video id="video" class="w-full h-full object-cover rounded-md" style="transform:scale(1)" autoplay playsinline></video>
    </div>
    <canvas id="canvas" class="hidden"></canvas>

    <!-- 操作按鈕 -->
    <div class="flex justify-center items-center mb-4 gap-4 w-full">
      <button id="zoomInButton" class="bg-gray-200 text-gray-700 px-3 py-2 rounded-md hover:bg-gray-300 focus:outline-none sm:px-4 hidden">放大</button>
      <button id="zoomOutButton" class="bg-gray-200 text-gray-700 px-3 py-2 rounded-md hover:bg-gray-300 focus:outline-none sm:px-4 hidden">縮小</button>
      <button id="toggleButton" class="bg-blue-500 text-white px-3 py-2 rounded-md hover:bg-blue-600 focus:outline-none sm:px-4">開始掃描</button>
    </div>

    <!-- 掃描結果 -->
    <div id="result" class="mt-4 hidden">
      <h2 class="text-lg font-semibold text-gray-700 mb-2">掃描結果</h2>
      <div class="flex mb-4 text-sm" id="tabContainer">
        <button id="parsedTab" class="flex-1 py-2 px-4 bg-blue-100 text-blue-700 font-medium rounded-l-md border-b-2 border-blue-500">整理後的資料</button>
        <button id="rawTab" class="flex-1 py-2 px-4 bg-gray-100 text-gray-700 font-medium rounded-r-md">原始數據</button>
      </div>
      <div id="parsedData" class="block">
        <table id="resultTable" class="w-full border-collapse text-sm">
          <tbody id="resultBody"></tbody>
        </table>
      </div>
      <div id="rawData" class="hidden">
        <pre id="rawText" class="bg-gray-50 p-4 rounded-md text-gray-600 overflow-auto text-xs"></pre>
      </div>
    </div>

    <p id="status" class="text-center text-gray-600 mt-4">請點擊「開始掃描」啟動攝影機</p>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* DOM 元素 */
    const video = document.getElementById('video');
    const videoContainer = document.getElementById('videoContainer');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const result = document.getElementById('result');
    const resultBody = document.getElementById('resultBody');
    const rawText = document.getElementById('rawText');
    const status = document.getElementById('status');
    const toggleButton = document.getElementById('toggleButton');
    const parsedTab = document.getElementById('parsedTab');
    const rawTab = document.getElementById('rawTab');
    const parsedData = document.getElementById('parsedData');
    const rawData = document.getElementById('rawData');
    const zoomInButton = document.getElementById('zoomInButton');
    const zoomOutButton = document.getElementById('zoomOutButton');
    const tabContainer = document.getElementById('tabContainer');

    /* 狀態變數 */
    let isScanning = false;
    let rawDataCache = '';
    let zoomLevel = 1;
    let stream = null;

    /* 開啟攝影機 */
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        video.play();
        videoContainer.classList.remove('hidden');
        zoomInButton.classList.remove('hidden');
        zoomOutButton.classList.remove('hidden');
        status.textContent = '請將 QR Code 對準攝影機';
        if (isScanning) requestAnimationFrame(tick);
      } catch (err) {
        status.textContent = '無法開啟攝影機，請確認權限';
        status.classList.add('text-red-500');
      }
    }

    /* 關閉攝影機 */
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.srcObject = null;
      videoContainer.classList.add('hidden');
    }

    /* 逐幀掃描 */
    function tick() {
      if (!isScanning) return;
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imgData.data, imgData.width, imgData.height);
        if (code) {
          showResult(code.data);
          status.textContent = '掃描成功！';
          status.classList.replace('text-gray-600', 'text-green-500');
          isScanning = false;
          toggleButton.textContent = '開始掃描';
          stopCamera();
          zoomInButton.classList.add('hidden');
          zoomOutButton.classList.add('hidden');
          return;
        }
      }
      if (isScanning) requestAnimationFrame(tick);
    }

    /* 顯示結果表格 / 原文 */
    function showResult(data) {
      result.classList.remove('hidden');
      resultBody.innerHTML = '';
      rawDataCache = data;

      // Field mappings for display
      const fieldMap = {
        ware: '站別',
        ctlno: '管理號碼',
        model: '機種',
        pdno: '機號',
        tapn: '買方品番',
        pano: '材料代號',
        bdate: '購買日期',
        pdlf: '機齡'
      };

      // Translation for 'ware'
      const wareMap = {
        '650': '整新廠',
        'A00': '花蓮站',
        'AB0': '台東站',
        'AC0': '基隆站',
        'AD0': '宜蘭站',
        'B00': '西區站',
        'BA0': '東區站',
        'BD0': '三重站',
        'BE0': '北區站',
        'BJ0': '金門站',
        'BK0': '中和站',
        'BL0': '系統北部',
        'BM0': '系統台中',
        'BN0': '系統南部',
        'BX0': '修理廠',
        'BY0': '數位修理',
        'C00': '桃園站',
        'CA0': '中壢站',
        'D00': '新竹站',
        'DB0': '苗栗站',
        'EA0': '豐原站',
        'EB0': '清水站',
        'ED0': '台中站',
        'F00': '彰化站',
        'FB0': '草屯站',
        'G00': '嘉義站',
        'GC0': '虎尾站',
        'GE0': '新營站',
        'H00': '台南站',
        'I00': '高北站',
        'IA0': '高南站0',
        'ID0': '岡山站',
        'IE0': '澎湖站'
      };

      // Translation for 'pdlf'
      const pdlfMap = {
        '1': '一日內',
        '2': '三月內',
        '3': '半年內',
        '4': '一年內',
        '5': '二年內',
        '6': '三年內',
        '8': '四年內',
        '9': '五年內',
        'A': '六年內',
        'C': '七年以上'
      };

      let cleaned = data.trim().replace(/[\n\r\s]+/g, ' ').replace(/'/g, '"');
      let obj;
      try {
        obj = JSON.parse(cleaned);
        if (!obj || typeof obj !== 'object') throw new Error();
      } catch {
        // Non-JSON data: check if it's a URL
        const urlMatch = cleaned.match(/(https?:\/\/[^\s\]})]+)/);
        if (urlMatch) {
          rawText.innerHTML = `<a href="${urlMatch[1]}" target="_blank" class="text-blue-500 underline">${urlMatch[1]}</a>`;
        } else {
          rawText.textContent = data;
        }
        // Hide parsed tab and show raw tab
        tabContainer.classList.add('hidden');
        parsedData.classList.add('hidden');
        rawData.classList.remove('hidden');
        status.textContent = '掃描成功，但內容不是有效 JSON';
        status.classList.replace('text-green-500', 'text-yellow-500');
        return;
      }

      // Check if JSON contains any expected fields
      const requiredFields = Object.keys(fieldMap);
      const hasExpectedFields = Object.keys(obj).some(key => requiredFields.includes(key));

      if (!hasExpectedFields) {
        // JSON but no expected fields: show raw data only
        rawText.textContent = JSON.stringify(obj, null, 2);
        tabContainer.classList.add('hidden');
        parsedData.classList.add('hidden');
        rawData.classList.remove('hidden');
        status.textContent = '掃描成功，但內容不符合預期格式';
        status.classList.replace('text-green-500', 'text-yellow-500');
        return;
      }

      // Valid JSON with expected fields: show table
      tabContainer.classList.remove('hidden');
      parsedData.classList.remove('hidden');
      rawData.classList.add('hidden');
      rawText.textContent = JSON.stringify(obj, null, 2);
      parsedTab.classList.replace('bg-gray-100', 'bg-blue-100');
      parsedTab.classList.replace('text-gray-700', 'text-blue-700');
      rawTab.classList.replace('bg-blue-100', 'bg-gray-100');
      rawTab.classList.replace('text-blue-700', 'text-gray-700');

      let hasMissingFields = false;
      for (const [key, value] of Object.entries(obj)) {
        if (!requiredFields.includes(key)) continue; // Skip non-expected fields
        const displayKey = fieldMap[key] || key;
        let displayValue = value;

        // Translate 'ware' field
        if (key === 'ware' && wareMap[value]) {
          displayValue = wareMap[value];
        }
        // Translate 'pdlf' field
        else if (key === 'pdlf' && pdlfMap[value]) {
          displayValue = pdlfMap[value];
        }
        // Handle URLs
        else if (typeof value === 'string' && /^(https?:\/\/)/.test(value)) {
          displayValue = `<a href="${value}" target="_blank" class="text-blue-500 underline">${value}</a>`;
        }

        const tr = document.createElement('tr');
        tr.className = 'border-b';
        tr.innerHTML = `<td class="py-2 px-4 text-gray-700 font-medium w-1/3">${displayKey}</td>` +
                       `<td class="py-2 px-4 text-gray-600">${displayValue}</td>`;
        resultBody.appendChild(tr);
      }

      // Add missing fields in red
      const missingFields = requiredFields.filter(field => !obj.hasOwnProperty(field));
      if (missingFields.length > 0) {
        hasMissingFields = true;
        missingFields.forEach(field => {
          const tr = document.createElement('tr');
          tr.className = 'border-b';
          tr.innerHTML = `<td class="py-2 px-4 text-red-500 font-medium w-1/3">${fieldMap[field]}</td>` +
                         `<td class="py-2 px-4 text-red-500">缺少資料</td>`;
          resultBody.appendChild(tr);
        });
      }

      // Update status for missing fields
      if (hasMissingFields) {
        status.textContent = '掃描成功，但缺少部分欄位';
        status.classList.replace('text-green-500', 'text-yellow-500');
      }
    }

    /* 若 value 為 URL 轉成連結 */
    function linkify(v) {
      if (typeof v === 'string' && /^(https?:\/\/)/.test(v)) {
        return `<a href="${v}" target="_blank" class="text-blue-500 underline">${v}</a>`;
      }
      return v;
    }

    /* Tab 切換 */
    parsedTab.addEventListener('click', () => switchTab(true));
    rawTab.addEventListener('click', () => switchTab(false));

    function switchTab(showParsed) {
      if (showParsed) {
        parsedTab.classList.replace('bg-gray-100', 'bg-blue-100');
        parsedTab.classList.replace('text-gray-700', 'text-blue-700');
        rawTab.classList.replace('bg-blue-100', 'bg-gray-100');
        rawTab.classList.replace('text-blue-700', 'text-gray-700');
        parsedData.classList.remove('hidden');
        rawData.classList.add('hidden');
      } else {
        rawTab.classList.replace('bg-gray-100', 'bg-blue-100');
        rawTab.classList.replace('text-gray-700', 'text-blue-700');
        parsedTab.classList.replace('bg-blue-100', 'bg-gray-100');
        parsedTab.classList.replace('text-blue-700', 'text-gray-700');
        rawData.classList.remove('hidden');
        parsedData.classList.add('hidden');
      }
    }

    /* 影像縮放 */
    zoomInButton.addEventListener('click', () => {
      zoomLevel = Math.min(zoomLevel + 0.2, 3);
      video.style.transform = `scale(${zoomLevel})`;
    });
    zoomOutButton.addEventListener('click', () => {
      zoomLevel = Math.max(zoomLevel - 0.2, 1);
      video.style.transform = `scale(${zoomLevel})`;
    });

    /* 開始 / 暫停 */
    toggleButton.addEventListener('click', () => {
      if (isScanning) {
        isScanning = false;
        toggleButton.textContent = '開始掃描';
        zoomInButton.classList.add('hidden');
        zoomOutButton.classList.add('hidden');
        stopCamera();
      } else {
        isScanning = true;
        toggleButton.textContent = '暫停掃描';
        zoomLevel = 1;
        video.style.transform = 'scale(1)';
        result.classList.add('hidden');
        tabContainer.classList.remove('hidden');
        switchTab(true);
        status.className = 'text-center text-gray-600 mt-4';
        startCamera();
      }
    });
  });
  </script>
</body>
</html>