<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>購物匯率計算機 v7 (含匯出)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入匯出所需的函式庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { touch-action: manipulation; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        [contenteditable="true"]:focus {
            outline: none;
            background-color: #eff6ff;
            border-bottom: 2px solid #3b82f6;
            border-radius: 4px;
            padding: 2px 4px;
        }
        .name-field:empty::before {
            content: attr(placeholder);
            color: #94a3b8;
            font-style: italic;
            pointer-events: none;
        }
        .editable-cursor { cursor: text; }
        
        .rate-panel {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .rate-panel.open {
            max-height: 280px;
            opacity: 1;
        }

        /* 專門用於生成圖片/PDF 的收據樣式，平時隱藏 */
        #exportReceipt {
            position: absolute;
            top: -9999px;
            left: -9999px;
            width: 500px;
            background: white;
            padding: 20px;
            font-family: sans-serif;
            color: #1e293b;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-20 font-sans text-slate-800">

    <!-- 頂部總額與控制區 (Sticky Header) -->
    <div class="sticky top-0 z-20 bg-blue-600 text-white shadow-lg rounded-b-2xl transition-all duration-300">
        <div class="max-w-md mx-auto px-4 py-3">
            
            <div class="flex justify-between items-center mb-2 opacity-90">
                <h1 class="text-sm font-medium tracking-wide flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>
                    購物計算機 v7
                </h1>
                <div class="flex gap-2">
                    <button id="toggleRateBtn" class="text-xs bg-blue-700 hover:bg-blue-800 px-3 py-1 rounded-full transition-colors border border-blue-500/30 flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                        設定
                    </button>
                    <!-- 新增匯出按鈕 -->
                    <button id="exportBtn" class="text-xs bg-emerald-600 hover:bg-emerald-700 px-3 py-1 rounded-full transition-colors border border-emerald-500/30 flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        匯出
                    </button>
                    <button id="clearBtn" class="text-xs bg-blue-700 hover:bg-blue-800 px-3 py-1 rounded-full transition-colors disabled:opacity-50 disabled:cursor-not-allowed border border-blue-500/30">
                        清空
                    </button>
                </div>
            </div>

            <!-- 匯率設定面板 -->
            <div id="ratePanel" class="rate-panel bg-blue-800/30 rounded-xl mb-2">
                <div class="p-3 space-y-2">
                    <div class="flex items-end gap-2 text-xs">
                        <div class="flex-1">
                            <label class="block text-blue-200 mb-1">消費幣別 (Base)</label>
                            <select id="currencyBase" class="currency-select w-full bg-blue-900 text-white rounded p-1.5 border border-blue-500">
                                <option value="TWD">TWD (台幣)</option>
                                <option value="JPY" selected>JPY (日幣)</option>
                                <option value="KRW">KRW (韓元)</option>
                                <option value="USD">USD (美金)</option>
                                <option value="AUD">AUD (澳幣)</option>
                                <option value="EUR">EUR (歐元)</option>
                                <option value="CNY">CNY (人民幣)</option>
                                <option value="HKD">HKD (港幣)</option>
                                <option value="THB">THB (泰銖)</option>
                                <option value="GBP">GBP (英鎊)</option>
                                <option value="SGD">SGD (新幣)</option>
                                <option value="MYR">MYR (馬幣)</option>
                                <option value="VND">VND (越南盾)</option>
                                <option value="CAD">CAD (加幣)</option>
                            </select>
                        </div>
                        
                        <button id="swapCurrencyBtn" class="mb-1 p-1.5 bg-blue-700 hover:bg-blue-600 rounded-full text-blue-200 transition-colors" title="交換幣別">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 16V4M7 4L3 8M7 4L11 8"/><path d="M17 8V20M17 20L21 16M17 20L13 16"/></svg>
                        </button>

                        <div class="flex-1">
                            <label class="block text-blue-200 mb-1">換算顯示 (Target)</label>
                            <select id="currencyTarget" class="currency-select w-full bg-blue-900 text-white rounded p-1.5 border border-blue-500">
                                <option value="TWD" selected>TWD (台幣)</option>
                                <option value="JPY">JPY (日幣)</option>
                                <option value="KRW">KRW (韓元)</option>
                                <option value="USD">USD (美金)</option>
                                <option value="AUD">AUD (澳幣)</option>
                                <option value="EUR">EUR (歐元)</option>
                                <option value="CNY">CNY (人民幣)</option>
                                <option value="HKD">HKD (港幣)</option>
                                <option value="THB">THB (泰銖)</option>
                                <option value="GBP">GBP (英鎊)</option>
                                <option value="SGD">SGD (新幣)</option>
                                <option value="MYR">MYR (馬幣)</option>
                                <option value="VND">VND (越南盾)</option>
                                <option value="CAD">CAD (加幣)</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="flex-1">
                            <label class="block text-blue-200 text-[10px] mb-0.5">匯率 (自動/手動)</label>
                            <input type="number" id="rateInput" step="0.0001" class="w-full bg-blue-900 text-white rounded p-1 text-xs border border-blue-500" placeholder="匯率">
                        </div>
                        <button id="fetchRateBtn" class="mt-4 px-3 py-1 bg-blue-500 hover:bg-blue-400 text-xs rounded shadow-sm flex items-center gap-1 h-[26px]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M21.34 5.5A10 10 0 1 1 11 2.64"/></svg> 更新
                        </button>
                    </div>
                    <div id="apiStatus" class="text-[10px] text-blue-300 text-center hidden"></div>
                </div>
            </div>

            <!-- 總金額顯示 -->
            <div class="flex flex-col items-center justify-center py-1 mb-2">
                <div class="flex items-baseline gap-1">
                    <span id="baseCurrencyLabel" class="text-sm font-medium opacity-80">JPY</span>
                    <span id="totalDisplay" class="text-4xl font-bold tracking-tight">0</span>
                </div>
                <!-- 換算顯示 -->
                <div id="convertedDisplayContainer" class="text-blue-100 text-sm font-medium bg-blue-800/30 px-3 py-1 rounded-full mt-1 flex items-center gap-2">
                    <span>≈</span>
                    <span id="convertedDisplay">$0</span>
                    <span id="targetCurrencyLabel">TWD</span>
                    <span class="text-[10px] opacity-60 ml-1">(匯率: <span id="currentRateDisplay">--</span>)</span>
                </div>
            </div>

            <!-- 排序按鈕組 -->
            <div class="flex justify-center w-full">
                <div class="inline-flex bg-blue-800/40 p-1 rounded-lg gap-1 w-full max-w-[320px]">
                    <button id="sortDefault" class="flex-1 py-1.5 text-xs rounded-md transition-all font-medium text-center text-blue-100 hover:bg-blue-700/50">
                        時間
                    </button>
                    <button id="sortAsc" class="flex-1 py-1.5 text-xs rounded-md transition-all font-medium text-center text-blue-100 hover:bg-blue-700/50">
                        低→高
                    </button>
                    <button id="sortDesc" class="flex-1 py-1.5 text-xs rounded-md transition-all font-medium text-center text-blue-100 hover:bg-blue-700/50">
                        高→低
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-md mx-auto px-2 mt-4">
        <!-- 輸入區域 -->
        <div class="bg-white rounded-xl shadow-sm p-3 mb-4 border border-slate-200 z-10 sticky top-[10px]">
            <form id="itemForm" class="flex flex-col gap-2">
                <div class="flex gap-2">
                    <div class="flex-1">
                        <input type="text" id="nameInput" placeholder="輸入新項目品名..." class="w-full bg-slate-50 border border-slate-200 text-slate-800 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all">
                    </div>
                    <div class="w-1/3 min-w-[90px] relative">
                        <input type="number" id="priceInput" inputmode="decimal" placeholder="價格" required class="w-full bg-slate-50 border border-slate-200 text-slate-800 rounded-lg px-3 py-2 font-mono font-medium text-right text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all pr-8">
                        <span id="inputCurrencyLabel" class="absolute right-2 top-2 text-xs text-slate-400 font-bold">JPY</span>
                    </div>
                </div>
                <button type="submit" class="w-full py-2.5 rounded-lg font-bold text-white text-sm shadow-sm flex items-center justify-center gap-2 transition-transform active:scale-95 bg-blue-600 hover:bg-blue-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> 加入清單
                </button>
            </form>
        </div>

        <!-- 清單區域 -->
        <div id="listContainer" class="space-y-1 pb-10"></div>
        
        <!-- 空狀態 -->
        <div id="emptyState" class="hidden text-center py-8 text-slate-400 flex-col items-center">
            <p class="text-sm">目前沒有項目</p>
            <p class="text-xs mt-2 opacity-60">輸入價格後按下加入</p>
        </div>
    </div>

    <!-- 隱藏的收據 DOM (用於生成 PNG/PDF) -->
    <div id="exportReceipt">
        <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px dashed #ccc; padding-bottom: 15px;">
            <h2 style="font-size: 24px; font-weight: bold; margin: 0; color: #2563eb;">購物清單</h2>
            <p style="margin: 5px 0 0 0; color: #64748b; font-size: 14px;" id="receiptDate">Date: 2023-10-27</p>
            <p style="margin: 2px 0 0 0; color: #64748b; font-size: 14px;">匯率: <span id="receiptRate">0.21</span> (<span id="receiptBase">JPY</span> → <span id="receiptTarget">TWD</span>)</p>
        </div>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
            <thead>
                <tr style="border-bottom: 2px solid #334155;">
                    <th style="text-align: left; padding: 8px 4px; color: #475569;">品名</th>
                    <th style="text-align: right; padding: 8px 4px; color: #475569;">金額 (<span class="receiptBaseLabel">JPY</span>)</th>
                    <th style="text-align: right; padding: 8px 4px; color: #475569;">約 (<span class="receiptTargetLabel">TWD</span>)</th>
                </tr>
            </thead>
            <tbody id="receiptItems" style="font-size: 16px;">
                <!-- Items will be injected here -->
            </tbody>
            <tfoot>
                <tr style="border-top: 2px solid #334155; font-weight: bold;">
                    <td style="padding: 12px 4px;">總計</td>
                    <td style="text-align: right; padding: 12px 4px;" id="receiptTotalBase">0</td>
                    <td style="text-align: right; padding: 12px 4px; color: #2563eb;" id="receiptTotalTarget">0</td>
                </tr>
            </tfoot>
        </table>
        <div style="text-align: center; color: #94a3b8; font-size: 12px; margin-top: 30px;">
            Generated by Shopping Calculator
        </div>
    </div>

    <!-- 清空確認 Modal -->
    <div id="clearModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm transform transition-all scale-100">
            <div class="flex flex-col items-center text-center gap-3">
                <div class="bg-red-100 p-3 rounded-full text-red-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                </div>
                <h3 class="text-lg font-bold text-slate-800">確定要清空嗎？</h3>
                <div class="grid grid-cols-2 gap-3 w-full mt-2">
                    <button id="cancelModalBtn" class="py-2.5 px-4 rounded-xl border border-slate-200 font-medium text-slate-600 hover:bg-slate-50">取消</button>
                    <button id="confirmClearBtn" class="py-2.5 px-4 rounded-xl bg-red-600 font-medium text-white shadow-lg hover:bg-red-700">確認清空</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 匯出格式選擇 Modal -->
    <div id="exportFormatModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-slate-800 text-center mb-4">選擇匯出格式</h3>
            <div class="space-y-3">
                <button onclick="prepareExport('png')" class="w-full flex items-center p-3 rounded-xl border border-slate-200 hover:bg-slate-50 transition-colors">
                    <div class="bg-blue-100 text-blue-600 p-2 rounded-lg mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                    </div>
                    <div class="text-left">
                        <div class="font-bold text-slate-800">圖片 (PNG)</div>
                        <div class="text-xs text-slate-500">適合分享到通訊軟體</div>
                    </div>
                </button>
                <button onclick="prepareExport('xlsx')" class="w-full flex items-center p-3 rounded-xl border border-slate-200 hover:bg-slate-50 transition-colors">
                    <div class="bg-green-100 text-green-600 p-2 rounded-lg mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                    </div>
                    <div class="text-left">
                        <div class="font-bold text-slate-800">Excel (XLSX)</div>
                        <div class="text-xs text-slate-500">適合後續編輯計算</div>
                    </div>
                </button>
                <button onclick="prepareExport('pdf')" class="w-full flex items-center p-3 rounded-xl border border-slate-200 hover:bg-slate-50 transition-colors">
                    <div class="bg-red-100 text-red-600 p-2 rounded-lg mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="M9 15l3 3 3-3"/></svg>
                    </div>
                    <div class="text-left">
                        <div class="font-bold text-slate-800">文件 (PDF)</div>
                        <div class="text-xs text-slate-500">適合保存紀錄</div>
                    </div>
                </button>
            </div>
            <button onclick="closeExportModal()" class="w-full mt-4 py-2.5 text-slate-500 font-medium hover:text-slate-800">取消</button>
        </div>
    </div>

    <!-- 匯出動作 Modal (分享/下載) -->
    <div id="exportActionModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center">
            <div id="exportLoading" class="py-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                <p class="text-sm text-slate-500 mt-2">正在處理...</p>
            </div>
            <div id="exportActions" class="hidden">
                <h3 class="text-lg font-bold text-slate-800 mb-2">檔案已就緒</h3>
                <p class="text-sm text-slate-500 mb-4" id="exportFileInfo">Format: PNG</p>
                <div class="grid grid-cols-2 gap-3">
                    <button id="downloadBtn" class="py-2.5 px-4 rounded-xl bg-slate-100 text-slate-800 font-bold hover:bg-slate-200 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        儲存
                    </button>
                    <button id="shareBtn" class="py-2.5 px-4 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                        分享
                    </button>
                </div>
                <button onclick="closeActionModal()" class="w-full mt-4 py-2 text-slate-400 text-sm">關閉</button>
            </div>
        </div>
    </div>

    <script>
        // --- 資料狀態 ---
        let items = JSON.parse(localStorage.getItem('shoppingItems')) || [];
        let sortState = 'default';
        
        // 匯率設定
        let exchangeSettings = JSON.parse(localStorage.getItem('exchangeSettings')) || {
            base: 'JPY',
            target: 'TWD',
            rate: 0.215,
            isManual: false
        };

        // --- DOM 元素 ---
        const els = {
            form: document.getElementById('itemForm'),
            nameInput: document.getElementById('nameInput'),
            priceInput: document.getElementById('priceInput'),
            listContainer: document.getElementById('listContainer'),
            emptyState: document.getElementById('emptyState'),
            totalDisplay: document.getElementById('totalDisplay'),
            clearBtn: document.getElementById('clearBtn'),
            sortBtns: {
                default: document.getElementById('sortDefault'),
                asc: document.getElementById('sortAsc'),
                desc: document.getElementById('sortDesc')
            },
            clearModal: document.getElementById('clearModal'),
            cancelModalBtn: document.getElementById('cancelModalBtn'),
            confirmClearBtn: document.getElementById('confirmClearBtn'),
            
            // 匯率相關元素
            toggleRateBtn: document.getElementById('toggleRateBtn'),
            ratePanel: document.getElementById('ratePanel'),
            currencyBase: document.getElementById('currencyBase'),
            currencyTarget: document.getElementById('currencyTarget'),
            swapCurrencyBtn: document.getElementById('swapCurrencyBtn'),
            rateInput: document.getElementById('rateInput'),
            fetchRateBtn: document.getElementById('fetchRateBtn'),
            apiStatus: document.getElementById('apiStatus'),
            
            // 顯示相關
            baseCurrencyLabel: document.getElementById('baseCurrencyLabel'),
            inputCurrencyLabel: document.getElementById('inputCurrencyLabel'),
            convertedDisplay: document.getElementById('convertedDisplay'),
            targetCurrencyLabel: document.getElementById('targetCurrencyLabel'),
            currentRateDisplay: document.getElementById('currentRateDisplay'),

            // 匯出相關
            exportBtn: document.getElementById('exportBtn'),
            exportFormatModal: document.getElementById('exportFormatModal'),
            exportActionModal: document.getElementById('exportActionModal'),
            exportLoading: document.getElementById('exportLoading'),
            exportActions: document.getElementById('exportActions'),
            downloadBtn: document.getElementById('downloadBtn'),
            shareBtn: document.getElementById('shareBtn'),
            exportFileInfo: document.getElementById('exportFileInfo'),
            
            // 隱藏收據 DOM
            exportReceipt: document.getElementById('exportReceipt'),
            receiptDate: document.getElementById('receiptDate'),
            receiptRate: document.getElementById('receiptRate'),
            receiptBase: document.getElementById('receiptBase'),
            receiptTarget: document.getElementById('receiptTarget'),
            receiptItems: document.getElementById('receiptItems'),
            receiptTotalBase: document.getElementById('receiptTotalBase'),
            receiptTotalTarget: document.getElementById('receiptTotalTarget'),
            receiptBaseLabels: document.querySelectorAll('.receiptBaseLabel'),
            receiptTargetLabels: document.querySelectorAll('.receiptTargetLabel')
        };

        // --- 初始化 ---
        init();

        function init() {
            els.currencyBase.value = exchangeSettings.base;
            els.currencyTarget.value = exchangeSettings.target;
            els.rateInput.value = exchangeSettings.rate;
            
            if (!exchangeSettings.isManual) {
                fetchExchangeRate();
            }

            updateCurrencyLabels();
            updateSortBtnStyles();
            render();
        }

        // --- 匯率邏輯 ---

        els.toggleRateBtn.addEventListener('click', () => {
            els.ratePanel.classList.toggle('open');
        });

        // 交換按鈕
        els.swapCurrencyBtn.addEventListener('click', () => {
            els.swapCurrencyBtn.style.transform = "rotate(180deg)";
            setTimeout(() => els.swapCurrencyBtn.style.transform = "rotate(0deg)", 300);

            const temp = exchangeSettings.base;
            exchangeSettings.base = exchangeSettings.target;
            exchangeSettings.target = temp;
            
            els.currencyBase.value = exchangeSettings.base;
            els.currencyTarget.value = exchangeSettings.target;
            
            exchangeSettings.isManual = false;
            updateCurrencyLabels();
            fetchExchangeRate(); 
            saveSettings();
        });

        els.currencyBase.addEventListener('change', (e) => {
            exchangeSettings.base = e.target.value;
            exchangeSettings.isManual = false;
            updateCurrencyLabels();
            fetchExchangeRate();
            saveSettings();
        });

        els.currencyTarget.addEventListener('change', (e) => {
            exchangeSettings.target = e.target.value;
            exchangeSettings.isManual = false;
            updateCurrencyLabels();
            fetchExchangeRate();
            saveSettings();
        });

        els.rateInput.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            if (!isNaN(val) && val > 0) {
                exchangeSettings.rate = val;
                exchangeSettings.isManual = true;
                saveSettings();
                render();
            }
        });

        els.fetchRateBtn.addEventListener('click', fetchExchangeRate);

        async function fetchExchangeRate() {
            const base = exchangeSettings.base;
            const target = exchangeSettings.target;

            els.fetchRateBtn.innerHTML = '...';
            els.fetchRateBtn.disabled = true;
            els.apiStatus.classList.add('hidden');

            try {
                if (base === target) {
                    updateRate(1);
                    return;
                }

                const url = `https://api.exchangerate-api.com/v4/latest/${base}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('API Error');
                
                const data = await response.json();
                const rate = data.rates[target];
                
                if (rate) {
                    updateRate(rate);
                    exchangeSettings.isManual = false;
                    saveSettings();
                    els.apiStatus.textContent = `更新成功 (1 ${base} = ${rate} ${target})`;
                    els.apiStatus.classList.remove('hidden');
                } else {
                    alert(`找不到 ${base} 到 ${target} 的匯率`);
                }

            } catch (error) {
                console.error("匯率抓取失敗:", error);
                els.apiStatus.textContent = "更新失敗，請檢查網路";
                els.apiStatus.classList.remove('hidden');
            } finally {
                els.fetchRateBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M21.34 5.5A10 10 0 1 1 11 2.64"/></svg> 更新';
                els.fetchRateBtn.disabled = false;
            }
        }

        function updateRate(newRate) {
            exchangeSettings.rate = newRate;
            els.rateInput.value = newRate < 0.01 ? newRate.toFixed(6) : newRate; 
            saveSettings();
            render();
        }

        function updateCurrencyLabels() {
            els.baseCurrencyLabel.textContent = exchangeSettings.base;
            els.inputCurrencyLabel.textContent = exchangeSettings.base;
            els.targetCurrencyLabel.textContent = exchangeSettings.target;
            render(); 
        }

        function saveSettings() {
            localStorage.setItem('exchangeSettings', JSON.stringify(exchangeSettings));
        }

        // --- 匯出功能 ---

        els.exportBtn.addEventListener('click', () => {
            if (items.length === 0) {
                alert("清單是空的，無法匯出");
                return;
            }
            els.exportFormatModal.classList.remove('hidden');
        });

        function closeExportModal() {
            els.exportFormatModal.classList.add('hidden');
        }

        function closeActionModal() {
            els.exportActionModal.classList.add('hidden');
            // 清理 URL
            if (window.currentExportUrl) {
                URL.revokeObjectURL(window.currentExportUrl);
                window.currentExportUrl = null;
            }
        }

        // 準備並生成檔案
        async function prepareExport(type) {
            closeExportModal();
            els.exportActionModal.classList.remove('hidden');
            els.exportLoading.classList.remove('hidden');
            els.exportActions.classList.add('hidden');

            const dateStr = new Date().toISOString().split('T')[0];
            const filename = `ShoppingList_${dateStr}`;
            
            try {
                let blob, fileObj;

                if (type === 'png') {
                    blob = await generatePNGBlob();
                    fileObj = new File([blob], `${filename}.png`, { type: 'image/png' });
                    els.exportFileInfo.textContent = `Format: PNG Image`;
                } 
                else if (type === 'xlsx') {
                    blob = generateXLSXBlob();
                    fileObj = new File([blob], `${filename}.xlsx`, { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    els.exportFileInfo.textContent = `Format: Excel (.xlsx)`;
                } 
                else if (type === 'pdf') {
                    blob = await generatePDFBlob();
                    fileObj = new File([blob], `${filename}.pdf`, { type: 'application/pdf' });
                    els.exportFileInfo.textContent = `Format: PDF Document`;
                }

                // 處理 UI 狀態
                els.exportLoading.classList.add('hidden');
                els.exportActions.classList.remove('hidden');

                // 設定下載按鈕
                window.currentExportUrl = URL.createObjectURL(blob);
                els.downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = window.currentExportUrl;
                    a.download = fileObj.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    closeActionModal();
                };

                // 設定分享按鈕
                // 檢查是否支援分享且允許分享該檔案類型
                if (navigator.canShare && navigator.canShare({ files: [fileObj] })) {
                    els.shareBtn.classList.remove('hidden', 'opacity-50', 'cursor-not-allowed');
                    els.shareBtn.onclick = async () => {
                        try {
                            await navigator.share({
                                files: [fileObj],
                                title: '購物清單',
                                text: `這是我的購物清單 (${dateStr})`
                            });
                            closeActionModal();
                        } catch (err) {
                            console.log('分享取消或失敗', err);
                        }
                    };
                } else {
                    // 如果不支援分享 (如電腦版 Chrome 限制多)，隱藏分享或變灰
                    els.shareBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    els.shareBtn.onclick = () => alert("您的瀏覽器或裝置目前不支援直接分享此檔案格式，請使用「儲存」功能。");
                }

            } catch (error) {
                console.error(error);
                alert("匯出發生錯誤: " + error.message);
                closeActionModal();
            }
        }

        // 填充隱藏的收據 DOM
        function populateReceipt() {
            const dateStr = new Date().toLocaleString('zh-TW', { hour12: false });
            els.receiptDate.textContent = `Date: ${dateStr}`;
            els.receiptRate.textContent = exchangeSettings.rate;
            els.receiptBase.textContent = exchangeSettings.base;
            els.receiptTarget.textContent = exchangeSettings.target;

            // 更新表頭幣別
            els.receiptBaseLabels.forEach(el => el.textContent = exchangeSettings.base);
            els.receiptTargetLabels.forEach(el => el.textContent = exchangeSettings.target);

            const displayItems = [...items]; 
            // 保持當前排序
            if (sortState === 'asc') displayItems.sort((a, b) => a.price - b.price);
            else if (sortState === 'desc') displayItems.sort((a, b) => b.price - a.price);

            let total = 0;
            els.receiptItems.innerHTML = displayItems.map(item => {
                total += item.price;
                const conv = item.price * exchangeSettings.rate;
                return `
                <tr style="border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 8px 4px; word-break: break-all;">${item.name || '(未命名)'}</td>
                    <td style="text-align: right; padding: 8px 4px;">${item.price.toLocaleString()}</td>
                    <td style="text-align: right; padding: 8px 4px; color: #64748b;">${conv.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                </tr>`;
            }).join('');

            const totalConv = total * exchangeSettings.rate;
            els.receiptTotalBase.textContent = total.toLocaleString();
            els.receiptTotalTarget.textContent = totalConv.toLocaleString(undefined, {maximumFractionDigits: 0});
        }

        // 產生 PNG
        function generatePNGBlob() {
            populateReceipt();
            return html2canvas(els.exportReceipt, { scale: 2 }).then(canvas => {
                return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
            });
        }

        // 產生 XLSX
        function generateXLSXBlob() {
            const dateStr = new Date().toISOString().split('T')[0];
            const data = items.map(item => ({
                '品名': item.name || '(未命名)',
                [`價格 (${exchangeSettings.base})`]: item.price,
                [`約 (${exchangeSettings.target})`]: Math.round(item.price * exchangeSettings.rate)
            }));
            
            // 加入總計列
            const total = items.reduce((sum, i) => sum + i.price, 0);
            data.push({
                '品名': '總計',
                [`價格 (${exchangeSettings.base})`]: total,
                [`約 (${exchangeSettings.target})`]: Math.round(total * exchangeSettings.rate)
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "購物清單");
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            return new Blob([wbout], { type: 'application/octet-stream' });
        }

        // 產生 PDF
        async function generatePDFBlob() {
            // 使用 html2canvas 先轉成圖片再放入 PDF，解決中文字型問題
            populateReceipt();
            const canvas = await html2canvas(els.exportReceipt, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            
            // 計算圖片縮放以適應 A4 寬度
            const imgProps = pdf.getImageProperties(imgData);
            const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            pdf.addImage(imgData, 'PNG', 0, 10, pdfWidth, imgHeight); // top margin 10mm
            return pdf.output('blob');
        }

        // --- 既有清單邏輯 ---

        els.form.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = els.nameInput.value.trim();
            const price = parseFloat(els.priceInput.value);

            if (!price && price !== 0) return;

            const newItem = { id: Date.now(), name, price };
            items = [newItem, ...items];
            
            els.nameInput.value = '';
            els.priceInput.value = '';
            
            if(sortState !== 'default') {
                sortState = 'default';
                updateSortBtnStyles();
            }
            
            saveAndRender();
        });

        els.sortBtns.default.addEventListener('click', () => setSort('default'));
        els.sortBtns.asc.addEventListener('click', () => setSort('asc'));
        els.sortBtns.desc.addEventListener('click', () => setSort('desc'));

        function setSort(type) {
            sortState = type;
            updateSortBtnStyles();
            render();
        }

        function updateSortBtnStyles() {
            const activeClass = ['bg-white', 'text-blue-700', 'shadow-sm'];
            const inactiveClass = ['text-blue-100', 'hover:bg-blue-700/50'];
            Object.values(els.sortBtns).forEach(btn => {
                btn.classList.remove(...activeClass);
                btn.classList.add(...inactiveClass);
            });
            els.sortBtns[sortState].classList.remove(...inactiveClass);
            els.sortBtns[sortState].classList.add(...activeClass);
        }

        els.listContainer.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('button[data-action="delete"]');
            if (deleteBtn) {
                const id = parseInt(deleteBtn.dataset.id);
                items = items.filter(item => item.id !== id);
                saveAndRender();
            }
        });

        els.listContainer.addEventListener('focusin', (e) => {
            const target = e.target;
            if (target.dataset.field === 'price') {
                const id = parseInt(target.dataset.id);
                const item = items.find(i => i.id === id);
                if (item) target.textContent = item.price;
            }
        }, true);

        els.listContainer.addEventListener('focusout', (e) => {
            const target = e.target;
            if (target.getAttribute('contenteditable') === 'true') {
                const id = parseInt(target.dataset.id);
                const field = target.dataset.field;
                const rawValue = target.textContent.trim();
                
                const itemIndex = items.findIndex(i => i.id === id);
                if (itemIndex > -1) {
                    if (field === 'price') {
                        let newPrice = parseFloat(rawValue);
                        if (isNaN(newPrice)) newPrice = 0;
                        items[itemIndex].price = newPrice;
                        saveAndRender();
                    } else if (field === 'name') {
                        items[itemIndex].name = rawValue;
                        if (rawValue === '') target.textContent = '';
                        localStorage.setItem('shoppingItems', JSON.stringify(items));
                    }
                }
            }
        });

        els.listContainer.addEventListener('keydown', (e) => {
            if (e.target.getAttribute('contenteditable') === 'true' && e.key === 'Enter') {
                e.preventDefault();
                e.target.blur();
            }
        });

        els.clearBtn.addEventListener('click', () => {
            if (items.length > 0) els.clearModal.classList.remove('hidden');
        });
        els.cancelModalBtn.addEventListener('click', () => els.clearModal.classList.add('hidden'));
        els.confirmClearBtn.addEventListener('click', () => {
            items = [];
            setSort('default');
            saveAndRender();
            els.clearModal.classList.add('hidden');
        });

        function saveAndRender() {
            localStorage.setItem('shoppingItems', JSON.stringify(items));
            render();
        }

        function render() {
            const total = items.reduce((sum, item) => sum + item.price, 0);
            
            els.totalDisplay.textContent = total.toLocaleString();
            
            const rate = exchangeSettings.rate;
            const convertedTotal = total * rate;
            
            const displayConverted = convertedTotal.toLocaleString(undefined, { 
                maximumFractionDigits: convertedTotal > 1000 ? 0 : 2 
            });
            
            els.convertedDisplay.textContent = '$' + displayConverted;
            els.currentRateDisplay.textContent = rate < 0.01 ? rate.toFixed(6) : rate;

            els.clearBtn.disabled = items.length === 0;

            if (items.length === 0) {
                els.listContainer.innerHTML = '';
                els.emptyState.style.display = 'flex';
                els.listContainer.appendChild(els.emptyState);
                return;
            }
            els.emptyState.style.display = 'none';

            let displayItems = [...items];
            if (sortState === 'asc') displayItems.sort((a, b) => a.price - b.price);
            else if (sortState === 'desc') displayItems.sort((a, b) => b.price - a.price);

            els.listContainer.innerHTML = displayItems.map(item => {
                const itemConverted = item.price * exchangeSettings.rate;
                const itemConvertedStr = itemConverted.toLocaleString(undefined, {
                    maximumFractionDigits: itemConverted > 1000 ? 0 : 2
                });
                
                return `
                <div class="group flex items-center justify-between px-3 py-3 bg-white rounded-lg border border-slate-100 shadow-sm transition-all hover:shadow-md mb-1">
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <div class="flex flex-col items-end min-w-[70px]">
                            <div 
                                contenteditable="true" 
                                data-id="${item.id}" 
                                data-field="price"
                                inputmode="decimal"
                                class="editable-cursor text-base font-bold text-slate-800 text-right py-0.5 px-1"
                            >${item.price.toLocaleString()}</div>
                            <div class="text-[10px] text-slate-400 font-medium pr-1">
                                ≈ ${itemConvertedStr}
                            </div>
                        </div>
                        
                        <div class="h-6 w-px bg-slate-200"></div>
                        
                        <div 
                            contenteditable="true" 
                            data-id="${item.id}" 
                            data-field="name"
                            placeholder="點擊輸入名稱"
                            class="name-field editable-cursor text-sm truncate flex-1 py-1 px-1 text-slate-700"
                        >${item.name || ''}</div>
                    </div>
                    
                    <button data-id="${item.id}" data-action="delete" class="ml-2 p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            `}).join('');
        }
        
        // 讓 prepareExport 在 HTML 中可用 (雖然不在 global scope 也不會出錯，但為了保險起見)
        window.prepareExport = prepareExport;
        window.closeExportModal = closeExportModal;
        window.closeActionModal = closeActionModal;
    </script>
</body>
</html>