<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>80FLC è»Ÿé«”æ›´æ–°çµ±è¨ˆå ±å‘Š (æœ€çµ‚ç‰ˆ - åœ–ä¾‹è¦–è¦ºå„ªåŒ–)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
    /* è—è‰²ç³»é…è‰²æ–¹æ¡ˆ */
    :root {
        --color-primary-dark: #1A237E;      
        --color-primary-light: #BBDEFB;     
        --color-highlight: #42A5F5;         
        --color-total: #0D47A1;             
        --color-subtle-bg: #E3F2FD;         
        --color-alert: #D32F2F;             
        
        /* åœ“é¤…åœ–å¼·å°æ¯”è‰² */
        --color-chart-north: #42A5F5;       
        --color-chart-central: #FF5722;     
        --color-chart-south: #4CAF50;       
    }

    /* åŸºç¤èˆ‡èƒŒæ™¯ */
    body {
        margin: 0;
        padding: 10px;
        
        font-family: 'Microsoft JhengHei','Noto Sans TC',sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
    }

    /* æ ¸å¿ƒå¡ç‰‡ (é–å®š 4:3 æ¯”ä¾‹) */
    .card {
        width: 750px;
        height: 562.5px; /* é–å®š 4:3 æ¯”ä¾‹ */
        background: white;
        overflow: hidden; 
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
    }

    /* æ¨™é ­å€ */
    header {
        background: #0D47A1;
        color: #FFFFFF;
        padding: 20px;
        text-align: center;
        flex-shrink: 0; 
    }
    h1 {
        margin: 0;
        font-size: 32px;
        font-weight: 600;
    }
    .date {
        font-size: 18px;
        margin-top: 3px;
        opacity: 0.9;
    }

    /* å…§å®¹å€ï¼šå·¦å³åˆ†æ¬„ */
    .content {
        padding: 20px;
        display: flex;
        flex-grow: 1;
        gap: 20px;
        min-height: 0;
    }
    
    /* å·¦å³åˆ†æ¬„æ¨£å¼ */
    .column {
        flex: 1; 
        padding-right: 0; 
        display: flex;
        flex-direction: column;
        overflow: hidden; 
    }

    /* å³å´æ¬„ä½ä¿®æ­£ (æ°´å¹³å¡«æ»¿) */
    .content > .column:nth-child(2) {
        margin-right: -20px; /* æ‹‰ä¼¸è‡³å¡ç‰‡é‚Šç·£ */
        padding-right: 20px; 
    }

    /* å€å¡Šæ¨™é¡Œ */
    h3 {
        margin: 0 0 10px 0;
        font-size: 20px;
        font-weight: 500;
        color: var(--color-primary-dark);
        border-bottom: 1px solid var(--color-primary-light);
        padding-bottom: 5px;
        flex-shrink: 0;
    }

    /* è¡¨æ ¼åŸºç¤æ¨£å¼ */
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 24px;
        margin-bottom: 0;
        table-layout: fixed; 
    }
    td {
        padding: 2px 3px; 
        text-align: center;
        border-bottom: none; 
        vertical-align: middle; 
        word-break: break-all; 
    }
    
    /* æ¬„ä½å¯¬åº¦æ¯”ä¾‹ */
    #current-month-table td:first-child,
    #history-table td:first-child {
        width: 35%; 
        text-align: left;
        color: var(--color-primary-dark);
        font-weight: 600;
        white-space: nowrap; 
    }
    #current-month-table td,
    #history-table td {
        width: 21.66%; 
    }


    /* --- å·¦æ¬„ï¼šæœ¬æœˆçµ±è¨ˆ (å‚ç›´å£“ç¸®) --- */
    
    /* åœ“é¤…åœ–å®¹å™¨ */
    #pie-chart-container {
        flex-shrink: 0;
        height: 140px; 
        width: 100%;
        margin-bottom: 8px; 
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* æœ¬æœˆè¡¨æ ¼ä½”ç”¨æ‰€æœ‰å‰©é¤˜ç©ºé–“ */
    #current-month-table {
        flex-grow: 1; 
        flex-direction: column;
        justify-content: space-evenly; 
        height: 100%;
    }

    /* åˆ†è™•æ•¸å­—åŠ å¤§ */
    #current-month-table td {
        padding: 5px 3px; 
        font-size: 18px; 
    }
    
    #current-month-table .num {
        font-size: 30px; 
        font-weight: bold;
        color: var(--color-highlight);
    }
    
    /* ç¸½è¨ˆè¡Œ */
    #current-month-table .total td {
        background: var(--color-subtle-bg);
        font-size: 20px; 
        border-top: 2px solid var(--color-total);
        padding: 8px 3px; 
    }
    #current-month-table .total .num {
        font-size: 50px; 
        color: var(--color-total);
    }


    /* --- å³æ¬„ï¼šæ­·å²æ•¸æ“š (ç„¡æ²è»¸) --- */
    
    #history-table {
        flex-grow: 1; 
        flex-direction: column;
        height: 100%; 
        overflow-y: hidden; 
    }
    
    /* æ­·å²è¡¨æ ¼è¡¨é ­ */
    .history-header {
        flex-shrink: 0; 
    }
    .history-header td {
        font-size: 14px;
        padding: 3px 3px;
        border-bottom: 2px solid var(--color-highlight);
        background: var(--color-subtle-bg);
    }
    
    /* å‹•æ…‹æ’å…¥çš„æœˆä»½è¡Œï¼šå¯¦ç¾å‡åˆ†é«˜/ä½”æ»¿å‰©é¤˜ç©ºé–“çš„é—œéµ */
    #history-table tr:not(.history-header):not(.grand-total-row):not(.total-sum-row) {
        flex: 1; 
    }
    
    /* æ­·å²æœˆä»½æ¬„å­—é«” */
    #history-table tr:not(.history-header):not(.grand-total-row):not(.total-sum-row) td:first-child {
        font-size: 14px; 
        font-weight: normal;
        color: var(--color-primary-dark);
        text-align: left;
        white-space: nowrap;
    }

    /* æ•¸æ“šè¡Œé‚Šæ¡†ä¿®æ­£ */
    #history-table tr.data-row:not(.empty-fill) td {
        border-bottom: 1px dashed #E0E0E0;
    }
    
    /* æ­·å²æ¯æœˆæ•¸æ“š */
    #history-table .history-num {
        font-size: 12px; 
        font-weight: 500;
        color: var(--color-primary-dark);
    }
    
    /* ç´¯è¨ˆè¡ŒåŸºç¤ */
    .grand-total-row {
        flex-shrink: 0; 
        margin-top: auto; 
        z-index: 20;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); 
    }
    .grand-total-row{
        font-size:20px
    }
    /* ç´¯è¨ˆä»¶æ•¸è¡Œ */
    .grand-total-row:not(.total-sum-row) {
        background: #FFEBEE; 
        border-top: 3px solid var(--color-alert);
    }
    
    #current-total{
        color:#b53426 !important;
    }
    td{
        text-align:center!important;
    }

    /* æ–°å¢æ¨£å¼ï¼šæ­·å²ç¸½ä»¶æ•¸ */
    .total-sum-row {
        background: #E8F5E9; /* æ·ºç¶ è‰²æˆ–å¦ä¸€ç¨®å°æ¯”è‰² */
        border-top: 3px solid var(--color-chart-south); /* ä½¿ç”¨ç¶ è‰²ç·šæ¢ */
        font-size: 20px;
    }
    .total-sum-row td {
        padding: 0px 0px;
    }
    #grand-total-sum {
        color: #2E7D32 !important; /* æ·±ç¶ è‰²å¼·èª¿ */
        font-size: 26px !important;
    }
</style>
</head>
<body>
<div class="card">
    <header>
        <h1>å°éŠ€æ¨™80FLCæ©Ÿç¨®è»Ÿé«”æ›´æ–°ä»¶æ•¸çµ±è¨ˆ</h1>
        <div class="date" id="current-month-range"></div>
    </header>
    
    <div class="content">
                <div class="column">
            <h3>ğŸ“…æœ¬æœˆ (<span id="current-month-display"></span>) çµ±è¨ˆ</h3>

            <div id="pie-chart-container">
                <canvas id="pie-chart"></canvas>
            </div>

            <table id="current-month-table">
                <tr id="north-row"><td>åŒ—è™•</td><td class="num"></td></tr>
                <tr id="central-row"><td>ä¸­è™•</td><td class="num"></td></tr>
                <tr id="south-row"><td>å—è™•</td><td class="num"></td></tr>
                <tr class="total"><td>æœ¬æœˆç¸½è¨ˆ</td><td class="num" id="current-total"></td></tr>
            </table>
        </div>

                <div class="column">
            <h3>ğŸ“š ç´¯è¨ˆä»¶æ•¸</h3>
            
            <table id="history-table">
                                <tr class="history-header">
                    <td>æœˆä»½</td>
                    <td>åŒ—è™•</td>
                    <td>ä¸­è™•</td>
                    <td>å—è™•</td>
                </tr>
                
                                    <tr class="grand-total-row">
                    <td>ç´¯è¨ˆä»¶æ•¸</td>
                    <td class="num" id="grand-total-north"></td>
                    <td class="num" id="grand-total-central"></td>
                    <td class="num" id="grand-total-south"></td>
                </tr>
                <tr class="grand-total-row total-sum-row">
                    <td>ç´¯è¨ˆç¸½ä»¶æ•¸</td>
                    <td class="num" id="grand-total-sum" colspan="3"></td>
                </tr>
            </table>
        </div>
    </div>
</div>

<script>
// *** æ¨¡æ“¬æ‚¨çš„æ­·å²æ•¸æ“š ***
const historyData = [
    { month: '2025-11', north: 0, central: 67, south: 0 },
];

function renderPieChart(data) {
    const total = data.north + data.central + data.south;
    if (total === 0) {
        document.getElementById('pie-chart-container').innerHTML = '<p style="text-align:center; color: #999; font-size:14px;">æœ¬æœˆç„¡æ›´æ–°æ•¸æ“š</p>';
        return;
    }

    const ctx = document.getElementById('pie-chart').getContext('2d');
    
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['åŒ—è™•', 'ä¸­è™•', 'å—è™•'], // ç¸®çŸ­æ¨™ç±¤ä»¥é¿å…æ›è¡Œ
            datasets: [{
                data: [data.north, data.central, data.south],
                backgroundColor: [
                    getComputedStyle(document.documentElement).getPropertyValue('--color-chart-north').trim(), 
                    getComputedStyle(document.documentElement).getPropertyValue('--color-chart-central').trim(), 
                    getComputedStyle(document.documentElement).getPropertyValue('--color-chart-south').trim()
                ],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom', 
                    labels: {
                        font: {
                            size: 12,
                            family: 'Microsoft JhengHei'
                        },
                        // *** é—œéµä¿®æ­£ï¼šä½¿ç”¨åœ“é»è‰²å¡Šä¸¦åœ¨åœ–ä¾‹ä¸­é¡¯ç¤ºç™¾åˆ†æ¯” ***
                        usePointStyle: true, // ä½¿ç”¨åœ“é»è€Œéæ–¹å½¢è‰²å¡Š
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                const totalValue = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                return data.labels.map(function(label, i) {
                                    const value = data.datasets[0].data[i];
                                    const percentage = totalValue > 0 ? (value / totalValue * 100).toFixed(1) : 0;
                                    return {
                                        text: label + ': ' + value + ' (' + percentage + '%)',
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: data.datasets[0].borderColor,
                                        lineWidth: data.datasets[0].borderWidth,
                                        // ç¢ºä¿åœ–ä¾‹æ¨™è¨˜æ˜¯é»
                                        pointStyle: 'circle',
                                        hidden: !chart.isDatasetVisible(0) || chart.getDatasetMeta(0).data[i].hidden,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            // ä¿ç•™ Tooltip çš„ç™¾åˆ†æ¯”é¡¯ç¤º
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed !== null) {
                                label += context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                label += ' (' + (context.parsed / total * 100).toFixed(1) + '%)'; 
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
}


function renderReport() {
    const historyTable = document.getElementById('history-table');
    
    // æ ¼å¼åŒ–æœˆä»½ï¼š YYYY/MM
    const formatMonth = (date) => `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}`;

    if (historyData.length === 0) {
        document.getElementById('current-month-range').textContent = 'ç„¡æ•¸æ“š';
        return;
    }

    // --- 1. è™•ç†æœ¬æœˆæ•¸æ“š (å·¦å´è¡¨æ ¼ & åœ“é¤…åœ–) ---
    const latestMonth = historyData[0];
    const latestDate = new Date(latestMonth.month + '-01');

    document.getElementById('current-month-range').textContent = `${formatMonth(latestDate)}ï¼ˆè³‡æ–™å€é–“ï¼š${latestMonth.month}-01 â€“ ${latestMonth.month}-30ï¼‰`;
    document.getElementById('current-month-display').textContent = formatMonth(latestDate);
    
    // å¡«å……å·¦å´åˆ†è™•æ•¸æ“š
    document.querySelector('#north-row td:nth-child(2)').textContent = latestMonth.north;
    document.querySelector('#central-row td:nth-child(2)').textContent = latestMonth.central;
    document.querySelector('#south-row td:nth-child(2)').textContent = latestMonth.south;

    const currentTotal = latestMonth.north + latestMonth.central + latestMonth.south;
    document.getElementById('current-total').textContent = currentTotal;

    // æ¸²æŸ“åœ“é¤…åœ–
    renderPieChart(latestMonth);

    // --- 2. è™•ç†æ­·å²æ•¸æ“š (å³å´è¡¨æ ¼) ---
    const dataToDisplay = historyData.slice(0, 12); // åªé¡¯ç¤ºè¿‘ 12 å€‹æœˆ
    
    // è¨ˆç®—æ­·å²ç¸½ç´¯è¨ˆ (åŒ…å«æ‰€æœ‰æ•¸æ“š)
    let cumulativeGrandTotal = { north: 0, central: 0, south: 0 };
    historyData.forEach(item => {
        cumulativeGrandTotal.north += item.north;
        cumulativeGrandTotal.central += item.central;
        cumulativeGrandTotal.south += item.south;
    });

    let historyHtml = '';
    const MAX_DISPLAY_MONTHS = 12; 
    
    // æ’å…¥å¯¦éš›æ•¸æ“šè¡Œ
    dataToDisplay.forEach((item, i) => {
        const monthDate = new Date(item.month + '-01');
        const monthDisplay = formatMonth(monthDate);
        const isCurrentMonth = i === 0;

        historyHtml += `
            <tr class="data-row ${isCurrentMonth ? 'current-month-row' : ''}" style="height: ${100 / MAX_DISPLAY_MONTHS}%">
                <td>${isCurrentMonth ? 'æœ¬æœˆ' : monthDisplay}</td>
                <td class="history-num">${item.north}</td>
                <td class="history-num">${item.central}</td>
                <td class="history-num">${item.south}</td>
            </tr>
        `;
    });
    
    // ç¢ºä¿ç¸½è¡Œæ•¸é”åˆ° 12 è¡Œ
    const actualDisplayMonths = dataToDisplay.length;
    const remainingRows = MAX_DISPLAY_MONTHS - actualDisplayMonths;
    if (remainingRows > 0) {
        // ä½¿ç”¨ç©ºçš„ <tr> æ­é… CSS å¯¦ç¾å‡åˆ†é«˜åº¦
        const emptyRowHtml = `<tr class="data-row empty-fill" style="height: ${100 / MAX_DISPLAY_MONTHS}%">
            <td></td><td></td><td></td><td></td>
        </tr>`;
        
        for (let i = 0; i < remainingRows; i++) {
            historyHtml += emptyRowHtml;
        }
    }


    // å°‡æœˆä»½æ•¸æ“šå’Œå¡«å……è¡Œæ’å…¥åˆ°æ­·å²è¡¨æ ¼ä¸­ (åœ¨è¡¨é ­è¡Œä¹‹å¾Œï¼Œç¸½ç´¯è¨ˆè¡Œä¹‹å‰)
    const historyHeaderRow = historyTable.querySelector('.history-header');
    const grandTotalRow = historyTable.querySelector('.grand-total-row:not(.total-sum-row)');
    if (historyHeaderRow && grandTotalRow) {
        historyHeaderRow.insertAdjacentHTML('afterend', historyHtml);
    } 
    
    // --- 3. é¡¯ç¤ºç¸½ç´¯è¨ˆ (ä½¿ç”¨åŒ…å«æ‰€æœ‰æ•¸æ“šçš„ç¸½å’Œ) ---
    document.getElementById('grand-total-north').textContent = cumulativeGrandTotal.north;
    document.getElementById('grand-total-central').textContent = cumulativeGrandTotal.central;
    document.getElementById('grand-total-south').textContent = cumulativeGrandTotal.south;

    // *** æ–°å¢ï¼šè¨ˆç®—ä¸¦é¡¯ç¤ºæ­·å²ç¸½è¨ˆ (ç¸½ä»¶æ•¸) ***
    const totalGrandSum = cumulativeGrandTotal.north + cumulativeGrandTotal.central + cumulativeGrandTotal.south;
    document.getElementById('grand-total-sum').textContent = totalGrandSum;
}

// é‹è¡Œç¨‹å¼
document.addEventListener('DOMContentLoaded', renderReport);
</script>
</body>
</html>