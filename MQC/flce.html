<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>80FLC è»Ÿé«”æ›´æ–°çµ±è¨ˆå ±å‘Š (æœ€çµ‚ç‰ˆ - å„ªåŒ–)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
    /* è—è‰²ç³»é…è‰²æ–¹æ¡ˆ */
    :root {
        --color-primary-dark: #1A237E;
        --color-primary-light: #BBDEFB;
        --color-highlight: #42A5F5;
        --color-total: #0D47A1;
        --color-subtle-bg: #E3F2FD;
        --color-alert: #D32F2F;

        /* åœ“é¤…åœ–å¼·å°æ¯”è‰² */
        --color-chart-north: #42A5F5;
        --color-chart-central: #FF5722;
        --color-chart-south: #4CAF50;
    }

    /* åŸºç¤èˆ‡èƒŒæ™¯ */
    body {
        margin: 0;
        padding: 10px;

        font-family: 'Microsoft JhengHei','Noto Sans TC',sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background-color: #f0f4f8; /* å¢åŠ èƒŒæ™¯è‰² */
    }

    /* æ ¸å¿ƒå¡ç‰‡ (é–å®š 4:3 æ¯”ä¾‹) */
    .card {
        width: 750px;
        height: 562.5px; /* é–å®š 4:3 æ¯”ä¾‹ */
        background: white;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
    }

    /* æ¨™é ­å€ */
    header {
        background: #0D47A1;
        color: #FFFFFF;
        padding: 20px;
        text-align: center;
        flex-shrink: 0;
    }
    h1 {
        margin: 0;
        font-size: 32px;
        font-weight: 600;
    }
    .date {
        font-size: 18px;
        margin-top: 3px;
        opacity: 0.9;
    }

    /* å…§å®¹å€ï¼šå·¦å³åˆ†æ¬„ */
    .content {
        padding: 20px;
        display: flex;
        flex-grow: 1;
        gap: 20px;
        min-height: 0;
    }

    /* å·¦å³åˆ†æ¬„æ¨£å¼ */
    .column {
        flex: 1;
        padding-right: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* å³å´æ¬„ä½ä¿®æ­£ (æ°´å¹³å¡«æ»¿) */
    .content > .column:nth-child(2) {
        margin-right: -20px; /* æ‹‰ä¼¸è‡³å¡ç‰‡é‚Šç·£ */
        padding-right: 20px;
    }

    /* å€å¡Šæ¨™é¡Œ */
    h3 {
        margin: 0 0 10px 0;
        font-size: 20px;
        font-weight: 500;
        color: var(--color-primary-dark);
        border-bottom: 1px solid var(--color-primary-light);
        padding-bottom: 5px;
        flex-shrink: 0;
    }

    /* è¡¨æ ¼åŸºç¤æ¨£å¼ */
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 24px;
        margin-bottom: 0;
        table-layout: fixed;
    }
    td {
        padding: 2px 3px;
        text-align: center;
        border-bottom: none;
        vertical-align: middle;
        word-break: break-all;
    }

    /* æ¬„ä½å¯¬åº¦æ¯”ä¾‹ */
    #current-month-table td:first-child,
    #history-table td:first-child {
        width: 35%;
        text-align: left;
        color: var(--color-primary-dark);
        font-weight: 600;
        white-space: nowrap;
    }
    #current-month-table td,
    #history-table td {
        width: 21.66%;
    }


    /* --- å·¦æ¬„ï¼šæœ¬æœˆçµ±è¨ˆ (å‚ç›´å£“ç¸®) --- */

    /* åœ“é¤…åœ–å®¹å™¨ */
    #pie-chart-container {
        flex-shrink: 0;
        height: 140px;
        width: 100%;
        margin-bottom: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* æœ¬æœˆè¡¨æ ¼ä½”ç”¨æ‰€æœ‰å‰©é¤˜ç©ºé–“ */
    #current-month-table {
        flex-grow: 1;
        flex-direction: column;
        justify-content: space-evenly;
        height: 100%;
    }

    /* åˆ†è™•æ•¸å­—åŠ å¤§ */
    #current-month-table td {
        padding: 5px 3px;
        font-size: 18px;
    }

    #current-month-table .num {
        font-size: 30px;
        font-weight: bold;
        color: var(--color-highlight);
    }

    /* ç¸½è¨ˆè¡Œ */
    #current-month-table .total td {
        background: var(--color-subtle-bg);
        font-size: 20px;
        border-top: 2px solid var(--color-total);
        padding: 8px 3px;
    }
    #current-month-table .total .num {
        font-size: 50px;
        color: var(--color-total);
    }


    /* --- å³æ¬„ï¼šæ­·å²æ•¸æ“š (ç„¡æ²è»¸) --- */

    #history-table {
        flex-grow: 1;
        flex-direction: column;
        height: 100%;
        overflow-y: hidden;
    }

    /* æ­·å²è¡¨æ ¼è¡¨é ­ */
    .history-header {
        flex-shrink: 0;
    }
    .history-header td {
        font-size: 14px;
        padding: 3px 3px;
        border-bottom: 2px solid var(--color-highlight);
        background: var(--color-subtle-bg);
    }

    /* å‹•æ…‹æ’å…¥çš„æœˆä»½è¡Œï¼šå¯¦ç¾å‡åˆ†é«˜/ä½”æ»¿å‰©é¤˜ç©ºé–“çš„é—œéµ */
    #history-table tr:not(.history-header):not(.grand-total-row):not(.total-sum-row) {
        flex: 1;
    }

    /* æ­·å²æœˆä»½æ¬„å­—é«” */
    #history-table tr:not(.history-header):not(.grand-total-row):not(.total-sum-row) td:first-child {
        font-size: 14px;
        font-weight: normal;
        color: var(--color-primary-dark);
        text-align: left;
        white-space: nowrap;
    }

    /* æ•¸æ“šè¡Œé‚Šæ¡†ä¿®æ­£ */
    #history-table tr.data-row:not(.empty-fill) td {
        border-bottom: 1px dashed #E0E0E0;
    }

    /* æ­·å²æ¯æœˆæ•¸æ“š */
    #history-table .history-num {
        font-size: 12px;
        font-weight: 500;
        color: var(--color-primary-dark);
    }

    /* ç´¯è¨ˆè¡ŒåŸºç¤ */
    .grand-total-row {
        flex-shrink: 0;
        margin-top: auto;
        z-index: 20;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .grand-total-row{
        font-size:20px
    }
    /* ç´¯è¨ˆä»¶æ•¸è¡Œ */
    .grand-total-row:not(.total-sum-row) {
        background: #FFEBEE;
        border-top: 3px solid var(--color-alert);
    }

    #current-total{
        color:#b53426 !important;
    }
    td{
        text-align:center!important;
    }

    /* æ–°å¢æ¨£å¼ï¼šæ­·å²ç¸½ä»¶æ•¸ */
    .total-sum-row {
        background: #E8F5E9; /* æ·ºç¶ è‰²æˆ–å¦ä¸€ç¨®å°æ¯”è‰² */
        border-top: 3px solid var(--color-chart-south); /* ä½¿ç”¨ç¶ è‰²ç·šæ¢ */
        font-size: 20px;
    }
    .total-sum-row td {
        padding: 0px 0px;
    }
    #grand-total-sum {
        color: #2E7D32 !important; /* æ·±ç¶ è‰²å¼·èª¿ */
        font-size: 26px !important;
    }

    /* ================================================= */
    /* *** æ–°å¢ï¼šç·¨è¼¯å™¨ç›¸é—œæ¨£å¼ *** */
    /* ================================================= */

    /* æµ®å‹•ç·¨è¼¯æŒ‰éˆ• */
    #edit-button {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: var(--color-highlight);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: background-color 0.3s;
        z-index: 1000; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
    }
    #edit-button:hover {
        background-color: #1E88E5;
    }

    /* ç·¨è¼¯å™¨æµ®å‹•è¦–çª— */
    #editor-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 999;
        justify-content: center;
        align-items: center;
    }

    .editor-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 800px;
        max-height: 80%;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid var(--color-primary-light);
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .editor-header h2 {
        margin: 0;
        font-size: 24px;
        color: var(--color-primary-dark);
    }

    .close-button {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #757575;
    }

    /* ç·¨è¼¯è¡¨æ ¼å®¹å™¨ */
    .editor-table-container {
        flex-grow: 1;
        overflow-y: auto; /* å…è¨±è¡¨æ ¼å…§å®¹æ²å‹• */
        margin-bottom: 15px;
    }

    /* ç·¨è¼¯è¡¨æ ¼æ¨£å¼ */
    #edit-data-table {
        width: 100%;
        table-layout: fixed;
    }
    #edit-data-table th, #edit-data-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
        font-size: 14px;
    }
    #edit-data-table th {
        background-color: var(--color-subtle-bg);
        color: var(--color-primary-dark);
        font-weight: 600;
    }
    /* åˆªé™¤æ¬„ä½æ¨£å¼ */
    #edit-data-table th:last-child {
        width: 10%;
    }
    /* å¯ç·¨è¼¯å„²å­˜æ ¼ */
    #edit-data-table td[contenteditable="true"] {
        background-color: #FFFDE7; /* æ·ºé»ƒè‰²è¡¨ç¤ºå¯ç·¨è¼¯ */
        cursor: text;
        /* é¿å…å…‰æ¨™è·³è½‰çš„é—œéµï¼šç§»é™¤ oninput æ™‚çš„é‡æ–°æ¸²æŸ“/é©—è­‰é‚è¼¯ï¼Œæ”¹ç”¨ onblur */
    }
    /* æœˆä»½æ¬„ä½å›ºå®šå¯¬åº¦ */
    #edit-data-table th:first-child {
        width: 25%;
    }

    /* åˆ†é èˆ‡æ“ä½œæ§åˆ¶ */
    .editor-controls {
        display: flex;
        flex-direction: column;
    }
    .pagination-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .pagination-controls button {
        padding: 5px 10px;
        background-color: var(--color-highlight);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .pagination-controls button:disabled {
        background-color: #BDBDBD;
        cursor: not-allowed;
    }

    .pagination-controls span {
        font-weight: 600;
        color: var(--color-primary-dark);
    }

    /* æ–°å¢æŒ‰éˆ• */
    #add-month-button {
        background-color: var(--color-chart-north);
        color: white;
        padding: 10px;
        font-size: 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 5px; /* çµ¦åº•éƒ¨ä¸€äº›é–“éš” */
    }
    #add-month-button:hover { background-color: #1E88E5; }

    /* åˆªé™¤æŒ‰éˆ• */
    .delete-btn {
        background-color: var(--color-alert);
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
    }
    .delete-btn:hover {
        background-color: #A31F1F;
    }
</style>
</head>
<body>
<button id="edit-button">ç·¨è¼¯æ•¸æ“š âœï¸</button>

<div class="card">
    <header>
        <h1>å°éŠ€æ¨™80FLCæ©Ÿç¨®è»Ÿé«”æ›´æ–°ä»¶æ•¸çµ±è¨ˆ</h1>
        <div class="date" id="current-month-range"></div>
    </header>

    <div class="content">
        <div class="column">
            <h3>ğŸ“…æœ¬æœˆ (<span id="current-month-display"></span>) çµ±è¨ˆ</h3>

            <div id="pie-chart-container">
                <canvas id="pie-chart"></canvas>
            </div>

            <table id="current-month-table">
                <tr id="north-row"><td>åŒ—è™•</td><td class="num"></td></tr>
                <tr id="central-row"><td>ä¸­è™•</td><td class="num"></td></tr>
                <tr id="south-row"><td>å—è™•</td><td class="num"></td></tr>
                <tr class="total"><td>æœ¬æœˆç¸½è¨ˆ</td><td class="num" id="current-total"></td></tr>
            </table>
        </div>

        <div class="column">
            <h3>ğŸ“š ç´¯è¨ˆä»¶æ•¸</h3>

            <table id="history-table">
                <tr class="history-header">
                    <td>æœˆä»½</td>
                    <td>åŒ—è™•</td>
                    <td>ä¸­è™•</td>
                    <td>å—è™•</td>
                </tr>

                <tr class="grand-total-row">
                    <td>ç´¯è¨ˆä»¶æ•¸</td>
                    <td class="num" id="grand-total-north"></td>
                    <td class="num" id="grand-total-central"></td>
                    <td class="num" id="grand-total-south"></td>
                </tr>
                <tr class="grand-total-row total-sum-row">
                    <td>ç´¯è¨ˆç¸½ä»¶æ•¸</td>
                    <td class="num" id="grand-total-sum" colspan="3"></td>
                </tr>
            </table>
        </div>
    </div>
</div>

<div id="editor-modal">
    <div class="editor-content">
        <div class="editor-header">
            <h2>ç·¨è¼¯æ­·å²æ•¸æ“š (å³æ™‚ä¿å­˜)</h2>
            <button class="close-button" id="close-editor-button">&times;</button>
        </div>

        <div class="editor-table-container">
            <table id="edit-data-table">
                <thead>
                    <tr>
                        <th style="width: 25%;">æœˆä»½ (YYYY-MM)</th>
                        <th style="width: 20%;">åŒ—è™•</th>
                        <th style="width: 20%;">ä¸­è™•</th>
                        <th style="width: 20%;">å—è™•</th>
                        <th style="width: 15%;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="editor-table-body">
                    </tbody>
            </table>
        </div>

        <div class="editor-controls">
            <div class="pagination-controls">
                <button id="prev-page-button">ä¸Šä¸€é </button>
                <span id="page-info"></span>
                <button id="next-page-button">ä¸‹ä¸€é </button>
            </div>
            <button id="add-month-button">â• æ–°å¢æœˆä»½</button>
        </div>
    </div>
</div>

<script>
    // LocalStorage Key
    const STORAGE_KEY = '80FLC_SoftwareUpdateHistory';

    // æ¨¡æ“¬æ‚¨çš„åˆå§‹æ­·å²æ•¸æ“šï¼ˆç•¶ LocalStorage ä¸­æ²’æœ‰æ•¸æ“šæ™‚ä½¿ç”¨ï¼‰
    const initialHistoryData = [
        { month: '2025-12', north: 10, central: 20, south: 5 },
        { month: '2025-11', north: 0, central: 67, south: 0 },
        { month: '2025-10', north: 5, central: 12, south: 3 },
        { month: '2025-09', north: 8, central: 4, south: 10 },
        { month: '2025-08', north: 2, central: 0, south: 7 },
        { month: '2025-07', north: 15, central: 25, south: 1 },
        { month: '2025-06', north: 3, central: 10, south: 20 },
        { month: '2025-05', north: 0, central: 0, south: 50 },
        { month: '2025-04', north: 1, central: 3, south: 8 },
        { month: '2025-03', north: 6, central: 9, south: 4 },
        { month: '2025-02', north: 10, central: 10, south: 10 },
        { month: '2025-01', north: 12, central: 15, south: 18 },
        { month: '2024-12', north: 20, central: 30, south: 40 },
        { month: '2024-11', north: 5, central: 8, south: 12 },
        { month: '2024-10', north: 1, central: 1, south: 1 }
    ];

    let currentHistoryData = []; // å ±è¡¨ä½¿ç”¨çš„æ•¸æ“šæº
    const PAGE_SIZE = 12; // ç·¨è¼¯å™¨æ¯é é¡¯ç¤ºç­†æ•¸
    let currentPage = 1; // ç·¨è¼¯å™¨ç•¶å‰é ç¢¼

    // --- è¼”åŠ©å‡½æ•¸ ---

    // æ ¼å¼åŒ–æœˆä»½é¡¯ç¤ºï¼š YYYY/MM
    const formatMonthDisplay = (date) => `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}`;
    // æª¢æŸ¥ YYYY-MM æ ¼å¼
    const isValidMonthFormat = (monthStr) => /^\d{4}-\d{2}$/.test(monthStr);

    // --- æ•¸æ“šåŠ è¼‰èˆ‡ä¿å­˜å‡½æ•¸ ---

    function loadHistoryData() {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
            // è§£ææ•¸æ“šä¸¦æŒ‰æœˆä»½é™åºæ’åº (æœ€æ–°æœˆä»½åœ¨æœ€å‰é¢)
            currentHistoryData = JSON.parse(storedData)
                .filter(item => isValidMonthFormat(item.month)) // ç¢ºä¿æ•¸æ“šæ ¼å¼æ­£ç¢º
                .sort((a, b) => b.month.localeCompare(a.month));
        } else {
            // å¦‚æœ LocalStorage æ²’æœ‰æ•¸æ“šï¼Œä½¿ç”¨åˆå§‹æ•¸æ“šä¸¦ä¿å­˜
            currentHistoryData = initialHistoryData.sort((a, b) => b.month.localeCompare(a.month));
            saveHistoryData(currentHistoryData);
        }
    }

    function saveHistoryData(data) {
        // ä¿å­˜å‰å†æ¬¡æ’åºï¼Œç¢ºä¿æœ€æ–°æœˆä»½æ°¸é åœ¨æœ€ä¸Šé¢
        const sortedData = data.sort((a, b) => b.month.localeCompare(a.month));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(sortedData));
        currentHistoryData = sortedData; // æ›´æ–°å…§éƒ¨è®Šé‡
    }

    // --- æ ¸å¿ƒæ›´æ–°é‚è¼¯ï¼šå³æ™‚ä¿å­˜èˆ‡æ¸²æŸ“ ---

    /**
     * å¾ç•¶å‰ç·¨è¼¯å™¨è¡¨æ ¼ä¸­è®€å–æ‰€æœ‰æ•¸æ“šï¼Œæ›´æ–°åˆ° currentHistoryDataï¼Œ
     * ä¿å­˜åˆ° LocalStorageï¼Œä¸¦é‡æ–°æ¸²æŸ“ä¸»å ±è¡¨å’Œç·¨è¼¯å™¨è¡¨æ ¼ã€‚
     */
    function updateAndRenderAll() {
        const tableBody = document.getElementById('editor-table-body');
        const rows = tableBody.querySelectorAll('tr');

        const newArray = [];
        
        // 1. å¾ç•¶å‰ç·¨è¼¯å™¨è¡¨æ ¼è®€å–ä¿®æ”¹å¾Œçš„æ•¸æ“š (åƒ…ç•¶å‰é )
        rows.forEach(row => {
            const currentMonth = row.querySelector('[data-field="month"]').textContent.trim();
            
            // ç”±æ–¼æˆ‘å€‘åªæœ‰ç•¶å‰é çš„è³‡æ–™ï¼Œéœ€è¦å¾åŸå§‹ currentHistoryData æ‰¾åˆ°æ‰€æœ‰æœªåœ¨ç•¶å‰é é¡¯ç¤ºçš„è³‡æ–™
            // ç‚ºäº†ç°¡åŒ–é‚è¼¯å’Œç¢ºä¿æ•¸æ“šå®Œæ•´æ€§ï¼Œæˆ‘å€‘å°‡åœ¨ç·¨è¼¯å™¨é—œé–‰æ™‚æ‰é€²è¡Œä¿å­˜ã€‚
            // 
            // ğŸš¨ ä¿®æ­£ï¼šç‚ºäº†å¯¦ç¾å³æ™‚ä¿å­˜ï¼Œæˆ‘å€‘å¿…é ˆä¿®æ”¹ currentHistoryData æœ¬èº«ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½è®€å–ã€‚
            // é€™æ˜¯æ›´å®‰å…¨çš„åšæ³•ï¼Œå› ç‚º currentHistoryData åŒ…å«äº†æ‰€æœ‰æœˆä»½çš„è³‡æ–™ã€‚

            // ç²å–åŸæ•¸æ“šåœ¨å…¨åŸŸé™£åˆ—ä¸­çš„ç´¢å¼•
            const originalMonth = row.getAttribute('data-month');
            const originalIndex = currentHistoryData.findIndex(item => item.month === originalMonth);


            if (originalIndex !== -1) {
                // é©—è­‰ä¸¦æ›´æ–°
                const newMonth = row.querySelector('[data-field="month"]').textContent.trim();
                const north = row.querySelector('[data-field="north"]').textContent.trim() || '0';
                const central = row.querySelector('[data-field="central"]').textContent.trim() || '0';
                const south = row.querySelector('[data-field="south"]').textContent.trim() || '0';
                
                let valid = true;
                
                // æœˆä»½æ ¼å¼é©—è­‰
                if (!isValidMonthFormat(newMonth)) {
                    valid = false;
                }
                
                // æ•¸å­—é©—è­‰
                if (isNaN(parseInt(north)) || isNaN(parseInt(central)) || isNaN(parseInt(south))) {
                    valid = false;
                }

                // æœˆä»½é‡è¤‡é©—è­‰
                const monthExists = currentHistoryData.some((item, i) => i !== originalIndex && item.month === newMonth);
                if (monthExists) {
                    valid = false;
                }

                if (valid) {
                    currentHistoryData[originalIndex].month = newMonth;
                    currentHistoryData[originalIndex].north = parseInt(north, 10);
                    currentHistoryData[originalIndex].central = parseInt(central, 10);
                    currentHistoryData[originalIndex].south = parseInt(south, 10);
                    
                    // æ›´æ–° data-month å±¬æ€§ï¼Œç¢ºä¿ä¸‹ä¸€è¼ªæŸ¥æ‰¾æ­£ç¢º
                    row.setAttribute('data-month', newMonth);
                } else {
                    // å¦‚æœé©—è­‰å¤±æ•—ï¼Œä¸ä¿å­˜ï¼Œä¹Ÿä¸é‡æ–°æ¸²æŸ“ã€‚
                    return; 
                }
            }
        });

        // 2. ä¿å­˜æ•¸æ“šä¸¦é‡æ–°æ¸²æŸ“
        saveHistoryData(currentHistoryData);
        renderReport(); // æ›´æ–°å ±è¡¨ä¸»é«”
        // é‡æ–°æ¸²æŸ“ç·¨è¼¯å™¨è¡¨æ ¼ï¼Œä¿æŒåœ¨ç•¶å‰é 
        renderEditorTable(false); 
    }

    // --- ç·¨è¼¯å™¨ç›¸é—œå‡½æ•¸ ---

    let isInternalUpdate = false; // ç”¨æ–¼é˜²æ­¢ onblur è§¸ç™¼æ™‚çš„æ­»å¾ªç’°

    // æ¸²æŸ“ç·¨è¼¯å™¨è¡¨æ ¼ (æ–°å¢ä¸€å€‹åƒæ•¸ forceRenderReport ç”¨æ–¼é é¢åˆ‡æ›)
    function renderEditorTable(forceRenderReport = true) {
        const tableBody = document.getElementById('editor-table-body');
        const totalItems = currentHistoryData.length;
        const totalPages = Math.ceil(totalItems / PAGE_SIZE);

        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
        if (totalPages === 0) currentPage = 1;

        const startIndex = (currentPage - 1) * PAGE_SIZE;
        const endIndex = Math.min(startIndex + PAGE_SIZE, totalItems);
        const pageData = currentHistoryData.slice(startIndex, endIndex);

        let html = '';
        pageData.forEach((item) => {
            html += `
                <tr data-month="${item.month}">
                    <td contenteditable="true" data-field="month" 
                        onblur="handleCellBlur(this, 'month')" 
                        class="month-cell">${item.month}</td>
                    <td contenteditable="true" data-field="north" onblur="handleCellBlur(this, 'number')">${item.north}</td>
                    <td contenteditable="true" data-field="central" onblur="handleCellBlur(this, 'number')">${item.central}</td>
                    <td contenteditable="true" data-field="south" onblur="handleCellBlur(this, 'number')">${item.south}</td>
                    <td><button class="delete-btn" data-month-to-delete="${item.month}">åˆªé™¤</button></td>
                </tr>
            `;
        });
        tableBody.innerHTML = html;

        // æ›´æ–°åˆ†é æ§åˆ¶
        document.getElementById('page-info').textContent = totalItems === 0 ? 'ç„¡æ•¸æ“š' : `ç¬¬ ${currentPage} é  / å…± ${totalPages} é `;
        document.getElementById('prev-page-button').disabled = currentPage === 1 || totalPages === 0;
        document.getElementById('next-page-button').disabled = currentPage === totalPages || totalPages === 0;
        document.querySelector('.pagination-controls').style.display = totalPages > 0 ? 'flex' : 'none';

        // é‡æ–°ç¶å®šåˆªé™¤äº‹ä»¶
        tableBody.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const monthToDelete = e.target.getAttribute('data-month-to-delete');
                handleDeleteRow(monthToDelete); // ç›´æ¥åˆªé™¤ï¼Œç„¡æç¤º
            });
        });

        if (forceRenderReport) {
            renderReport(); // ç¢ºä¿ä¸»å ±è¡¨æ˜¯æœ€æ–°çš„
        }
    }

    // è™•ç†å–®å…ƒæ ¼å¤±å»ç„¦é» (å³æ™‚ä¿å­˜çš„æ ¸å¿ƒ)
    function handleCellBlur(element, type) {
        if (isInternalUpdate) return;
        isInternalUpdate = true; // è¨­ç½®é–ï¼Œé˜²æ­¢éè¿´èª¿ç”¨

        let value = element.textContent.trim();

        if (type === 'number') {
            // æ•¸å­—é©—è­‰èˆ‡æ ¼å¼åŒ–
            value = value.replace(/[^0-9]/g, '');
            value = parseInt(value, 10) || 0; // è½‰ç‚ºæ•¸å­—ï¼Œç„¡æ•ˆå‰‡ç‚º 0
            element.textContent = value;
        } 
        
        // æ•¸å­—è¼¸å…¥æ™‚ï¼Œå› ç‚ºå·²ç¶“ä¿®æ­£äº†ï¼Œæ‰€ä»¥ä¸ç”¨æ“”å¿ƒå…‰æ¨™å•é¡Œã€‚

        // ç«‹å³æ›´æ–°ä¸¦é‡æ–°æ¸²æŸ“æ‰€æœ‰å…§å®¹
        updateAndRenderAll();
        
        isInternalUpdate = false;
    }

    // æ‰“é–‹ç·¨è¼¯å™¨
    function openEditor() {
        loadHistoryData();
        currentPage = 1; 
        renderEditorTable(true);
        document.getElementById('editor-modal').style.display = 'flex';
    }

    // é—œé–‰ç·¨è¼¯å™¨
    function closeEditor() {
        document.getElementById('editor-modal').style.display = 'none';
        // ç¢ºä¿é—œé–‰æ™‚æ˜¯æœ€æ–°æ•¸æ“š
        renderReport();
    }

    // è™•ç†æ–°å¢æœˆä»½
    function handleAddRow() {
        const newMonth = prompt("è«‹è¼¸å…¥è¦æ–°å¢çš„æœˆä»½ (æ ¼å¼: YYYY-MM)ï¼Œä¾‹å¦‚: 2026-01");

        if (!newMonth) return;

        const trimmedMonth = newMonth.trim();
        if (!isValidMonthFormat(trimmedMonth)) {
            // ä¸ä½¿ç”¨ alertï¼Œä½†æ“ä½œå¤±æ•—æ™‚å¿…é ˆçµ¦ç”¨æˆ¶åé¥‹ (é€™è£¡ä½¿ç”¨ console å’Œ prompt çš„æ–¹å¼)
            console.error("æœˆä»½æ ¼å¼éŒ¯èª¤ã€‚è«‹ä½¿ç”¨ YYYY-MM æ ¼å¼ã€‚");
            return;
        }

        if (currentHistoryData.some(item => item.month === trimmedMonth)) {
            console.error(`æœˆä»½ ${trimmedMonth} å·²å­˜åœ¨æ–¼æ•¸æ“šä¸­ã€‚`);
            return;
        }

        currentHistoryData.push({
            month: trimmedMonth,
            north: 0,
            central: 0,
            south: 0
        });

        // ä¿å­˜ä¸¦é‡æ–°æ¸²æŸ“ï¼Œè‡ªå‹•è·³è½‰åˆ°åŒ…å«æ–°æœˆä»½çš„ç¬¬ä¸€é  (æœ€æ–°æœˆä»½æœƒåœ¨ç¬¬ä¸€é )
        saveHistoryData(currentHistoryData);
        currentPage = 1; 
        renderEditorTable(true);
    }

    // è™•ç†åˆªé™¤æœˆä»½ (ç›´æ¥åŸ·è¡Œï¼Œç„¡æç¤º)
    function handleDeleteRow(monthToDelete) {
        const initialLength = currentHistoryData.length;
        const newArray = currentHistoryData.filter(item => item.month !== monthToDelete);
        
        if (newArray.length === initialLength) {
            console.error(`æ‰¾ä¸åˆ°æœˆä»½ ${monthToDelete}ã€‚`);
            return;
        }

        saveHistoryData(newArray); // ä¿å­˜åˆªé™¤å¾Œçš„æ•¸æ“š

        // é‡æ–°è¨ˆç®—é ç¢¼ï¼Œç¢ºä¿ä¸æœƒåœç•™åœ¨ç©ºé 
        const totalPagesAfterDelete = Math.ceil(newArray.length / PAGE_SIZE);
        if (currentPage > totalPagesAfterDelete && totalPagesAfterDelete > 0) {
            currentPage = totalPagesAfterDelete;
        } else if (totalPagesAfterDelete === 0) {
            currentPage = 1;
        }

        // é‡æ–°æ¸²æŸ“ç·¨è¼¯å™¨è¡¨æ ¼å’Œå ±è¡¨
        renderEditorTable(true); 
    }

    // --- å ±è¡¨æ¸²æŸ“å‡½æ•¸ (ä¿æŒä¸è®Š) ---
    let currentChart = null;

    function renderPieChart(data) {
        if (currentChart) {
            currentChart.destroy();
            currentChart = null;
        }

        const container = document.getElementById('pie-chart-container');
        container.innerHTML = '<canvas id="pie-chart"></canvas>';
        const ctx = document.getElementById('pie-chart').getContext('2d');
        const total = data.north + data.central + data.south;

        if (total === 0) {
            container.innerHTML = '<p style="text-align:center; color: #999; font-size:14px;">æœ¬æœˆç„¡æ›´æ–°æ•¸æ“š</p>';
            return;
        }

        currentChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['åŒ—è™•', 'ä¸­è™•', 'å—è™•'],
                datasets: [{
                    data: [data.north, data.central, data.south],
                    backgroundColor: [
                        getComputedStyle(document.documentElement).getPropertyValue('--color-chart-north').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--color-chart-central').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--color-chart-south').trim()
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: { size: 12, family: 'Microsoft JhengHei' },
                            usePointStyle: true,
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    const totalValue = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return data.labels.map(function(label, i) {
                                        const value = data.datasets[0].data[i];
                                        const percentage = totalValue > 0 ? (value / totalValue * 100).toFixed(1) : 0;
                                        return {
                                            text: label + ': ' + value + ' (' + percentage + '%)',
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            pointStyle: 'circle',
                                            hidden: !chart.isDatasetVisible(0) || chart.getDatasetMeta(0).data[i].hidden,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed !== null) {
                                    label += context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    label += ' (' + (context.parsed / total * 100).toFixed(1) + '%)';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderReport() {
        loadHistoryData();
        const historyTable = document.getElementById('history-table');
        const MAX_DISPLAY_MONTHS = 12;

        if (currentHistoryData.length === 0) {
            // æ¸…ç©ºå ±è¡¨æ‰€æœ‰æ•¸æ“š
            document.getElementById('current-month-range').textContent = 'ç„¡æ•¸æ“š';
            document.getElementById('current-month-display').textContent = 'N/A';
            ['current-total', 'grand-total-north', 'grand-total-central', 'grand-total-south', 'grand-total-sum'].forEach(id => document.getElementById(id).textContent = '0');
            document.querySelectorAll('#current-month-table .num').forEach(el => el.textContent = '0');
            document.getElementById('pie-chart-container').innerHTML = '<p style="text-align:center; color: #999; font-size:14px;">ç„¡æ•¸æ“šå¯é¡¯ç¤º</p>';
            historyTable.querySelectorAll('.data-row').forEach(row => row.remove());
            return;
        }

// --- 1. è™•ç†æœ¬æœˆæ•¸æ“š (å·¦å´è¡¨æ ¼ & åœ“é¤…åœ–) ---
const latestMonth = currentHistoryData[0];
const latestDate = new Date(latestMonth.month + '-01');
const monthDisplay = formatMonthDisplay(latestDate);

// *** ä¿®æ­£éƒ¨åˆ†é–‹å§‹ ***
const [y, m] = latestMonth.month.split('-').map(Number);
const lastDay = new Date(y, m, 0).getDate(); // è‡ªå‹•å–å¾— 28, 29, 30 æˆ– 31
document.getElementById('current-month-range').textContent = `${monthDisplay}ï¼ˆè³‡æ–™å€é–“ï¼š${latestMonth.month}-01 â€“ ${latestMonth.month}-${lastDay}ï¼‰`;
// *** ä¿®æ­£éƒ¨åˆ†çµæŸ ***

document.getElementById('current-month-display').textContent = monthDisplay;

        document.querySelector('#north-row td:nth-child(2)').textContent = latestMonth.north;
        document.querySelector('#central-row td:nth-child(2)').textContent = latestMonth.central;
        document.querySelector('#south-row td:nth-child(2)').textContent = latestMonth.south;

        const currentTotal = latestMonth.north + latestMonth.central + latestMonth.south;
        document.getElementById('current-total').textContent = currentTotal;

        renderPieChart(latestMonth);

        // --- 2. è™•ç†æ­·å²æ•¸æ“š (å³å´è¡¨æ ¼) ---
        const dataToDisplay = currentHistoryData.slice(0, MAX_DISPLAY_MONTHS);

        let cumulativeGrandTotal = { north: 0, central: 0, south: 0 };
        currentHistoryData.forEach(item => {
            cumulativeGrandTotal.north += Number(item.north) || 0;
            cumulativeGrandTotal.central += Number(item.central) || 0;
            cumulativeGrandTotal.south += Number(item.south) || 0;
        });

        historyTable.querySelectorAll('.data-row').forEach(row => row.remove());

        let historyHtml = '';

        dataToDisplay.forEach((item, i) => {
            const rowMonthDate = new Date(item.month + '-01');
            const rowMonthDisplay = formatMonthDisplay(rowMonthDate);
            const isCurrentMonth = i === 0;

            historyHtml += `
                <tr class="data-row ${isCurrentMonth ? 'current-month-row' : ''}" style="height: ${100 / MAX_DISPLAY_MONTHS}%">
                    <td>${isCurrentMonth ? 'æœ¬æœˆ' : rowMonthDisplay}</td>
                    <td class="history-num">${item.north}</td>
                    <td class="history-num">${item.central}</td>
                    <td class="history-num">${item.south}</td>
                </tr>
            `;
        });

        const actualDisplayMonths = dataToDisplay.length;
        const remainingRows = MAX_DISPLAY_MONTHS - actualDisplayMonths;
        if (remainingRows > 0) {
            const emptyRowHtml = `<tr class="data-row empty-fill" style="height: ${100 / MAX_DISPLAY_MONTHS}%">
                <td></td><td></td><td></td><td></td>
            </tr>`;

            for (let i = 0; i < remainingRows; i++) {
                historyHtml += emptyRowHtml;
            }
        }

        const historyHeaderRow = historyTable.querySelector('.history-header');
        historyHeaderRow.insertAdjacentHTML('afterend', historyHtml);


        // --- 3. é¡¯ç¤ºç¸½ç´¯è¨ˆ ---
        document.getElementById('grand-total-north').textContent = cumulativeGrandTotal.north;
        document.getElementById('grand-total-central').textContent = cumulativeGrandTotal.central;
        document.getElementById('grand-total-south').textContent = cumulativeGrandTotal.south;

        const totalGrandSum = cumulativeGrandTotal.north + cumulativeGrandTotal.central + cumulativeGrandTotal.south;
        document.getElementById('grand-total-sum').textContent = totalGrandSum;
    }


    // ç¶å®šäº‹ä»¶
    document.getElementById('edit-button').addEventListener('click', openEditor);
    document.getElementById('close-editor-button').addEventListener('click', closeEditor);
    document.getElementById('add-month-button').addEventListener('click', handleAddRow);

    document.getElementById('prev-page-button').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderEditorTable(true);
        }
    });

    document.getElementById('next-page-button').addEventListener('click', () => {
        const totalItems = currentHistoryData.length;
        const totalPages = Math.ceil(totalItems / PAGE_SIZE);
        if (currentPage < totalPages) {
            currentPage++;
            renderEditorTable(true);
        }
    });

    // é‹è¡Œç¨‹å¼
    document.addEventListener('DOMContentLoaded', renderReport);
</script>
</body>
</html>